<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.7">
<title>Phusion Passenger users guide, Nginx version</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
  overflow: auto;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #777777;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


/*
 * Theme specific overrides of the preceding (asciidoc.css) CSS.
 *
 */
body {
  font-family: Garamond, Georgia, serif;
  font-size: 17px;
  color: #3E4349;
  line-height: 1.3em;
}
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Garmond, Georgia, serif;
  font-weight: normal;
  border-bottom-width: 0;
  color: #3E4349;
}
div.title, caption.title { color: #596673; font-weight: bold; }
h1 { font-size: 240%; }
h2 { font-size: 180%; }
h3 { font-size: 150%; }
h4 { font-size: 130%; }
h5 { font-size: 115%; }
h6 { font-size: 100%; }
#header h1 { margin-top: 0; }
#toc {
  color: #444444;
  line-height: 1.5;
  padding-top: 1.5em;
}
#toctitle {
  font-size: 20px;
}
#toc a {
    border-bottom: 1px dotted #999999;
    color: #444444 !important;
    text-decoration: none !important;
}
#toc a:hover {
    border-bottom: 1px solid #6D4100;
    color: #6D4100 !important;
    text-decoration: none !important;
}
div.toclevel1 { margin-top: 0.2em; font-size: 16px; }
div.toclevel2 { margin-top: 0.15em; font-size: 14px; }
em, dt, td.hdlist1 { color: black; }
strong { color: #3E4349; }
a { color: #004B6B; text-decoration: none; border-bottom: 1px dotted #004B6B; }
a:visited { color: #615FA0; border-bottom: 1px dotted #615FA0; }
a:hover { color: #6D4100; border-bottom: 1px solid #6D4100; }
div.tableblock > table, table.tableblock { border: 3px solid #E8E8E8; }
th.tableblock, td.tableblock { border: 1px solid #E8E8E8; }
ul > li > * { color: #3E4349; }
pre, tt, .monospaced { font-family: Consolas,Menlo,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; }
tt, .monospaced { font-size: 0.9em; color: black;
}
div.exampleblock > div.content, div.sidebarblock > div.content, div.listingblock > div.content { border-width: 0 0 0 3px; border-color: #E8E8E8; }
div.verseblock { border-left-width: 0; margin-left: 3em; }
div.quoteblock { border-left-width: 3px; margin-left: 0; margin-right: 0;}
div.admonitionblock td.content { border-left: 3px solid #E8E8E8; }
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
<style type="text/css">
body {
	margin: 1em auto 1em auto;
	padding: 0 1em 0 1em;
	max-width: 800px;
}

a.image {
	border: none;
}

.comments {
	display: block;
	background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAgCAYAAAB6kdqOAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAB0wAAAdMBc2+PegAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAASjSURBVFiFvZdPaBxVHMc/b/7sbNLdxG13s0sbE1jBxELVbVGEgqmQiiBiDxZqKRWhR0Fqe/BSmoNQSNmrt4ISTyV3byWLHorVU5dYtgVpk4DGhXZ1a7rZmXkeMm99eZn9k1b9wY/3Z2f2fX7f3++9mRFSSnQTQgjAAkTkaO2zmtRaCYTSABBqrIEkS6VS9vTp069lMpmClFL4vt8BCsNwWwsQBAHm7+Y4CAKEEEGtVvtlYWHhbqvVagJ/AE90MCGlVDD2xYsXiydPnvza87wXksnk8NDQUFIPQPW7zfXyMAwJw5BGo/FXs9ncvHfv3tKFCxe+aLfbDyKwQEopFZBdLpdfnp2d/Tafz4+5rhsxghAC1d+h/y5gzH69XvdrtdqDs2fPfuT7/jLQkFIGlhBC5HK5oZmZmW8KhUI+kUgIy7KwLAvbtrFte1vfdHVtnKtg9L7yffv2OcViceLSpUufA88DSSGEcABrfn7+zdHR0UnXdWNv1tXqpY6phGVZnRoy/0MIQT6fdw4ePHgUKAK/AU8sQOzfv/+tdDq9x4xKd1MVU51uSvTzVCrlTU9PTwN7AGEBYmRk5FXXdTvk+gI6kJnGQQG6KQQwMjLiTk1NTQIJBQTgmAWst2rhfiBxC3ab00wAbtRugZjb2LzR3O7d2rh7+s2Ztg1IwajChK2DTSlggpuFrHs34H7BOHELqN0Rl5K4P+4GNQioPt8BUqeoqpd+MGYQvQ7DfrCxKVNAcTCws0B7RdrvhO4HtS1lCkYtbKrT7WB8GihdQf2B3FFIPbEH2cY6iAljjk1l4qB2KKSrMwjMblXqpVpfIF2lXjBxULsB06HigDb1lA2ijgm0WyithmS73faJ3iYdgHq9/tOBAwfe9jyvJ4wam1H1O196QT18+HBzeXl5FQgVkLxz5873k5OTzWw2m+oHE6dMHEw3EGBbuh4/fuyvrKysAS1AOkA4Nzf3w5EjR+6m0+mS/tTvBhMH1U2lXgqtra21l5aWvgNWgCYQ2tH/hY1G48epqal3Pc/b4ziOGLQegiCIPVv0ubhDcXV1dfP27dv3y+Xyl0AVqAO+/pKfmpiYeHFubm4+m82+kkgkPNd1nbjI9TaZTNqu61rRQpbrujiOs+O6MAx59OhRuL6+3mq1Wq1KpXJjYWFhMYK5DzSljF7yo7RYwBCQBfKlUml6bGxsMggCLwgC/Ruts4CRPpFMJodnZmbeKBaLLxUKheFMJmPr6a5Wq0+uXLmyWK1WK8DPwBrwO7AhpQxB+y6LoARbhe4Bw0AyGlv0N/Vd56VSqb3nzp378PDhw+/ncrnnCoWCZ1kWvu9z69at9fPnz3+6sbFxE/gVaEkNYhuQBqUvsBtTSnrAKDB25syZ944dO/ZxNpvNjY+PDzebTb9Sqdy8fPnyZ0AN+FOpEwv0rKYFZEdgaSB7/PjxoydOnPgkl8tNAN7169fLi4uLX7G1w/5RadDnz9N4pJbNVupzwHSpVPrg6tWrN65du/broUOHZoEMYHXu+S+BYsA8YC9QHB8ff/3UqVPvREC2uvZfT1kvi9KpNo7LVo1uApsqZf8rkAHWMX2X/Q1tcUY1hl3QyQAAAABJRU5ErkJggg==') top left no-repeat;
	float: left;
	margin-left: -55px;
	width: 36px;
	height: 48px;
	line-height: 0;
	color: black;
	text-decoration: none !important;
	border: none !important;
}

#toc .comments {
	margin-top: 0.25em;
}

.sect1 .comments {
	margin-top: 0.5em;
}

.sect2 .comments {
	margin-top: 1.15em;
}

.sect3 .comments {
	margin-top: -1em;
}

.comments.empty {
	opacity: 0.2;
}

.comments.empty:hover,
.comments.nonempty {
	opacity: 1;
}

.comments .count {
	display: block;
	font-size: 80%;
	padding-top: 12px;
	text-align: center;
	text-shadow: 1px 1px 2px white;
}

#comments_lightbox_shadow {
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	background: black;
	opacity: 0.7;
	z-index: 10;
}

#comments_lightbox_contents {
	position: fixed;
	top: 10%;
	left: 20%;
	right: 20%;
	bottom: 10%;
	background: white;
	overflow: auto;
	z-index: 11;
}

#comments_lightbox_contents > .shell {
	margin: 2em;
}

pre {
	overflow: auto;
}

@media print {
	body {
		font-size: 18pt;
	}
	
	#header h1 {
		page-break-after: always;
		font-size: 500%;
		vertical-align: middle;
	}
	
	#header {
		page-break-after: always;
	}
	
	#toctitle {
		font-size: 200%;
		margin-bottom: 1em;
	}
	
	div.toclevel1 {
		font-size: 100%;
	}
	
	div.toclevel2 {
		font-size: 90%;
	}
	
	div.toclevel3 {
		font-size: 80%;
	}
	
	#content .comments {
		display: none;
	}
	
	@page :left {
		@bottom-left {
			content: counter(page);
		}
	}
}

#topbar {
	position: fixed;
	left: 0;
	top: 0;
	right: 0;
	height: 2.5em;
	padding-left: 10%;
	padding-right: 10%;
	z-index: 1;
	background: #880000;
	overflow: hidden;
	white-space: nowrap;
	box-shadow: 0px 3px 6px #555555;
	-moz-box-shadow: 0px 3px 6px #555555;
	-webkit-box-shadow: 0px 3px 6px #555555;
	-o-box-shadow: 0px 3px 6px #555555;
}

#topbar .title {
	display: inline-block;
	margin: 0.6em 1em 0 0;
	vertical-align: top;
}

#topbar .title img {
	display: none;
	margin-right: 6px;
	vertical-align: middle;
}

#topbar .title a {
	color: #fffafa;
	border: 0;
}

#topbar .title:hover img,
.mobile #topbar .title img {
	display: inline-block;
	margin-left: -17px;
}

#topbar .title:hover a,
.mobile #topbar .title a {
	color: #ffffdd;
}

#floattoc {
	position: fixed;
	z-index: 1;
	top: 2em;
	bottom: 20%;
	width: 50%;
	background: #f0f0f0;
	color: black;
	box-shadow: 0px 6px 6px #555555;
	-moz-box-shadow: 0px 6px 6px #555555;
	-webkit-box-shadow: 0px 6px 6px #555555;
	-o-box-shadow: 0px 6px 6px #555555;
	overflow: auto;
	padding: 1em;
	border-radius: 6px;
	-webkit-border-radius: 8px;
	-webkit-border-top-left-radius: 0;
	-webkit-border-top-right-radius: 0;
	-moz-border-radius: 8px;
	-moz-border-radius-topleft: 0;
	-moz-border-top-right-radius: 0;
	-o-border-radius: 8px;
	-o-border-radius-topleft: 0;
	-o-border-top-right-radius: 0;
	border-radius: 8px;
	border-top-left-radius: 0;
	border-top-right-radius: 0;
}

#floattoc a.current {
	font-weight: bold;
	color: black;
}

#current_section {
	display: inline-block;
	margin: 0.5em 0 0 0;
	padding: 0.2em 0.5em 0.2em 0.5em;
	background: #550000;
	font-size: 90%;
	vertical-align: top;
	color: white;
	border: none;
	-webkit-border-radius: 8px;
	-moz-border-radius: 8px;
	-o-border-radius: 8px;
	border-radius: 8px;
}

#current_section:hover {
	text-decoration: none;
	border: none;
}

#current_section.pressed {
	background: #f0f0f0;
	color: black;
	-webkit-border-top-left-radius: 8px;
	-webkit-border-top-right-radius: 8px;
	-webkit-border-bottom-left-radius: 0;
	-webkit-border-bottom-right-radius: 0;
	-moz-border-radius-topleft: 8px;
	-moz-border-radius-topright: 8px;
	-moz-border-bottom-left-radius: 0;
	-moz-border-bottom-right-radius: 0;
	border-top-left-radius: 8px;
	border-top-right-radius: 8px;
	border-bottom-left-radius: 0;
	border-bottom-right-radius: 0;
}

/* http://nicolasgallagher.com/jump-links-and-viewport-positioning/ */
.anchor_helper {
	position: relative;
	display: block;
	top: -50px;
	width: 1px;
	height: 1px;
}

</style>
</head>
<body class="article">
<div id="topbar" style="display: none">
	<div class="title">
		<!-- Don't put a space between the img and a. That will break the hover layout. -->
		<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAKCAYAAAEV95QVAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sGCRMSACDxkZwAAAAidEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVAgb24gYSBNYWOHqHdDAAAAZUlEQVQY032PSxbAIAjEIlfygL6ePF3UUvpzNjgSYWwqAMEhUQnANnsC7TQPeJpsVWzMuh2sog4vDTUbqP081zECrW4dtdaQGSIKlWluPyjK+VXxAz5XfcKufCzA130AfQHWB30HZxlPaP080xsAAAAASUVORK5CYII=" width="11" height="10" alt=""><a href="javascript:void(Mizuho.smoothlyScrollToToc())">Phusion Passenger users guide, Nginx version</a>
	</div>
	<a href="javascript:void(0)" id="current_section"></a>
</div>
<div id="header">
<h1>Phusion Passenger users guide, Nginx version</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p><span class="image">
<a class="image" href="http://www.phusion.nl/">
<img src="images/phusion_banner.png" alt="images/phusion_banner.png">
</a>
</span></p></div>
<div class="paragraph"><p>Phusion Passenger is an application server which can directly integrate into Nginx. It is designed to be easy to use, fast, stable and reliable and is used by <a href="http://trends.builtwith.com/Web-Server/Phusion-Passenger">hundreds of thousands of websites</a> all over the world.</p></div>
<div class="paragraph"><p>Phusion Passenger is a so-called polyglot application server because it supports applications written in multiple programming languages. At this time, Ruby and Python are supported.</p></div>
<div class="paragraph"><p>This users guide will teach you:</p></div>
<div class="ulist"><ul>
<li>
<p>
How to install Nginx with Phusion Passenger support.
</p>
</li>
<li>
<p>
How to configure Phusion Passenger.
</p>
</li>
<li>
<p>
How to deploy Ruby and Python applications.
</p>
</li>
<li>
<p>
How to solve common problems.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This guide assumes that the reader is somewhat familiar with Nginx and with
using the command line.</p></div>
</div>
</div>
<div id="toc">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><div id="toctitle">Table of Contents</div>
<div class="foo toclevel2"><a href="#_support_information">1. Support information</a></div>
<div class="foo toclevel3"><a href="#_supported_operating_systems_and_languages">1.1. Supported operating systems and languages</a></div>
<div class="foo toclevel3"><a href="#where_to_get_support">1.2. Where to get support</a></div>
<div class="foo toclevel2"><a href="#installation">2. Installation</a></div>
<div class="foo toclevel3"><a href="#_synopsis">2.1. Synopsis</a></div>
<div class="foo toclevel3"><a href="#install_osx_homebrew">2.2. Installing or upgrading on Mac OS X with Homebrew</a></div>
<div class="foo toclevel3"><a href="#install_on_debian_ubuntu">2.3. Installing or upgrading on Debian or Ubuntu</a></div>
<div class="foo toclevel4"><a href="#install_add_apt_repo">2.3.1. Adding our APT repository</a></div>
<div class="foo toclevel4"><a href="#_installing_packages">2.3.2. Installing packages</a></div>
<div class="foo toclevel4"><a href="#inserting_passenger_root_for_apt">2.3.3. Inserting passenger_root into nginx.conf</a></div>
<div class="foo toclevel3"><a href="#installing_or_upgrading_on_red_hat">2.4. Installing or upgrading on Red Hat or CentOS</a></div>
<div class="foo toclevel4"><a href="#install_add_yum_repo">2.4.1. Adding our YUM repository</a></div>
<div class="foo toclevel4"><a href="#_installing_packages_2">2.4.2. Installing packages</a></div>
<div class="foo toclevel3"><a href="#_installing_or_upgrading_on_heroku">2.5. Installing or upgrading on Heroku</a></div>
<div class="foo toclevel3"><a href="#rubygems_generic_install">2.6. Generic installation, upgrade and downgrade method: via RubyGems</a></div>
<div class="foo toclevel3"><a href="#tarball_generic_install">2.7. Generic installation, upgrade and downgrade method: via tarball</a></div>
<div class="foo toclevel3"><a href="#_upgrading_from_open_source_to_enterprise">2.8. Upgrading from open source to Enterprise</a></div>
<div class="foo toclevel3"><a href="#_cryptographic_verification_of_installation_files">2.9. Cryptographic verification of installation files</a></div>
<div class="foo toclevel4"><a href="#_synopsis_2">2.9.1. Synopsis</a></div>
<div class="foo toclevel4"><a href="#_importing_the_phusion_software_signing_key">2.9.2. Importing the Phusion Software Signing key</a></div>
<div class="foo toclevel4"><a href="#_verifying_the_phusion_software_signing_key">2.9.3. Verifying the Phusion Software Signing key</a></div>
<div class="foo toclevel4"><a href="#_verifying_the_gem_and_tarball">2.9.4. Verifying the gem and tarball</a></div>
<div class="foo toclevel4"><a href="#_verifying_git_signatures">2.9.5. Verifying Git signatures</a></div>
<div class="foo toclevel4"><a href="#_verifying_deb_and_rpm_packages">2.9.6. Verifying DEB and RPM packages</a></div>
<div class="foo toclevel4"><a href="#_revocation">2.9.7. Revocation</a></div>
<div class="foo toclevel3"><a href="#_non_interactive_automatic_headless_installs_or_upgrades">2.10. Non-interactive, automatic, headless installs or upgrades</a></div>
<div class="foo toclevel3"><a href="#_customizing_the_compilation_process">2.11. Customizing the compilation process</a></div>
<div class="foo toclevel4"><a href="#_setting_the_compiler">2.11.1. Setting the compiler</a></div>
<div class="foo toclevel4"><a href="#_adding_additional_compiler_or_linker_flags">2.11.2. Adding additional compiler or linker flags</a></div>
<div class="foo toclevel4"><a href="#forcing_location_of_command_line_tools_and_dependencies">2.11.3. Forcing location of command line tools and dependencies</a></div>
<div class="foo toclevel3"><a href="#_installing_as_a_normal_nginx_module_without_using_the_installer">2.12. Installing as a normal Nginx module without using the installer</a></div>
<div class="foo toclevel3"><a href="#nginx_init_script">2.13. Creating an Nginx init script</a></div>
<div class="foo toclevel3"><a href="#_disabling_without_uninstalling">2.14. Disabling without uninstalling</a></div>
<div class="foo toclevel3"><a href="#uninstalling">2.15. Uninstalling</a></div>
<div class="foo toclevel3"><a href="#moving_phusion_passenger">2.16. Moving to a different directory</a></div>
<div class="foo toclevel2"><a href="#deploying_a_rack_app">3. Deploying a Rack-based Ruby application</a></div>
<div class="foo toclevel3"><a href="#_tutorial_example_writing_and_deploying_a_hello_world_rack_application">3.1. Tutorial/example: writing and deploying a Hello World Rack application</a></div>
<div class="foo toclevel3"><a href="#_deploying_to_a_virtual_host_8217_s_root">3.2. Deploying to a virtual host’s root</a></div>
<div class="foo toclevel3"><a href="#deploying_rack_to_sub_uri">3.3. Deploying to a sub URI</a></div>
<div class="foo toclevel3"><a href="#_redeploying_restarting_the_rack_application">3.4. Redeploying (restarting the Rack application)</a></div>
<div class="foo toclevel3"><a href="#_rackup_specifications_for_various_web_frameworks">3.5. Rackup specifications for various web frameworks</a></div>
<div class="foo toclevel4"><a href="#_camping">3.5.1. Camping</a></div>
<div class="foo toclevel4"><a href="#_halcyon">3.5.2. Halcyon</a></div>
<div class="foo toclevel4"><a href="#_mack">3.5.3. Mack</a></div>
<div class="foo toclevel4"><a href="#_merb">3.5.4. Merb</a></div>
<div class="foo toclevel4"><a href="#_ramaze">3.5.5. Ramaze</a></div>
<div class="foo toclevel4"><a href="#_sinatra">3.5.6. Sinatra</a></div>
<div class="foo toclevel2"><a href="#deploying_a_wsgi_app">4. Deploying a WSGI (Python) application</a></div>
<div class="foo toclevel3"><a href="#_tutorial_example_writing_and_deploying_a_hello_world_wsgi_application">4.1. Tutorial/example: writing and deploying a Hello World WSGI application</a></div>
<div class="foo toclevel3"><a href="#_deploying_to_a_virtual_host_8217_s_root_2">4.2. Deploying to a virtual host’s root</a></div>
<div class="foo toclevel3"><a href="#deploying_wsgi_to_sub_uri">4.3. Deploying to a sub URI</a></div>
<div class="foo toclevel3"><a href="#_redeploying_restarting_the_wsgi_application">4.4. Redeploying (restarting the WSGI application)</a></div>
<div class="foo toclevel3"><a href="#_sample_span_class_monospaced_passenger_wsgi_py_span_for_django">4.5. Sample passenger_wsgi.py for Django</a></div>
<div class="foo toclevel2"><a href="#_deploying_a_node_js_application">5. Deploying a Node.js application</a></div>
<div class="foo toclevel2"><a href="#_deploying_a_meteor_application">6. Deploying a Meteor application</a></div>
<div class="foo toclevel2"><a href="#_configuring_phusion_passenger">7. Configuring Phusion Passenger</a></div>
<div class="foo toclevel3"><a href="#PassengerRoot">7.1. passenger_root &lt;directory&gt;</a></div>
<div class="foo toclevel3"><a href="#_deployment_options">7.2. Deployment options</a></div>
<div class="foo toclevel4"><a href="#_passenger_enabled_lt_on_off_gt">7.2.1. passenger_enabled &lt;on|off&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerBaseURI">7.2.2. passenger_base_uri &lt;uri&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerDocumentRoot">7.2.3. passenger_document_root &lt;path&gt;</a></div>
<div class="foo toclevel3"><a href="#_application_loading_options">7.3. Application loading options</a></div>
<div class="foo toclevel4"><a href="#PassengerRuby">7.3.1. passenger_ruby &lt;filename&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_python_lt_filename_gt">7.3.2. passenger_python &lt;filename&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_nodejs_lt_filename_gt">7.3.3. passenger_nodejs &lt;filename&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_meteor_app_settings_lt_filename_gt">7.3.4. passenger_meteor_app_settings &lt;filename&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerAppEnv">7.3.5. passenger_app_env &lt;string&gt;</a></div>
<div class="foo toclevel4"><a href="#RailsEnv">7.3.6. rails_env &lt;string&gt;</a></div>
<div class="foo toclevel4"><a href="#RackEnv">7.3.7. rack_env &lt;string&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerAppRoot">7.3.8. passenger_app_root &lt;path/to/root&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerAppGroupName">7.3.9. passenger_app_group_name &lt;name&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerAppType">7.3.10. passenger_app_type &lt;name&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerStartupFile">7.3.11. passenger_startup_file &lt;filename&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerSpawnMethod">7.3.12. passenger_spawn_method &lt;string&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerEnvVar">7.3.13. passenger_env_var &lt;name&gt; &lt;value&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerLoadShellEnvvars">7.3.14. passenger_load_shell_envvars &lt;on|off&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerRollingRestarts">7.3.15. passenger_rolling_restarts &lt;on|off&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerResistDeploymentErrors">7.3.16. passenger_resist_deployment_errors &lt;on|off&gt;</a></div>
<div class="foo toclevel3"><a href="#_security_options">7.4. Security options</a></div>
<div class="foo toclevel4"><a href="#PassengerUserSwitching">7.4.1. passenger_user_switching &lt;on|off&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerUser">7.4.2. passenger_user &lt;username&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerGroup">7.4.3. passenger_group &lt;group name&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerDefaultUser">7.4.4. passenger_default_user &lt;username&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerDefaultGroup">7.4.5. Passenger_default_group &lt;group name&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_show_version_in_header_lt_on_off_gt">7.4.6. passenger_show_version_in_header &lt;on|off&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerFriendlyErrorPages">7.4.7. passenger_friendly_error_pages &lt;on|off&gt;</a></div>
<div class="foo toclevel3"><a href="#_resource_control_and_optimization_options">7.5. Resource control and optimization options</a></div>
<div class="foo toclevel4"><a href="#PassengerMaxPoolSize">7.5.1. passenger_max_pool_size &lt;integer&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerMinInstances">7.5.2. passenger_min_instances &lt;integer&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerMaxInstances">7.5.3. passenger_max_instances &lt;integer&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_max_instances_per_app_lt_integer_gt">7.5.4. passenger_max_instances_per_app &lt;integer&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerPoolIdleTime">7.5.5. passenger_pool_idle_time &lt;integer&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_max_preloader_idle_time_lt_integer_gt">7.5.6. passenger_max_preloader_idle_time &lt;integer&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_start_timeout_lt_seconds_gt">7.5.7. passenger_start_timeout &lt;seconds&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerConcurrencyModel">7.5.8. passenger_concurrency_model &lt;process|thread&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerThreadCount">7.5.9. passenger_thread_count &lt;number&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerMaxRequests">7.5.10. passenger_max_requests &lt;integer&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerMaxRequestTime">7.5.11. passenger_max_request_time &lt;seconds&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerMemoryLimit">7.5.12. passenger_memory_limit &lt;integer&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_stat_throttle_rate_lt_integer_gt">7.5.13. passenger_stat_throttle_rate &lt;integer&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerPreStart">7.5.14. passenger_pre_start &lt;url&gt;</a></div>
<div class="foo toclevel3"><a href="#_connection_handling_options">7.6. Connection handling options</a></div>
<div class="foo toclevel4"><a href="#PassengerSetHeader">7.6.1. passenger_set_header &lt;HTTP header name&gt; &lt;value&gt;</a></div>
<div class="foo toclevel4"><a href="#passenger_max_request_queue_size">7.6.2. passenger_max_request_queue_size &lt;number&gt;</a></div>
<div class="foo toclevel4"><a href="#passenger_request_queue_overflow_status_code">7.6.3. passenger_request_queue_overflow_status_code &lt;code&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerStickySessions">7.6.4. passenger_sticky_sessions &lt;on|off&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerStickySessionsCookieName">7.6.5. passenger_sticky_sessions_cookie_name</a></div>
<div class="foo toclevel4"><a href="#_passenger_ignore_client_abort_lt_on_off_gt">7.6.6. passenger_ignore_client_abort &lt;on|off&gt;</a></div>
<div class="foo toclevel4"><a href="#passenger_intercept_errors">7.6.7. passenger_intercept_errors &lt;on|off&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_pass_header_lt_header_name_gt">7.6.8. passenger_pass_header &lt;header name&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_ignore_headers_lt_header_names_8230_gt">7.6.9. passenger_ignore_headers &lt;header names…&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_headers_hash_bucket_size_lt_size_gt">7.6.10. passenger_headers_hash_bucket_size &lt;size&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_headers_hash_max_size_lt_size_gt">7.6.11. passenger_headers_hash_max_size &lt;size&gt;</a></div>
<div class="foo toclevel4"><a href="#passenger_buffer_response">7.6.12. passenger_buffer_response &lt;on|off&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerResponseBufferHighWatermark">7.6.13. passenger_response_buffer_high_watermark &lt;bytes&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_buffer_size">7.6.14. passenger_buffer_size</a></div>
<div class="foo toclevel4"><a href="#_passenger_buffers">7.6.15. passenger_buffers</a></div>
<div class="foo toclevel4"><a href="#_passenger_busy_buffers_size">7.6.16. passenger_busy_buffers_size</a></div>
<div class="foo toclevel3"><a href="#_logging_and_debugging_options">7.7. Logging and debugging options</a></div>
<div class="foo toclevel4"><a href="#PassengerLogLevel">7.7.1. passenger_log_level &lt;integer&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerLogFile">7.7.2. passenger_log_file &lt;filename&gt;</a></div>
<div class="foo toclevel4"><a href="#_passengerfiledescriptorlogfile_lt_filename_gt">7.7.3. PassengerFileDescriptorLogFile &lt;filename&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_debugger_lt_on_off_gt">7.7.4. passenger_debugger &lt;on|off&gt;</a></div>
<div class="foo toclevel3"><a href="#_advanced_options">7.8. Advanced options</a></div>
<div class="foo toclevel4"><a href="#PassengerInstanceRegistryDir">7.8.1. passenger_instance_registry_dir &lt;directory&gt;</a></div>
<div class="foo toclevel4"><a href="#PassengerDataBufferDir">7.8.2. passenger_data_buffer_dir &lt;directory&gt;</a></div>
<div class="foo toclevel4"><a href="#_passenger_fly_with_lt_socket_filename_gt">7.8.3. passenger_fly_with &lt;socket filename&gt;</a></div>
<div class="foo toclevel3"><a href="#_deprecated_or_removed_options">7.9. Deprecated or removed options</a></div>
<div class="foo toclevel4"><a href="#_rails_spawn_method">7.9.1. rails_spawn_method</a></div>
<div class="foo toclevel4"><a href="#_passenger_debug_log_file">7.9.2. passenger_debug_log_file</a></div>
<div class="foo toclevel2"><a href="#troubleshooting">8. Troubleshooting</a></div>
<div class="foo toclevel3"><a href="#_generic_troubleshooting_tips">8.1. Generic troubleshooting tips</a></div>
<div class="foo toclevel3"><a href="#_why_does_the_first_request_take_a_long_time">8.2. Why does the first request take a long time?</a></div>
<div class="foo toclevel3"><a href="#_upon_accessing_the_web_app_nginx_reports_a_permission_denied_error">8.3. Upon accessing the web app, Nginx reports a "Permission denied" error</a></div>
<div class="foo toclevel3"><a href="#_i_get_command_not_found_when_running_a_phusion_passenger_command_through_sudo">8.4. I get "command not found" when running a Phusion Passenger command through sudo</a></div>
<div class="foo toclevel3"><a href="#_the_application_thinks_its_not_on_ssl_even_though_it_is">8.5. The application thinks its not on SSL even though it is</a></div>
<div class="foo toclevel3"><a href="#_ruby_on_rails_specific_troubleshooting">8.6. Ruby on Rails-specific troubleshooting</a></div>
<div class="foo toclevel4"><a href="#_the_about_your_application_8217_s_environment_link_does_not_work">8.6.1. The "About your application’s environment" link does not work</a></div>
<div class="foo toclevel4"><a href="#_the_rails_application_reports_that_it_8217_s_unable_to_start_because_of_a_permission_error">8.6.2. The Rails application reports that it’s unable to start because of a permission error</a></div>
<div class="foo toclevel4"><a href="#_the_rails_application_8217_s_log_file_is_not_being_written_to">8.6.3. The Rails application’s log file is not being written to</a></div>
<div class="foo toclevel2"><a href="#_analysis_and_system_maintenance">9. Analysis and system maintenance</a></div>
<div class="foo toclevel3"><a href="#_inspecting_memory_usage">9.1. Inspecting memory usage</a></div>
<div class="foo toclevel3"><a href="#_inspecting_phusion_passenger_8217_s_internal_status">9.2. Inspecting Phusion Passenger’s internal status</a></div>
<div class="foo toclevel3"><a href="#debugging_frozen">9.3. Debugging frozen applications</a></div>
<div class="foo toclevel3"><a href="#_accessing_individual_application_processes">9.4. Accessing individual application processes</a></div>
<div class="foo toclevel3"><a href="#_attaching_an_irb_console_to_an_application_process">9.5. Attaching an IRB console to an application process</a></div>
<div class="foo toclevel2"><a href="#_tips">10. Tips</a></div>
<div class="foo toclevel3"><a href="#user_switching">10.1. User Switching (security feature)</a></div>
<div class="foo toclevel4"><a href="#_requirements">10.1.1. Requirements</a></div>
<div class="foo toclevel4"><a href="#_effects">10.1.2. Effects</a></div>
<div class="foo toclevel4"><a href="#_caveats_amp_troubleshooting">10.1.3. Caveats &amp; troubleshooting</a></div>
<div class="foo toclevel4"><a href="#user_switching_rpm_caveats">10.1.4. Red Hat and CentOS caveats</a></div>
<div class="foo toclevel4"><a href="#finding_out_app_user">10.1.5. Finding out what user an application is running as</a></div>
<div class="foo toclevel3"><a href="#reducing_memory_usage">10.2. Copy-on-write memory support (reducing memory consumption of Ruby applications)</a></div>
<div class="foo toclevel3"><a href="#tuning_sse_websockets">10.3. Tuning for Server Sent Events and WebSockets</a></div>
<div class="foo toclevel3"><a href="#bundler_support">10.4. Bundler support</a></div>
<div class="foo toclevel4"><a href="#add_passenger_to_gemfile">10.4.1. Does Phusion Passenger itself need to be added to the Gemfile?</a></div>
<div class="foo toclevel3"><a href="#_installing_multiple_ruby_on_rails_versions">10.5. Installing multiple Ruby on Rails versions</a></div>
<div class="foo toclevel3"><a href="#_making_the_application_restart_after_each_request">10.6. Making the application restart after each request</a></div>
<div class="foo toclevel3"><a href="#sub_uri_deployment_uri_fix">10.7. How to fix broken images/CSS/JavaScript URIs in sub-URI deployments</a></div>
<div class="foo toclevel3"><a href="#_out_of_band_work_and_out_of_band_garbage_collection">10.8. Out-of-Band Work and Out-of-Band Garbage Collection</a></div>
<div class="foo toclevel3"><a href="#_hooks">10.9. Hooks</a></div>
<div class="foo toclevel4"><a href="#_example">10.9.1. Example</a></div>
<div class="foo toclevel4"><a href="#_environment">10.9.2. Environment</a></div>
<div class="foo toclevel4"><a href="#_blocking_and_concurrency">10.9.3. Blocking and concurrency</a></div>
<div class="foo toclevel4"><a href="#_error_handling">10.9.4. Error handling</a></div>
<div class="foo toclevel4"><a href="#_compatibility">10.9.5. Compatibility</a></div>
<div class="foo toclevel4"><a href="#_available_hooks">10.9.6. Available hooks</a></div>
<div class="foo toclevel3"><a href="#flying_passenger">10.10. Flying Passenger</a></div>
<div class="foo toclevel4"><a href="#_requirements_2">10.10.1. Requirements</a></div>
<div class="foo toclevel4"><a href="#_basic_usage">10.10.2. Basic usage</a></div>
<div class="foo toclevel4"><a href="#configuring_flying_passenger">10.10.3. Configuring Flying Passenger</a></div>
<div class="foo toclevel4"><a href="#_managing_the_flying_passenger_daemon">10.10.4. Managing the Flying Passenger daemon</a></div>
<div class="foo toclevel4"><a href="#using_flying_passenger_with_mri_18_or_jruby">10.10.5. Using Flying Passenger with MRI 1.8 or JRuby</a></div>
<div class="foo toclevel4"><a href="#flying_passenger_caveats">10.10.6. Caveats and limitations</a></div>
<div class="foo toclevel2"><a href="#_under_the_hood">11. Under the hood</a></div>
<div class="foo toclevel3"><a href="#_page_caching_support">11.1. Page caching support</a></div>
<div class="foo toclevel3"><a href="#relationship_with_ruby">11.2. Phusion Passenger and its relationship with Ruby</a></div>
<div class="foo toclevel4"><a href="#_how_ruby_is_used">11.2.1. How Ruby is used</a></div>
<div class="foo toclevel4"><a href="#_when_the_system_has_multiple_ruby_interpreters">11.2.2. When the system has multiple Ruby interpreters</a></div>
<div class="foo toclevel3"><a href="#application_detection">11.3. How Phusion Passenger detects whether a virtual host is a web application</a></div>
<div class="foo toclevel2"><a href="#_appendix_a_about_this_document">12. Appendix A: About this document</a></div>
<div class="foo toclevel2"><a href="#_appendix_b_terminology">13. Appendix B: Terminology</a></div>
<div class="foo toclevel3"><a href="#application_root">13.1. Application root</a></div>
<div class="foo toclevel3"><a href="#idle_process">13.2. Idle process</a></div>
<div class="foo toclevel3"><a href="#inactive_process">13.3. Inactive process</a></div>
<div class="foo toclevel2"><a href="#spawning_methods_explained">14. Appendix C: Spawning methods explained</a></div>
<div class="foo toclevel3"><a href="#_the_most_straightforward_and_traditional_way_direct_spawning">14.1. The most straightforward and traditional way: direct spawning</a></div>
<div class="foo toclevel3"><a href="#_the_smart_spawning_method">14.2. The smart spawning method</a></div>
<div class="foo toclevel4"><a href="#_how_it_works">14.2.1. How it works</a></div>
<div class="foo toclevel4"><a href="#_summary_of_benefits">14.2.2. Summary of benefits</a></div>
<div class="foo toclevel3"><a href="#_smart_spawning_caveat_1_unintentional_file_descriptor_sharing">14.3. Smart spawning caveat #1: unintentional file descriptor sharing</a></div>
<div class="foo toclevel4"><a href="#_example_1_memcached_connection_sharing_harmful">14.3.1. Example 1: Memcached connection sharing (harmful)</a></div>
<div class="foo toclevel4"><a href="#_example_2_log_file_sharing_not_harmful">14.3.2. Example 2: Log file sharing (not harmful)</a></div>
<div class="foo toclevel3"><a href="#_smart_spawning_caveat_2_the_need_to_revive_threads">14.4. Smart spawning caveat #2: the need to revive threads</a></div>
<div class="foo toclevel2"><a href="#about_environment_variables">15. Appendix D: About environment variables</a></div>
<div class="foo toclevel3"><a href="#_working_with_environment_variables">15.1. Working with environment variables</a></div>
<div class="foo toclevel3"><a href="#the_path_env_var">15.2. The PATH environment variable</a></div>
<div class="foo toclevel4"><a href="#_adding_phusion_passenger_8217_s_administration_tools_to_path">15.2.1. Adding Phusion Passenger’s administration tools to PATH</a></div>
<div class="foo toclevel3"><a href="#_making_environment_variables_permanent">15.3. Making environment variables permanent</a></div>
<div class="foo toclevel4"><a href="#_bash">15.3.1. bash</a></div>
<div class="foo toclevel4"><a href="#_apache">15.3.2. Apache</a></div>
<div class="foo toclevel4"><a href="#_nginx">15.3.3. Nginx</a></div>
<div class="foo toclevel4"><a href="#_cron">15.3.4. cron</a></div>
<div class="foo toclevel4"><a href="#env_vars_passenger_apps">15.3.5. Phusion Passenger-served apps</a></div>
<div class="foo toclevel3"><a href="#env_vars_and_sudo">15.4. Environment variables and sudo</a></div>
</div>
</div>
<div id="content">

<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_support_information"></span><h2 data-comment-topic="support-information-nl5gdn" data-anchor="_support_information">1. Support information</h2>
<div class="sectionbody">
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_supported_operating_systems_and_languages"></span><h3 data-comment-topic="supported-operating-systems-a5n2x4" data-anchor="_supported_operating_systems_and_languages">1.1. Supported operating systems and languages</h3>
<div class="paragraph"><p>Phusion Passenger works on almost any POSIX-compliant operating system. In other
words: practically any operating system on earth, except Microsoft Windows.</p></div>
<div class="paragraph"><p>Supported operating systems:</p></div>
<table class="tableblock frame-all grid-all" style="
width:100%;
">
<col style="width:50%;">
<col style="width:50%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top"> OS                  </th>
<th class="tableblock halign-left valign-top"> Minimum version</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ubuntu</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10.04</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Debian</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Red Hat, CentOS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Amazon Linux</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All versions supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mac OS X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10.8 Mountain Lion</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FreeBSD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OpenBSD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Other Unix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>"Other Unix" is supported on a "best-effort" basis. We do not regularly check whether Phusion Passenger still works on other Unices, but if users report issues then we’ll try to address them.</p></div>
<div class="paragraph"><p>Supported architectures:</p></div>
<table class="tableblock frame-all grid-all" style="
width:100%;
">
<col style="width:50%;">
<col style="width:50%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top"> Architecture      </th>
<th class="tableblock halign-left valign-top"> Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x86 (32-bit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x86_64 (64-bit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Other</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported on a "best-effort" basis.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Supported languages and frameworks:</p></div>
<table class="tableblock frame-all grid-all" style="
width:100%;
">
<col style="width:50%;">
<col style="width:50%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top"> Language/framework  </th>
<th class="tableblock halign-left valign-top"> Minimum version</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ruby (MRI)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.8.5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JRuby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.7.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rubinius</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.2.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ruby on Rails</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Python</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Node.js</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Meteor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.6</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>If you run into any issues, please
<a href="https://github.com/phusion/passenger/issues">report a bug</a>
or
<a href="http://groups.google.com/group/phusion-passenger">join our discussion forum</a>.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="where_to_get_support"></span><h3 data-comment-topic="where-to-get-support-2s9na5" data-anchor="where_to_get_support">1.2. Where to get support</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="http://groups.google.com/group/phusion-passenger">Community discussion forum</a> - post a
  message here if you’re experiencing problems. Support on this forum is provided by the community on a best-effort basis, so a (timely) response is not guaranteed.
</p>
</li>
<li>
<p>
<a href="https://github.com/phusion/passenger/issues">Issue tracker</a> - report
  bugs here.
</p>
</li>
<li>
<p>
Email <a href="mailto:support@phusion.nl">support@phusion.nl</a> if you are a <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a> customer. Please mention your order reference. If you are not an Enterprise customer, we kindly redirect you to the community discussion forum instead.
</p>
</li>
<li>
<p>
<a href="https://www.phusionpassenger.com/commercial_support">Commercial support contracts</a> are also available.
</p>
</li>
<li>
<p>
Report security vulnerabilities to <a href="mailto:security@phusion.nl">security@phusion.nl</a>. We will do our best to respond to you as quickly as we can, so please do not disclose the vulnerability until then.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Please consult <a href="https://www.phusionpassenger.com/support">the Phusion Passenger website</a> for a full list of support resources.</p></div>
</div>
</div>
</div>
<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="installation"></span><h2 data-comment-topic="installing-phusion-passenger-hn03ac" data-anchor="installation">2. Installation</h2>
<div class="sectionbody">
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_synopsis"></span><h3 data-comment-topic="synopsis-1uu3sqp" data-anchor="_synopsis">2.1. Synopsis</h3>
<div class="paragraph"><p>Because Phusion Passenger is designed to run in a wide variety of operating systems and configurations, there are multiple ways to install it. Most users  — especially first-time users — will prefer <em>OS-specific installation instructions</em>. These are not only the easiest, but also allow Phusion Passenger to integrate into the operating system in the best way possible. Other users should consult the <em>generic installation instructions</em>.</p></div>
<div class="paragraph"><p>The steps for upgrading or downgrading Phusion Passenger is almost the same as the steps for installing. All the installation guides in this section will also teach you how to upgrade and downgrade.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="install_osx_homebrew"></span><h3 data-comment-topic="installing-or-upgrading-on-mac-os-x-with-homebrew-13ovvy9" data-anchor="install_osx_homebrew">2.2. Installing or upgrading on Mac OS X with Homebrew</h3>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>Open source</strong>
</dt>
<dd>
<p>
        Every time we release a new Phusion Passenger version, we make it available through <a href="http://brew.sh/">Homebrew</a>. Please note that the Homebrew maintainers have to merge our pull requests manually, so it may take a day or two before a new version shows up in the official Homebrew repository.
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Update the Homebrew recipes:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>brew update</pre>
</div>
</div>
</li>
<li>
<p>
Run one of the following, and follow the instructions:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>brew install passenger nginx --with-passenger
-OR-
brew upgrade passenger nginx --with-passenger</pre>
</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">
<div class="title">Upgrade note</div>
<div class="paragraph"><p>If Phusion Passenger has been updated, but no new Nginx version has been released, then you must also reinstall Nginx against the latest version of Phusion Passenger:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>brew reinstall nginx --with-passenger</pre>
</div>
</div>
</td>
</tr></table>
</div>
</li>
</ol></div>
</dd>
<dt class="hdlist1">
<strong>Enterprise</strong>
</dt>
<dd>
<p>
        <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a> is currently not available through Homebrew. Please try one of the other installation methods instead.
</p>
</dd>
</dl></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="install_on_debian_ubuntu"></span><h3 data-comment-topic="installing-or-upgrading-on-ubuntu-fw5fvp" data-anchor="install_on_debian_ubuntu">2.3. Installing or upgrading on Debian or Ubuntu</h3>
<div class="paragraph"><p>We provide an official Phusion Passenger APT repository. This APT repository contains Phusion Passenger packages for multiple versions of Debian and Ubuntu. These packages are automatically built by our build server after we push out a source release, and thus are always up to date with the official source releases.</p></div>
<div class="paragraph"><p>If you use these packages to install Phusion Passenger then you do not need to run <span class="monospaced">passenger-install-apache2-module</span> or <span class="monospaced">passenger-install-nginx-module</span>. These packages contain all the binaries that you need.</p></div>
<div class="paragraph"><p>Packages are available for the x86 and x86_64 architectures. Our policy is to support all Ubuntu LTS releases that are still supported by Canonical, plus the latest Ubuntu release, plus all Debian releases that are still supported by Debian.</p></div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="install_add_apt_repo"></span><h4 data-comment-topic="adding-our-apt-repository-p60cki" data-anchor="install_add_apt_repo">2.3.1. Adding our APT repository</h4>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Install our PGP key. Packages are signed by "Phusion Automated Software Signing (<a href="mailto:auto-software-signing@phusion.nl">auto-software-signing@phusion.nl</a>)", fingerprint 1637 8A33 A6EF 1676 2922 526E 561F 9B9C AC40 B2F7.
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 561F9B9CAC40B2F7</pre>
</div>
</div>
</li>
<li>
<p>
Add HTTPS support for APT. Our APT repository is stored on an HTTPS server.
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo apt-get install apt-transport-https ca-certificates</pre>
</div>
</div>
</li>
<li>
<p>
Create a file <span class="monospaced">/etc/apt/sources.list.d/passenger.list</span> and insert <strong>one of</strong> the following lines, depending on your distribution.
</p>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>Open source</strong>
</dt>
<dd>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">##### !!!! Only add ONE of these lines, not all of them !!!! #####</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Ubuntu 15.04</span></span>
deb https<span style="color: #990000">:</span>//oss-binaries<span style="color: #990000">.</span>phusionpassenger<span style="color: #990000">.</span>com/apt/passenger vivid main
<span style="font-style: italic"><span style="color: #9A1900"># Ubuntu 14.04</span></span>
deb https<span style="color: #990000">:</span>//oss-binaries<span style="color: #990000">.</span>phusionpassenger<span style="color: #990000">.</span>com/apt/passenger trusty main
<span style="font-style: italic"><span style="color: #9A1900"># Ubuntu 12.04</span></span>
deb https<span style="color: #990000">:</span>//oss-binaries<span style="color: #990000">.</span>phusionpassenger<span style="color: #990000">.</span>com/apt/passenger precise main
<span style="font-style: italic"><span style="color: #9A1900"># Debian 8</span></span>
deb https<span style="color: #990000">:</span>//oss-binaries<span style="color: #990000">.</span>phusionpassenger<span style="color: #990000">.</span>com/apt/passenger jessie main
<span style="font-style: italic"><span style="color: #9A1900"># Debian 7</span></span>
deb https<span style="color: #990000">:</span>//oss-binaries<span style="color: #990000">.</span>phusionpassenger<span style="color: #990000">.</span>com/apt/passenger wheezy main
<span style="font-style: italic"><span style="color: #9A1900"># Debian 6</span></span>
deb https<span style="color: #990000">:</span>//oss-binaries<span style="color: #990000">.</span>phusionpassenger<span style="color: #990000">.</span>com/apt/passenger squeeze main</tt></pre>
</div>
</div>
</dd>
<dt class="hdlist1">
<strong>Enterprise</strong>
</dt>
<dd>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">##### !!!! Only add ONE of these lines, not all of them !!!! #####</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Ubuntu 15.04</span></span>
deb https<span style="color: #990000">:</span>//download<span style="color: #990000">:</span>YOUR_DOWNLOAD_TOKEN@www<span style="color: #990000">.</span>phusionpassenger<span style="color: #990000">.</span>com/enterprise_apt vivid main
<span style="font-style: italic"><span style="color: #9A1900"># Ubuntu 14.04</span></span>
deb https<span style="color: #990000">:</span>//download<span style="color: #990000">:</span>YOUR_DOWNLOAD_TOKEN@www<span style="color: #990000">.</span>phusionpassenger<span style="color: #990000">.</span>com/enterprise_apt trusty main
<span style="font-style: italic"><span style="color: #9A1900"># Ubuntu 12.04</span></span>
deb https<span style="color: #990000">:</span>//download<span style="color: #990000">:</span>YOUR_DOWNLOAD_TOKEN@www<span style="color: #990000">.</span>phusionpassenger<span style="color: #990000">.</span>com/enterprise_apt precise main
<span style="font-style: italic"><span style="color: #9A1900"># Debian 8</span></span>
deb https<span style="color: #990000">:</span>//download<span style="color: #990000">:</span>YOUR_DOWNLOAD_TOKEN@www<span style="color: #990000">.</span>phusionpassenger<span style="color: #990000">.</span>com/enterprise_apt jessie main
<span style="font-style: italic"><span style="color: #9A1900"># Debian 7</span></span>
deb https<span style="color: #990000">:</span>//download<span style="color: #990000">:</span>YOUR_DOWNLOAD_TOKEN@www<span style="color: #990000">.</span>phusionpassenger<span style="color: #990000">.</span>com/enterprise_apt wheezy main
<span style="font-style: italic"><span style="color: #9A1900"># Debian 6</span></span>
deb https<span style="color: #990000">:</span>//download<span style="color: #990000">:</span>YOUR_DOWNLOAD_TOKEN@www<span style="color: #990000">.</span>phusionpassenger<span style="color: #990000">.</span>com/enterprise_apt squeeze main</tt></pre>
</div>
</div>
<div class="paragraph"><p>You can find the correct value for <em>YOUR_DOWNLOAD_TOKEN</em> in the <a href="https://www.phusionpassenger.com/orders">Customer Area</a>.</p></div>
</dd>
</dl></div>
</li>
<li>
<p>
Secure <span class="monospaced">passenger.list</span> and update your APT cache:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo chown root: /etc/apt/sources.list.d/passenger.list
sudo chmod 600 /etc/apt/sources.list.d/passenger.list
sudo apt-get update</pre>
</div>
</div>
</li>
<li>
<p>
(Optional) If using <span class="monospaced">unattended-upgrades</span>, add our APT repository to the list of <span class="monospaced">Allowed-Origins</span> for upgrades, <span class="monospaced">/etc/apt/apt.conf.d/50unattended-upgrades</span>:
</p>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">//</span> Automatically upgrade packages from these <span style="color: #990000">(</span>origin<span style="color: #990000">:</span>archive<span style="color: #990000">)</span> pairs
Unattended-Upgrade<span style="color: #990000">::</span>Allowed-Origins {
  <span style="color: #990000">//</span> To check <span style="color: #FF0000">"Origin:"</span> and <span style="color: #FF0000">"Suite:"</span><span style="color: #990000">,</span> you could use e<span style="color: #990000">.</span>g<span style="color: #990000">.:</span>
  <span style="color: #990000">//</span> grep <span style="color: #FF0000">"Origin</span><span style="color: #CC33CC">\|</span><span style="color: #FF0000">Suite"</span> /var/lib/apt/lists/oss-binaries<span style="color: #990000">.</span>phusionpassenger<span style="color: #990000">.</span>com<span style="color: #990000">*</span>
  <span style="color: #FF0000">"Phusion:stable"</span><span style="color: #990000">;</span>
}<span style="color: #990000">;</span></tt></pre>
</div>
</div>
</li>
</ol></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_installing_packages"></span><h4 data-comment-topic="installing-packages-j9glez" data-anchor="_installing_packages">2.3.2. Installing packages</h4>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">You should install <span class="monospaced">nginx-extras</span> even if you have already installed an Nginx package from the official Debian/Ubuntu repository. This is because the Nginx binary that our packages supply is compiled with the Passenger module.</td>
</tr></table>
</div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>Open source</strong>
</dt>
<dd>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<a href="#install_add_apt_repo">Add our APT repository.</a>
</p>
</li>
<li>
<p>
Install the packages:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo apt-get install nginx-extras passenger</pre>
</div>
</div>
</li>
<li>
<p>
Edit <span class="monospaced">/etc/nginx/nginx.conf</span> and uncomment <span class="monospaced">passenger_root</span> and <span class="monospaced">passenger_ruby</span>.
</p>
<div class="paragraph"><p>Especially <a href="#PassengerRoot">passenger_root</a> is important: Phusion Passenger won’t work without it! If you don’t see a commented version of <span class="monospaced">passenger_root</span> inside nginx.conf, then you need to <a href="#inserting_passenger_root_for_apt">insert it yourself</a>.</p></div>
</li>
<li>
<p>
Restart Nginx:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo service nginx restart</pre>
</div>
</div>
</li>
</ol></div>
</dd>
<dt class="hdlist1">
<strong>Enterprise</strong>
</dt>
<dd>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Download your license key from the <a href="https://www.phusionpassenger.com/orders">Customer Area</a> and save it as <span class="monospaced">/etc/passenger-enterprise-license</span>.
</p>
</li>
<li>
<p>
<a href="#install_add_apt_repo">Add our APT repository.</a>
</p>
</li>
<li>
<p>
Install the packages:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo apt-get install nginx-extras passenger-enterprise</pre>
</div>
</div>
</li>
<li>
<p>
Edit <span class="monospaced">/etc/nginx/nginx.conf</span> and uncomment <span class="monospaced">passenger_root</span> and <span class="monospaced">passenger_ruby</span>.
</p>
<div class="paragraph"><p>Especially <a href="#PassengerRoot">passenger_root</a> is important: Phusion Passenger won’t work without it! If you don’t see a commented version of <span class="monospaced">passenger_root</span> inside nginx.conf, then you need to <a href="#inserting_passenger_root_for_apt">insert it yourself</a>.</p></div>
</li>
<li>
<p>
Restart Nginx:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo service nginx restart</pre>
</div>
</div>
</li>
</ol></div>
</dd>
</dl></div>
<div class="paragraph"><p>You can now proceed with a chapter for Deploying your (specific type of) application.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="inserting_passenger_root_for_apt"></span><h4 data-comment-topic="inserting-passenger-root-into-nginx-conf--1pmj19o" data-anchor="inserting_passenger_root_for_apt">2.3.3. Inserting <span class="monospaced">passenger_root</span> into nginx.conf</h4>
<div class="paragraph"><p>If there is no <a href="#PassengerRoot">passenger_root</a> directive in <span class="monospaced">/etc/nginx/nginx.conf</span>, you can insert it yourself as follows:</p></div>
<div class="paragraph"><p>First, run the following command and take note of its output:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>/usr/bin/passenger-config --root</pre>
</div>
</div>
<div class="paragraph"><p>Next, insert the following snippet into <span class="monospaced">/etc/nginx/nginx.conf</span>, under the <span class="monospaced">http</span> block:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>passenger_root whatever_value_you_got_from_previous_command;</pre>
</div>
</div>
<div class="paragraph"><p>Here is an example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>...
http {
   # path-to-locations.ini is given to you by `passenger-config --root`.
   passenger_root /path-to-locations.ini;
   ...
}</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="installing_or_upgrading_on_red_hat"></span><h3 data-comment-topic="installing-or-upgrading-on-red-hat-fedora-centos-or-scientificlinux-1uus5a1" data-anchor="installing_or_upgrading_on_red_hat">2.4. Installing or upgrading on Red Hat or CentOS</h3>
<div class="paragraph"><p>We provide an official Phusion Passenger YUM repository with packages for Red Hat Enterprise Linux and CentOS. These packages are automatically built by our build server after we push out a source release, and thus are always up to date with the official source releases.</p></div>
<div class="paragraph"><p>If you use these packages to install Phusion Passenger then you do not need to run <span class="monospaced">passenger-install-apache2-module</span> or <span class="monospaced">passenger-install-nginx-module</span>. These packages contain all the binaries that you need. These packages also come with SELinux policy modules so that Passenger works nicely with SELinux.</p></div>
<div class="paragraph"><p>Packages are available for the x86 and x86_64 architectures. Our policy is to support all Red Hat and CentOS releases that still receive full updates by their vendors. The earliest Red Hat and CentOS version we support is version 5.</p></div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="install_add_yum_repo"></span><h4 data-comment-topic="adding-our-yum-repository-2i9z9o" data-anchor="install_add_yum_repo">2.4.1. Adding our YUM repository</h4>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Install <a href="https://fedoraproject.org/wiki/EPEL">EPEL</a> and a few other prerequisites.
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo yum install epel-release pygpgme curl</pre>
</div>
</div>
</li>
<li>
<p>
Download the Passenger YUM repository definition.
</p>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>Open source</strong>
</dt>
<dd>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo curl --fail -sSLo /etc/yum.repos.d/passenger.repo https://oss-binaries.phusionpassenger.com/yum/definitions/el-passenger.repo</pre>
</div>
</div>
</dd>
<dt class="hdlist1">
<strong>Enterprise</strong>
</dt>
<dd>
<div class="listingblock">
<div class="content monospaced">
<pre>unset HISTFILE
sudo curl --fail -sSLo -u download:YOUR_DOWNLOAD_TOKEN /etc/yum.repos.d/passenger.repo https://www.phusionpassenger.com/enterprise_yum/el-passenger-enterprise.repo</pre>
</div>
</div>
<div class="paragraph"><p>The <span class="monospaced">unset HISTFILE</span> command ensures that your download token isn’t saved to the Bash history file.</p></div>
<div class="paragraph"><p>You can find the correct value for <em>YOUR_DOWNLOAD_TOKEN</em> in the <a href="https://www.phusionpassenger.com/orders">Customer Area</a>.</p></div>
</dd>
</dl></div>
</li>
<li>
<p>
Secure <span class="monospaced">passenger.repo</span>:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo chown root: /etc/yum.repos.d/passenger.repo
sudo chmod 600 /etc/yum.repos.d/passenger.repo</pre>
</div>
</div>
</li>
</ol></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_installing_packages_2"></span><h4 data-comment-topic="installing-packages-1actlet" data-anchor="_installing_packages_2">2.4.2. Installing packages</h4>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">
<div class="title">Notes about SELinux on Red Hat 6 and CentOS 6</div>
<div class="paragraph"><p>If you are on Red Hat 6 or CentOS 6, and you are also using SELinux in enforcing mode, then Passenger requires kernel &gt;= 2.6.39.</p></div>
<div class="paragraph"><p>If you want to install Passenger on Red Hat 6 or CentOS 6, without upgrading your kernel, then you must <strong>disable</strong> SELinux completely. Edit <span class="monospaced">/etc/selinux/config</span>, set <span class="monospaced">SELINUX=disabled</span> and reboot. Note that merely setting SELinux to permissive mode is not enough.</p></div>
<div class="paragraph"><p>This issue does not apply to Red Hat &gt;= 7 and CentOS &gt;= 7, because these OS versions supply recent enough kernel versions.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>You can install the Passenger packages as follows.</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>Open source</strong>
</dt>
<dd>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<a href="#install_add_yum_repo">Add our YUM repository.</a>
</p>
</li>
<li>
<p>
Install the packages:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo yum install nginx passenger</pre>
</div>
</div>
</li>
<li>
<p>
Edit <span class="monospaced">/etc/nginx/conf.d/passenger.conf</span> and uncomment <span class="monospaced">passenger_root</span>, <span class="monospaced">passenger_ruby</span> and <span class="monospaced">passenger_instance_registry_dir</span>.
</p>
<div class="paragraph"><p>Especially <a href="#PassengerRoot">passenger_root</a> is important: Phusion Passenger won’t work without it!</p></div>
</li>
<li>
<p>
Restart Nginx:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo service nginx restart</pre>
</div>
</div>
</li>
</ol></div>
</dd>
<dt class="hdlist1">
<strong>Enterprise</strong>
</dt>
<dd>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Download your license key from the <a href="https://www.phusionpassenger.com/orders">Customer Area</a> and save it as <span class="monospaced">/etc/passenger-enterprise-license</span>.
</p>
</li>
<li>
<p>
<a href="#install_add_yum_repo">Add our YUM repository.</a>
</p>
</li>
<li>
<p>
Install the packages:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo yum install nginx passenger-enterprise</pre>
</div>
</div>
</li>
<li>
<p>
Edit <span class="monospaced">/etc/nginx/conf.d/passenger.conf</span> and uncomment <span class="monospaced">passenger_root</span>, <span class="monospaced">passenger_ruby</span> and <span class="monospaced">passenger_instance_registry_dir</span>.
</p>
<div class="paragraph"><p>Especially <a href="#PassengerRoot">passenger_root</a> is important: Phusion Passenger won’t work without it!</p></div>
</li>
<li>
<p>
Restart Nginx:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo service nginx restart</pre>
</div>
</div>
</li>
</ol></div>
</dd>
</dl></div>
<div class="paragraph"><p>You can now proceed with a chapter for Deploying your (specific type of) application.</p></div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_installing_or_upgrading_on_heroku"></span><h3 data-comment-topic="installing-or-upgrading-on-heroku-jh07kr" data-anchor="_installing_or_upgrading_on_heroku">2.5. Installing or upgrading on Heroku</h3>
<div class="paragraph"><p>Please refer to our <a href="https://github.com/phusion/passenger-ruby-heroku-demo#readme">Heroku Ruby demo</a> for installation and upgrade instructions for Heroku.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="rubygems_generic_install"></span><h3 data-comment-topic="generic-installation-upgrade-and-downgrade-method-via-rubygems-76uol7" data-anchor="rubygems_generic_install">2.6. Generic installation, upgrade and downgrade method: via RubyGems</h3>
<div class="paragraph"><p>RubyGems is only used as a method to obtain the Phusion Passenger files, so in case you have multiple Ruby versions it does not matter which Ruby’s RubyGems you use for installation. Once installed, Phusion Passenger can work with all other Ruby versions on your system. This is explained in <a href="#relationship_with_ruby">Phusion Passenger and its relationship with Ruby</a>.</p></div>
<span class="anchor_helper" id="is_ruby_home_or_system_wide_installed"></span><h4 class="float" data-anchor="is_ruby_home_or_system_wide_installed">Step 1: figuring out whether your Ruby is installed in the home directory or system-wide</h4>
<div class="paragraph"><p>Ruby may either be installed in the home directory, or system-wide. If it’s installed system-wide then we will want to install gems system-wide as well, so you need to switch to a root prompt first. If Ruby is installed in the home directory then we will want to install gems to the home directory as well, as a normal user.</p></div>
<div class="paragraph"><p>To find out which case applies, run the following command to find out where the <span class="monospaced">ruby</span> command is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>which ruby</pre>
</div>
</div>
<div class="paragraph"><p>Do you see a filename that references <em>/home</em> or <em>/Users</em>? If so then your Ruby interpreter is installed in your home directory and you can proceed to step 2. Otherwise, you need to switch to a root prompt by running one of the following commands:</p></div>
<div class="ulist"><ul>
<li>
<p>
Are you using RVM? Run <span class="monospaced">rvmsudo -s</span>
</p>
</li>
<li>
<p>
Are you not using RVM, or do you not know what RVM is? Run <span class="monospaced">sudo -s</span>
</p>
</li>
<li>
<p>
Is <em>sudo</em> not installed on your system? Run <span class="monospaced">su -c bash</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>You must maintain this root prompt throughout this installation guide.</p></div>
<span class="anchor_helper" id="_step_2_install_the_gem"></span><h4 class="float" data-anchor="_step_2_install_the_gem">Step 2: install the gem</h4>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>Open Source</strong>
</dt>
<dd>
<p>
        Install the latest gem to obtain the files for the latest stable version of the open source Phusion Passenger:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>gem install passenger</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Previous versions and beta versions</div>
<div class="paragraph"><p>Sometimes you will want to obtain the latest beta version of Phusion Passenger. Beta versions are not normally selected by <span class="monospaced">gem install</span>, so to opt-in for beta versions you have to add the <span class="monospaced">--pre</span> argument:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gem install passenger --pre</pre>
</div>
</div>
<div class="paragraph"><p>If you want to obtain a specific version of Phusion Passenger, e.g. because you are downgrading, then specify the version number with <span class="monospaced">--version</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gem install passenger --version 3.0.0</pre>
</div>
</div>
<div class="paragraph"><p>If you want to obtain a specific <strong>beta</strong> version of Phusion Passenger then you must also pass <span class="monospaced">--pre</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gem install passenger --version 3.9.1.beta --pre</pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">
<strong>Enterprise</strong>
</dt>
<dd>
<p>
First, download the <strong>license key</strong> from the <a href="https://www.phusionpassenger.com/orders">Customer Area</a> and save it as <span class="monospaced">/etc/passenger-enterprise-license</span>.
</p>
<div class="paragraph"><p>Next, add the Phusion Passenger Enterprise gem server to your RubyGems source list:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gem source --add https://download:YOUR_DOWNLOAD_TOKEN@www.phusionpassenger.com/enterprise_gems/</pre>
</div>
</div>
<div class="paragraph"><p>Substitute <em>YOUR_DOWNLOAD_TOKEN</em> with the one you find in the <a href="https://www.phusionpassenger.com/orders">Customer Area</a>. And notice the <strong>trailing slash</strong> in the URL! It is very important.</p></div>
<div class="paragraph"><p>Finally, install the latest gem to obtain the files for the latest stable version of the open source Phusion Passenger:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gem install passenger-enterprise-server</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Previous versions and beta versions</div>
<div class="paragraph"><p>Sometimes you will want to obtain the latest beta version of Phusion Passenger Enterprise. Beta versions are not normally selected by <span class="monospaced">gem install</span>, so to opt-in for beta versions you have to add the <span class="monospaced">--pre</span> argument:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gem install passenger-enterprise-server --pre</pre>
</div>
</div>
<div class="paragraph"><p>If you want to obtain a specific version of Phusion Passenger Enterprise, e.g. because you are downgrading, then specify the version number with <span class="monospaced">--version</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gem install passenger-enterprise-server --version 3.0.0</pre>
</div>
</div>
<div class="paragraph"><p>If you want to obtain a specific <strong>beta</strong> version of Phusion Passenger then you must also pass <span class="monospaced">--pre</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gem install passenger-enterprise-server --version 3.9.1.beta --pre</pre>
</div>
</div>
</div>
</div>
</dd>
</dl></div>
<span class="anchor_helper" id="run_passenger_installer"></span><h4 class="float" data-anchor="run_passenger_installer">Step 3: run the Phusion Passenger installer</h4>
<div class="paragraph"><p>Nginx is a different from other web servers in that it does not support loadable modules. The only way to extend Nginx is to recompile it entirely from source. Since Phusion Passenger consists of some external executables plus an Nginx module, you must recompile Nginx when first installing Phusion Passenger, but also when upgrading Nginx itself or when upgrading the Phusion Passenger version.</p></div>
<div class="paragraph"><p>Recompiling Nginx and the Phusion Passenger executables is what we will do in this step. The good news is that Phusion Passenger provides a tool to make this easy for you.</p></div>
<div class="paragraph"><p>If you’ve already installed Nginx before, but without Phusion Passenger support, then you <strong>should</strong> uninstall it first. You don’t have to, because you can also install another Nginx with Phusion Passenger support, in parallel to the existing Nginx. We merely recommend uninstalling the existing in order to avoid user confusion, but the choice is yours.</p></div>
<div class="paragraph"><p>If you had previously installed Nginx with Phusion Passenger support, and you are upgrading, then you don’t have to uninstall your existing Nginx first. Instead we’ll overwrite it this step. But it is important that you recompile Nginx with the configure parameters that you used last time.</p></div>
<div class="paragraph"><p>Here’s how you can uninstall the original Nginx:</p></div>
<div class="ulist"><ul>
<li>
<p>
If you installed the existing Nginx through APT, run: <span class="monospaced">sudo apt-get remove nginx nginx-full nginx-light nginx-naxsi nginx-common</span>
</p>
</li>
<li>
<p>
If you installed the existing Nginx through YUM, run <span class="monospaced">yum remove nginx</span> as root.
</p>
</li>
</ul></div>
<div class="paragraph"><p>To proceed with installing or upgrading Phusion Passenger, run the Phusion Passenger Nginx installer and follow the on-screen instructions:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>passenger-install-nginx-module</pre>
</div>
</div>
<div class="paragraph"><p>At some point it will ask you which prefix to install Nginx to. If you’re upgrading, then specify the same prefix that you used last time, as well as the same configuration parameters that you used last time.</p></div>
<span class="anchor_helper" id="_step_4_restarting_the_flying_passenger_daemon"></span><h4 class="float" data-anchor="_step_4_restarting_the_flying_passenger_daemon">Step 4: restarting the Flying Passenger daemon</h4>
<div class="paragraph"><p>If you are using <a href="#flying_passenger">Flying Passenger</a> then you must restart the Flying Passenger daemon by sending it the SIGTERM signal:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>kill `cat /path-to/flying-passenger.pid`</pre>
</div>
</div>
<div class="paragraph"><p>Or, if Flying Passenger is not running with a PID file, look up its PID us <span class="monospaced">ps</span> and then send it SIGTERM:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>ps aux | grep flying-passenger
kill PID_OF_FLYING_PASSENGER</pre>
</div>
</div>
<span class="anchor_helper" id="verify_passenger_running"></span><h4 class="float" data-anchor="verify_passenger_running">Step 5: verifying that Phusion Passenger is running</h4>
<div class="paragraph"><p>Restart your web server and run:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>passenger-memory-stats</pre>
</div>
</div>
<div class="paragraph"><p>You should see the web server processes as well as a number of Phusion Passenger processes (e.g. PassengerWatchdog, PassengerHelperAgent). Congratulations, Phusion Passenger is now installed and running!
At this point you may be interested in <a href="#nginx_init_script">creating an Nginx init script</a>.</p></div>
<div class="paragraph"><p>If the output is not as expected, then please refer to the <a href="#troubleshooting">Troubleshooting</a> section.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="tarball_generic_install"></span><h3 data-comment-topic="generic-installation-upgrade-and-downgrade-method-via-tarball-2gkx43" data-anchor="tarball_generic_install">2.7. Generic installation, upgrade and downgrade method: via tarball</h3>
<span class="anchor_helper" id="_step_1_installing_ruby"></span><h4 class="float" data-anchor="_step_1_installing_ruby">Step 1: installing Ruby</h4>
<div class="paragraph"><p>Phusion Passenger supports multiple languages and its core is written in C++, but its installer and administration tools are written in Ruby, so you must install Ruby.</p></div>
<div class="paragraph"><p>Even though Ruby is required, Ruby will normally not be loaded during normal operation unless you deploy a Ruby web application on Phusion Passenger. Phusion Passenger’s dependency on Ruby is very minimal. See <a href="#relationship_with_ruby">Phusion Passenger and its relationship with Ruby</a> for details.</p></div>
<table class="tableblock frame-all grid-all" style="
width:100%;
">
<col style="width:50%;">
<col style="width:50%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Debian, Ubuntu</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="monospaced">sudo apt-get update</span><br>
<span class="monospaced">sudo apt-get install ruby rake</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Red Hat, CentOS, ScientificLinux, Amazon Linux</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable <a href="http://fedoraproject.org/wiki/EPEL">EPEL</a>, then run as root:<br>
<span class="monospaced">yum install ruby rubygem-rake</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mac OS X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No action needed. Ruby is installed by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Other operating systems</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Install Ruby from <a href="http://www.ruby-lang.org/">the Ruby website</a>.</p></td>
</tr>
</tbody>
</table>
<span class="anchor_helper" id="_step_2_download_and_extract_the_tarball"></span><h4 class="float" data-anchor="_step_2_download_and_extract_the_tarball">Step 2: download and extract the tarball</h4>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>Open Source</strong>
</dt>
<dd>
<p>
        Download the open source Phusion Passenger tarball from <a href="https://www.phusionpassenger.com/download#open_source">the Phusion Passenger website</a>.
</p>
<div class="paragraph"><p>Older versions can be found in <a href="https://www.phusionpassenger.com/file_releases">the release archive</a>.</p></div>
</dd>
<dt class="hdlist1">
<strong>Enterprise</strong>
</dt>
<dd>
<p>
        <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a> customers can download the Phusion Passenger Enterprise tarball from the <a href="https://www.phusionpassenger.com/orders">Customer Area</a>.
</p>
<div class="paragraph"><p>Also be sure to download the <strong>license key</strong> and save it as <span class="monospaced">/etc/passenger-enterprise-license</span>.</p></div>
</dd>
</dl></div>
<div class="paragraph"><p>Once you have downloaded the tarball, pick a location to extract it to. You can pick any location. A good location is <em>/opt/passenger</em>. Create this directory and extract the tarball as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>mkdir /opt/passenger
cd /opt/passenger
tar xzvf /location-to/passenger-x.x.x.tar.gz
cd /opt/passenger/passenger-x.x.x</pre>
</div>
</div>
<div class="paragraph"><p>Note that <span class="monospaced">passenger-x.x.x</span> should be <span class="monospaced">passenger-enterprise-server-x.x.x</span> if you’re using Phusion Passenger Enterprise.</p></div>
<span class="anchor_helper" id="_step_3_run_the_phusion_passenger_installer"></span><h4 class="float" data-anchor="_step_3_run_the_phusion_passenger_installer">Step 3: run the Phusion Passenger installer</h4>
<div class="paragraph"><p>Nginx is a different from other web servers in that it does not support loadable modules. The only way to extend Nginx is to recompile it entirely from source. Since Phusion Passenger consists of some external executables plus an Nginx module, you must recompile Nginx when first installing Phusion Passenger, but also when upgrading Nginx itself or when upgrading the Phusion Passenger version.</p></div>
<div class="paragraph"><p>Recompiling Nginx and the Phusion Passenger executables is what we will do in this step. The good news is that Phusion Passenger provides a tool to make this easy for you.</p></div>
<div class="paragraph"><p>If you’ve already installed Nginx before, but without Phusion Passenger support, then you <strong>should</strong> uninstall it first. You don’t have to, because you can also install another Nginx with Phusion Passenger support, in parallel to the existing Nginx. We merely recommend uninstalling the existing in order to avoid user confusion, but the choice is yours.</p></div>
<div class="paragraph"><p>If you had previously installed Nginx with Phusion Passenger support, and you are upgrading, then you don’t have to uninstall your existing Nginx first. Instead we’ll overwrite it this step. But it is important that you recompile Nginx with the configure parameters that you used last time.</p></div>
<div class="paragraph"><p>Here’s how you can uninstall the original Nginx:</p></div>
<div class="ulist"><ul>
<li>
<p>
If you installed the existing Nginx through APT, run: <span class="monospaced">sudo apt-get remove nginx nginx-full nginx-light nginx-naxsi nginx-common</span>
</p>
</li>
<li>
<p>
If you installed the existing Nginx through YUM, run <span class="monospaced">yum remove nginx</span> as root.
</p>
</li>
</ul></div>
<div class="paragraph"><p>To proceed with installing or upgrading Phusion Passenger, run the Phusion Passenger Nginx installer and follow the on-screen instructions:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>./bin/passenger-install-nginx-module</pre>
</div>
</div>
<div class="paragraph"><p>At some point it will ask you which prefix to install Nginx to. If you’re upgrading, then specify the same prefix that you used last time, as well as the same configuration parameters that you used last time.</p></div>
<span class="anchor_helper" id="_step_4_restarting_the_flying_passenger_daemon_2"></span><h4 class="float" data-anchor="_step_4_restarting_the_flying_passenger_daemon_2">Step 4: restarting the Flying Passenger daemon</h4>
<div class="paragraph"><p>If you are using <a href="#flying_passenger">Flying Passenger</a> then you must restart the Flying Passenger daemon by sending it the SIGTERM signal:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>kill `cat /path-to/flying-passenger.pid`</pre>
</div>
</div>
<div class="paragraph"><p>Or, if Flying Passenger is not running with a PID file, look up its PID us <span class="monospaced">ps</span> and then send it SIGTERM:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>ps aux | grep flying-passenger
kill PID_OF_FLYING_PASSENGER</pre>
</div>
</div>
<span class="anchor_helper" id="_step_5_verifying_that_phusion_passenger_is_running"></span><h4 class="float" data-anchor="_step_5_verifying_that_phusion_passenger_is_running">Step 5: verifying that Phusion Passenger is running</h4>
<div class="paragraph"><p>Restart your web server and run:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>./bin/passenger-memory-stats</pre>
</div>
</div>
<div class="paragraph"><p>You should see the web server processes as well as a number of Phusion Passenger processes (e.g. PassengerWatchdog, PassengerHelperAgent). Congratulations, Phusion Passenger is now installed and running!
At this point you may be interested in <a href="#nginx_init_script">creating an Nginx init script</a>.</p></div>
<div class="paragraph"><p>If the output is not as expected, then please refer to the <a href="#troubleshooting">Troubleshooting</a> section.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_upgrading_from_open_source_to_enterprise"></span><h3 data-comment-topic="upgrading-from-open-source-to-enterprise-1a58c2b" data-anchor="_upgrading_from_open_source_to_enterprise">2.8. Upgrading from open source to Enterprise</h3>
<div class="paragraph"><p>Phusion Passenger comes in two variants: an open source version, as well as an <a href="https://www.phusionpassenger.com/enterprise">Enterprise version</a> which introduces a myriad of useful features that can improve stability and performance and efficiency.</p></div>
<div class="paragraph"><p>Customers who have bought Phusion Passenger Enterprise can upgrade their open source installation to Enterprise as follows:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<a href="#uninstalling">Uninstall the open source Phusion Passenger</a>.
</p>
</li>
<li>
<p>
Install the Enterprise version by following one of the installation guides in this section (e.g. <a href="#rubygems_generic_install">RubyGems generic installation</a> or <a href="#tarball_generic_install">tarball generic installation</a>).
</p>
</li>
</ol></div>
<div class="paragraph"><p>The uninstallation is necessary because the Enterprise Ruby gem has a different gem name (<em>passenger-enterprise-server</em> instead of <em>passenger</em>), but the same administration command names (e.g. <span class="monospaced">passenger-status</span>). Uninstalling the open source version avoids any conflicts.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_cryptographic_verification_of_installation_files"></span><h3 data-comment-topic="cryptographic-verification-of-installation-files-2goray" data-anchor="_cryptographic_verification_of_installation_files">2.9. Cryptographic verification of installation files</h3>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_synopsis_2"></span><h4 data-comment-topic="synopsis-4fv6zw" data-anchor="_synopsis_2">2.9.1. Synopsis</h4>
<div class="paragraph"><p>We digitally sign various files with our GPG key so that you can check whether they’re legit, i.e. whether they really came from Phusion and haven’t been tampered with by a third party. We apply signing since the open source version 4.0.0 RC 4, or the Enterprise version 4.0.0 RC 1.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_importing_the_phusion_software_signing_key"></span><h4 data-comment-topic="importing-the-phusion-software-signing-key-1qfpaj4" data-anchor="_importing_the_phusion_software_signing_key">2.9.2. Importing the Phusion Software Signing key</h4>
<div class="paragraph"><p>Phusion’s GPG key for signing software is as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Phusion Software Signing (software-signing@phusion.nl)
Short key ID: 0x0A212A8C
Long key ID: 0x2AC745A50A212A8C
Fingerprint: D5F0 8514 2693 9232 F437  AB72 2AC7 45A5 0A21 2A8C</pre>
</div>
</div>
<div class="paragraph"><p>This key is stored at <a href="http://www.phusion.nl/about/gpg">the Phusion website</a> and at the key servers <a href="http://pool.sks-keyservers.net/pks/lookup?op=get&amp;search=0x2AC745A50A212A8C">sks-keyservers.net</a> and <a href="http://keyserver.ubuntu.com/pks/lookup?op=get&amp;search=0x2AC745A50A212A8C">keyserver.ubuntu.com</a>. You can import it to your keyring with one of these command:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gpg --keyserver pool.sks-keyservers.net --search-keys 0x2AC745A50A212A8C
# -OR-
gpg --keyserver keyserver.ubuntu.com --search-keys 0x2AC745A50A212A8C</pre>
</div>
</div>
<div class="paragraph"><p>The Phusion Software Signing key is only used for signing software. It’s never used for signing emails or for encrypting files, so please be suspicious if you encounter usage of this key outside the context of signing software, and alert us at <a href="mailto:support@phusion.nl">support@phusion.nl</a>. Include "notspam" in the message to bypass our spam filter.</p></div>
<div class="paragraph"><p>The email address <a href="mailto:software-signing@phusion.nl">software-signing@phusion.nl</a> redirects to <a href="mailto:info@phusion.nl">info@phusion.nl</a> so it’s safe to send email there.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_verifying_the_phusion_software_signing_key"></span><h4 data-comment-topic="verifying-the-phusion-software-signing-key-i7f1vj" data-anchor="_verifying_the_phusion_software_signing_key">2.9.3. Verifying the Phusion Software Signing key</h4>
<div class="paragraph"><p>The Phusion Software Signing key is also <strong>signed by the Phusion founders</strong>. Their keys are as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Hongli Lai (hongli@phusion.nl)
Short key ID: 8C59158F
Long key ID: CD70085E8C59158F
Fingerprint: 218A 7255 83D0 2ECE F3A9 C2A7 CD70 085E 8C59 158F</pre>
</div>
</div>
<div class="literalblock">
<div class="content monospaced">
<pre>Ninh Bui (ninh@phusion.nl)
Short key ID: 69481265
Long key ID: AE405F7869481265
Fingerprint: A77C 9CEF 766D 0E7D A95B 8778 AE40 5F78 6948 1265</pre>
</div>
</div>
<div class="paragraph"><p>Both keys are stored at both sks-servers.net and keyserver.ubuntu.com. Import them with:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gpg --keyserver pool.sks-servers.net --search-keys 0xCD70085E8C59158F
gpg --keyserver pool.sks-servers.net --search-keys 0xAE405F7869481265
# -OR-
gpg --keyserver keyserver.ubuntu.com --search-keys 0xCD70085E8C59158F
gpg --keyserver keyserver.ubuntu.com --search-keys 0xAE405F7869481265</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_verifying_the_gem_and_tarball"></span><h4 data-comment-topic="verifying-the-gem-and-tarball-dr9466" data-anchor="_verifying_the_gem_and_tarball">2.9.4. Verifying the gem and tarball</h4>
<div class="paragraph"><p>You can find the open source version’s gem and tarball GPG signatures at <a href="https://www.phusionpassenger.com/file_releases">https://www.phusionpassenger.com/file_releases</a>. The Enterprise version’s GPG signatures can be found in the <a href="https://www.phusionpassenger.com/orders">Customer Area</a>. All signatures have the <em>.asc</em> extension. Once you have imported our key, you can verify the validity of a file against its signature as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ gpg --verify passenger-x.x.x.tar.gz.asc passenger-x.x.x.tar.gz
gpg: Signature made Mon Mar 11 09:45:46 2013 CET using RSA key ID 0A212A8C
gpg: Good signature from "Phusion Software Signing &lt;software-signing@phusion.nl&gt;"</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_verifying_git_signatures"></span><h4 data-comment-topic="verifying-git-signatures-dyo4fk" data-anchor="_verifying_git_signatures">2.9.5. Verifying Git signatures</h4>
<div class="paragraph"><p>Tags in the <a href="https://github.com/phusion/passenger">Git repository for the open source version</a> are also tagged. You can verify a Git tag as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ git tag --verify release-x.x.x
object d886f34b5705e4314feccaf0d77b9a38416e15e0
type commit
tag release-4.0.0.rc5
tagger Hongli Lai (Phusion) &lt;hongli@phusion.nl&gt; 1362993117 +0100

This is a tag message.
gpg: Signature made Mon Mar 11 10:12:02 2013 CET using RSA key ID 0A212A8C
gpg: Good signature from "Phusion Software Signing &lt;software-signing@phusion.nl&gt;"</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_verifying_deb_and_rpm_packages"></span><h4 data-comment-topic="verifying-deb-and-rpm-packages-1ed36d5" data-anchor="_verifying_deb_and_rpm_packages">2.9.6. Verifying DEB and RPM packages</h4>
<div class="paragraph"><p>The DEB and RPM packages are signed with the signatures of the respective packagers. They are automatically checked upon installation.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_revocation"></span><h4 data-comment-topic="revocation-xwvhea" data-anchor="_revocation">2.9.7. Revocation</h4>
<div class="paragraph"><p>In the event our key is compromised, we will revoke the key and upload the revocation information to sks-servers.net and keyserver.ubuntu.com. However your system will not know about the revocation until you update the keys from the keyservers. You should update your keys regularly (e.g. once a week) by invoking:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gpg --refresh-keys --keyserver pool.sks-servers.net
# -OR-
gpg --refresh-keys --keyserver keyserver.ubuntu.com</pre>
</div>
</div>
<div class="paragraph"><p>If you installed Phusion Passenger through our APT repository, then you should update APT’s keyring from time to time as well:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo apt-key adv --refresh-keys --keyserver keyserver.ubuntu.com</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_non_interactive_automatic_headless_installs_or_upgrades"></span><h3 data-comment-topic="non-interactive-automatic-headless-installs-or-upgrades-834ymv" data-anchor="_non_interactive_automatic_headless_installs_or_upgrades">2.10. Non-interactive, automatic, headless installs or upgrades</h3>
<div class="paragraph"><p>By default, the installer (<span class="monospaced">passenger-install-nginx-module</span>) is interactive. If you want to automate installation then you can do so by passing various answers to the installer through command line options. Please run the installer with <span class="monospaced">--help</span> for a list of available command line options.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_customizing_the_compilation_process"></span><h3 data-comment-topic="customizing-the-compilation-process-u4cdcf" data-anchor="_customizing_the_compilation_process">2.11. Customizing the compilation process</h3>
<div class="paragraph"><p>The Phusion Passenger compilation process can be customized with environment variables. You can learn more about environment variables in <a href="#about_environment_variables">About environment variables</a>.</p></div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_setting_the_compiler"></span><h4 data-comment-topic="setting-the-compiler-1l6dpe1" data-anchor="_setting_the_compiler">2.11.1. Setting the compiler</h4>
<div class="paragraph"><p>You can force the Phusion Passenger build system to use a specific C or C++ compiler by setting the <span class="monospaced">CC</span> and <span class="monospaced">CXX</span> environment variables. These may be set to any arbitrary shell commands.</p></div>
<div class="paragraph"><p>For example, contributors who want to hack on Phusion Passenger may want to use Clang for faster compilation and <a href="http://ccache.samba.org/">ccache</a> for faster recompilation, and may want to enable more error-catching compilation flags:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">CC</span><span style="color: #990000">=</span><span style="color: #FF0000">'ccache clang -fcolor-diagnostics -Qunused-arguments -fcatch-undefined-behavior -ftrapv'</span>
<span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">CXX</span><span style="color: #990000">=</span><span style="color: #FF0000">'ccache clang++ -fcolor-diagnostics -Qunused-arguments -fcatch-undefined-behavior -ftrapv'</span></tt></pre>
</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">If you run the installer with <span class="monospaced">sudo</span> then environment variables may not be passed properly. Learn more at <a href="#env_vars_and_sudo">Environment variables and sudo</a>.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_adding_additional_compiler_or_linker_flags"></span><h4 data-comment-topic="adding-additional-compiler-or-linker-flags-1jehjon" data-anchor="_adding_additional_compiler_or_linker_flags">2.11.2. Adding additional compiler or linker flags</h4>
<div class="paragraph"><p>On some systems, C/C++ libraries and headers that Phusion Passenger requires may be located in a non-standard directory. You can force the Phusion Passenger build system to look in those locations by injecting compiler and linker flags using the following environment variables:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">EXTRA_PRE_CFLAGS</span>
</dt>
<dd>
<p>
        These flags are injected into all C compiler invocations that involve compiling C source files. This also covers compiler invocations that compile <strong>and</strong> link. The flags are injected at the beginning of the command string, even before <span class="monospaced">EXTRA_PRE_LDFLAGS</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">EXTRA_CFLAGS</span>
</dt>
<dd>
<p>
        Similar to <span class="monospaced">EXTRA_PRE_CFLAGS</span>, but injected at the end of the command string, before <span class="monospaced">EXTRA_LDFLAGS</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">EXTRA_PRE_CXXFLAGS</span>
</dt>
<dd>
<p>
        Similar to <span class="monospaced">EXTRA_PRE_CFLAGS</span>, but for C++ compiler invocations.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">EXTRA_CXXFLAGS</span>
</dt>
<dd>
<p>
        Similar to <span class="monospaced">EXTRA_CFLAGS</span>, but for C++ compiler invocations.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">EXTRA_PRE_LDFLAGS</span>
</dt>
<dd>
<p>
        These flags are injected into all C/C++ compiler invocations that involve linking. This includes compiler invocations that compile <strong>and</strong> link. The flags are injected at the beginning of the command string, but after <span class="monospaced">EXTRA_PRE_CFLAGS</span>/<span class="monospaced">EXTRA_PRE_CXXFLAGS</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">EXTRA_PRE_C_LDFLAGS</span>
</dt>
<dd>
<p>
        These flags are injected into all C compiler invocations that involve linking, right after <span class="monospaced">EXTRA_PRE_LDFLAGS</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">EXTRA_PRE_CXX_LDFLAGS</span>
</dt>
<dd>
<p>
        Similar to <span class="monospaced">EXTRA_PRE_CXX_LDFLAGS</span>, but for C++ compiler invocations.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">EXTRA_LDFLAGS</span>
</dt>
<dd>
<p>
        Similar to <span class="monospaced">EXTRA_PRE_LDFLAGS</span>, but injected at the very end of the command string, even after <span class="monospaced">EXTRA_CFLAGS</span> and <span class="monospaced">EXTRA_CXXFLAGS</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">EXTRA_C_LDFLAGS</span>
</dt>
<dd>
<p>
        Similar to <span class="monospaced">EXTRA_LDFLAGS</span>, but only injected for C executable linking commands. Injected right after <span class="monospaced">EXTRA_LDFLAGS</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">EXTRA_CXX_LDFLAGS</span>
</dt>
<dd>
<p>
        Similar to <span class="monospaced">EXTRA_LDFLAGS</span>, but only injected for C++ executable linking commands. Injected right after <span class="monospaced">EXTRA_LDFLAGS</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">PASSENGER_THREAD_LOCAL_STORAGE</span>
</dt>
<dd>
<p>
        Setting this to 1 will enable the <span class="monospaced">PASSENGER_THREAD_LOCAL_STORAGE</span> macro, which forcefully disables the use of thread-local storage inside the Phusion Passenger codebase. Setting this environment variable is useful on systems that have broken support for thread-local storage, despite passing our build system’s check for proper thread-local storage support. At the time of writing, one user has reported that Ubuntu 12.04 32-bit has broken thread-local storage report although neither the reporter nor us were able to reproduce the problem on any other systems running Ubuntu 12.04 32-bit. Note that this flag has no effect on non-Phusion Passenger code.
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">If you run the installer with <span class="monospaced">sudo</span> then environment variables may not be passed properly. Learn more at <a href="#env_vars_and_sudo">Environment variables and sudo</a>.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="forcing_location_of_command_line_tools_and_dependencies"></span><h4 data-comment-topic="forcing-location-of-certain-command-line-tools-1j93cki" data-anchor="forcing_location_of_command_line_tools_and_dependencies">2.11.3. Forcing location of command line tools and dependencies</h4>
<div class="paragraph"><p>The Phusion Passenger build system attempts to autodetect many things by locating relevant helper tools. For example, to find out which compiler flags it should use for compiling Apache modules, it locates the <span class="monospaced">apxs2</span> command and queries it. To find out which compiler flags it should use for libcurl, it queries the <span class="monospaced">curl-config</span> command. These commands may not be in <span class="monospaced">$PATH</span>, or even when they are you may want to use a different one.</p></div>
<div class="paragraph"><p>You can force the build to find certain command line tools at certain locations by using the following environment variables:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">HTTPD</span>
</dt>
<dd>
<p>
        The location of the <span class="monospaced">httpd</span> executable (the Apache server executable).
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">APXS2</span>
</dt>
<dd>
<p>
        The location of the <span class="monospaced">apxs2</span> executable (the Apache module developer tool). Only used by <span class="monospaced">passenger-install-apache2-module</span>.
</p>
<div class="paragraph"><p>This environment variable, together with <span class="monospaced">HTTPD</span>, are what you need to customize if you have multiple Apache installations on your system, or if your Apache is located in a non-standard location which Phusion Passenger cannot detect. By setting <span class="monospaced">APXS2</span> and <span class="monospaced">HTTP</span> to the right paths, you can force Phusion Passenger to be compiled against that specific Apache installation.</p></div>
<div class="paragraph"><p>For example, if your Apache installation is located in <span class="monospaced">/opt/lamp/apache2</span>, then you can run the installer as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ sudo bash
# export HTTPD=/opt/lampp/apache2/bin/apache
# export APXS2=/opt/lampp/apache2/bin/apxs
# passenger-install-apache2-module</pre>
</div>
</div>
</dd>
<dt class="hdlist1">
<span class="monospaced">APR_CONFIG</span>
</dt>
<dd>
<p>
        The location of the <span class="monospaced">apr-config</span> executable (the Apache Portable Runtime developer tool).
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">APU_CONFIG</span>
</dt>
<dd>
<p>
        The location of the <span class="monospaced">apu-config</span> executable (the Apache Portable Runtime Utility developer tool).
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">MAKE</span>
</dt>
<dd>
<p>
        The location of a <span class="monospaced">make</span> tool. It does not matter which implementation of <span class="monospaced">make</span> this is.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">GMAKE</span>
</dt>
<dd>
<p>
        The location of the GNU-compatible <span class="monospaced">make</span> tool.
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip">
</td>
<td class="content">If you do not know what environment variables are, or how to use them, then please read <a href="#env_vars_and_sudo">Environment variables and sudo</a>.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">If you run the installer with <span class="monospaced">sudo</span> then environment variables may not be passed properly. Learn more at <a href="#env_vars_and_sudo">Environment variables and sudo</a>.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_installing_as_a_normal_nginx_module_without_using_the_installer"></span><h3 data-comment-topic="installing-as-a-normal-nginx-module-without-using-the-installer-1kkpes5" data-anchor="_installing_as_a_normal_nginx_module_without_using_the_installer">2.12. Installing as a normal Nginx module without using the installer</h3>
<div class="paragraph"><p>You can also install Phusion Passenger the way you install any other Nginx module, e.g. with <span class="monospaced">--add-module</span>. This installation mode is useful if you already have an Nginx tarball somewhere.</p></div>
<div class="paragraph"><p>You need to run Nginx’s configure script with <span class="monospaced">--add-module=/path-to-passenger-nginx-addon-dir</span>. The right value for <span class="monospaced">/path-to-passenger-nginx-addon-dir</span> can be obtained with the command:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>passenger-config --nginx-addon-dir</pre>
</div>
</div>
<div class="paragraph"><p>After having installed Nginx with Phusion Passenger support, you must paste the following
line into your Nginx configuration file:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>passenger_root /path-to-passenger-root;</pre>
</div>
</div>
<div class="paragraph"><p>The right value for <span class="monospaced">/path-to-passenger-root</span> can be obtained by running the following command:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>passenger-config --root</pre>
</div>
</div>
<div class="paragraph"><p>After having modified the Nginx configuration file, restart Nginx.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="nginx_init_script"></span><h3 data-comment-topic="creating-an-nginx-init-script-1kd8zg5" data-anchor="nginx_init_script">2.13. Creating an Nginx init script</h3>
<div class="paragraph"><p>If you installed Nginx with one of the generic installation methods then you won’t have an init script to start, stop and restart Nginx with. A bare Nginx installation works with signals: you start it by invoking it from the command line, you stop it by sending SIGTERM to it and you gracefully restart it by sending SIGHUP to it.</p></div>
<div class="paragraph"><p>If you prefer to use an init script then please refer to the following resources:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://wiki.nginx.org/Nginx-init-ubuntu">Init script for Ubuntu 8.04-9.10</a>
</p>
</li>
<li>
<p>
<a href="http://library.linode.com/web-servers/nginx/installation/ubuntu-12.04-precise-pangolin#sph_create-an-init-script-to-manage-nginx">Init script for Ubuntu 12.04</a>
</p>
</li>
<li>
<p>
<a href="http://wiki.nginx.org/RedHatNginxInitScript">Init script for Red Hat, Fedora and CentOS</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>When using one of those init scripts, please make sure that the paths inside the init script are correct. In particular, the paths to the Nginx binary, to the PID file and to the configuration file must match the actual locations of your Nginx installation.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_disabling_without_uninstalling"></span><h3 data-comment-topic="disabling-without-uninstalling-1t5tqan" data-anchor="_disabling_without_uninstalling">2.14. Disabling without uninstalling</h3>
<div class="paragraph"><p>You can temporarily unload (disable) Phusion Passenger from the web server, without
uninstalling the Phusion Passenger files, so that the web server behaves as if Phusion
Passenger was never installed in the first place. This might be useful to you if -
for example - you seem to be experiencing a problem caused by Phusion Passenger,
but you want to make sure whether that’s actually the case without having
to go through the hassle of uninstalling Phusion Passenger completely. When disabled,
Phusion Passenger will not occupy any memory or CPU or otherwise interfere with
the web server.</p></div>
<div class="paragraph"><p>To unload Phusion Passenger, edit your Nginx configuration file(s)
and comment out all Phusion Passenger configuration directives.</p></div>
<div class="paragraph"><p>For example, if your configuration file looks like this…</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>...

http {
    passenger_root /somewhere/passenger-x.x.x;
    passenger_ruby /usr/bin/ruby;
    passenger_max_pool_size 10;

    gzip on;

    server {
        server_name www.foo.com;
        listen 80;
        root /webapps/foo/public;
        passenger_enabled on;
    }
}</pre>
</div>
</div>
<div class="paragraph"><p>…then comment out the relevant directives, so that it looks like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>...

http {
    # passenger_root /somewhere/passenger-x.x.x;
    # passenger_ruby /usr/bin/ruby;
    # passenger_max_pool_size 10;

    gzip on;

    server {
        server_name www.foo.com;
        listen 80;
        root /webapps/foo/public;
        # passenger_enabled on;
    }
}</pre>
</div>
</div>
<div class="paragraph"><p>After you’ve done this, save the configuration file and restart the web server.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="uninstalling"></span><h3 data-comment-topic="uninstalling-phusion-passenger-wuycvb" data-anchor="uninstalling">2.15. Uninstalling</h3>
<div class="paragraph"><p>To uninstall Phusion Passenger, please first remove all Phusion Passenger
configuration directives from your web server configuration file(s). After you’ve
done this, you need to remove the Phusion Passenger files.</p></div>
<div class="ulist"><ul>
<li>
<p>
If you installed Phusion Passenger through Homebrew, then run <span class="monospaced">brew uninstall passenger</span>.
</p>
</li>
<li>
<p>
If you installed Phusion Passenger via a Ruby gem, then run <span class="monospaced">gem uninstall passenger</span> (or, if you’re a <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a> user, <span class="monospaced">gem uninstall passenger-enterprise-server</span>).
  You <a href="#is_ruby_home_or_system_wide_installed">might have to run this as root</a>.
</p>
</li>
<li>
<p>
If you installed Phusion Passenger via a source tarball, then remove the directory
  in which you placed the extracted Phusion Passenger files. This directory is the
  same as the one pointed to the by <span class="monospaced">PassengerRoot</span>/<span class="monospaced">passenger_root</span> configuration directive.
</p>
</li>
<li>
<p>
If you installed Phusion Passenger through APT or YUM, then use them to uninstall Phusion Passenger.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Nginx does not have to be recompiled after uninstalling Phusion Passenger. Altough Nginx will contain the Phusion Passenger Nginx module, the module will not do anything when all Phusion Passenger configuration directives are removed.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="moving_phusion_passenger"></span><h3 data-comment-topic="moving-to-a-different-directory-gif3wo" data-anchor="moving_phusion_passenger">2.16. Moving to a different directory</h3>
<div class="paragraph"><p>If you installed Phusion Passenger through a tarball then you can move the Phusion Passenger directory to another location. This is not possible if you used any of the other installation methods.</p></div>
<div class="paragraph"><p>First, move the directory to whereever you like:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>mv /opt/passenger/passenger-4.0.0 /usr/local/passenger-4.0.0</pre>
</div>
</div>
<div class="paragraph"><p>Next you must tell Nginx that Phusion Passenger has moved.
Open your Nginx configuration file and set the <em>passenger_root</em> directive to the new location:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>passenger_root /usr/local/passenger-4.0.0;</pre>
</div>
</div>
<div class="paragraph"><p>Restart your web server to finalize the change.</p></div>
<div class="paragraph"><p>If you used <a href="#tarball_generic_install">the tarball installation method</a> and you added Phusion Passenger’s <span class="monospaced">bin</span> subdirectory to <span class="monospaced">PATH</span>, then you must update your PATH with the new location. Open <span class="monospaced">/etc/bashrc</span> (or <span class="monospaced">/etc/bash.bashrc</span> on some systems) and change:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>export PATH=/opt/passenger/passenger-4.0.0/bin:$PATH</pre>
</div>
</div>
<div class="paragraph"><p>to:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>export PATH=/usr/local/passenger-4.0.0/bin:$PATH</pre>
</div>
</div>
<div class="paragraph"><p>Finally, restart all your shell sessions to activate the PATH change.</p></div>
</div>
</div>
</div>
<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="deploying_a_rack_app"></span><h2 data-comment-topic="deploying-a-rack-based-ruby-application-including-rails-3--12benx3" data-anchor="deploying_a_rack_app">3. Deploying a Rack-based Ruby application</h2>
<div class="sectionbody">
<div class="paragraph"><p>Phusion Passenger supports arbitrary Ruby web applications that follow the
<a href="http://rack.rubyforge.org/">Rack</a> interface.</p></div>
<div class="paragraph"><p>Phusion Passenger assumes that Rack application directories have a certain layout.
Suppose that you have a Rack application in <em>/webapps/rackapp</em>. Then that
folder must contain at least three entries:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>config.ru</em>, a Rackup file for starting the Rack application. This file must contain
  the complete logic for initializing the application.
</p>
</li>
<li>
<p>
<em>public/</em>, a folder containing public static web assets, like images and stylesheets.
</p>
</li>
<li>
<p>
<em>tmp/</em>, used for <em>restart.txt</em> (our application restart mechanism). This will
  be explained in a following subsection.
</p>
</li>
</ul></div>
<div class="paragraph"><p>So <em>/webapps/rackapp</em> must, at minimum, look like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>/webapps/rackapp
  |
  +-- config.ru
  |
  +-- public/
  |
  +-- tmp/</pre>
</div>
</div>
<div class="paragraph"><p>Suppose you own the domain <em>www.rackapp.com</em>. You can either deploy your application
to the virtual host’s root (i.e. the application will be accessible from the root URL,
<em>http://www.rackapp.com/</em>), or in a sub URI (i.e. the application will be
accessible from a sub URL, such as <em>http://www.rackapp.com/rackapp</em>).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">The default <span class="monospaced">RACK_ENV</span> environment in which deployed Rack applications
are run, is “production”. You can change this by changing the
<a href="#RackEnv">rack_env</a> configuration option.</td>
</tr></table>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_tutorial_example_writing_and_deploying_a_hello_world_rack_application"></span><h3 data-comment-topic="tutorial-example-writing-and-deploying-a-hello-world-rack-application-1wstx99" data-anchor="_tutorial_example_writing_and_deploying_a_hello_world_rack_application">3.1. Tutorial/example: writing and deploying a Hello World Rack application</h3>
<div class="paragraph"><p>First we create a Phusion Passenger-compliant Rack directory structure:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ mkdir /webapps/rack_example
$ mkdir /webapps/rack_example/public
$ mkdir /webapps/rack_example/tmp</pre>
</div>
</div>
<div class="paragraph"><p>Next, we write a minimal "hello world" Rack application:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ cd /webapps/rack_example
$ some_awesome_editor config.ru
...type in some source code...
$ cat config.ru
app = proc do |env|
    [200, { "Content-Type" =&gt; "text/html" }, ["hello &lt;b&gt;world&lt;/b&gt;"]]
end
run app</pre>
</div>
</div>
<div class="paragraph"><p>Finally, we deploy it by adding the following configuration options to
the Nginx configuration file:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>http {
    ...
    server {
        listen 80;
        server_name www.rackexample.com;
        root /webapps/rack_example/public;
        passenger_enabled on;
    }
    ...
}</pre>
</div>
</div>
<div class="paragraph"><p>And we’re done! After an Nginx restart, the above Rack application will be available
under the URL <em>http://www.rackexample.com/</em>.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_deploying_to_a_virtual_host_8217_s_root"></span><h3 data-comment-topic="deploying-to-a-virtual-host-s-root-1mh24z5" data-anchor="_deploying_to_a_virtual_host_8217_s_root">3.2. Deploying to a virtual host’s root</h3>
<div class="paragraph"><p>Add a <em>server</em> virtual host entry to your Nginx configuration file. The virtual host’s
root must point to your Rack application’s <em>public</em> folder. You must also set
<em>passenger_enabled on</em> in the <em>server</em> block.</p></div>
<div class="paragraph"><p>For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>http {
    ...
    server {
        listen 80;
        server_name www.rackapp.com;
        root /webapps/rackapp/public;
        passenger_enabled on;
    }
    ...
}</pre>
</div>
</div>
<div class="paragraph"><p>Then restart Nginx. The application has now been deployed.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="deploying_rack_to_sub_uri"></span><h3 data-comment-topic="deploying-to-a-sub-uri-1il2qj7" data-anchor="deploying_rack_to_sub_uri">3.3. Deploying to a sub URI</h3>
<div class="paragraph"><p>Suppose that you already have a virtual host for the application <span class="monospaced">/websites/phusion</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>http {
    ...

    server {
        listen 80;
        server_name www.phusion.nl;
        root /websites/phusion;
        passenger_enabled on;
    }

    ...
}</pre>
</div>
</div>
<div class="paragraph"><p>And you want your Rack application, located in <span class="monospaced">/websites/rack</span>, to be accessible from the URL
<em>http://www.phusion.nl/subapp</em>.</p></div>
<div class="paragraph"><p>To do this, you need to perform the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create a <span class="monospaced">location</span> with parameter <span class="monospaced">~ ^/&lt;SUBURI&gt;(/.*|$)</span>. This is a regular expression that says: "match everything that is exactly &lt;SUBURI&gt;, or starts with &lt;SUBDURI&gt;/".
</p>
</li>
<li>
<p>
Inside the location block, set <span class="monospaced">alias &lt;PATH TO YOUR APPLICATION'S PUBLIC DIRECTORY&gt;$1</span>.
</p>
</li>
<li>
<p>
Inside the location block, set <span class="monospaced">passenger_base_uri &lt;SUBURI&gt;</span>.
</p>
</li>
<li>
<p>
Inside the location block, set <span class="monospaced">passenger_app_root &lt;PATH TO YOUR APPLICATION ROOT&gt;</span>.
</p>
</li>
<li>
<p>
Inside the location block, set <span class="monospaced">passenger_document_root &lt;PATH TO YOUR APPLICATION'S PUBLIC DIRECTORY&gt;</span>.
</p>
</li>
<li>
<p>
Inside the location block, re-specify <span class="monospaced">passenger_enabled on</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Here is an example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>http {
    ...

    server {
        listen 80;
        server_name www.phusion.nl;
        root /websites/phusion;

        # This block has been added.
        location ~ ^/subapp(/.*|$) {
            alias /websites/rack/public$1;  # &lt;-- be sure to point to 'public'!
            passenger_base_uri /subapp;
            passenger_app_root /websites/rack;
            passenger_document_root /websites/rack/public;
            passenger_enabled on;
        }
    }

    ...
}</pre>
</div>
</div>
<div class="paragraph"><p>Then restart Nginx. The application has now been deployed on the sub-URI.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_redeploying_restarting_the_rack_application"></span><h3 data-comment-topic="redeploying-restarting-the-rack-application--xnbfam" data-anchor="_redeploying_restarting_the_rack_application">3.4. Redeploying (restarting the Rack application)</h3>
<div class="paragraph"><p>Deploying a new version of a Rack application is as simple as
re-uploading the application files, and restarting the application.</p></div>
<div class="paragraph"><p>There are two ways to restart the application:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
By restarting Nginx.
</p>
</li>
<li>
<p>
By creating or modifying the file <em>tmp/restart.txt</em> in the Rack
   application’s <a href="#application_root">root folder</a>. Phusion Passenger will
   automatically restart the application.
</p>
</li>
</ol></div>
<div class="paragraph"><p>For example, to restart our example application, we type this in the
command line:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>touch /webapps/rackapp/tmp/restart.txt</pre>
</div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_rackup_specifications_for_various_web_frameworks"></span><h3 data-comment-topic="rackup-specifications-for-various-web-frameworks-1a2cs41" data-anchor="_rackup_specifications_for_various_web_frameworks">3.5. Rackup specifications for various web frameworks</h3>
<div class="paragraph"><p>This subsection shows example <em>config.ru</em> files for various web frameworks.</p></div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_camping"></span><h4 data-comment-topic="camping-16vz2yb" data-anchor="_camping">3.5.1. Camping</h4>
<div class="listingblock">
<div class="content monospaced">
<pre>require 'rubygems'
require 'rack'
require 'camping'

##### Begin Camping application
Camping.goes :Blog

...your application code here...
##### End Camping application

run Rack::Adapter::Camping.new(Blog)</pre>
</div>
</div>
<div class="paragraph"><p>For Camping versions 2.0 and up, using <span class="monospaced">run Blog</span> as the final line will do.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_halcyon"></span><h4 data-comment-topic="halcyon-1benlfl" data-anchor="_halcyon">3.5.2. Halcyon</h4>
<div class="listingblock">
<div class="content monospaced">
<pre>require 'rubygems'
require 'halcyon'
$LOAD_PATH.unshift(Halcyon.root / 'lib')
Halcyon::Runner.load_config Halcyon.root/'config'/'config.yml'
run Halcyon::Runner.new</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_mack"></span><h4 data-comment-topic="mack-1ezijq6" data-anchor="_mack">3.5.3. Mack</h4>
<div class="listingblock">
<div class="content monospaced">
<pre>ENV["MACK_ENV"] = ENV["RACK_ENV"]
load("Rakefile")
require 'rubygems'
require 'mack'
run Mack::Utils::Server.build_app</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_merb"></span><h4 data-comment-topic="merb-ddsh55" data-anchor="_merb">3.5.4. Merb</h4>
<div class="listingblock">
<div class="content monospaced">
<pre>require 'rubygems'
require 'merb-core'

Merb::Config.setup(
  :merb_root   =&gt; ::File.expand_path(::File.dirname(__FILE__)),
  :environment =&gt; ENV['RACK_ENV']
)
Merb.environment = Merb::Config[:environment]
Merb.root = Merb::Config[:merb_root]
Merb::BootLoader.run

run Merb::Rack::Application.new</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_ramaze"></span><h4 data-comment-topic="ramaze-1p2zod" data-anchor="_ramaze">3.5.5. Ramaze</h4>
<div class="listingblock">
<div class="content monospaced">
<pre>require "rubygems"
require "ramaze"
Ramaze.trait[:essentials].delete Ramaze::Adapter
require "start"
Ramaze.start!
run Ramaze::Adapter::Base</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_sinatra"></span><h4 data-comment-topic="sinatra-a7u9ag" data-anchor="_sinatra">3.5.6. Sinatra</h4>
<div class="listingblock">
<div class="content monospaced">
<pre>require 'rubygems'
require 'sinatra'

set :environment, ENV['RACK_ENV'].to_sym
disable :run, :reload

require 'app.rb'

run Sinatra::Application</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="deploying_a_wsgi_app"></span><h2 data-comment-topic="deploying-a-wsgi-python-application-1or2efo" data-anchor="deploying_a_wsgi_app">4. Deploying a WSGI (Python) application</h2>
<div class="sectionbody">
<div class="paragraph"><p>Phusion Passenger supports all WSGI-compliant Python web applications. Suppose that you have a WSGI application in <em>/webapps/wsgiapp</em>. Then that folder must contain at least three entries:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>passenger_wsgi.py</em>, which Phusion Passenger will use as the main entry point for your application. This file must export a WSGI object called <span class="monospaced">application</span>.
</p>
</li>
<li>
<p>
<em>public/</em>, a folder containing public static web assets, like images and stylesheets.
</p>
</li>
<li>
<p>
<em>tmp/</em>, used for <em>restart.txt</em> (our application restart mechanism). This will be explained in a following subsection.
</p>
</li>
</ul></div>
<div class="paragraph"><p>So <em>/webapps/wsgiapp</em> must, at minimum, look like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>/webapps/wsgiapp
  |
  +-- passenger_wsgi.py
  |
  +-- public/
  |
  +-- tmp/</pre>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_tutorial_example_writing_and_deploying_a_hello_world_wsgi_application"></span><h3 data-comment-topic="tutorial-example-writing-and-deploying-a-hello-world-wsgi-application-k5ron2" data-anchor="_tutorial_example_writing_and_deploying_a_hello_world_wsgi_application">4.1. Tutorial/example: writing and deploying a Hello World WSGI application</h3>
<div class="paragraph"><p>First we create a Phusion Passenger-compliant WSGI directory structure:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ mkdir /webapps/wsgi_example
$ mkdir /webapps/wsgi_example/public
$ mkdir /webapps/wsgi_example/tmp</pre>
</div>
</div>
<div class="paragraph"><p>Next, we write a minimal "hello world" WSGI application:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ cd /webapps/wsgi_example
$ some_awesome_editor passenger_wsgi.py
...type in some source code...
$ cat passenger_wsgi.py
def application(environ, start_response):
  start_response('200 OK', [('Content-Type', 'text/plain')])
  return [b"hello world!\n"]</pre>
</div>
</div>
<div class="paragraph"><p>Finally, we deploy it by adding the following configuration options to
the Nginx configuration file:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>http {
    ...
    server {
        listen 80;
        server_name www.wsgiexample.com;
        root /webapps/wsgi_example/public;
        passenger_enabled on;
    }
    ...
}</pre>
</div>
</div>
<div class="paragraph"><p>And we’re done! After an Nginx restart, the above WSGI application will be available
under the URL <em>http://www.wsgiexample.com/</em>.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_deploying_to_a_virtual_host_8217_s_root_2"></span><h3 data-comment-topic="deploying-to-a-virtual-host-s-root-f02erj" data-anchor="_deploying_to_a_virtual_host_8217_s_root_2">4.2. Deploying to a virtual host’s root</h3>
<div class="paragraph"><p>Add a <em>server</em> virtual host entry to your Nginx configuration file. The virtual host’s
root must point to your WSGI application’s <em>public</em> folder. You must also set
<em>passenger_enabled on</em> in the <em>server</em> block.</p></div>
<div class="paragraph"><p>For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>http {
    ...
    server {
        listen 80;
        server_name www.wsgiapp.com;
        root /webapps/wsgiapp/public;
        passenger_enabled on;
    }
    ...
}</pre>
</div>
</div>
<div class="paragraph"><p>Then restart Nginx. The application has now been deployed.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="deploying_wsgi_to_sub_uri"></span><h3 data-comment-topic="deploying-to-a-sub-uri-37q0ou" data-anchor="deploying_wsgi_to_sub_uri">4.3. Deploying to a sub URI</h3>
<div class="paragraph"><p>Suppose that you already have a virtual host for the application <span class="monospaced">/websites/phusion</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>http {
    ...

    server {
        listen 80;
        server_name www.phusion.nl;
        root /websites/phusion;
        passenger_enabled on;
    }

    ...
}</pre>
</div>
</div>
<div class="paragraph"><p>And you want your WSGI application, located in <span class="monospaced">/websites/wsgi</span>, to be accessible from the URL
<em>http://www.phusion.nl/subapp</em>.</p></div>
<div class="paragraph"><p>To do this, you need to perform the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create a <span class="monospaced">location</span> with parameter <span class="monospaced">~ ^/&lt;SUBURI&gt;(/.*|$)</span>. This is a regular expression that says: "match everything that is exactly &lt;SUBURI&gt;, or starts with &lt;SUBDURI&gt;/".
</p>
</li>
<li>
<p>
Inside the location block, set <span class="monospaced">alias &lt;PATH TO YOUR APPLICATION'S PUBLIC DIRECTORY&gt;$1</span>.
</p>
</li>
<li>
<p>
Inside the location block, set <span class="monospaced">passenger_base_uri &lt;SUBURI&gt;</span>.
</p>
</li>
<li>
<p>
Inside the location block, set <span class="monospaced">passenger_app_root &lt;PATH TO YOUR APPLICATION ROOT&gt;</span>.
</p>
</li>
<li>
<p>
Inside the location block, set <span class="monospaced">passenger_document_root &lt;PATH TO YOUR APPLICATION'S PUBLIC DIRECTORY&gt;</span>.
</p>
</li>
<li>
<p>
Inside the location block, re-specify <span class="monospaced">passenger_enabled on</span>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Here is an example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>http {
    ...

    server {
        listen 80;
        server_name www.phusion.nl;
        root /websites/phusion;

        # This block has been added.
        location ~ ^/subapp(/.*|$) {
            alias /websites/wsgi/public$1;  # &lt;-- be sure to point to 'public'!
            passenger_base_uri /subapp;
            passenger_app_root /websites/wsgi;
            passenger_document_root /websites/wsgi/public;
            passenger_enabled on;
        }
    }

    ...
}</pre>
</div>
</div>
<div class="paragraph"><p>Then restart Nginx. The application has now been deployed on the sub-URI.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_redeploying_restarting_the_wsgi_application"></span><h3 data-comment-topic="redeploying-restarting-the-wsgi-application--10zdh2k" data-anchor="_redeploying_restarting_the_wsgi_application">4.4. Redeploying (restarting the WSGI application)</h3>
<div class="paragraph"><p>Deploying a new version of a WSGI application is as simple as
re-uploading the application files, and restarting the application.</p></div>
<div class="paragraph"><p>There are two ways to restart the application:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
By restarting Nginx.
</p>
</li>
<li>
<p>
By creating or modifying the file <em>tmp/restart.txt</em> in the WSGI
   application’s <a href="#application_root">root folder</a>. Phusion Passenger will
   automatically restart the application.
</p>
</li>
</ol></div>
<div class="paragraph"><p>For example, to restart our example application, we type this in the
command line:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>touch /webapps/wsgiapp/tmp/restart.txt</pre>
</div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_sample_span_class_monospaced_passenger_wsgi_py_span_for_django"></span><h3 data-comment-topic="sample-passenger-wsgi-py-for-django-1cvndls" data-anchor="_sample_span_class_monospaced_passenger_wsgi_py_span_for_django">4.5. Sample <span class="monospaced">passenger_wsgi.py</span> for Django</h3>
<div class="paragraph"><p>For Django applications, <span class="monospaced">passenger_wsgi.py</span> should look like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre><strong>import</strong> myproject.wsgi
application = myproject.wsgi.application</pre>
</div>
</div>
<div class="paragraph"><p>Replace <span class="monospaced">myproject</span> with your project’s module name.</p></div>
</div>
</div>
</div>
<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_deploying_a_node_js_application"></span><h2 data-comment-topic="deploying-a-node-js-application-15wbczd" data-anchor="_deploying_a_node_js_application">5. Deploying a Node.js application</h2>
<div class="sectionbody">
<div class="paragraph"><p>Please refer to <a href="https://github.com/phusion/passenger/wiki/Phusion-Passenger%3A-Node.js-tutorial">the Node.js tutorial</a>.</p></div>
</div>
</div>
<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_deploying_a_meteor_application"></span><h2 data-comment-topic="deploying-a-meteor-application-1b51wl9" data-anchor="_deploying_a_meteor_application">6. Deploying a Meteor application</h2>
<div class="sectionbody">
<div class="paragraph"><p>Please refer to <a href="https://github.com/phusion/passenger/wiki/Phusion-Passenger:-Meteor-tutorial">the Meteor tutorial</a>.</p></div>
</div>
</div>
<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_configuring_phusion_passenger"></span><h2 data-comment-topic="configuring-phusion-passenger-1g1svey" data-anchor="_configuring_phusion_passenger">7. Configuring Phusion Passenger</h2>
<div class="sectionbody">
<div class="paragraph"><p>After installation, Phusion Passenger does not need any further configurations.
Nevertheless, the system administrator may be interested in changing
Phusion Passenger’s behavior. Phusion Passenger supports the following configuration
options in the Nginx configuration file:</p></div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerRoot"></span><h3 data-comment-topic="passenger-root-directory--bqvhhz" data-anchor="PassengerRoot">7.1. passenger_root &lt;directory&gt;</h3>
<div class="paragraph"><p>The location to the Phusion Passenger root directory. This configuration option
is essential to Phusion Passenger, and allows Phusion Passenger to locate its own
data files. If you do not set this option, then Phusion Passenger will disable itself, and Nginx will behave as if Phusion Passenger was never installed. If you set this option to the wrong value, then Phusion Passenger will make Nginx abort with an error.</p></div>
<div class="paragraph"><p>While installing Phusion Passenger, you have been told to set this option in your Nginx configuration file, and you have been told what value to set it to. So under normal conditions, you don’t have ask yourself what value to set for this option. But in case you lost the value (e.g. because you accidentally removed the Nginx configuration file, and you are trying to reconstruct it), or in case you didn’t follow the installation instructions correctly, then here’s how you can find out the correct value:</p></div>
<div class="ulist"><ul>
<li>
<p>
If you installed Phusion Passenger through <a href="#install_on_debian_ubuntu">our APT repository</a>, then follow the instructions in <a href="#inserting_passenger_root_for_apt">Inserting <span class="monospaced">passenger_root</span> into nginx.conf</a>.
</p>
</li>
<li>
<p>
If you installed Phusion Passenger through RubyGems, then the value can be obtained by running <span class="monospaced">passenger-config --root</span>.
</p>
</li>
<li>
<p>
If you installed Phusion Passenger through the source tarball, then the value is the path to the Phusion Passenger directory. For example, if you extracted the tarball’s contents to <span class="monospaced">/opt/passenger/passenger-x.x.x</span>, then <span class="monospaced">passenger_root</span> must be <span class="monospaced">/opt/passenger/passenger-x.x.x</span>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If you’ve moved Phusion Passenger to a different directory then you need to update
this option as well. Please read
<a href="#moving_phusion_passenger">Moving Phusion Passenger to a different directory</a> for more information.</p></div>
<div class="paragraph"><p>This required option may only occur once, in the <em>http</em> configuration block.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">This option has no effect when you are using <a href="#flying_passenger">Flying Passenger</a>.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_deployment_options"></span><h3 data-comment-topic="deployment-options-1a1vxsp" data-anchor="_deployment_options">7.2. Deployment options</h3>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_enabled_lt_on_off_gt"></span><h4 data-comment-topic="passenger-enabled-on-off--1rpb2t7" data-anchor="_passenger_enabled_lt_on_off_gt">7.2.1. passenger_enabled &lt;on|off&gt;</h4>
<div class="paragraph"><p>This option may be specified in the <em>http</em> configuration block, a
<em>server</em> configuration block, a <em>location</em> configuration block or
an <em>if</em> configuration scope, to enable or disable Phusion Passenger
for that server or that location.</p></div>
<div class="paragraph"><p>Phusion Passenger is disabled by default, so you must explicitly enable
it for server blocks that you wish to serve through Phusion Passenger.
Please see <a href="#deploying_a_rack_app">Deploying a Rack-based Ruby application</a>
and <a href="#deploying_a_wsgi_app">Deploying a WSGI (Python) application</a>
for examples.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    listen 80;
    server_name www.example.com;
    root /webapps/example/public;

    # You must explicitly set 'passenger_enabled on', otherwise
    # Phusion Passenger won't serve this app.
    passenger_enabled on;
}</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerBaseURI"></span><h4 data-comment-topic="passenger-base-uri-uri--1xtuo50" data-anchor="PassengerBaseURI">7.2.2. passenger_base_uri &lt;uri&gt;</h4>
<div class="paragraph"><p>Used to specify that the given URI is an distinct application that should
be served by Phusion Passenger. Please refer to the following sections for
more information:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="#deploying_rack_to_sub_uri">Deploying Rack to a sub URI</a>
</p>
</li>
<li>
<p>
<a href="#deploying_wsgi_to_sub_uri">Deploying WSGI to a sub URI</a>
</p>
</li>
<li>
<p>
<a href="#deploying_rails_to_sub_uri">Deploying Rails 1 and Rails 2 to a sub URI</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>It is allowed to specify this option multiple times. Do this to deploy multiple
applications in different sub-URIs under the same virtual host.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerDocumentRoot"></span><h4 data-comment-topic="passenger-document-root-path--1pge8kd" data-anchor="PassengerDocumentRoot">7.2.3. passenger_document_root &lt;path&gt;</h4>
<div class="paragraph"><p>Used in sub-URI deployment scenarios to tell Phusion Passenger where it
should look for static files. Please refer to the following sections for
more information:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="#deploying_rack_to_sub_uri">Deploying Rack to a sub URI</a>
</p>
</li>
<li>
<p>
<a href="#deploying_wsgi_to_sub_uri">Deploying WSGI to a sub URI</a>
</p>
</li>
<li>
<p>
<a href="#deploying_rails_to_sub_uri">Deploying Rails 1 and Rails 2 to a sub URI</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once.</p></div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_application_loading_options"></span><h3 data-comment-topic="application-loading-options-f3skts" data-anchor="_application_loading_options">7.3. Application loading options</h3>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerRuby"></span><h4 data-comment-topic="passenger-ruby-filename--1gnok5k" data-anchor="PassengerRuby">7.3.1. passenger_ruby &lt;filename&gt;</h4>
<div class="paragraph"><p>The <span class="monospaced">passenger_ruby</span> option allows one to specify the Ruby interpreter to use. Similarly, the <span class="monospaced">passenger_python</span> and <span class="monospaced">passenger_nodejs</span> options are for specifying the Python interpreter and Node.js commands, respectively.</p></div>
<div class="paragraph"><p>In versions prior to 4.0.0, only a single Ruby version was supported for the entire Nginx instance, so <span class="monospaced">passenger_ruby</span> may only occur in the global server configuration. Also, the <span class="monospaced">passenger_python</span>/<span class="monospaced">passenger_nodejs</span> options were not supported.</p></div>
<div class="paragraph"><p>Since version 4.0.0, Phusion Passenger supports multiple Ruby interpreters in the same Nginx instance. And so, since version 4.0.0, this option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The <span class="monospaced">passenger_ruby</span> in the <span class="monospaced">http</span> block - that is, the one that <span class="monospaced">passenger-install-nginx-module</span> outputs - is used for invoking certain Phusion Passenger tools that are written in Ruby, e.g. the internal helper script used by <a href="#PassengerPreStart">passenger_pre_start</a>. It is okay if the value refers to a different Ruby interpreter than the one you originally installed Phusion Passenger with. You can learn more about all this in <a href="#relationship_with_ruby">Phusion Passenger and its relationship with Ruby</a>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">passenger_ruby</span> directive in the <span class="monospaced">http</span> block is also used as the default Ruby interpreter for Ruby web apps. You don’t <strong>have</strong> to specify a <span class="monospaced">passenger_ruby</span> in the <span class="monospaced">http</span> block though, because the default is to use the first <span class="monospaced">ruby</span> command found in <span class="monospaced">$PATH</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">passenger_python</span> and <span class="monospaced">passenger_nodejs</span> options work in a similar manner, but apply to Python and Node.js instead.</p></div>
<div class="paragraph"><p>You can also override <span class="monospaced">passenger_ruby</span> and other directives in specific contexts if you want to use a different interpreter for that web app. For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>http {
    passenger_root ...;

    # Use Ruby 1.8.7 by default.
    passenger_ruby /usr/bin/ruby1.8;
    # Use Python 2.6 by default.
    passenger_python /usr/bin/python2.6;
    # Use /usr/bin/node by default.
    passenger_nodejs /usr/bin/node;

    server {
        # This Rails web app will use Ruby 1.8.7
        listen 80;
        server_name www.foo.com;
        root /webapps/foo/public;
    }

    server {
        # This Rails web app will use Ruby 1.9.3, as installed by RVM
        passenger_ruby /usr/local/rvm/wrappers/ruby-1.9.3/ruby;

        listen 80;
        server_name www.bar.com;
        root /webapps/bar/public;

        # If you have a web app deployed in a sub-URI, customize
        # passenger_ruby/passenger_python inside a `location` block.
        # The web app under www.bar.com/blog will use JRuby 1.7.1
        location ~ ^/blog(/.*|$) {
            alias /websites/blog/public$1;
            passenger_base_uri /blog;
            passenger_app_root /websites/blog;
            passenger_document_root /websites/blog/public;
            passenger_enabled on;
            passenger_ruby /usr/local/rvm/wrappers/jruby-1.7.1/ruby;
        }
    }

    server {
        # This Flask web app will use Python 3.0
        passenger_python /usr/bin/python3.0;

        listen 80;
        server_name www.baz.com;
        root /webapps/baz/public;
    }
}</pre>
</div>
</div>
<div class="paragraph">
<div class="title">RVM helper tool</div>
<p>Phusion Passenger provides the <span class="monospaced">passenger-config --ruby-command</span> tool for figuring out the correct command for invoking a specific Ruby interpreter. This is especially useful for RVM users. Suppose that you have both Ruby 1.8.7 and Ruby 1.9.3 installed through RVM, and you want to know the correct commands for each Ruby interpreter.</p>
</div>
<div class="paragraph"><p>For this purpose we’ll want to invoke <span class="monospaced">passenger-config</span> using its full path, because each time you <span class="monospaced">rvm use</span> a different Ruby interpreter, RVM changes <span class="monospaced">$PATH</span>. If you did not install Phusion Passenger through the generic tarball installation method, then here’s how you can figure out where <span class="monospaced">passenger-config</span> is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ which passenger-config
/opt/passenger/bin/passenger-config</pre>
</div>
</div>
<div class="paragraph"><p>Now, switch to all the RVM Ruby interpreters you want to use. In each interpreter, invoke <span class="monospaced">passenger-config --ruby-command</span>. For Ruby 1.8.7:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ rvm use 1.8.7
$ /opt/passenger/bin/passenger-config --ruby-command
passenger-config was invoked through the following Ruby interpreter:
  Command: /usr/local/rvm/wrappers/ruby-1.8.7-p358/ruby
  Version: ruby 1.8.7 (2012-02-08 patchlevel 358) [universal-darwin12.0]
  To use in Apache: PassengerRuby /usr/local/rvm/wrappers/ruby-1.8.7-p358/ruby
  To use in Nginx : passenger_ruby /usr/local/rvm/wrappers/ruby-1.8.7-p358/ruby
  To use with Standalone: /usr/local/rvm/wrappers/ruby-1.8.7-p358/ruby /opt/passenger/bin/passenger start


## Notes for RVM users
Do you want to know which command to use for a different Ruby interpreter? 'rvm use' that Ruby interpreter, then re-run 'passenger-config --ruby-command'.</pre>
</div>
</div>
<div class="paragraph"><p>Then, for Ruby 1.9.3:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ rvm use 1.9.3
$ /opt/passenger/bin/passenger-config --ruby-command
passenger-config was invoked through the following Ruby interpreter:
  Command: /usr/local/rvm/wrappers/ruby-1.9.3-p392/ruby
  Version: ruby 1.9.3p392 (2013-02-22 revision 39386) [x86_64-darwin12.2.1]
  To use in Apache: PassengerRuby /usr/local/rvm/wrappers/ruby-1.9.3-p392/ruby
  To use in Nginx : passenger_ruby /usr/local/rvm/wrappers/ruby-1.9.3-p392/ruby
  To use with Standalone: /usr/local/rvm/wrappers/ruby-1.9.3-p392/ruby /opt/passenger/bin/passenger start


## Notes for RVM users
Do you want to know which command to use for a different Ruby interpreter? 'rvm use' that Ruby interpreter, then re-run 'passenger-config --ruby-command'.</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_python_lt_filename_gt"></span><h4 data-comment-topic="passenger-python-filename--14p554" data-anchor="_passenger_python_lt_filename_gt">7.3.2. passenger_python &lt;filename&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 4.0.0.</strong></p></div>
<div class="paragraph"><p>This option allows one to specify the Python interpreter to use. See <a href="#PassengerRuby">passenger_ruby</a> for more information. The default value is <em>python</em>, meaning that the Python interpreter will be looked up according to the <span class="monospaced">PATH</span> environment variable.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_nodejs_lt_filename_gt"></span><h4 data-comment-topic="passenger-nodejs-filename--16hzjsv" data-anchor="_passenger_nodejs_lt_filename_gt">7.3.3. passenger_nodejs &lt;filename&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 4.0.24.</strong></p></div>
<div class="paragraph"><p>This option allows one to specify the Node.js command to use. See <a href="#PassengerRuby">passenger_ruby</a> for more information. The default value is <em>node</em>, meaning that the Node.js command will be looked up according to the <span class="monospaced">PATH</span> environment variable.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_meteor_app_settings_lt_filename_gt"></span><h4 data-comment-topic="passenger-meteor-app-settings-filename--1toqnaz" data-anchor="_passenger_meteor_app_settings_lt_filename_gt">7.3.4. passenger_meteor_app_settings &lt;filename&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 5.0.7.</strong></p></div>
<div class="paragraph"><p>When using a Meteor application in non-bundled mode, use this option to specify a (JSON) file with settings for the application. Meteor will be started with the <span class="monospaced">--settings</span> parameter set to this option.</p></div>
<div class="paragraph"><p>N.B. For bundled mode, Meteor requires you to put applications settings in the <span class="monospaced">METEOR_SETTINGS</span> environment variable.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerAppEnv"></span><h4 data-comment-topic="passenger-app-env-string--qjeimp" data-anchor="PassengerAppEnv">7.3.5. passenger_app_env &lt;string&gt;</h4>
<div class="paragraph"><p>This option sets the value of the following environment variables:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">RAILS_ENV</span>
</p>
</li>
<li>
<p>
<span class="monospaced">RACK_ENV</span>
</p>
</li>
<li>
<p>
<span class="monospaced">WSGI_ENV</span>
</p>
</li>
<li>
<p>
<span class="monospaced">NODE_ENV</span>
</p>
</li>
<li>
<p>
<span class="monospaced">PASSENGER_APP_ENV</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Some web frameworks, for example Rails and Connect.js, adjust their behavior according to the value in one of these environment variables.</p></div>
<div class="paragraph"><p>Phusion Passenger for Nginx sets the default value to <strong>production</strong>. If you’re developing an Rails application then you should set this to <span class="monospaced">development</span>.</p></div>
<div class="paragraph"><p>If you want to set other environment variables, please refer to <a href="#env_vars_passenger_apps">Setting environment variables for Phusion Passenger-served apps</a>.</p></div>
<div class="paragraph"><p>Setting this option also adds the application environment name to the default <a href="#PassengerAppGroupName">application group name</a>, so that you can run multiple versions of your application with different application environment names.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>production</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="RailsEnv"></span><h4 data-comment-topic="rails-env-string--jlh7v9" data-anchor="RailsEnv">7.3.6. rails_env &lt;string&gt;</h4>
<div class="paragraph"><p>An alias for <a href="#PassengerAppEnv">passenger_app_env</a>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="RackEnv"></span><h4 data-comment-topic="rack-env-string--tqmrt0" data-anchor="RackEnv">7.3.7. rack_env &lt;string&gt;</h4>
<div class="paragraph"><p>An alias for <a href="#PassengerAppEnv">passenger_app_env</a>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerAppRoot"></span><h4 data-comment-topic="passenger-app-root-path-to-root--1dbudc6" data-anchor="PassengerAppRoot">7.3.8. passenger_app_root &lt;path/to/root&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 4.0.0.</strong></p></div>
<div class="paragraph"><p>By default, Phusion Passenger assumes that the application’s root directory
is the parent directory of the <em>public</em> directory. This option allows one to
specify the application’s root independently from the Nginx <em>root</em>, which
is useful if the <em>public</em> directory lives in a non-standard place.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    server_name test.host;
    root /var/rails/zena/sites/example.com/public;
    # normally Phusion Passenger would
    # have assumed that the application
    # root is "/var/rails/zena/sites/example.com"
    passenger_app_root /var/rails/zena;
}</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerAppGroupName"></span><h4 data-comment-topic="passenger-app-group-name-name--11jrx8u" data-anchor="PassengerAppGroupName">7.3.9. passenger_app_group_name &lt;name&gt;</h4>
<div class="paragraph"><p>Sets the name of the application group that the current application should belong to. Its default value is the virtual host’s root directory, plus (if it is set), the <a href="#PassengerAppEnv">application environment name</a>.</p></div>
<div class="paragraph"><p>Phusion Passenger stores and caches most application spawning settings — such as environment variables, process limits, etc — on a per-app-group-name basis. This means that if you want to start two versions of your application, with each version having different environment variables, then you must assign them under different application group names.</p></div>
<div class="paragraph"><p>For example, consider a situation in which you are running multiple versions of the same app, with each version intended for a different customer. You use the <span class="monospaced">CUSTOMER_NAME</span> environment variable to tell the app which customer that version should serve.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre># WRONG example! Doesn't work!

server {
    listen 80;
    server_name customer1.foo.com;
    root /webapps/foo/public;
    passenger_enabled on;
    passenger_env_var CUSTOMER_NAME customer1;
}

server {
    listen 80;
    server_name customer2.foo.com;
    root /webapps/foo/public;
    passenger_enabled on;
    passenger_env_var CUSTOMER_NAME customer2;
}</pre>
</div>
</div>
<div class="paragraph"><p>This example doesn’t work, because Phusion Passenger thinks that they are the same application. When a user visits customer1.foo.com, Phusion Passenger will start a process with <span class="monospaced">CUSTOMER_NAME=customer1</span>. When another user visits customer2.foo.com, Phusion Passenger will route the request to the application process that was started earlier. Because environment variables are only set during application process startup, the second user will be served the website for customer 1.</p></div>
<div class="paragraph"><p>To make this work, assign unique application group names:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    listen 80;
    server_name customer1.foo.com;
    root /webapps/foo/public;
    passenger_enabled on;
    passenger_env_var CUSTOMER_NAME customer1;
    passenger_app_group_name foo_customer1;
}

server {
    listen 80;
    server_name customer2.foo.com;
    root /webapps/foo/public;
    passenger_enabled on;
    passenger_env_var CUSTOMER_NAME customer2;
    passenger_app_group_name foo_customer2;
}</pre>
</div>
</div>
<div class="paragraph"><p>Note that it is not necessary to set <span class="monospaced">passenger_app_group_name</span> if you want to run two versions of your application under different <a href="#PassengerAppEnv">application environment names</a>, because the application environment name is included in the default application group name. For example, consider a situation in which you want to run a production and a staging version of your application. The following configuration will work fine:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    listen 80;
    server_name bar.com;
    root /webapps/bar/public;
    passenger_enabled on;
    # Phusion Passenger implicitly sets:
    # passenger_app_group_name /webapps/bar/public;
}

server {
    listen 80;
    server_name staging.com;
    root /webapps/bar/public;
    passenger_enabled on;
    passenger_app_env staging;
    # Phusion Passenger implicitly sets:
    # passenger_app_group_name '/webapps/bar/public (staging)';
}</pre>
</div>
</div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerAppType"></span><h4 data-comment-topic="passenger-app-type-name--g9zccv" data-anchor="PassengerAppType">7.3.10. passenger_app_type &lt;name&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 4.0.25.</strong></p></div>
<div class="paragraph"><p>By default, Phusion Passenger autodetects the type of the application, e.g. whether it’s a Ruby, Python, Node.js or Meteor app. If it’s unable to autodetect the type of the application (e.g. because you’ve specified a custom <a href="#PassengerStartupFile">passenger_startup_file</a>) then you can use this option to force Phusion Passenger to recognize the application as a specific type.</p></div>
<div class="paragraph"><p>Allowed values are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">rack</span> - Ruby and Rails
</p>
</li>
<li>
<p>
<span class="monospaced">wsgi</span> - Python
</p>
</li>
<li>
<p>
<span class="monospaced">node</span> - Node.js, or Meteor JS in bundled mode
</p>
</li>
<li>
<p>
<span class="monospaced">meteor</span> - Meteor JS in non-bundled mode
</p>
</li>
</ul></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    server_name example.com;
    root /webapps/example.com/public;
    passenger_enabled on;
    # Use server.js as the startup file (entry point file) for
    # your Node.js application, instead of the default app.js
    passenger_startup_file server.js;
    passenger_app_type node;
&lt;/VirtualHost&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerStartupFile"></span><h4 data-comment-topic="passenger-startup-file-filename--y4gy1m" data-anchor="PassengerStartupFile">7.3.11. passenger_startup_file &lt;filename&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 4.0.25.</strong></p></div>
<div class="paragraph"><p>This option specifies the startup file that Phusion Passenger should use when loading the application.</p></div>
<div class="paragraph"><p>Every application has a <strong>startup file</strong> or <strong>entry point file</strong>: a file where the application begins execution. Some languages have widely accepted conventions about how such a file should be called (e.g. Ruby, with its <span class="monospaced">config.ru</span>). Other languages have somewhat-accepted conventions (e.g. Node.js, with its <span class="monospaced">app.js</span>). In these cases, Phusion Passenger reuses these conventions, and executes applications through those files.</p></div>
<div class="paragraph"><p>Other languages have no conventions at all, and so Phusion Passenger invents one (e.g. Python WSGI with <span class="monospaced">passenger_wsgi.py</span>).</p></div>
<div class="paragraph"><p>Here’s a list of the language-specific conventions that Phusion Passenger accepts:</p></div>
<table class="tableblock frame-all grid-all" style="
width:100%;
">
<col style="width:50%;">
<col style="width:50%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top"> Language                        </th>
<th class="tableblock halign-left valign-top"> Phusion Passenger convention</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ruby on Rails &gt;= 3.0, Ruby Rack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">config.ru</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ruby on Rails 1.x and 2.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">config/environment.rb</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Python</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">passenger_wsgi.py</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Node.js</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">app.js</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>But sometimes you might not want to adhere to the convention that Phusion Passenger accepts. For example, on Node.js, you might want to use <span class="monospaced">server.js</span> as the startup file instead of the default <span class="monospaced">app.js</span>. With this option, you can customize the startup file to any file you like.</p></div>
<div class="paragraph"><p>Notes:</p></div>
<div class="ulist"><ul>
<li>
<p>
Customizing the startup file affects <a href="#user_switching">user switching</a>. After all, if user switching is enabled, the application is executed as the user that owns the startup file.
</p>
</li>
<li>
<p>
If you set this option, you <strong>must</strong> also set <a href="#PassengerAppType">passenger_app_type</a>, otherwise Phusion Passenger doesn’t know what kind of application it is.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    server_name example.com;
    root /webapps/example.com/public;
    passenger_enabled on;
    # Use server.js as the startup file (entry point file) for
    # your Node.js application, instead of the default app.js
    passenger_startup_file server.js;
    passenger_app_type node;
&lt;/VirtualHost&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerSpawnMethod"></span><h4 data-comment-topic="passenger-spawn-method-string--1sc6njl" data-anchor="PassengerSpawnMethod">7.3.12. passenger_spawn_method &lt;string&gt;</h4>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip">
</td>
<td class="content">
<div class="title">"What spawn method should I use?"</div>
<div class="paragraph"><p>This subsection attempts to describe spawn methods, but it’s okay if you don’t (want to)
understand it, as it’s mostly a technical detail. You can basically follow this rule of thumb:</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>If your application works on Mongrel or Thin, but not on Phusion Passenger, then set
<span class="monospaced">passenger_spawn_method</span> to <em>direct</em>. Otherwise, leave it at <em>smart</em> (the default).</p></div>
</div>
</div>
<div class="paragraph"><p>However, we do recommend you to try to understand it. The <em>smart</em> spawn
method brings many benefits.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Internally, Phusion Passenger spawns multiple Ruby application processes in order to handle
requests. But there are multiple ways with which processes can be spawned, each having
its own set of pros and cons. Supported spawn methods are:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<em>smart</em>
</dt>
<dd>
<p>
This spawning method caches code using the app preloader. Framework code is not
cached between multiple applications, although it is cached within
instances of the same application. Please read
<a href="#spawning_methods_explained">Spawning methods explained</a> for a more detailed
explanation of what smart spawning exactly does.
</p>
<div class="paragraph"><p><strong>Pros:</strong>
Smart spawning caches code where possible to speed up the respawn process
and is compatible with most applications</p></div>
<div class="paragraph"><p><strong>Cons:</strong>
It is possible that it may be incompatible with some applications</p></div>
</dd>
<dt class="hdlist1">
<em>direct</em>
</dt>
<dd>
<p>
This spawning method is similar to the one used in Mongrel Cluster. It does not
perform any code caching at all. Please read
<a href="#spawning_methods_explained">Spawning methods explained</a> for a more detailed
explanation of what direct spawning exactly does.
</p>
<div class="paragraph"><p><strong>Pros:</strong>
Direct spawning is guaranteed to be compatible with all applications
and libraries.</p></div>
<div class="paragraph"><p><strong>Cons:</strong>
Much slower than smart spawning. Every spawn action will be equally slow, though no slower than
the startup time of a single server in Mongrel Cluster. Direct spawning will also
render <a href="#reducing_memory_usage">Ruby Enterprise Edition’s memory reduction technology</a> useless.</p></div>
</dd>
</dl></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>As of Phusion Passenger 4.0, <em>conservative</em> spawning was renamed to <em>direct</em> and <em>smart-lv2</em> was renamed
to <em>smart</em>. The old <em>smart</em> spawning has been removed in favor of the new version.</p></div>
</div>
</div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>smart</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerEnvVar"></span><h4 data-comment-topic="passenger-env-var-name-value--y8e7wh" data-anchor="PassengerEnvVar">7.3.13. passenger_env_var &lt;name&gt; &lt;value&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 5.0.0.</strong></p></div>
<div class="paragraph"><p>Sets environment variables to pass to the application. Environment variables are only set during application loading.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    server_name www.foo.com;
    root /webapps/foo/public;
    passenger_enabled on;

    passenger_env_var DATABASE_USERNAME foo_db;
    passenger_env_var DATABASE_PASSWORD secret;
}</pre>
</div>
</div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified multiple times.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerLoadShellEnvvars"></span><h4 data-comment-topic="passenger-load-shell-envvars-on-off--fw5u4l" data-anchor="PassengerLoadShellEnvvars">7.3.14. passenger_load_shell_envvars &lt;on|off&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 4.0.20.</strong></p></div>
<div class="paragraph"><p>Enables or disables the loading of shell environment variables before spawning the application.</p></div>
<div class="paragraph"><p>If this option is turned on, and the user’s shell is <span class="monospaced">bash</span>, then applications are loaded by running them with <span class="monospaced">bash -l -c</span>. Otherwise, they are loaded by running them directly from the <span class="monospaced">PassengerHelperAgent</span> process.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>on</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerRollingRestarts"></span><h4 data-comment-topic="passenger-rolling-restarts" data-anchor="PassengerRollingRestarts">7.3.15. passenger_rolling_restarts &lt;on|off&gt;</h4>
<div class="paragraph"><p><strong>This feature is only available in <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a>. It was introduced in version 3.0.0. <a href="https://www.phusionpassenger.com/download">Buy Phusion Passenger Enterprise here.</a></strong></p></div>
<div class="paragraph"><p>Enables or disables support for rolling restarts through restart.txt. Normally when you
restart an application by touching restart.txt, Phusion Passenger would
shut down all application processes and spawn a new one. The spawning
of a new application process could take a while, and any requests that
come in during this time will be blocked until this first application
process has spawned.</p></div>
<div class="paragraph"><p>But when rolling restarts are enabled, Phusion Passenger Enterprise will:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Spawn a new process in the background.
</p>
</li>
<li>
<p>
When it’s done spawning, Phusion Passenger Enterprise will replace one of the old processes with this newly spawned one.
</p>
</li>
<li>
<p>
Step 1 and 2 are repeated until all processes have been replaced.
</p>
</li>
</ol></div>
<div class="paragraph"><p>This way, visitors will not experience any delays when you are restarting your application. This allows you to, for example, upgrade your application often without degrading user experience.</p></div>
<div class="paragraph"><p>Rolling restarts have a few caveat however that you should be aware of:</p></div>
<div class="ulist"><ul>
<li>
<p>
Upgrading an application sometimes involves upgrading the database schema.
  With rolling restarts, there may be a point in time during which processes
  belonging to the previous version and processes belonging to the new version
  both exist at the same time. Any database schema upgrades you perform must
  therefore be backwards-compatible with the old application version.
</p>
</li>
<li>
<p>
Because there’s no telling which process will serve a request, users may
  not see changes brought about by the new version until all processes have
  been restarted. It is for this reason that you should not use rolling
  restarts in development, only in production.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If Passenger Enterprise could not rolling restart a process (let’s call it <em>A</em>) because it is unable to spawn a new process (let’s call it <em>B</em>), then Passenger Enterprise will give up trying to rolling restart that particular process <em>A</em>. What happens next depends on whether <a href="#PassengerResistDeploymentErrors">deployment error resistance</a> is enabled:</p></div>
<div class="ulist"><ul>
<li>
<p>
If deployment error resistance is disabled (the default), then Passenger Enterprise will proceed with trying to restart the remaining processes.
</p>
</li>
<li>
<p>
If deployment error resistance is enabled, the Passenger Enterprise will give up rolling restarting immediately. The application group will be put into Deployment Error Resistance Mode.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Please note that <span class="monospaced">passenger_rolling_restarts</span> is completely unrelated to the <span class="monospaced">passenger-config restart-app</span> command. That command always initiates a blocking restart, unless <span class="monospaced">--rolling-restart</span> is given.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>off</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerResistDeploymentErrors"></span><h4 data-comment-topic="passenger-resist-deployment-errors-on-off--k9yf1" data-anchor="PassengerResistDeploymentErrors">7.3.16. passenger_resist_deployment_errors &lt;on|off&gt;</h4>
<div class="paragraph"><p><strong>This feature is only available in <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a>. It was introduced in version 3.0.0. <a href="https://www.phusionpassenger.com/download">Buy Phusion Passenger Enterprise here.</a></strong></p></div>
<div class="paragraph"><p>Enables or disables resistance against deployment errors.</p></div>
<div class="paragraph"><p>Suppose you’ve upgraded your application and you’ve issued a command to restart it (e.g. by touching restart.txt), but the application code contains an error that prevents Phusion Passenger from successfully spawning a process (e.g. a syntax error). Phusion Passenger would normally display an error message in response to this.</p></div>
<div class="paragraph"><p>By enabling deployment error resistance, Phusion Passenger Enterprise would instead do this:</p></div>
<div class="ulist"><ul>
<li>
<p>
It passes the request to one of the existing application processes (that belong to the previous version of the application). The visitor will not see a Phusion Passenger process spawning error message.
</p>
</li>
<li>
<p>
It logs the error to the global web server error log file.
</p>
</li>
<li>
<p>
It sets an internal flag so that no processes for this application will be spawned (even when the current traffic would normally result in more processes being spawned) and no processes will be idle cleaned. Processes <strong>could</strong> still be shutdown because of other events, e.g. because their <a href="#PassengerMemoryLimit">memory limit</a> have been reached. You can see whether the flag is set by invoking <span class="monospaced">passenger-status</span>. If you see the message "Resisting deployment error" then the flag is set.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This way, visitors will suffer minimally from deployment errors. Phusion Passenger will attempt to restart the application again next time restart.txt is touched, or when you issue the <span class="monospaced">passenger-config restart-app</span> command.</p></div>
<div class="paragraph"><p>Enabling deployment error resistance only works if <a href="#PassengerRollingRestarts">rolling restart</a> is also enabled.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>off</em>.</p></div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_security_options"></span><h3 data-comment-topic="security-options-1bv93g4" data-anchor="_security_options">7.4. Security options</h3>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerUserSwitching"></span><h4 data-comment-topic="passenger-user-switching-on-off--1p37u3l" data-anchor="PassengerUserSwitching">7.4.1. passenger_user_switching &lt;on|off&gt;</h4>
<div class="paragraph"><p>Whether to enable <a href="#user_switching">user switching support</a>.</p></div>
<div class="paragraph"><p>This option may only occur once, in the <em>http</em> configuration block.
The default value is <em>on</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">This option has no effect when you are using <a href="#flying_passenger">Flying Passenger</a>. You can disable user switching for Flying Passenger by starting the Flying Passenger daemon as a non-root user.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/warning.png" alt="Warning">
</td>
<td class="content">If you’re on Red Hat or CentOS, be sure to read <a href="#user_switching_rpm_caveats">the Red Hat and CentOS user switching caveats</a>.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerUser"></span><h4 data-comment-topic="passenger-user-username--b06ur7" data-anchor="PassengerUser">7.4.2. passenger_user &lt;username&gt;</h4>
<div class="paragraph"><p>If <a href="#user_switching">user switching support</a> is enabled, then Phusion Passenger will
by default run the web application as the owner of the file <em>config/environment.rb</em>
(for Rails apps) or <em>config.ru</em> (for Rack apps). This option allows you to override
that behavior and explicitly set a user to run the web application as, regardless
of the ownership of <em>environment.rb</em>/<em>config.ru</em>.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerGroup"></span><h4 data-comment-topic="passenger-user-group-name--1fco4j7" data-anchor="PassengerGroup">7.4.3. passenger_group &lt;group name&gt;</h4>
<div class="paragraph"><p>If <a href="#user_switching">user switching support</a> is enabled, then Phusion Passenger will
by default run the web application as the primary group of the owner of the file
<em>config/environment.rb</em> (for Rails apps) or <em>config.ru</em> (for Rack apps). This option
allows you to override that behavior and explicitly set a group to run the web application
as, regardless of the ownership of <em>environment.rb</em>/<em>config.ru</em>.</p></div>
<div class="paragraph"><p><em>&lt;group name&gt;</em> may also be set to the special value <em>!STARTUP_FILE!</em>, in which case
the web application’s group will be set to <em>environment.rb</em>/<em>config.ru</em>'s group.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerDefaultUser"></span><h4 data-comment-topic="passenger-default-user-username--1h6cdmf" data-anchor="PassengerDefaultUser">7.4.4. passenger_default_user &lt;username&gt;</h4>
<div class="paragraph"><p>Phusion Passenger enables <a href="#user_switching">user switching support</a> by default.
This configuration option allows one to specify the user that applications must
run as, if user switching fails or is disabled.</p></div>
<div class="paragraph"><p>This option may only occur once, in the <em>http</em> configuration block.
The default value is <em>nobody</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">This option has no effect when you are using <a href="#flying_passenger">Flying Passenger</a>. There is currently no way to set this option when using Flying Passenger, but if you want to disable user switching for Flying Passenger then you can do so by starting the Flying Passenger daemon as a non-root user.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerDefaultGroup"></span><h4 data-comment-topic="passenger-default-group-group-name--1qxn2qa" data-anchor="PassengerDefaultGroup">7.4.5. Passenger_default_group &lt;group name&gt;</h4>
<div class="paragraph"><p>Phusion Passenger enables <a href="#user_switching">user switching support</a> by default.
This configuration option allows one to specify the group that applications must
run as, if user switching fails or is disabled.</p></div>
<div class="paragraph"><p>This option may only occur once, in the <em>http</em> configuration block.
The default value is the primary group of the user specifified by
<a href="#PassengerDefaultUser">passenger_default_user</a>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">This option has no effect when you are using <a href="#flying_passenger">Flying Passenger</a>. There is currently no way to set this option when using Flying Passenger, but if you want to disable user switching for Flying Passenger then you can do so by starting the Flying Passenger daemon as a non-root user.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_show_version_in_header_lt_on_off_gt"></span><h4 data-comment-topic="passenger-show-version-in-header-on-off--2h49av" data-anchor="_passenger_show_version_in_header_lt_on_off_gt">7.4.6. passenger_show_version_in_header &lt;on|off&gt;</h4>
<div class="paragraph"><p>When turned on, Phusion Passenger will output its version number in the <span class="monospaced">Server</span> and <span class="monospaced">X-Powered-By</span> header in all Phusion Passenger-served requests:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Server: nginx/1.3.11 + Phusion Passenger 4.0.0
X-Powered-By: Phusion Passenger 4.0.0</pre>
</div>
</div>
<div class="paragraph"><p>When turned off, the version number will be hidden:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Server: nginx/1.3.11 + Phusion Passenger
X-Powered-By: Phusion Passenger</pre>
</div>
</div>
<div class="paragraph"><p>This option may only occur once, in the <em>http</em> configuration block.
The default value is <em>on</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerFriendlyErrorPages"></span><h4 data-comment-topic="passenger-friendly-error-pages-on-off--1ti1a0e" data-anchor="PassengerFriendlyErrorPages">7.4.7. passenger_friendly_error_pages &lt;on|off&gt;</h4>
<div class="paragraph"><p>Phusion Passenger can display friendly error pages whenever an application fails
to start. This friendly error page presents the startup error message, some
suggestions for solving the problem, a backtrace and a dump of the environment variables.
This feature is very useful during application development and useful for less experienced
system administrators, but the page might reveal potentially sensitive information,
depending on the application. For this reason, friendly error pages are turned off by default when
<a href="#PassengerAppEnv">passenger_app_env (and its aliases such as rails_env and rack_env)</a>
is set to <em>staging</em> or <em>production</em>, but enabled by default otherwise. You can use
this option to explicitly enable or disable this feature.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value depends on <a href="#PassengerAppEnv">passenger_app_env (and its aliases such as rails_env and rack_env)</a>, as documented above.</p></div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_resource_control_and_optimization_options"></span><h3 data-comment-topic="resource-control-and-optimization-options-xd7evs" data-anchor="_resource_control_and_optimization_options">7.5. Resource control and optimization options</h3>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerMaxPoolSize"></span><h4 data-comment-topic="passenger-max-pool-size-integer--3jzefs" data-anchor="PassengerMaxPoolSize">7.5.1. passenger_max_pool_size &lt;integer&gt;</h4>
<div class="paragraph"><p>The maximum number of <a href="#application_process">application processes</a> that may
simultanously exist. A larger number results in higher memory usage,
but improves the ability to handle concurrent HTTP requests.</p></div>
<div class="paragraph"><p>The optimal value depends on your system’s hardware and your workload. You can learn more at the Phusion article <a href="http://blog.phusion.nl/2013/03/12/tuning-phusion-passengers-concurrency-settings/">Tuning Phusion Passenger’s concurrency settings</a>.</p></div>
<div class="paragraph"><p>If you find that your server is running out of memory then you should lower this value.</p></div>
<div class="paragraph"><p>This option may only occur once, in the <em>http</em> configuration block.
The default value is <em>6</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">This option has no effect when you are using <a href="#flying_passenger">Flying Passenger</a>. Instead, you should configure this by passing the <span class="monospaced">--max-pool-size</span> command line option to the Flying Passenger daemon.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerMinInstances"></span><h4 data-comment-topic="passenger-min-instances-integer--uclykt" data-anchor="PassengerMinInstances">7.5.2. passenger_min_instances &lt;integer&gt;</h4>
<div class="paragraph"><p>This specifies the minimum number of application processes that should exist for a
given application. You should set this option to a
non-zero value if you want to avoid potentially long startup times after a website
has been <a href="#idle_process">idle</a> for an extended period.</p></div>
<div class="paragraph"><p>Please note that this option does <strong>not</strong> pre-start application processes during Nginx
startup. It just makes sure that when the application is first accessed:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
at least the given number of processes will be spawned.
</p>
</li>
<li>
<p>
the given number of processes will be kept around even when processes are being
   idle cleaned (see <a href="#PassengerPoolIdleTime">passenger_pool_idle_time</a>).
</p>
</li>
</ol></div>
<div class="paragraph"><p>If you want to pre-start application processes during Nginx startup, then you should use the <a href="#PassengerPreStart">passenger_pre_start</a> directive, possibly in combination with
<em>passenger_min_instances</em>. This behavior might seem counter-intuitive at first sight,
but <a href="#PassengerPreStart">passenger_pre_start</a> explains the rationale behind it.</p></div>
<div class="paragraph"><p>For example, suppose that you have the following configuration:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>http {
    ...
    passenger_max_pool_size 15;
    passenger_pool_idle_time 10;

    server {
        listen 80;
        server_name foobar.com;
        root /webapps/foobar/public;
        passenger_min_instances 3;
    }
}</pre>
</div>
</div>
<div class="paragraph"><p>When you start Nginx, there are 0 application processes for <em>foobar.com</em>. Things will
stay that way until someone visits <em>foobar.com</em>. Suppose that there is only 1 visitor.
1 application process will be started immediately to serve the visitor, while 2 will
be spawned in the background. After 10 seconds, when the idle timeout has
been reached, these 3 application processes will not be cleaned up.</p></div>
<div class="paragraph"><p>Now suppose that there’s a sudden spike of traffic, and 100 users visit <em>foobar.com</em>
simultanously. Phusion Passenger will start 12 more application processes. After the idle
timeout of 10 seconds have passed, Phusion Passenger will clean up 12 application
processes, keeping 3 processes around.</p></div>
<div class="paragraph"><p>The passenger_min_instances option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>1</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerMaxInstances"></span><h4 data-comment-topic="passenger-max-instances" data-anchor="PassengerMaxInstances">7.5.3. passenger_max_instances &lt;integer&gt;</h4>
<div class="paragraph"><p><strong>This feature is only available in <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a>. It was introduced in version 3.0.0. <a href="https://www.phusionpassenger.com/download">Buy Phusion Passenger Enterprise here.</a></strong></p></div>
<div class="paragraph"><p>The maximum number of application processes that may simultaneously exist
for an application. This helps to make sure that a single application
will not occupy all available slots in the application pool.</p></div>
<div class="paragraph"><p>This value must be less than <a href="#PassengerMaxPoolSize">passenger_max_pool_size</a>. A value of 0
means that there is no limit placed on the number of processes a single application
may spawn, i.e. only the global limit of <a href="#PassengerMaxPoolSize">passenger_max_pool_size</a>
will be enforced.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>0</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip">
</td>
<td class="content">
<div class="title">Practical usage example</div>
<div class="paragraph"><p>Suppose that you’re hosting two web applications on your server, a personal
blog and an e-commerce website. You’ve set <a href="#PassengerMaxPoolSize">passenger_max_pool_size</a>
to 10. The e-commerce website is more important to you. You can then set
<em>passenger_max_instances</em> to 3 for your blog, so that it will never spawn more
than 3 processes, even if it suddenly gets a lot of traffic. Your e-commerce website
on the other hand will be free to spawn up to 10 processes if it gets a lot of traffic.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_max_instances_per_app_lt_integer_gt"></span><h4 data-comment-topic="passenger-max-instances-per-app-integer--1xhbbne" data-anchor="_passenger_max_instances_per_app_lt_integer_gt">7.5.4. passenger_max_instances_per_app &lt;integer&gt;</h4>
<div class="paragraph"><p>The maximum number of application processes that may simultaneously exist
for a single application. This helps to make sure that a single application
will not occupy all available slots in the application pool.</p></div>
<div class="paragraph"><p>This value must be less than <a href="#PassengerMaxPoolSize">passenger_max_pool_size</a>. A value of 0
means that there is no limit placed on the number of processes a single application
may use, i.e. only the global limit of <a href="#PassengerMaxPoolSize">passenger_max_pool_size</a>
will be enforced.</p></div>
<div class="paragraph"><p>This option may only occur once, in the <em>http</em> configuration block.
The default value is <em>0</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerPoolIdleTime"></span><h4 data-comment-topic="passenger-pool-idle-time-integer--xcw65o" data-anchor="PassengerPoolIdleTime">7.5.5. passenger_pool_idle_time &lt;integer&gt;</h4>
<div class="paragraph"><p>The maximum number of seconds that an application process may be idle. That is,
if an application process hasn’t received any traffic after the given number of
seconds, then it will be shutdown in order to conserve memory.</p></div>
<div class="paragraph"><p>Decreasing this value means that applications will have to be spawned
more often. Since spawning is a relatively slow operation, some visitors may
notice a small delay when they visit your Rails/Rack website. However, it will also
free up resources used by applications more quickly.</p></div>
<div class="paragraph"><p>The optimal value depends on the average time that a visitor spends on a single
Rails/Rack web page. We recommend a value of <span class="monospaced">2 * x</span>, where <span class="monospaced">x</span> is the average
number of seconds that a visitor spends on a single Rails/Rack web page. But your
mileage may vary.</p></div>
<div class="paragraph"><p>When this value is set to <em>0</em>, application processes will not be shutdown unless
it’s really necessary, i.e. when Phusion Passenger is out of worker processes
for a given application and one of the <a href="#inactive_process">inactive application processes</a> needs to
make place for another application process. Setting the value to 0 is
recommended if you’re on a non-shared host that’s only running a few
applications, each which must be available at all times.</p></div>
<div class="paragraph"><p>This option may only occur once, in the <em>http</em> configuration block.
The default value is <em>300</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">This option has no effect when you are using <a href="#flying_passenger">Flying Passenger</a>. Instead, you should configure this by passing the <span class="monospaced">--pool-idle-time</span> command line option to the Flying Passenger daemon.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_max_preloader_idle_time_lt_integer_gt"></span><h4 data-comment-topic="rails-app-spawner-idle-time-integer--1xjqe4b" data-anchor="_passenger_max_preloader_idle_time_lt_integer_gt">7.5.6. passenger_max_preloader_idle_time &lt;integer&gt;</h4>
<div class="paragraph"><p>The preloader process (explained in <a href="#spawning_methods_explained">Spawning methods explained</a>) has an idle timeout, just like the backend processes spawned by
Phusion Passenger do. That is, it will automatically shutdown if it hasn’t done
anything for a given period.</p></div>
<div class="paragraph"><p>This option allows you to set the prealoader’s idle timeout, in
seconds. A value of <em>0</em> means that it should never idle timeout.</p></div>
<div class="paragraph"><p>Setting a higher value will mean that the preloader is kept around
longer, which may slightly increase memory usage. But as long as the
preloader is running, the time to spawn a Ruby on Rails backend
process only takes about 10% of the time that is normally needed, assuming that
you’re using the <em>smart</em> <a href="#PassengerSpawnMethod">spawning method</a>. So if your
system has enough memory, is it recommended that you set this option to a high
value or to <em>0</em>.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>300</em> (5 minutes).</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_start_timeout_lt_seconds_gt"></span><h4 data-comment-topic="passenger-start-timeout-seconds--8xn504" data-anchor="_passenger_start_timeout_lt_seconds_gt">7.5.7. passenger_start_timeout &lt;seconds&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 4.0.15.</strong></p></div>
<div class="paragraph"><p>Specifies a timeout for the startup of application processes. If an application process fails to start within the timeout period then it will be forcefully killed with SIGKILL, and the error will be logged.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>90</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerConcurrencyModel"></span><h4 data-comment-topic="passenger-concurrency-model-process-thread--brcvkk" data-anchor="PassengerConcurrencyModel">7.5.8. passenger_concurrency_model &lt;process|thread&gt;</h4>
<div class="paragraph"><p><strong>This feature is only available in <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a>. It was introduced in version 4.0.0. <a href="https://www.phusionpassenger.com/download">Buy Phusion Passenger Enterprise here.</a></strong></p></div>
<div class="paragraph"><p>Specifies the I/O concurrency model that should be used for Ruby application processes. Phusion Passenger supports two concurrency models:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>process</em> - single-threaded, multi-processed I/O concurrency. Each application process only has a single thread and can only handle 1 request at a time. This is the concurrency model that Ruby applications traditionally used. It has excellent compatiblity (can work with applications that are not designed to be thread-safe) but is unsuitable for workloads in which the application has to wait for a lot of external I/O (e.g. HTTP API calls), and uses more memory because each process has a large memory overhead.
</p>
</li>
<li>
<p>
<em>thread</em> - multi-threaded, multi-processed I/O concurrency. Each application process has multiple threads (customizable via <a href="#PassengerThreadCount">passenger_thread_count</a>). This model provides much better I/O concurrency and uses less memory because threads share memory with each other within the same process. However, using this model may cause compatibility problems if the application is not designed to be thread-safe.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This option has no effect on non-Ruby applications.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>process</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerThreadCount"></span><h4 data-comment-topic="passenger-thread-count-number--1kd6ffy" data-anchor="PassengerThreadCount">7.5.9. passenger_thread_count &lt;number&gt;</h4>
<div class="paragraph"><p><strong>This feature is only available in <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a>. It was introduced in version 4.0.0. <a href="https://www.phusionpassenger.com/download">Buy Phusion Passenger Enterprise here.</a></strong></p></div>
<div class="paragraph"><p>Specifies the number of threads that Phusion Passenger should spawn per Ruby application process. This option only has effect if <a href="#PassengerConcurrencyModel">passenger_concurrency_model</a> is <em>thread</em>.</p></div>
<div class="paragraph"><p>This option has no effect on non-Ruby applications.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>1</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerMaxRequests"></span><h4 data-comment-topic="passenger-max-requests-integer--sgzint" data-anchor="PassengerMaxRequests">7.5.10. passenger_max_requests &lt;integer&gt;</h4>
<div class="paragraph"><p>The maximum number of requests an application process will process. After
serving that many requests, the application process will be shut down and
Phusion Passenger will restart it. A value of 0 means that there is no maximum:
an application process will thus be shut down when its idle timeout has been
reached.</p></div>
<div class="paragraph"><p>This option is useful if your application is leaking memory. By shutting
it down after a certain number of requests, all of its memory is guaranteed
to be freed by the operating system.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>0</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution">
</td>
<td class="content">
<div class="paragraph"><p>The <a href="#PassengerMaxRequests">passenger_max_requests</a> directive should be considered
as a workaround for misbehaving applications. It is advised that you fix the
problem in your application rather than relying on these directives as a
measure to avoid memory leaks.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerMaxRequestTime"></span><h4 data-comment-topic="passenger-max-request-time-seconds--1htog2g" data-anchor="PassengerMaxRequestTime">7.5.11. passenger_max_request_time &lt;seconds&gt;</h4>
<div class="paragraph"><p><strong>This feature is only available in <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a>. It was introduced in version 3.0.0. <a href="https://www.phusionpassenger.com/download">Buy Phusion Passenger Enterprise here.</a></strong></p></div>
<div class="paragraph"><p>The maximum amount of time, in seconds, that an application process may take
to process a request. If the request takes longer than this amount of time,
then the application process will be forcefully shut down, and possibly
restarted upon the next request. A value of 0 means that there is no time limit.</p></div>
<div class="paragraph"><p>This option is useful for preventing your application from freezing for an
indefinite period of time.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>0</em>.</p></div>
<div class="paragraph">
<div class="title">Example</div>
<p>Suppose that most of your requests are known to finish within 2 seconds.
However, there is one URI, <em>/expensive_computation</em>, which is known to take up
to 10 seconds. You can then configure Phusion Passenger as follows:</p>
</div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    listen 80;
    server_name www.example.com;
    root /webapps/my_app/public;
    passenger_enabled on;
    passenger_max_request_time 2;
    location /expensive_compuation {
        passenger_enabled on;
        passenger_max_request_time 10;
    }
}</pre>
</div>
</div>
<div class="paragraph"><p>If a request to <em>/expensive_computation</em> takes more than 10 seconds,
or if a request to any other URI takes more than 2 seconds,
then the corresponding application process will be forced to shutdown.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution">
</td>
<td class="content">
<div class="paragraph"><p>The <a href="#PassengerMaxRequestTime">passenger_max_request_time</a> directive should be
considered as a workaround for misbehaving applications. It is advised that you
fix the problem in your application rather than relying on these directives as a
measure to avoid freezing applications.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerMemoryLimit"></span><h4 data-comment-topic="passenger-memory-limit-integer--1ry7dwx" data-anchor="PassengerMemoryLimit">7.5.12. passenger_memory_limit &lt;integer&gt;</h4>
<div class="paragraph"><p><strong>This feature is only available in <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a>. It was introduced in version 3.0.0. <a href="https://www.phusionpassenger.com/download">Buy Phusion Passenger Enterprise here.</a></strong></p></div>
<div class="paragraph"><p>The maximum amount of memory that an application process may use, in megabytes.
Once an application process has surpassed its memory limit, it will process
all the requests currently present in its queue and then shut down.
A value of 0 means that there is no maximum: the application’s memory usage
will not be checked.</p></div>
<div class="paragraph"><p>This option is useful if your application is leaking memory. By shutting
it down, all of its memory is guaranteed to be freed by the operating system.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>0</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">
<div class="title">A word about permissions</div>
<div class="paragraph"><p>The <a href="#PassengerMemoryLimit">passenger_memory_limit</a> directive uses the
<span class="monospaced">ps</span> command to query memory usage information. On Linux, it further
queries <span class="monospaced">/proc</span> to obtain additional memory usage information that’s
not obtainable through <span class="monospaced">ps</span>. You should ensure that the <span class="monospaced">ps</span> works
correctly and that the <span class="monospaced">/proc</span> filesystem is accessible by the
<span class="monospaced">PassengerHelperAgent</span> process.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution">
</td>
<td class="content">
<div class="paragraph"><p>The <a href="#PassengerMaxRequests">passenger_max_requests</a> and
<a href="#PassengerMemoryLimit">passenger_memory_limit</a> directives should be considered
as workarounds for misbehaving applications. It is advised that you fix the
problem in your application rather than relying on these directives as a
measure to avoid memory leaks.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_stat_throttle_rate_lt_integer_gt"></span><h4 data-comment-topic="passenger-stat-throttle-rate-integer--xzjbry" data-anchor="_passenger_stat_throttle_rate_lt_integer_gt">7.5.13. passenger_stat_throttle_rate &lt;integer&gt;</h4>
<div class="paragraph"><p>By default, Phusion Passenger performs several filesystem checks (or, in
programmers jargon, <em>stat() calls</em>) each time a request is processed:</p></div>
<div class="ulist"><ul>
<li>
<p>
It checks which the application <a href="#PassengerStartupFile">startup files</a> are present, in order to autodetect the application type.
</p>
</li>
<li>
<p>
It checks whether <em>restart.txt</em> has changed or whether <em>always_restart.txt</em>
  exists, in order to determine whether the application should be restarted.
</p>
</li>
</ul></div>
<div class="paragraph"><p>On some systems where disk I/O is expensive, e.g. systems where the harddisk is
already being heavily loaded, or systems where applications are stored on NFS
shares, these filesystem checks can incur a lot of overhead.</p></div>
<div class="paragraph"><p>You can decrease or almost entirely eliminate this overhead by setting
<em>PassengerStatThrottleRate</em>. Setting this option to a value of <em>x</em> means that
the above list of filesystem checks will be performed at most once every <em>x</em>
seconds. Setting it to a value of <em>0</em> means that no throttling will take place,
or in other words, that the above list of filesystem checks will be performed on
every request.</p></div>
<div class="paragraph"><p>This option may be specified once, in the <span class="monospaced">http</span> configuration block. The default value is <em>10</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerPreStart"></span><h4 data-comment-topic="passenger-pre-start-url--npldeb" data-anchor="PassengerPreStart">7.5.14. passenger_pre_start &lt;url&gt;</h4>
<div class="paragraph"><p>By default, Phusion Passenger does not start any application processes until said
web application is first accessed. The result is that the first visitor of said
web application might experience a small delay as Phusion Passenger is starting
the web application on demand. If that is undesirable, then this directive can be
used to pre-started application processes during Nginx startup.</p></div>
<div class="paragraph"><p>A few things to be careful of:</p></div>
<div class="ulist"><ul>
<li>
<p>
This directive accepts the <strong>URL</strong> of the web application you want to pre-start,
  not a on/off value! This might seem a bit weird, but read on for rationale. As
  for the specifics of the URL:
</p>
<div class="ulist"><ul>
<li>
<p>
The domain part of the URL must be equal to the value of the <em>server_name</em>
    directive of the server block that defines the web application.
</p>
</li>
<li>
<p>
Unless the web application is deployed on port 80, the URL should contain
    the web application’s port number too.
</p>
</li>
<li>
<p>
The path part of the URL must point to some URI that the web application
    handles.
</p>
</li>
</ul></div>
</li>
<li>
<p>
You will probably want to combine this option with
  <a href="#PassengerMinInstances">passenger_min_instances</a> because application processes
  started with <em>passenger_pre_start</em> are subject to the usual idle timeout rules.
  See the example below for an explanation.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This option may only occur in the <em>http</em> configuration block. It may be specified
any number of times.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">This option is currently not available when using <a href="#flying_passenger">Flying Passenger</a>.</td>
</tr></table>
</div>
<div class="sect4">
<h5 id="_example_1_basic_usage">Example 1: basic usage</h5>
<div class="paragraph"><p>Suppose that you have the following web applications.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    listen 80;
    server_name foo.com;
    root /webapps/foo/public;
    passenger_enabled on;
}

server {
    listen 3500;
    server_name bar.com;
    root /webapps/bar/public;
    passenger_enabled on;
}</pre>
</div>
</div>
<div class="paragraph"><p>You want both of them to be pre-started during Nginx startup. The URL for
foo.com is <em>http://foo.com/</em> (or, equivalently, <em>http://foo.com:80/</em>) and
the URL for bar.com is <em>http://bar.com:3500/</em>. So we add two passenger_pre_start
directives, like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    listen 80;
    server_name foo.com;
    root /webapps/foo/public;
    passenger_enabled on;
}

server {
    listen 3500;
    server_name bar.com;
    root /webapps/bar/public;
    passenger_enabled on;
}

passenger_pre_start http://foo.com/;           # &lt;--- added
passenger_pre_start http://bar.com:3500/;      # &lt;--- added</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_example_2_pre_starting_apps_that_are_deployed_in_sub_uris">Example 2: pre-starting apps that are deployed in sub-URIs</h5>
<div class="paragraph"><p>Suppose that you have a web application deployed in a sub-URI <em>/store</em>, like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    listen 80;
    server_name myblog.com;
    root /webapps/wordpress;
    passenger_base_uri /store;
}</pre>
</div>
</div>
<div class="paragraph"><p>Then specify the <em>server_name</em> value followed by the sub-URI, like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    listen 80;
    server_name myblog.com;
    root /webapps/wordpress;
    passenger_base_uri /store;
}

passenger_pre_start http://myblog.com/store;    # &lt;----- added</pre>
</div>
</div>
<div class="paragraph"><p>The sub-URI <strong>must</strong> be included; if you don’t then the directive will have no effect.
The following example is wrong and won’t pre-start the store web application:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>passenger_pre_start http://myblog.com/;    # &lt;----- WRONG! Missing "/store" part.</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_example_3_combining_with_passenger_min_instances">Example 3: combining with passenger_min_instances</h5>
<div class="paragraph"><p>Application processes started with passenger_pre_start are
also subject to the idle timeout rules as specified by
<a href="#PassengerPoolIdleTime">passenger_pool_idle_time</a>! That means that by default,
the pre-started application processes for foo.com and bar.com are shut down
after a few minutes of inactivity. If you don’t want that to happen, then
you should combine passenger_pre_start with
<a href="#PassengerMinInstances">passenger_min_instances</a>, like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    listen 80;
    server_name foo.com;
    root /webapps/foo/public;
    passenger_enabled on;
    passenger_min_instances 1;      # &lt;--- added
}

server {
    listen 3500;
    server_name bar.com;
    root /webapps/bar/public;
    passenger_enabled on;
    passenger_min_instances 1;      # &lt;--- added
}

passenger_pre_start http://foo.com/;
passenger_pre_start http://bar.com:3500/;</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_so_why_a_url_why_not_just_an_on_off_flag">So why a URL? Why not just an on/off flag?</h5>
<div class="paragraph"><p>A directive that accepts a simple on/off flag is definitely more intuitive,
but due technical difficulties w.r.t. the way Nginx works, it’s very hard
to implement it like that:</p></div>
<div class="paragraph"><p>It is very hard to obtain a full list of web applications defined in the
Nginx configuration file(s). In other words, it’s hard for Phusion Passenger
to know which web applications are deployed on Nginx until a web application
is first accessed, and without such a list Phusion Passenger wouldn’t know
which web applications to pre-start. So as a compromise, we made it accept a
URL.</p></div>
</div>
<div class="sect4">
<h5 id="_what_does_phusion_passenger_do_with_the_url">What does Phusion Passenger do with the URL?</h5>
<div class="paragraph"><p>During Nginx startup, Phusion Passenger will send a dummy HEAD request to the
given URL and discard the result. In other words, Phusion Passenger simulates a
web access at the given URL. However this simulated request is always sent to
localhost, <strong>not</strong> to the IP that the domain resolves to. Suppose that bar.com
in example 1 resolves to 209.85.227.99; Phusion Passenger will
send the following HTTP request to 127.0.0.1 port 3500 (and not to 209.85.227.99
port 3500):</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>HEAD / HTTP/1.1
Host: bar.com
Connection: close</pre>
</div>
</div>
<div class="paragraph"><p>Similarly, for example 2, Phusion Passenger will send the following HTTP request
to 127.0.0.1 port 80:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>HEAD /store HTTP/1.1
Host: myblog.com
Connection: close</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_do_i_need_to_edit_etc_hosts_and_point_the_domain_in_the_url_to_127_0_0_1">Do I need to edit /etc/hosts and point the domain in the URL to 127.0.0.1?</h5>
<div class="paragraph"><p>No. See previous subsection.</p></div>
</div>
<div class="sect4">
<h5 id="_my_web_application_consists_of_multiple_web_servers_what_url_do_i_need_to_specify_and_in_which_web_server_8217_s_nginx_config_file">My web application consists of multiple web servers. What URL do I need to specify, and in which web server’s Nginx config file?</h5>
<div class="paragraph"><p>Put the web application’s <em>server_name</em> value and the server block’s
port in the URL, and put
passenger_pre_start on all machines that you want to pre-start the web application
on. The simulated web request is always sent to 127.0.0.1, with the domain name
in the URL as value for the <em>Host</em> HTTP header, so you don’t need to worry about
the request ending up at a different web server in the cluster.</p></div>
</div>
<div class="sect4">
<h5 id="_does_passenger_pre_start_support_https_urls">Does passenger_pre_start support https:// URLs?</h5>
<div class="paragraph"><p>Yes. And it does not perform any certificate validation.</p></div>
</div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_connection_handling_options"></span><h3 data-comment-topic="connection-handling-options-8jgq90" data-anchor="_connection_handling_options">7.6. Connection handling options</h3>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerSetHeader"></span><h4 data-comment-topic="passenger-set-cgi-param-cgi-environment-name-value--rx9gc0" data-anchor="PassengerSetHeader">7.6.1. passenger_set_header &lt;HTTP header name&gt; &lt;value&gt;</h4>
<div class="paragraph"><p>Sets additional HTTP headers to pass to the web application. This is comparable to ngx_http_proxy_module’s <em>proxy_set_header</em> option. Nginx variables in the value are interpolated.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    server_name www.foo.com;
    root /webapps/foo/public;
    passenger_enabled on;

    passenger_set_header X-Power-Level 9000;
    passenger_set_header X-Forwarded-For internal-router.foo.com;
}</pre>
</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/warning.png" alt="Warning">
</td>
<td class="content">
<div class="title">This configuration option is NOT inherited across contexts</div>
<div class="paragraph"><p>In each new context (e.g. in each new <em>location</em> block), you must re-specify <span class="monospaced">passenger_set_header</span>. Values set in parent contexts have no effect on subcontexts. For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>server {
    ...
    passenger_set_header X-Foo foo;

    location /users {
        passenger_enabled on;
        # !!!THIS IS WRONG!!! The 'X-Foo' header will not
        # be passed URLs beginning with /users because we didn't
        # re-specify passenger_set_header.
    }

    location /apps {
        passenger_enabled on;
        # This is correct. Here we re-specify passenger_set_header,
        # so the 'X-Foo' header will be correctly passed to URLs
        # starting with /apps.
        passenger_set_header X-Foo foo;
    }
}</pre>
</div>
</div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified multiple times.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="passenger_max_request_queue_size"></span><h4 data-comment-topic="passenger-max-request-queue-size-number--i0te1b" data-anchor="passenger_max_request_queue_size">7.6.2. passenger_max_request_queue_size &lt;number&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 4.0.15.</strong></p></div>
<div class="paragraph"><p>When all application processes are already handling their maximum number of concurrent requests, Phusion Passenger will queue all incoming requests. This option specifies the maximum size for that queue. If the queue is already at this specified limit, then Phusion Passenger will immediately send a "503 Service Unavailable" error to any incoming requests. You may use <a href="#passenger_request_queue_overflow_status_code">passenger_request_queue_overflow_status_code</a> to customize the response status.</p></div>
<div class="paragraph"><p>A value of 0 means that the queue is unbounded.</p></div>
<div class="paragraph"><p><a href="http://stackoverflow.com/questions/20402801/what-is-optimal-value-for-phusion-passenger-passengermaxrequestqueuesize">This article on StackOverflow</a> explains how the request queue works, what it means for the queue to grow or become full, why that is bad, and what you can do about it.</p></div>
<div class="paragraph"><p>You may combine this option with <a href="#passenger_intercept_errors">passenger_intercept_errors</a> and <span class="monospaced">error_page</span> to set a custom error page whenever the queue is full. In the following example, Nginx will serve /error503.html whenever the queue is full:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>passenger_intercept_errors on;
error_page 503 /error503.html;</pre>
</div>
</div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>100</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="passenger_request_queue_overflow_status_code"></span><h4 data-comment-topic="passenger-request-queue-overflow-status-code-code--1wcwuxl" data-anchor="passenger_request_queue_overflow_status_code">7.6.3. passenger_request_queue_overflow_status_code &lt;code&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 4.0.15.</strong></p></div>
<div class="paragraph"><p>This option allows you to customize the HTTP status code that is sent back when the request queue is full. See <a href="#passenger_max_request_queue_size">passenger_max_request_queue_size</a> for more information.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>503</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerStickySessions"></span><h4 data-comment-topic="passenger-sticky-sessions-on-off--lwvbxs" data-anchor="PassengerStickySessions">7.6.4. passenger_sticky_sessions &lt;on|off&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 4.0.45.</strong></p></div>
<div class="paragraph"><p>When sticky sessions are enabled, all requests that a client sends will be routed to the same originating application process, whenever possible. When sticky sessions are disabled, requests may be distributed over multiple processes, and may not necessarily be routed to the originating process, in order to balance traffic over multiple CPU cores. Because of this, sticky sessions should only be enabled in specific circumstances.</p></div>
<div class="paragraph"><p>For applications that store important state inside the process’s own memory — that is, as opposed to storing state in a distributed data store, such as the database or Redis — sticky sessions <strong>should</strong> be enabled. This is because otherwise, some requests could be routed to a different process, which stores different state data. Because processes don’t share memory with each other, there’s no way for one process to know about the state in another process, and then things can go wrong.</p></div>
<div class="paragraph"><p>One prominent example is the popular <a href="http://sockjs.org/">SockJS library</a>, which is capable of emulating WebSockets through long polling. This is implemented through two HTTP endpoints, <span class="monospaced">/SESSION_ID/xhr_stream</span> (a long polling end point which sends data from the server to the client), and <span class="monospaced">/SESSION_ID/xhr_send</span> (a normal POST endpoint which is used for sending data from the client to the server). SockJS correlates the two requests with each other through a session identifier. At the same time, in its default configuration, it stores all known session identifiers in an in-memory data structure. It is therefore important that a particular <span class="monospaced">/SESSION_ID/xhr_send</span> request is sent to the same process where the corresponding <span class="monospaced">/SESSION_ID/xhr_stream</span> request originates from; otherwise, SockJS cannot correlate the two requests, and an error occurs.</p></div>
<div class="paragraph"><p>So prominent examples where sticky sessions should (or even <strong>must</strong>) be enabled, include:</p></div>
<div class="ulist"><ul>
<li>
<p>
Applications that use the SockJS library (unless configured with a distributed data store)
</p>
</li>
<li>
<p>
Applications that use the Socket.io library (unless configured with a distributed data store)
</p>
</li>
<li>
<p>
Applications that use the faye-websocket gem (unless configured with a distributed data store)
</p>
</li>
<li>
<p>
Meteor JS applications (because Meteor uses SockJS)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Sticky sessions work through the use of a special cookie, whose name can be customized with <a href="#PassengerStickySessionsCookieName">passenger_sticky_sessions_cookie_name</a>. Phusion Passenger puts an identifier in this cookie, which tells Phusion Passenger what the originating process is. Next time the client sends a request, Phusion Passenger reads this cookie and uses the value in the cookie to route the request back to the originating process. If the originating process no longer exists (e.g. because it has crashed or restarted) then Phusion Passenger will route the request to some other process, and reset the cookie.</p></div>
<div class="paragraph"><p>If you have a load balancer in front end of Phusion Passenger + Nginx, then you must configure sticky sessions on that load balancer too. Otherwise, the load balancer could route the request to a different server.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <span class="monospaced">http</span> configuration block.
</p>
</li>
<li>
<p>
In a <span class="monospaced">server</span> configuration block.
</p>
</li>
<li>
<p>
In a <span class="monospaced">location</span> configuration block.
</p>
</li>
<li>
<p>
In an <span class="monospaced">if</span> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <span class="monospaced">off</span>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerStickySessionsCookieName"></span><h4 data-comment-topic="passenger-sticky-sessions-cookie-name-8hrox9" data-anchor="PassengerStickySessionsCookieName">7.6.5. passenger_sticky_sessions_cookie_name</h4>
<div class="paragraph"><p><strong>Introduced in version 4.0.45.</strong></p></div>
<div class="paragraph"><p>Sets the name of the <a href="#PassengerStickySessions">sticky sessions</a> cookie.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <span class="monospaced">http</span> configuration block.
</p>
</li>
<li>
<p>
In a <span class="monospaced">server</span> configuration block.
</p>
</li>
<li>
<p>
In a <span class="monospaced">location</span> configuration block.
</p>
</li>
<li>
<p>
In an <span class="monospaced">if</span> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <span class="monospaced">_passenger_route</span>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_ignore_client_abort_lt_on_off_gt"></span><h4 data-comment-topic="passenger-ignore-client-abort" data-anchor="_passenger_ignore_client_abort_lt_on_off_gt">7.6.6. passenger_ignore_client_abort &lt;on|off&gt;</h4>
<div class="paragraph"><p>Normally, when the HTTP client aborts the connection (e.g. when the user clicked on "Stop"
in the browser), the connection with the application process will be closed too. If the
application process continues to send its response, then that will result in EPIPE errors
in the application, which will be printed in the error log if the application doesn’t
handle them gracefully.</p></div>
<div class="paragraph"><p>If this option is turned on then upon client abort Phusion Passenger will continue to
read the application process’s response while discarding all the read data. This prevents
EPIPE errors but it’ll also mean the backend process will be unavailable for new requests
until it is done sending its response.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>off</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="passenger_intercept_errors"></span><h4 data-comment-topic="passenger-intercept-errors-1uvcb9x" data-anchor="passenger_intercept_errors">7.6.7. passenger_intercept_errors &lt;on|off&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 4.0.15.</strong></p></div>
<div class="paragraph"><p>Decides if Nginx will intercept responses with HTTP status codes of 400 and higher.</p></div>
<div class="paragraph"><p>By default, all responses are sent as-is from the application or from the Phusion Passenger core. If you turn this option on then Nginx will be able to handle such responses using the Nginx <span class="monospaced">error_page</span> option. Responses with status codes that do not match an <span class="monospaced">error_page</span> option are sent as-is.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>off</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_pass_header_lt_header_name_gt"></span><h4 data-comment-topic="passenger-pass-header-header-name--1cg31je" data-anchor="_passenger_pass_header_lt_header_name_gt">7.6.8. passenger_pass_header &lt;header name&gt;</h4>
<div class="paragraph"><p>Some headers generated by backend applications are not forwarded to the HTTP client,
e.g. <em>X-Accel-Redirect</em> which is directly processed by Nginx and then discarded from
the final response. This directive allows one to force Nginx to pass those headers
anyway, similar to how <em>proxy_pass_header</em> works.</p></div>
<div class="paragraph"><p>For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>location / {
   passenger_pass_header X-Accel-Redirect;
}</pre>
</div>
</div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_ignore_headers_lt_header_names_8230_gt"></span><h4 data-comment-topic="passenger-ignore-headers-header-names--12zg5oh" data-anchor="_passenger_ignore_headers_lt_header_names_8230_gt">7.6.9. passenger_ignore_headers &lt;header names…&gt;</h4>
<div class="paragraph"><p>Disables processing of certain response header fields from the application, similar to how <em>proxy_ignore_headers</em> works.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_headers_hash_bucket_size_lt_size_gt"></span><h4 data-comment-topic="passenger-headers-hash-bucket-size-size--zx1rwf" data-anchor="_passenger_headers_hash_bucket_size_lt_size_gt">7.6.10. passenger_headers_hash_bucket_size &lt;size&gt;</h4>
<div class="paragraph"><p>Sets the bucket size of the hash tables used by the <a href="#PassengerSetHeader">passenger_set_header</a> directive. The details of setting up hash tables are can be found in <a href="http://nginx.org/en/docs/hash.html">the Nginx documentation</a>.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>64</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_headers_hash_max_size_lt_size_gt"></span><h4 data-comment-topic="passenger-headers-hash-max-size-size--1vl0i9u" data-anchor="_passenger_headers_hash_max_size_lt_size_gt">7.6.11. passenger_headers_hash_max_size &lt;size&gt;</h4>
<div class="paragraph"><p>Sets the maximum size of the hash tables used by the <a href="#PassengerSetHeader">passenger_set_header</a> directive. The details of setting up hash tables are can be found in <a href="http://nginx.org/en/docs/hash.html">the Nginx documentation</a>.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>512</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="passenger_buffer_response"></span><h4 data-comment-topic="passenger-buffer-response" data-anchor="passenger_buffer_response">7.6.12. passenger_buffer_response &lt;on|off&gt;</h4>
<div class="paragraph"><p>When turned on, application-generated responses are buffered by Nginx. Buffering will
happen in memory and also on disk if the response is larger than a certain threshold.</p></div>
<div class="paragraph"><p>Before we proceed with explaining this configuration option, we want to state the following to avoid confusion. If you use Phusion Passenger for Nginx, there are in fact two response buffering systems active:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The Nginx response buffering system. <span class="monospaced">passenger_buffer_response</span> turns this on or off.
</p>
</li>
<li>
<p>
The Phusion Passenger response buffering system, a.k.a. <em>real-time disk-backed response buffering</em>. This buffering system is always on, regardless of the value of <span class="monospaced">passenger_buffer_response</span>, but its behavior can be tweaked with <a href="#PassengerResponseBufferHighWatermark">passenger_response_buffer_high_watermark</a>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Response buffering is useful because it protects against slow HTTP clients that do not read responses immediately or quickly enough. Buffering prevents such slow clients from blocking web applications that have limited concurrency. Because Phusion Passenger’s response buffering is always turned on, you are always protected. Therefore, <span class="monospaced">passenger_buffer_response</span> is off by default, and you never should have to turn it on.</p></div>
<div class="paragraph"><p>If for whatever reason you want to turn Nginx-level response buffering on, you can do so with this option.</p></div>
<div class="paragraph"><p>Nginx’s response buffering works differently from Phusion Passenger’s. Nginx’s buffering system buffers the entire response before attempting to send it to the client, while Phusion Passenger’s attempts to send the data to the client immediately. Therefore, if you turn on <span class="monospaced">passenger_buffer_response</span>, you may interfere with applications that want to stream responses to the client.</p></div>
<div class="paragraph"><p>How does response buffering - whether it’s done by Nginx or by Phusion Passenger - exactly protect against slow clients?
Consider an HTTP client that’s on a dial-up modem link, and your
application process generates a 2 MB response. If the response is not buffered
then your application process will be blocked until the entire 2 MB has been
sent out to the HTTP client. This disallows your application process to do any useful
work in the mean time. By buffering responses, Phusion Passenger or Nginx will read
the application response as quickly as possible and will take care of forwarding the data
to slow clients.</p></div>
<div class="paragraph"><p>So keep in mind that enabling <span class="monospaced">passenger_buffering_response</span> will make streaming responses
impossible. Consider for example this piece of Rails code:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>render :text =&gt; lambda { |response, output|
    10.times do |i|
        output.write("entry #{i}\n")
        output.flush
        sleep 1
    end
}</pre>
</div>
</div>
<div class="paragraph"><p>…or this piece of Rack code:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>class Response
    def each
        10.times do |i|
            yield("entry #{i}\n")
            sleep 1
        end
    end
end

app = lambda do |env|
    [200, { "Content-Type" =&gt; "text/plain" }, Response.new]
end</pre>
</div>
</div>
<div class="paragraph"><p>When <span class="monospaced">passenger_buffer_response</span> is turned on, Nginx will wait until
the application is done sending the entire response before forwarding it
to the client. The client will not receive anything for 10 seconds,
after which it receives the entire response at once.
When <span class="monospaced">passenger_buffer_response</span> is turned off, it works as expected: the client
receives an "entry X" message every second for 10 seconds.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>off</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerResponseBufferHighWatermark"></span><h4 data-comment-topic="passenger-response-buffer-high-watermark-bytes--ranajv" data-anchor="PassengerResponseBufferHighWatermark">7.6.13. passenger_response_buffer_high_watermark &lt;bytes&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 5.0.0.</strong></p></div>
<div class="paragraph"><p>As explained in <a href="#passenger_buffer_response">passenger_buffer_response</a>, Phusion Passenger has two response buffering mechanisms. This option configures the maximum size of the real-time disk-backed response buffering system. If the buffer is full, the application will be blocked until the client has fully read the buffer.</p></div>
<div class="paragraph"><p>This buffering system has a default size of <strong>128 MB</strong> (134217728 bytes). This default value is large enough to prevent most applications from blocking on slow clients, but small enough to prevent broken applications from filling up the hard disk.</p></div>
<div class="paragraph"><p>You can’t disable real-time disk-backed response buffering, but you can set the buffer size to a small value, which is effectively the same as disabling it.</p></div>
<div class="paragraph"><p>Most of the time, you won’t need to tweak this value. But there is one good use case where you may want set this option to a low value: if you are streaming a large response, but want to detect client disconnections as soon as possible. If the buffer size is larger than your response size, then Phusion Passenger will read and buffer the response as fast as it can, offloading the application as soon as it can, thereby preventing the application from detecting client disconnects. But if the buffer size is sufficiently small (say, 64 KB), then your application will effectively output response data at the same speed as the client reads it, allowing you to detect client disconnects almost immediately. This is also a down side, because many slow clients blocking your application can result in a denial of service, so use this option with care.</p></div>
<div class="paragraph"><p>If your application outputs responses larger than 128 MB and you are not interested in detecting client disconnects as soon as possible, then you should raise this value, or set it to 0.</p></div>
<div class="paragraph"><p>A value of 0 means that the buffer size is unlimited.</p></div>
<div class="paragraph"><p>This option may only occur once, in the <em>http</em> configuration block. The default value is <em>134217728</em> (128 MB).</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_buffer_size"></span><h4 data-comment-topic="passenger-buffer-size-1jfkq87" data-anchor="_passenger_buffer_size">7.6.14. passenger_buffer_size</h4>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_buffers"></span><h4 data-comment-topic="passenger-busy-buffers" data-anchor="_passenger_buffers">7.6.15. passenger_buffers</h4>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_busy_buffers_size"></span><h4 data-comment-topic="passenger-busy-buffer-size-124sj61" data-anchor="_passenger_busy_buffers_size">7.6.16. passenger_busy_buffers_size</h4>
<div class="paragraph"><p>These options have the same effect as ngx_http_proxy_module’s similarly named options.
They can be used to modify the maximum allowed HTTP header size.</p></div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_logging_and_debugging_options"></span><h3 data-comment-topic="logging-and-debugging-options-14e91ni" data-anchor="_logging_and_debugging_options">7.7. Logging and debugging options</h3>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerLogLevel"></span><h4 data-comment-topic="passenger-log-level-integer--17snhon" data-anchor="PassengerLogLevel">7.7.1. passenger_log_level &lt;integer&gt;</h4>
<div class="paragraph"><p>This option allows one to specify how much information Phusion Passenger should
write to the Nginx error log file. A higher log level value means that more
information will be logged.</p></div>
<div class="paragraph"><p>Possible values are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>0</em> (crit): Show only critical errors which would cause Phusion Passenger to abort.
</p>
</li>
<li>
<p>
<em>1</em> (error): Also show non-critical errors — errors that do not cause Phusion Passenger to abort.
</p>
</li>
<li>
<p>
<em>2</em> (warn): Also show warnings. These are not errors, and Phusion Passenger continues to operate correctly, but they might be an indication that something is wrong with the system.
</p>
</li>
<li>
<p>
<em>3</em> (notice): Also show important informational messages. These give you a high-level overview of what Phusion Passenger is doing.
</p>
</li>
<li>
<p>
<em>4</em> (info): Also show less important informational messages. These messages show more details about what Phusion Passenger is doing. They’re high-level enough to be readable by users.
</p>
</li>
<li>
<p>
<em>5</em> (debug): Also show the most important debugging information. Reading this information requires some system or programming knowledge, but the information shown is typically high-level enough to be understood by experienced system administrators.
</p>
</li>
<li>
<p>
<em>6</em> (debug2): Show more debugging information. This is typically only useful for developers.
</p>
</li>
<li>
<p>
<em>7</em> (debug3): Show even more debugging information.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This option may only occur once, in the <em>http</em> configuration block. The default is <em>3</em>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerLogFile"></span><h4 data-comment-topic="passenger-debug-log-file-filename--21ubaj" data-anchor="PassengerLogFile">7.7.2. passenger_log_file &lt;filename&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 5.0.5.</strong></p></div>
<div class="paragraph"><p>By default Phusion Passenger log messages are written to the global web server error log. With this option, you can have those messages logged to a different file instead.</p></div>
<div class="paragraph"><p>This option may only occur once, in the <em>http</em> configuration block.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">This option has no effect when you are using <a href="#flying_passenger">Flying Passenger</a>. Instead, you should configure this by passing the <span class="monospaced">--log-file</span> command line option to the Flying Passenger daemon.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passengerfiledescriptorlogfile_lt_filename_gt"></span><h4 data-comment-topic="passengerfiledescriptorlogfile-filename--bqbga8" data-anchor="_passengerfiledescriptorlogfile_lt_filename_gt">7.7.3. PassengerFileDescriptorLogFile &lt;filename&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 5.0.5.</strong></p></div>
<div class="paragraph"><p>Log file descriptor debug tracing messages to the given file.</p></div>
<div class="paragraph"><p>Phusion Passenger has the ability to log all file descriptors that it opens and closes. These logs are useful to the Phusion Passenger developers for the purpose of analyzing file descriptor leaks.</p></div>
<div class="paragraph"><p>File descriptor activity is logged as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
If <span class="monospaced">passenger_file_descriptor_log_file</span> is not set, then file descriptor activity is logged to the <a href="#PassengerLogFile">main log file</a>, but only if the <a href="#PassengerLogLevel">log level</a> is 5 (debug) or higher.
</p>
</li>
<li>
<p>
If <span class="monospaced">passenger_file_descriptor_log_file</span> is set, then file descriptor activity is logged to the specified file, regardless of the log level.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This option may only occur once, in the <em>http</em> configuration block.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">This option has no effect when you are using <a href="#flying_passenger">Flying Passenger</a>. Instead, you should configure this by passing the <span class="monospaced">--file-descriptor-log-file</span> command line option to the Flying Passenger daemon.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_debugger_lt_on_off_gt"></span><h4 data-comment-topic="passenger-debugger-on-off--1wkuq85" data-anchor="_passenger_debugger_lt_on_off_gt">7.7.4. passenger_debugger &lt;on|off&gt;</h4>
<div class="paragraph"><p><strong>This feature is only available in <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a>. It was introduced in version 3.0.0. <a href="https://www.phusionpassenger.com/download">Buy Phusion Passenger Enterprise here.</a></strong></p></div>
<div class="paragraph"><p>Turns support for application debugging on or off. In case of Ruby applications,
turning this option on will cause them to load the <span class="monospaced">ruby-debug</span> gem (when on Ruby 1.8),
the <span class="monospaced">debugger</span> gem (when on Ruby 1.9) or the <span class="monospaced">byebug</span> gem (when on Ruby 2.0). If you’re
using Bundler, you should add this to your Gemfile:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gem 'ruby-debug', :platforms =&gt; :ruby_18
gem 'debugger', :platforms =&gt; :ruby_19
gem 'byebug', :platforms =&gt; :ruby_20</pre>
</div>
</div>
<div class="paragraph"><p>Once debugging is turned on, you can use the command <span class="monospaced">passenger-irb --debug &lt;PID&gt;</span> to attach an rdebug console to the application process with the given PID. Attaching will succeed once the application process executes a <span class="monospaced">debugger</span> command.</p></div>
<div class="paragraph"><p>This option may occur in the following places:</p></div>
<div class="ulist"><ul>
<li>
<p>
In the <em>http</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>server</em> configuration block.
</p>
</li>
<li>
<p>
In a <em>location</em> configuration block.
</p>
</li>
<li>
<p>
In an <em>if</em> configuration scope.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In each place, it may be specified at most once. The default value is <em>off</em>.</p></div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_advanced_options"></span><h3 data-comment-topic="advanced-options-hnuhqz" data-anchor="_advanced_options">7.8. Advanced options</h3>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerInstanceRegistryDir"></span><h4 data-comment-topic="passenger-instance-registry-dir-directory--1jl6zij" data-anchor="PassengerInstanceRegistryDir">7.8.1. passenger_instance_registry_dir &lt;directory&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 5.0.0.</strong></p></div>
<div class="paragraph"><p>Specifies the directory that Phusion Passenger should use for registering its current instance.</p></div>
<div class="paragraph"><p>When Phusion Passenger starts up, it creates a temporary directory inside the <em>instance registry directory</em>. This temporary directory is called the <em>instance directory</em>. It contains all sorts of files that are important to that specific running Phusion Passenger instance, such as Unix domain socket files so that all the different Phusion Passenger processes can communicate with each other. Command line tools such as <span class="monospaced">passenger-status</span> use the files in this directory in order to query Phusion Passenger’s status.</p></div>
<div class="paragraph"><p>It is therefore important that, while Phusion Passenger is working, the instance directory is never removed or tampered with. However, the default path for the instance registry directory is the system’s temporary directory, and some systems may run background jobs that periodically clean this directory. If this happens, and the files inside the instance directory are removed, then it will cause Phusion Passenger to malfunction: Phusion Passenger won’t be able to communicate with its own processes, and you will see all kinds of connection errors in the log files. This malfunction can only be recovered from by restarting Nginx. You can prevent such cleaning background jobs from interfering by setting this option to a different directory.</p></div>
<div class="paragraph"><p>This option is also useful if the partition that the temporary directory lives on doesn’t have enough disk space.</p></div>
<div class="paragraph"><p>The instance directory is automatically removed when Nginx shuts down.</p></div>
<div class="paragraph"><p>This option may be specified once, in the <span class="monospaced">http</span> configuration block. The default value is as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
If you are on Red Hat and CentOS, and installed Passenger through the RPMs provided by Phusion, then the default value is <span class="monospaced">/var/run/passenger-instreg</span>.
</p>
</li>
<li>
<p>
Otherwise, the default value is the value of the <span class="monospaced">$TMPDIR</span> environment variable. Or, if <span class="monospaced">$TMPDIR</span> is not set, <span class="monospaced">/tmp</span>.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">This option has no effect when you are using <a href="#flying_passenger">Flying Passenger</a>. Instead, you should configure this by passing the <span class="monospaced">--instance-registry-dir</span> command line option to the Flying Passenger daemon.</td>
</tr></table>
</div>
<div class="paragraph">
<div class="title">Note regarding command line tools</div>
<p>Some Phusion Passenger command line administration tools, such as <span class="monospaced">passenger-status</span>, must know what Phusion Passenger’s instance registry directory is in order to function properly. You can pass the directory through the <span class="monospaced">PASSENGER_INSTANCE_REGISTRY_DIR</span> environment variable or the <span class="monospaced">TMPDIR</span> environment variable.</p>
</div>
<div class="paragraph"><p>For example, if you set <em>passenger_instance_registry_dir</em> to <em>/my_temp_dir</em>, then invoke <span class="monospaced">passenger-status</span> after you’ve set the <span class="monospaced">PASSENGER_INSTANCE_REGISTRY_DIR</span>, like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>export PASSENGER_INSTANCE_REGISTRY_DIR=/my_temp-dir
sudo -E passenger-status</pre>
</div>
</div>
<div class="paragraph"><p>Notes regarding the above example:</p></div>
<div class="ulist"><ul>
<li>
<p>
The -E option tells <em>sudo</em> to preserve environment variables.
</p>
</li>
<li>
<p>
If Phusion Passenger is installed through an RVM Ruby, then you must use <span class="monospaced">rvmsudo</span> instead of <span class="monospaced">sudo</span>.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="PassengerDataBufferDir"></span><h4 data-comment-topic="passenger-data-buffer-dir-directory--1isg9cm" data-anchor="PassengerDataBufferDir">7.8.2. passenger_data_buffer_dir &lt;directory&gt;</h4>
<div class="paragraph"><p><strong>Introduced in version 5.0.0.</strong></p></div>
<div class="paragraph"><p>By default, Phusion Passenger buffers large web application responses. This prevents slow HTTP clients from blocking web applications by reading responses very slowly. This feature is also known as <em>real-time disk-backed response buffering</em>.</p></div>
<div class="paragraph"><p>By default, such buffers are stored in the directory given by the <span class="monospaced">$TMPDIR</span> environment variable, or (if <span class="monospaced">$TMPDIR</span> is not set) the <span class="monospaced">/tmp</span> directory. This configuration directive allows you to specify a different directory.</p></div>
<div class="paragraph"><p>Changing this option is especially useful if the partition that the default directory lives on doesn’t have enough disk space.</p></div>
<div class="paragraph"><p>If you’ve specified such a directory (as opposed to using Phusion Passenger’s default) then you <strong>must</strong> ensure that this directory exists.</p></div>
<div class="paragraph"><p>This option may be specified once, in the <span class="monospaced">http</span> configuration block.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">This option has no effect when you are using <a href="#flying_passenger">Flying Passenger</a>. Instead, you should configure this by passing the <span class="monospaced">--data-buffer-dir</span> command line option to the Flying Passenger daemon.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_fly_with_lt_socket_filename_gt"></span><h4 data-comment-topic="passenger-fly-with-socket-filename--1amd1xn" data-anchor="_passenger_fly_with_lt_socket_filename_gt">7.8.3. passenger_fly_with &lt;socket filename&gt;</h4>
<div class="paragraph"><p><strong>This feature is only available in <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a>. It was introduced in version 4.1.0. <a href="https://www.phusionpassenger.com/download">Buy Phusion Passenger Enterprise here.</a></strong></p></div>
<div class="paragraph"><p>Enables <a href="#flying_passenger">Flying Passenger</a> mode, and configures Nginx to connect to the Flying Passenger daemon that’s listening on the given socket filename.</p></div>
<div class="paragraph"><p>This option may only occur once, in the <em>http</em> configuration block. When not set, Flying Passenger is not enabled.</p></div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_deprecated_or_removed_options"></span><h3 data-comment-topic="deprecated-options-1dtzo0g" data-anchor="_deprecated_or_removed_options">7.9. Deprecated or removed options</h3>
<div class="paragraph"><p>The following options have been deprecated or removed. Some are still supported for backwards
compatibility reasons.</p></div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_rails_spawn_method"></span><h4 data-comment-topic="rails-spawn-method-17vdnpt" data-anchor="_rails_spawn_method">7.9.1. rails_spawn_method</h4>
<div class="paragraph"><p>Deprecated in favor of <a href="#PassengerSpawnMethod">passenger_spawn_method</a>.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_passenger_debug_log_file"></span><h4 data-comment-topic="passenger-debug-log-file-1aqru34" data-anchor="_passenger_debug_log_file">7.9.2. passenger_debug_log_file</h4>
<div class="paragraph"><p>This option has been renamed in version 5.0.5 to <a href="#PassengerLogFile">passenger_log_file</a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="troubleshooting"></span><h2 data-comment-topic="troubleshooting-1pt0c76" data-anchor="troubleshooting">8. Troubleshooting</h2>
<div class="sectionbody">
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_generic_troubleshooting_tips"></span><h3 data-comment-topic="generic-troubleshooting-tips-xhe4nu" data-anchor="_generic_troubleshooting_tips">8.1. Generic troubleshooting tips</h3>
<div class="paragraph"><p>One of the first things you should do upon encountering a problem, is to check
the global Nginx error log file. This is one specified by the <span class="monospaced">error_log</span> directive in the main context (<strong>not</strong> the one inside the <span class="monospaced">http</span> context). The file is typically located in /var/log/nginx/error.log.
This log file contains:</p></div>
<div class="ulist"><ul>
<li>
<p>
Phusion Passenger error messages.
</p>
</li>
<li>
<p>
Everything that the application writes to STDERR. This typically consists of errors that the application encounters during startup, but not errors that it encounters when it’s handling requests.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If you’re using Ruby on Rails, then you should also check out <span class="monospaced">log/development.log</span> and <span class="monospaced">log/production.log</span>. When an error occurs during request handling, it is typically logged here. This file does <strong>not</strong> contain errors that Rails encounters during startup.</p></div>
<div class="paragraph"><p>Finally, you should be aware that Phusion Passenger runs your application under the <em>production</em> environment by default, not <em>development</em>. You can change this using the
<a href="#RailsEnv">rails_env</a>
option.</p></div>
<div class="paragraph"><p>If neither the logs nor this troubleshooting guide can help you, then please check out our <a href="#where_to_get_support">support resources</a>.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_why_does_the_first_request_take_a_long_time"></span><h3 data-comment-topic="why-does-the-first-request-take-a-long-time--1knj9fp" data-anchor="_why_does_the_first_request_take_a_long_time">8.2. Why does the first request take a long time?</h3>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>Symptoms</strong>
</dt>
<dd>
<p>
        The first request to your application takes more time than usual. Subsequent requests have the normal speed.
</p>
</dd>
<dt class="hdlist1">
<strong>Cause</strong>
</dt>
<dd>
<p>
        Phusion Passenger starts your application the first time it is accessed, not during web server startup. Some applications can take several seconds to start. If you’re using Ruby on Rails, then needing 10 seconds to start your application is normal. On slow or heavily loaded servers, or in case of large and heavy applications, the startup time may be even longer.
</p>
</dd>
<dt class="hdlist1">
<strong>Solution</strong>
</dt>
<dd>
<p>
        Use the
<a href="#PassengerPreStart">passenger_pre_start</a>
configuration option.
</p>
</dd>
</dl></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_upon_accessing_the_web_app_nginx_reports_a_permission_denied_error"></span><h3 data-comment-topic="upon-accessing-the-web-app-nginx-reports-a-permission-denied-error-1wgatlk" data-anchor="_upon_accessing_the_web_app_nginx_reports_a_permission_denied_error">8.3. Upon accessing the web app, Nginx reports a "Permission denied" error</h3>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>Symptoms</strong>
</dt>
<dd>
<p>
        A typical error message looks like this:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>2013/10/21 17:16:03 [alert] 98687#0: *1 Cannot stat
'/Users/phusion/Sites/rack.test/config.ru': Permission denied (errno=13); This
error means that the Nginx worker process (PID 99064, running as UID 70) does
not have permission to access this file. Please read the manual to learn how to
fix this problem: section 'Troubleshooting' -&gt; 'Upon accessing the web app,
Nginx reports a "Permission denied" error'; Extra info, client: 127.0.0.1,
server: www.foo.com, request: "GET / HTTP/1.1", host: "www.foo.com"</pre>
</div>
</div>
</dd>
<dt class="hdlist1">
<strong>Cause</strong>
</dt>
<dd>
<p>
        Phusion Passenger tries to access your application directory in order to find out what language it’s written in. This access is initiated from inside an Nginx worker process. This error indicates that the Nginx worker process does not have the proper permissions to access your application’s root directory.
</p>
</dd>
<dt class="hdlist1">
<strong>Solution</strong>
</dt>
<dd>
<p>
        You need to relax permissions to that the Nginx worker process can access your application directory, by making the directory group- and world-<strong>executable</strong>:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo chmod g+x,o+x /Users/phusion/Sites/rack.test</pre>
</div>
</div>
<div class="paragraph"><p>You <strong>also</strong> need to ensure that all parent directories are also <em>executable</em> by the Nginx process:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo chmod g+x,o+x /Users/phusion/Sites
sudo chmod g+x,o+x /Users/phusion
sudo chmod g+x,o+x /Users</pre>
</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">
<div class="title">Why <em>executable</em> permission and not <em>readable</em>?</div>On Unix, the <em>executable</em> permission on directories dictates whether a process is allowed to <strong>access</strong> files or subdirectories within that directory. The <em>readable</em> permission dictates whether a process is allowed to see what files are inside the directory, but does not necessarily allow access to them. You can learn more at <a href="http://en.wikipedia.org/wiki/File_system_permissions#Permissions">Wikipedia</a>.</td>
</tr></table>
</div>
</dd>
</dl></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_i_get_command_not_found_when_running_a_phusion_passenger_command_through_sudo"></span><h3 data-comment-topic="i-get-command-not-found-when-running-a-phusion-passenger-command-through-sudo-10fzwno" data-anchor="_i_get_command_not_found_when_running_a_phusion_passenger_command_through_sudo">8.4. I get "command not found" when running a Phusion Passenger command through sudo</h3>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>Symptoms</strong>
</dt>
<dd>
<p>
        Phusion Passenger commands can be found as a normal user, but not when run through sudo:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>$ passenger-status
...some output, but no "command not found" error...
$ passenger-install-apache2-module
...some output, but no "command not found" error...
$ sudo passenger-status
sudo: passenger-status: command not found
$ sudo passenger-install-apache2-module
sudo: passenger-install-apache2-module: command not found</pre>
</div>
</div>
</dd>
<dt class="hdlist1">
<strong>Cause</strong>
</dt>
<dd>
<p>
        The operating system looks up commands using <a href="#the_path_env_var">the PATH environment variable</a>. However, sudo resets all environment variables to a default value, dictated by sudo. If Phusion Passenger was installed to a location that is not in the default sudo PATH value, then sudo will not be able to find the Phusion Passenger commands.
</p>
<div class="paragraph"><p>In addition, if you installed Phusion Passenger using a Ruby interpreter that was installed through RVM, then you <strong>must</strong> use rvmsudo instead of sudo. As a rule, when you’re an RVM user, always use rvmsudo instead of sudo.</p></div>
</dd>
<dt class="hdlist1">
<strong>Solution</strong>
</dt>
<dd>
<p>
        Execute the command using its full path. You can use <span class="monospaced">which</span> as a normal user to lookup the full path:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>$ which passenger-status
/somewhere/bin/passenger-status</pre>
</div>
</div>
<div class="paragraph"><p>Next, run full path of the command using either sudo or rvmsudo:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ sudo /somewhere/bin/passenger-status

# -OR, if you're using RVM:-

$ rvmsudo /somewhere/bin/passenger-status</pre>
</div>
</div>
</dd>
<dt class="hdlist1">
<strong>Recommended reading</strong>
</dt>
<dd>
<p>
        When using sudo, you will probably run into similar "command not found" issues in the future, with components other than Phusion Passenger. We <strong>strongly recommend</strong> you to <a href="#about_environment_variables">learn about environment variables</a> so that you know what to do in the future.
</p>
</dd>
</dl></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_the_application_thinks_its_not_on_ssl_even_though_it_is"></span><h3 data-comment-topic="the-application-thinks-its-not-on-ssl-even-though-it-is-1e2m21h" data-anchor="_the_application_thinks_its_not_on_ssl_even_though_it_is">8.5. The application thinks its not on SSL even though it is</h3>
<div class="paragraph"><p>Rails and many other frameworks infers whether it’s running on SSL through the CGI
environment variable <span class="monospaced">HTTPS</span>. This variable is <strong>only</strong> set if you set <span class="monospaced">ssl on</span>.
Setting just <span class="monospaced">listen 443 ssl</span> is not enough.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_ruby_on_rails_specific_troubleshooting"></span><h3 data-comment-topic="ruby-on-rails-specific-troubleshooting-n8u5u1" data-anchor="_ruby_on_rails_specific_troubleshooting">8.6. Ruby on Rails-specific troubleshooting</h3>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_the_about_your_application_8217_s_environment_link_does_not_work"></span><h4 data-comment-topic="the-about-your-application-s-environment-link-does-not-work-9p7b2g" data-anchor="_the_about_your_application_8217_s_environment_link_does_not_work">8.6.1. The "About your application’s environment" link does not work</h4>
<div class="paragraph"><p>The "About your application’s environment" link only works if the application is started in the <em>development</em> environment. Phusion Passenger starts the application in the <em>production</em> environment by default. Please use
<a href="#RailsEnv">rails_env</a>
to change it.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_the_rails_application_reports_that_it_8217_s_unable_to_start_because_of_a_permission_error"></span><h4 data-comment-topic="the-rails-application-reports-that-it-s-unable-to-start-because-of-a-permission-error-58ww8s" data-anchor="_the_rails_application_reports_that_it_8217_s_unable_to_start_because_of_a_permission_error">8.6.2. The Rails application reports that it’s unable to start because of a permission error</h4>
<div class="paragraph"><p>Please check whether your Rails application’s folder has the correct
permissions. By default, Rails applications are started as the owner of the
file <span class="monospaced">config.ru</span>, except if the file is owned by root. If the
file is owned by root, then the Rails application will be started as <em>nobody</em>
(or as the user specify by <a href="#RailsDefaultUser">RailsDefaultUser</a>, if that’s
specified).</p></div>
<div class="paragraph"><p>Please read <a href="#user_switching">User switching (security)</a> for details.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_the_rails_application_8217_s_log_file_is_not_being_written_to"></span><h4 data-comment-topic="the-rails-application-s-log-file-is-not-being-written-to-9m2i5h" data-anchor="_the_rails_application_8217_s_log_file_is_not_being_written_to">8.6.3. The Rails application’s log file is not being written to</h4>
<div class="paragraph"><p>There are a couple things that you should be aware of:</p></div>
<div class="ulist"><ul>
<li>
<p>
By default, Phusion Passenger runs Rails applications in <em>production</em> mode,
  so please be sure to check <span class="monospaced">production.log</span> instead of <span class="monospaced">development.log</span>.
</p>
<div class="paragraph"><p>See
<a href="#RailsEnv">rails_env</a>
for configuration.
- By default, Phusion Passenger runs Rails applications as the owner of <span class="monospaced">config.ru</span>.
  So the log file can only be written to if that user has write permission to the
  log file. Please <span class="monospaced">chmod</span> or <span class="monospaced">chown</span> your log file accordingly.</p></div>
<div class="paragraph"><p>See <a href="#User_switching">User switching (security)</a> for details.</p></div>
</li>
</ul></div>
<div class="paragraph"><p>If you’re using a RedHat-derived Linux distribution (such as Fedora or CentOS)
then it is <a href="http://code.google.com/p/phusion-passenger/issues/detail?id=4">possible
that SELinux is interfering</a>. RedHat’s SELinux policy only allows Apache to read/write
directories that have the <em>httpd_sys_content_t</em> security context. Please run the
following command to give your Rails application folder that context:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>chcon -R -h -t httpd_sys_content_t /path/to/your/rails/app</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_analysis_and_system_maintenance"></span><h2 data-comment-topic="analysis-and-system-maintenance-1nnlnj8" data-anchor="_analysis_and_system_maintenance">9. Analysis and system maintenance</h2>
<div class="sectionbody">
<div class="paragraph"><p>Phusion Passenger provides a set of tools, which are useful for system analysis,
maintenance and troubleshooting.</p></div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_inspecting_memory_usage"></span><h3 data-comment-topic="inspecting-memory-usage-1k6y8v0" data-anchor="_inspecting_memory_usage">9.1. Inspecting memory usage</h3>
<div class="paragraph"><p>Process inspection tools such as <span class="monospaced">ps</span> and <span class="monospaced">top</span> are useful, but they
<a href="http://groups.google.com/group/phusion-passenger/msg/1fd1c233456d3180">rarely show the correct memory usage</a>.
The real memory usage is usually lower than what <span class="monospaced">ps</span> and <span class="monospaced">top</span> report.</p></div>
<div class="paragraph"><p>There are many technical reasons why this is so, but an explanation is beyond
the scope of this Users Guide. We kindly refer the interested reader to
operating systems literature about <em>virtual memory</em> and <em>copy-on-write</em>.</p></div>
<div class="paragraph"><p>The tool <span class="monospaced">passenger-memory-stats</span> allows one to easily analyze Phusion Passenger’s
and the web server’s real memory usage. For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[bash@localhost root]# passenger-memory-stats
------------- Apache processes --------------.
PID    PPID  Threads  VMSize   Private  Name
---------------------------------------------.
5947   1     9        90.6 MB  0.5 MB   /usr/sbin/apache2 -k start
5948   5947  1        18.9 MB  0.7 MB   /usr/sbin/fcgi-pm -k start
6029   5947  1        42.7 MB  0.5 MB   /usr/sbin/apache2 -k start
6030   5947  1        42.7 MB  0.5 MB   /usr/sbin/apache2 -k start
6031   5947  1        42.5 MB  0.3 MB   /usr/sbin/apache2 -k start
6033   5947  1        42.5 MB  0.4 MB   /usr/sbin/apache2 -k start
6034   5947  1        50.5 MB  0.4 MB   /usr/sbin/apache2 -k start
23482  5947  1        82.6 MB  0.4 MB   /usr/sbin/apache2 -k start
### Processes: 8
### Total private dirty RSS: 3.50 MB

----------- Nginx processes ------------.
PID    PPID   VMSize     Resident  Name
----------------------------------------.
51766  51764  82.7 MB    3.9 MB    nginx: master process ./objs/nginx
51773  51766  82.9 MB    0.9 MB    nginx: worker process

--------- Passenger processes ---------.
PID    Threads  VMSize   Private  Name
---------------------------------------.
6026   1        10.9 MB  4.7 MB   Passenger spawn server
23481  1        26.7 MB  3.0 MB   Passenger FrameworkSpawner: 2.0.2
23791  1        26.8 MB  2.9 MB   Passenger ApplicationSpawner: /var/www/projects/app1-foobar
23793  1        26.9 MB  17.1 MB  Rails: /var/www/projects/app1-foobar
### Processes: 4
### Total private dirty RSS: 27.76 M</pre>
</div>
</div>
<div class="paragraph"><p>The <em>Private</em> or <em>private dirty RSS</em> field shows the <strong>real</strong> memory usage of processes. Here,
we see that all the Apache and Nginx worker processes only take less than 1 MB memory each.
This is a lot less than the 50-80 MB-ish memory usage as shown in the <em>VMSize</em> column
(which is what a lot of people think is the real memory usage, but is actually not).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">Private dirty RSS reporting only works on Linux. Unfortunately other operating systems
don’t provide facilities for determining processes' private dirty RSS. On non-Linux systems,
the Resident Set Size is reported instead.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_inspecting_phusion_passenger_8217_s_internal_status"></span><h3 data-comment-topic="inspecting-phusion-passenger-s-internal-status-v36wbc" data-anchor="_inspecting_phusion_passenger_8217_s_internal_status">9.2. Inspecting Phusion Passenger’s internal status</h3>
<div class="paragraph"><p>One can inspect Phusion Passenger’s internal status with the tool <span class="monospaced">passenger-status</span>.
This tool must typically be run as root. For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[bash@localhost root]# passenger-status
----------- General information -----------
max      = 6
count    = 1
active   = 0
inactive = 1

----------- Domains -----------
/var/www/projects/app1-foobar:
  PID: 9617      Sessions: 0    Processed: 7       Uptime: 2m 23s</pre>
</div>
</div>
<div class="paragraph"><p>The <em>general information</em> section shows the following information:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
max
</dt>
<dd>
<p>
The maximum number of application instances that Phusion Passenger will
spawn. This equals the value given for <a href="#PassengerMaxPoolSize">PassengerMaxPoolSize</a> (Apache)
or <a href="#PassengerMaxPoolSize">passenger_max_pool_size</a> (Nginx).
</p>
</dd>
<dt class="hdlist1">
count
</dt>
<dd>
<p>
The number of application instances that are currently alive. This value
is always less than or equal to <em>max</em>.
</p>
</dd>
<dt class="hdlist1">
active
</dt>
<dd>
<p>
The number of application instances that are currently processing
requests. This value is always less than or equal to <em>count</em>.
</p>
</dd>
<dt class="hdlist1">
inactive
</dt>
<dd>
<p>
The number of application instances that are currently <strong>not</strong> processing
requests, i.e. are idle. Idle application instances will be shutdown after a while,
as can be specified with <a href="#PassengerPoolIdleTime">PassengerPoolIdleTime (Apache)</a>/<a href="#PassengerPoolIdleTime">passenger_pool_idle_time (Nginx)</a> (unless this
value is set to 0, in which case application instances are never shut down via idle
time). The value of <em>inactive</em> equals <span class="monospaced">count - active</span>.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The <em>domains</em> section shows, for each application directory, information about running
application instances:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Sessions
</dt>
<dd>
<p>
Shows how many HTTP client are currently in the queue of that application
Instance, waiting to be processed.
</p>
</dd>
<dt class="hdlist1">
Processed
</dt>
<dd>
<p>
Indicates how many requests the instance has served until now. <strong>Tip:</strong> it’s
possible to limit this number with the <a href="#PassengerMaxRequests">PassengerMaxRequests</a>
configuration directive.
</p>
</dd>
<dt class="hdlist1">
Uptime
</dt>
<dd>
<p>
Shows for how long the application instance has been running.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Since Phusion Passenger uses fair load balancing by default, the number of sessions for the
application instances should be fairly close to each other. For example, this is fairly
normal:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>  PID: 4281      Sessions: 2      Processed: 7      Uptime: 5m 11s
  PID: 4268      Sessions: 0      Processed: 5      Uptime: 4m 52s
  PID: 4265      Sessions: 1      Processed: 6      Uptime: 5m 38s
  PID: 4275      Sessions: 1      Processed: 7      Uptime: 3m 14s</pre>
</div>
</div>
<div class="paragraph"><p>But if you see a "spike", i.e. an application instance has an unusually high number of
sessions compared to the others, then there might be a problem:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>  PID: 4281      Sessions: 2      Processed: 7      Uptime: 5m 11s
  PID: 17468     Sessions: 8 &lt;-+  Processed: 2      Uptime: 4m 47s
  PID: 4265      Sessions: 1   |  Processed: 6      Uptime: 5m 38s
  PID: 4275      Sessions: 1   |  Processed: 7      Uptime: 3m 14s
                               |
                               +---- "spike"</pre>
</div>
</div>
<div class="paragraph"><p>The most likely reason why a spike occurs is because your application is frozen, i.e. it has stopped responding. See <a href="#debugging_frozen">Debugging frozen applications</a> for tips.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="debugging_frozen"></span><h3 data-comment-topic="debugging-frozen-applications-qoctl8" data-anchor="debugging_frozen">9.3. Debugging frozen applications</h3>
<div class="paragraph"><p>If one of your application processes is frozen (stopped responding), then you
can figure out where it is frozen by killing it with <em>SIGABRT</em>. This will cause the
processs to print a backtrace, after which it aborts. The backtrace information is
logged into the web server error log file.</p></div>
<div class="paragraph"><p>In case of Ruby applications, you can also send the <em>SIGQUIT</em> signal to have it print
a backtrace without aborting.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_accessing_individual_application_processes"></span><h3 data-comment-topic="accessing-individual-application-processes-1qe4fqk" data-anchor="_accessing_individual_application_processes">9.4. Accessing individual application processes</h3>
<div class="paragraph"><p>When a request is sent to the web server, Phusion Passenger will automatically forward
the request to the most suitable application process, but sometimes it is desirable to
be able to directly access the individual application processes. Use cases include, but
are not limited to:</p></div>
<div class="ulist"><ul>
<li>
<p>
One wants to debug a memory leak or memory bloat problem that only seems to appear on
  certain URIs. One can send a request to a specific process to see whether that request
  causes the process’s memory usage to rise.
</p>
</li>
<li>
<p>
The application caches data in local memory, and one wants to tell a specific
  application process to clear that local data.
</p>
</li>
<li>
<p>
Other debugging use cases.
</p>
</li>
</ul></div>
<div class="paragraph"><p>All individual application processes are accessible via HTTP, so you can use standard
HTTP tools like <em>curl</em>. The exact addresses can be obtained with the command
<span class="monospaced">passenger-status --verbose</span>. These sockets are all bound to 127.0.0.1, but the port
number is dynamically assigned. As a security measure, the sockets are also protected
with a process-specific random password, which you can see in the
<span class="monospaced">passenger-status --verbose</span> output. This password must be sent through the
“X-Passenger-Connect-Password” HTTP header.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>bash# passenger-status --verbose
----------- General information -----------
max      = 6
count    = 2
active   = 0
inactive = 2
Waiting on global queue: 0

----------- Application groups -----------
/Users/hongli/Sites/rack.test:
  App root: /Users/hongli/Sites/rack.test
  * PID: 24235   Sessions: 0    Processed: 7       Uptime: 17s
      URL     : http://127.0.0.1:58122
      Password: nFfVOX1F8LjZ90HJh28Sd_htJOsgRsNne2QXKf8NIXw
  * PID: 24250   Sessions: 0    Processed: 4       Uptime: 1s
      URL     : http://127.0.0.1:57933
      Password: _RGXlQ9EGDGJKLevQ_qflUtF1KmxEo2UiRzMwIE1sBY</pre>
</div>
</div>
<div class="paragraph"><p>Here we see that the web application <em>rack.test</em> has two processes.
Process 24235 is accessible via <a href="http://127.0.0.1:58122">http://127.0.0.1:58122</a>, and
process 24250 is accessible via <a href="http://127.0.0.1:57933">http://127.0.0.1:57933</a>.</p></div>
<div class="paragraph"><p>To access 24235 we must send its password, <em>nFfVOX1F8LjZ90HJh28Sd_htJOsgRsNne2QXKf8NIXw</em>,
through the <em>X-Passenger-Connect-Password</em> HTTP header, like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>bash# curl -H "X-Passenger-Connect-Password: nFfVOX1F8LjZ90HJh28Sd_htJOsgRsNne2QXKf8NIXw" http://127.0.0.1:58122/</pre>
</div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_attaching_an_irb_console_to_an_application_process"></span><h3 data-comment-topic="attaching-an-irb-console-to-an-application-process-d36enw" data-anchor="_attaching_an_irb_console_to_an_application_process">9.5. Attaching an IRB console to an application process</h3>
<div class="paragraph"><p><strong>This feature is only available in <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a>. It was introduced in version 3.0.0. <a href="https://www.phusionpassenger.com/download">Buy Phusion Passenger Enterprise here.</a></strong></p></div>
<div class="paragraph"><p>You can attach an IRB console to any application process and inspect its state by executing arbitrary Ruby code. Do this by invoking <span class="monospaced">passenger-irb &lt;PID&gt;</span> where <em>&lt;PID&gt;</em> is the PID of the application process you wish to inspect. Note that the IRB console is currently only available for Ruby apps, not for apps in any other languages.</p></div>
</div>
</div>
</div>
<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_tips"></span><h2 data-comment-topic="tips-n4c22d" data-anchor="_tips">10. Tips</h2>
<div class="sectionbody">
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="user_switching"></span><h3 data-comment-topic="user-switching-security--zmsy9o" data-anchor="user_switching">10.1. User Switching (security feature)</h3>
<div class="paragraph"><p>Phusion Passenger supports automatic <em>user switching</em>: by default, it attempts to run applications as the "right" user, instead of running all applications as the same user.</p></div>
<div class="paragraph"><p>To better understand the problem, let us consider the situation with PHP.
There is a problem that plagues most PHP web hosts, namely the fact that all PHP
applications are run in the same user context as the web server. So for
example, Joe’s PHP application will be able to read Jane’s PHP application’s
passwords. This is obviously undesirable on many servers.</p></div>
<div class="paragraph"><p>Phusion Passenger’s <em>user switching</em> feature solves this problem. Applications are
run as the owner of their "startup file". For Ruby apps, the startup file is
<span class="monospaced">config.ru</span> (Rack and Rails &gt;= 3) or <span class="monospaced">config/environment.rb</span> (Rails 1 and 2). For
Python apps, the startup file is <span class="monospaced">passenger_wsgi.py</span>. So suppose that <span class="monospaced">config.ru</span>
is owned by user <em>joe</em>, then Phusion Passenger will spawn the corresponding
application as <em>joe</em> as well. The exact rules are a little bit more complicated,
and they’re explained further down in this section.</p></div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_requirements"></span><h4 data-comment-topic="requirements-15ozqdj" data-anchor="_requirements">10.1.1. Requirements</h4>
<div class="paragraph"><p>User switching is only enabled when all of the following conditions are met:</p></div>
<div class="ulist"><ul>
<li>
<p>
When not using <a href="#flying_passenger">Flying Passenger</a> (this is probably the case):
</p>
<div class="ulist"><ul>
<li>
<p>
The
  <a href="#PassengerUserSwitching">passenger_user_switching</a>
option must be enabled.
</p>
</li>
<li>
<p>
The web server’s control process must have root privileges. This is the case on most installations.
</p>
</li>
</ul></div>
</li>
<li>
<p>
When using <a href="#flying_passenger">Flying Passenger</a>:
</p>
<div class="ulist"><ul>
<li>
<p>
The Flying Passenger daemon must be run with root privileges.
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_effects"></span><h4 data-comment-topic="effects-nd2m44" data-anchor="_effects">10.1.2. Effects</h4>
<div class="paragraph"><p>When not using Flying Passenger, the following table illustrates the effect for different combinations of the requirements.</p></div>
<table class="tableblock frame-all grid-all" style="
width:100%;
">
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>passenger_user_switching on</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>passenger_user_switching off</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Web server has root privileges</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User switching enabled.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User switching disabled. Apps are run as
  <a href="#PassengerDefaultUser">passenger_default_user</a> and
  <a href="#PassengerDefaultGroup">passenger_default_group</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Web server has no root privileges</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User switching disabled. Apps are run as the web server’s user.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User switching disabled. Apps are run as the web server’s user.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>When using Flying Passenger, the effect is as follows:</p></div>
<table class="tableblock frame-all grid-all" style="
width:100%;
">
<col style="width:50%;">
<col style="width:50%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Daemon run with root privileges</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User switching enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Daemon run without root privileges</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User switching disabled. Apps are run as the daemon’s user.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>When user switching is enabled, the following rules are followed to determine what user an application should be run as. The first matching rule is the rule that will be followed.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
If
  <a href="#PassengerUser">passenger_user</a> or
  <a href="#PassengerGroup">passenger_group</a>
are set, then the application will be run as the specified user/group. Thus, these options are a good way to override user switching settings.
</p>
</li>
<li>
<p>
If the startup file is owned by root or an unknown user, then the application will run as the user specified by
  <a href="#PassengerDefaultUser">passenger_default_user</a> and
  <a href="#PassengerDefaultGroup">passenger_default_group</a>.
</p>
</li>
<li>
<p>
Otherwise, the application is run as the owner of the startup file.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_caveats_amp_troubleshooting"></span><h4 data-comment-topic="caveats-troubleshooting-mbw582" data-anchor="_caveats_amp_troubleshooting">10.1.3. Caveats &amp; troubleshooting</h4>
<div class="paragraph"><p>If your application regularly encounters permission errors or fails to find certain files, then this is an indication that your application is started as a user that you did not intent it to be run as. Other symptoms include:</p></div>
<div class="ulist"><ul>
<li>
<p>
The application fails to start because Bundler complains that it cannot find gems. This probably indicates that Bundler does not have read access to the directory that contains Bundler-installed gems.
</p>
</li>
<li>
<p>
The application fails to start and its error message mentions the path <em>/nonexistent</em>. This probably indicates that your application is started as the <em>nobody</em> user. This is because on many systems, the <em>nobody</em> user’s home directory is <em>/nonexistent</em>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>To check whether it is indeed the case that your application is started as a different user than you intended to, see <a href="#finding_out_app_user">Finding out what user an application is running as</a>.</p></div>
<div class="paragraph"><p>The most likely reason why your application is started as <em>nobody</em> is probably because your startup file is owned by <em>root</em>, by <em>nobody</em> or by an unknown user. To fix this, change the owner of the startup file to the owner that you want to run the application as.</p></div>
<div class="paragraph"><p>Whatever user your application runs as, it must have read access to the <a href="#application_root">application root</a>, and read/write access to the application’s <em>logs</em> directory.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="user_switching_rpm_caveats"></span><h4 data-comment-topic="red-hat-and-centos-caveats-ilqxyl" data-anchor="user_switching_rpm_caveats">10.1.4. Red Hat and CentOS caveats</h4>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">This information only applies if you installed Passenger through the RPM packages provided by Phusion. If you did not installed Passenger through the RPM packages provided by Phusion, then you can ignore this section.</td>
</tr></table>
</div>
<div class="paragraph"><p>If you installed Passenger through Phusion’s RPM packages, and you want to disable user switching, then you must also change <a href="#PassengerInstanceRegistryDir">the location of the instance registry directory</a>.</p></div>
<div class="paragraph"><p>This is because our RPMs configure the default instance registry directory to <span class="monospaced">/var/run/passenger-instreg</span>, which is only writable by root. If you disable user switching, then the Passenger processes will run as
  <a href="#PassengerDefaultUser">passenger_default_user</a>,
which (as long as it’s not root) won’t be able to write to that directory.</p></div>
<div class="paragraph"><p>Note that any alternative instance registry directory must have the proper SELinux context, allowing the web server to read and write to it. We recommend that you create a directory <span class="monospaced">/var/lib/passenger-instreg</span> and give it the label <span class="monospaced">var_run_t</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>sudo mkdir /var/lib/passenger-instreg
sudo chcon -t var_run_t /var/lib/passenger-instreg</pre>
</div>
</div>
<div class="paragraph"><p>Then, in your Nginx config file:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>passenger_instance_registry_dir /var/lib/passenger-instreg;</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="finding_out_app_user"></span><h4 data-comment-topic="finding-out-what-user-an-application-is-running-as-1ni7zk6" data-anchor="finding_out_app_user">10.1.5. Finding out what user an application is running as</h4>
<div class="paragraph"><p>To find our what user an application is started as, first access its URL in your browser so that Phusion Passenger starts the application. For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>http://www.example.local/</pre>
</div>
</div>
<div class="paragraph"><p>The application will now either successfully start or fail to start. If it fails to start then you will see an error page that tells you what user the application was being started as. If you do not see the error page in the browser then set
  <a href="#PassengerFriendlyErrorPages">passenger_friendly_error_pages</a>
on.</p></div>
<div class="paragraph"><p>If the application successfully started, then run <span class="monospaced">passenger-status</span> to find the process’s PID:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>.---------- General information -----------
Max pool size : 6
Processes     : 1
Requests in top-level queue : 0

.---------- Application groups -----------
/webapps/example.local#default:
  App root: /webapps/example.local
  Requests in queue: 0
  * PID: 16915   Sessions: 0       Processed: 1       Uptime: 2s
    CPU: 0%      Memory  : 9M      Last used: 2s ago</pre>
</div>
</div>
<div class="paragraph"><p>In the above example we see that the PID is 16915. Next, use <em>ps</em> to find out the user that it is running as:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre># ps -o pid,user,comm -p 16915
  PID USER    COMM
16915 phusion Passenger RackApp: /webapps/example.local</pre>
</div>
</div>
<div class="paragraph"><p>As you can see, the application in this example is being run as user <em>phusion</em>.</p></div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="reducing_memory_usage"></span><h3 data-comment-topic="reducing-memory-consumption-of-ruby-on-rails-applications-by-33--1o3z66q" data-anchor="reducing_memory_usage">10.2. Copy-on-write memory support (reducing memory consumption of Ruby applications)</h3>
<div class="paragraph"><p>Phusion Passenger automatically leverages operating system virtual memory copy-on-write features in order to reduce the memory usage of Ruby applications. Experience has shown that this reduces memory usage by 33% on average. For this mechanism to work, a Ruby interpreter with a copy-on-write friendly garbage collector is required. The following Ruby interpreters have copy-on-write friendly garbage collectors:</p></div>
<div class="ulist"><ul>
<li>
<p>
MRI Ruby &gt;= 2.0. Versions prior to 2.0 did not have a copy-on-write friendly garbage collector.
</p>
</li>
<li>
<p>
<a href="http://www.rubyenterpriseedition.com/">Ruby Enterprise Edition</a>, which was Phusion’s branch of MRI Ruby 1.8 with a copy-on-write friendly garbage collector and other enhancement. It has reached End-Of-Life as of 2012, but remains available for legacy systems.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="tuning_sse_websockets"></span><h3 data-comment-topic="tuning-for-server-sent-events-and-websockets-8ec9td" data-anchor="tuning_sse_websockets">10.3. Tuning for Server Sent Events and WebSockets</h3>
<div class="paragraph"><p>Phusion Passenger supports Server Sent Events (SSE) and WebSockets out of the box with no configuration, but there are some things you need to know.</p></div>
<div class="paragraph"><p>First, WebSockets are <a href="https://github.com/phusion/passenger/issues/1202">not yet supported when using the Apache integration mode</a>.</p></div>
<div class="paragraph"><p>Second, for Ruby apps only, you need to insert a configuration snippet inside your <span class="monospaced">config.ru</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre><strong>if</strong> defined?(PhusionPassenger)
  PhusionPassenger.advertised_concurrency_level = 0
<strong>end</strong></pre>
</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">
<div class="paragraph"><p>This snippet tells Passenger that your Ruby app will handle SSE and WebSockets. In response, Passenger will adjust the connection concurrency settings for your app. Without this configuration snippet, SSE and WebSockets still work, but with degraded performance.</p></div>
<div class="paragraph"><p>This configuration snippet is currently necessary because of the way Passenger is implemented. We are <a href="https://github.com/phusion/passenger/issues/1195">working on improving this mechanism</a>. One day, the above configuration snippet will no longer be necessary. For now, you should include the above configuration snippet for optimal SSE and WebSocket performance.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Finally, you can find Passenger SSE and WebSocket demo apps on <a href="https://www.phusionpassenger.com/documentation_and_support">the Passenger documentation overview page</a>, under section "Demos".</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="bundler_support"></span><h3 data-comment-topic="bundler-support-19v1h43" data-anchor="bundler_support">10.4. Bundler support</h3>
<div class="paragraph"><p>Phusion Passenger has automatic support for <a href="http://gembundler.com/git.html">Bundler</a>.
The support consists of loading your application under the environment defined by your
Gemfile. In other words, Phusion Passenger loads your application as if <em>bundle exec</em> was used.</p></div>
<div class="paragraph"><p>The Bundler support works as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
If you have a <em>.bundle/environment.rb</em> in your application root, then Phusion
  Passenger will require that file before loading your application.
</p>
</li>
<li>
<p>
Otherwise, if you have a <em>Gemfile</em>, then Phusion Passenger will automatically call
  <span class="monospaced">Bundler.setup()</span> before loading your application.
</p>
</li>
</ul></div>
<div class="paragraph"><p>It’s possible that your application also calls <span class="monospaced">Bundler.setup</span> during loading, e.g. in
<em>config.ru</em> or in <em>config/boot.rb</em>. This is the case with Rails 3, and is also the case if you
modified your <em>config/boot.rb</em> according to the
<a href="http://gembundler.com/rails23.html">Bundler Rails 2.3 instructions</a>.
This leads to <span class="monospaced">Bundler.setup</span> being called twice, once before the application startup file
is required and once during application startup. However this is harmless and doesn’t
have any negative effects.</p></div>
<div class="paragraph"><p>Phusion Passenger assumes that you’re using Bundler &gt;= 0.9.5. If you don’t want Phusion
Passenger to run its Bundler support code, e.g. because you need to use an older version
of Bundler with an incompatible API or because you use a system other than Bundler, then
you can override Phusion Passenger’s Bundler support code by creating an empty file
<em>config/setup_load_paths.rb</em>. If this file exists then it will be required before loading
the application startup file. In this file you can do whatever you need to setup Bundler
or a similar system.</p></div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="add_passenger_to_gemfile"></span><h4 data-comment-topic="does-phusion-passenger-itself-need-to-be-added-to-the-gemfile--xn1a11" data-anchor="add_passenger_to_gemfile">10.4.1. Does Phusion Passenger itself need to be added to the Gemfile?</h4>
<div class="paragraph"><p>It is never necessary to add Phusion Passenger to the application’s Gemfile. In case of Phusion Passenger Standalone, it is not necessary to execute the <span class="monospaced">passenger</span> command through <span class="monospaced">bundle exec</span>. The reason for this is because Phusion Passenger automatically loads the Gemfile environment. Most other Ruby application servers do not automatically load the Gemfile environment, which is why they must be added to the Gemfile and be executed with <span class="monospaced">bundle exec</span>.</p></div>
<div class="paragraph"><p>Even when your application uses any of the Phusion Passenger APIs, you still do not need to add Phusion Passenger to the Gemfile. The only thing you need to do is to put Phusion Passenger API calls inside <span class="monospaced">if</span> blocks that check whether Phusion Passenger is active, by checking whether the <span class="monospaced">PhusionPassenger</span> namespace is defined:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre><strong>if</strong> defined?(PhusionPassenger)
    ...
<strong>end</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_installing_multiple_ruby_on_rails_versions"></span><h3 data-comment-topic="installing-multiple-ruby-on-rails-versions-1bp1fff" data-anchor="_installing_multiple_ruby_on_rails_versions">10.5. Installing multiple Ruby on Rails versions</h3>
<div class="paragraph"><p>Each Ruby on Rails applications that are going to be deployed may require a
specific Ruby on Rails version. You can install a specific version with
this command:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>gem install rails -v X.X.X</pre>
</div>
</div>
<div class="paragraph"><p>where <em>X.X.X</em> is the version number of Ruby on Rails.</p></div>
<div class="paragraph"><p>All of these versions will exist in parallel, and will not conflict with each
other. Phusion Passenger will automatically make use of the correct version.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_making_the_application_restart_after_each_request"></span><h3 data-comment-topic="making-the-application-restart-after-each-request-vimy48" data-anchor="_making_the_application_restart_after_each_request">10.6. Making the application restart after each request</h3>
<div class="paragraph"><p>In some situations it might be desirable to restart the web application after
each request, for example when developing a non-Rails application that doesn’t
support code reloading, or when developing a web framework.</p></div>
<div class="paragraph"><p>To achieve this, simply create the file <em>tmp/always_restart.txt</em> in your
application’s root folder. Unlike <em>restart.txt</em>, Phusion Passenger does not
check for this file’s timestamp: Phusion Passenger will always restart the
application, as long as <em>always_restart.txt</em> exists.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">If you’re just developing a Rails application then you probably don’t need
this feature. If you set
<em>rails_env development</em>
in your web server configuration,
then Rails will automatically reload your application code after each request.
<em>always_restart.txt</em> is mostly useful when you’re using a web framework that
doesn’t support code reloading by itself, of when you’re working on a web framework
yourself.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="sub_uri_deployment_uri_fix"></span><h3 data-comment-topic="how-to-fix-broken-images-css-javascript-uris-in-sub-uri-deployments-11mzwt6" data-anchor="sub_uri_deployment_uri_fix">10.7. How to fix broken images/CSS/JavaScript URIs in sub-URI deployments</h3>
<div class="paragraph"><p>Some people experience broken images and other broken static assets when they
deploy their application to a sub-URI (i.e. <em>http://mysite.com/railsapp/</em>).
The reason for this usually is that you used a
static URI for your image in the views. This means your <em>img</em> source probably refers
to something like <em>/images/foo.jpg</em>. The leading slash means that it’s an absolute URI:
you’re telling the browser to always load <em>http://mysite.com/images/foo.jpg</em> no
matter what. The problem is that the image is actually at
<em>http://mysite.com/railsapp/images/foo.jpg</em>. There are two ways to fix this.</p></div>
<div class="paragraph"><p>The first way (not recommended) is to change your view templates to refer to
<em>images/foo.jpg</em>. This is a relative URI: note the lack of a leading slash). What
this does is making the path relative to the current URI. The problem is that if you
use restful URIs, then your images will probably break again when you add a level to
the URI.
For example, when you’re at <em>http://mysite.com/railsapp</em> the browser will look for
<em>http://mysite.com/railsapp/images/foo.jpg</em>. But when you’re at
<em>http://mysite.com/railsapp/controller</em>. the browser will look for
<em>http://mysite.com/railsapp/controller/images/foo.jpg</em>.
So relative URIs usually don’t work well with layout templates.</p></div>
<div class="paragraph"><p>The second and highly recommended way is to always use Rails helper methods to
output tags for static assets. These helper methods automatically take care
of prepending the base URI that you’ve deployed the application to. For images
there is <span class="monospaced">image_tag</span>, for JavaScript there is <span class="monospaced">javascript_include_tag</span> and for
CSS there is <span class="monospaced">stylesheet_link_tag</span>. In the above example you would simply remove
the <em>&lt;img&gt;</em> HTML tag and replace it with inline Ruby like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&lt;%= image_tag("foo.jpg") %&gt;</pre>
</div>
</div>
<div class="paragraph"><p>This will generate the proper image tag to <span class="monospaced">$RAILS_ROOT/public/images/foo.jpg</span>
so that your images will always work no matter what sub-URI you’ve deployed to.</p></div>
<div class="paragraph"><p>These helper methods are more valuable than you may think. For example they also
append a timestamp to the URI to better facilitate HTTP caching. For more information,
please refer to
<a href="http://api.rubyonrails.org/classes/ActionView/Helpers/AssetTagHelper.html">the Rails API docs</a>.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_out_of_band_work_and_out_of_band_garbage_collection"></span><h3 data-comment-topic="out-of-band-work-and-out-of-band-garbage-collection-v89lu2" data-anchor="_out_of_band_work_and_out_of_band_garbage_collection">10.8. Out-of-Band Work and Out-of-Band Garbage Collection</h3>
<div class="paragraph"><p><strong>Available since Phusion Passenger 4.0.0.</strong></p></div>
<div class="paragraph"><p><strong>At this time, this feature is only available on Ruby.</strong></p></div>
<div class="paragraph"><p>The Out-of-Band Work feature allows you to run arbitrary long-running tasks outside normal request cycles. This works by letting current requests to the process finish, then telling the process to perform the out-of-band work, then resuming passing requests to the process after said work is finished.</p></div>
<div class="paragraph"><p>A specific (and perhaps primary) use case of of Out-of-Band Work is <strong>Out-of-Band Garbage Collection</strong>. The garbage collector is run outside normal request cycles so that garbage collection runs inside normal request cycles can finish a lot faster. This can potentially save tens to hundreds of milliseconds of latency in requests.</p></div>
<div class="paragraph"><p>Because Out-of-Band Work is implemented at the Phusion Passenger inter-process request routing level, and not by, say, spawning a thread inside the application process, Out-of-Band Work has the following useful properties:</p></div>
<div class="ulist"><ul>
<li>
<p>
It works well even with tasks that can pause all threads. The MRI Ruby garbage collector is a stop-the-world mark-and-sweep garbage collector.
</p>
</li>
<li>
<p>
Phusion Passenger can spawn more processes as necessary, in order to prevent situations in which all application processes are busy performing out-of-band work. Phusion Passenger guarantees that there’s at least one process that’s ready to process requests.
</p>
</li>
<li>
<p>
Phusion Passenger guarantees that no more than 1 process is performing out-of-band work at the same time.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Applications can use Out-of-Band Work as follows:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Ensure that
<a href="#PassengerMaxPoolSize">passenger_max_pool_size</a>
and
<a href="#PassengerMinInstances">passenger_min_instances</a>
are both larger than 1. Out-of-band work only works if there are at least 2 application processes.
</p>
</li>
<li>
<p>
Request out-of-band work by outputting the <span class="monospaced">!~Request-OOB-Work</span> header during a request. It does not matter what the value is. At this time, it is not possible to request out-of-band work from outside requests.
</p>
</li>
<li>
<p>
You can actually perform out-of-band work when you receive a <span class="monospaced">:oob_work</span> Phusion Passenger event.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Note that even though you can request out-of-band work, there’s no guarantee that Phusion Passenger will send an <span class="monospaced">oob_work</span> event in a timely manner, if at all. It is also possible that Phusion Passenger sends an <span class="monospaced">oob_work</span> event without you ever having requested one. This latter could for example happen if the OOB work is administrator-initiated. Do not make any assumptions in your code.</p></div>
<div class="paragraph"><p>Here’s an example which implements out-of-band garbage collection using the Out-of-Band framework. This example code doesn’t do anything when the code is not being run in Phusion Passenger, thanks to the <span class="monospaced">if</span> block.</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Somewhere in a controller method:</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Tell Phusion Passenger we want to perform OOB work.</span></span>
response<span style="color: #990000">.</span>headers<span style="color: #990000">[</span><span style="color: #FF0000">"!~Request-OOB-Work"</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">"true"</span>

<span style="font-style: italic"><span style="color: #9A1900"># Somewhere during application initialization:</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">defined</span></span><span style="color: #990000">?(</span>PhusionPassenger<span style="color: #990000">)</span>
    PhusionPassenger<span style="color: #990000">.</span>on_event<span style="color: #990000">(:</span>oob_work<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># Phusion Passenger has told us that we're ready to perform OOB work.</span></span>
        t0 <span style="color: #990000">=</span> Time<span style="color: #990000">.</span>now
        GC<span style="color: #990000">.</span>start
        Rails<span style="color: #990000">.</span>logger<span style="color: #990000">.</span>info <span style="color: #FF0000">"Out-Of-Bound GC finished in #{Time.now - t0} sec"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre>
</div>
</div>
<div class="paragraph"><p>For your convenience, Phusion Passenger provides a Rack middleware for out-of-band garbage collection. Add the following to your <span class="monospaced">config.ru</span>. Likewise, this example code doesn’t do anything when the code is not being run in Phusion Passenger, thanks to the <span class="monospaced">if</span> block.</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">defined</span></span><span style="color: #990000">?(</span>PhusionPassenger<span style="color: #990000">)</span>
    PhusionPassenger<span style="color: #990000">.</span>require_passenger_lib <span style="color: #FF0000">'rack/out_of_band_gc'</span>

    <span style="font-style: italic"><span style="color: #9A1900"># Trigger out-of-band GC every 5 requests.</span></span>
    use PhusionPassenger<span style="color: #990000">::</span>Rack<span style="color: #990000">::</span>OutOfBandGc<span style="color: #990000">,</span> <span style="color: #993399">5</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre>
</div>
</div>
<div class="paragraph"><p>It should be noted that, although the application uses the Phusion Passenger API, it is <a href="#add_passenger_to_gemfile"><strong>not</strong> necessary to add Phusion Passenger to the Gemfile</a>.</p></div>
<div class="paragraph"><p>References:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://blog.phusion.nl/2013/01/22/phusion-passenger-4-technology-preview-out-of-band-work/">The Phusion Blog article which first introduced this feature.</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_hooks"></span><h3 data-comment-topic="hooks-qrxle1" data-anchor="_hooks">10.9. Hooks</h3>
<div class="paragraph"><p><strong>Introduced in version 4.0.28.</strong></p></div>
<div class="paragraph"><p>Phusion Passenger provides a powerful but simple hooking system, which allows you to extend many aspects of Phusion Passenger’s behavior. The hooking system works by executing commands during certain events. Event parameters are passed to the command in the form of environment variables.</p></div>
<div class="paragraph"><p>You can define hooks by setting the configuration option <span class="monospaced">passenger_ctl hook_&lt;HOOK NAME&gt; &lt;COMMAND TO EXECUTE&gt;;</span>.</p></div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_example"></span><h4 data-comment-topic="example-1orara9" data-anchor="_example">10.9.1. Example</h4>
<div class="paragraph"><p>The hook system is best demonstrated with a simple example. In the following example we will hook into the <span class="monospaced">attached_process</span> event. This event is called whenever Phusion Passenger has successfully spawned an application processes and added it to the process pool. We print the process’s PID and application root.</p></div>
<div class="paragraph"><p>First, let’s create a script <span class="monospaced">/home/phusion/attached.sh</span> which is to be called during the hook.</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#!/bin/sh</span></span>
echo <span style="color: #FF0000">"Attached process $PASSENGER_PROCESS_PID for app $PASSENGER_APP_ROOT."</span></tt></pre>
</div>
</div>
<div class="paragraph"><p>Then we make it executable:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>chmod +x /home/phusion/attached.sh</pre>
</div>
</div>
<div class="paragraph"><p>And we define the hook in the configuration file:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>passenger_ctl hook_attached_process /home/phusion/attached.sh;</pre>
</div>
</div>
<div class="paragraph"><p>Now restart the web server and access a web app hosted by Phusion Passenger. You should see our message in the web server error log:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[ 2013-12-10 16:12:21.6456 28934/0x1064cb000 Hooks.h:129 ]: Running attached_process hook script: /home/phusion/attached.sh
Attached process 28303 for app /webapps/foobar.
[ 2013-12-10 16:12:21.6580 28934/0x1064cb000 Hooks.h:161 ]: Hook script /home/phusion/attached.sh (PID 28948) exited with status 0</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_environment"></span><h4 data-comment-topic="environment-10uhg8m" data-anchor="_environment">10.9.2. Environment</h4>
<div class="paragraph"><p>A lot of information is passed to hook scripts in the form of environment variables. They are all uppercase and begin with <span class="monospaced">PASSENGER_</span>. Some environment variables are passed to all hook scripts, others are passed depending on the hook.</p></div>
<div class="paragraph"><p>Here are some of the environment variables which are passed to all hooks, unless documented otherwise:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">PASSENGER_HOOK_NAME</span>
</p>
</li>
<li>
<p>
<span class="monospaced">PASSENGER_VERSION</span>
</p>
</li>
<li>
<p>
<span class="monospaced">PASSENGER_PASSENGER_ROOT</span>
</p>
</li>
<li>
<p>
<span class="monospaced">PASSENGER_INSTANCE_DIR</span>
</p>
</li>
<li>
<p>
<span class="monospaced">PASSENGER_INSTANCE_REGISTRY_DIR</span>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_blocking_and_concurrency"></span><h4 data-comment-topic="blocking-and-concurrency-g5njp1" data-anchor="_blocking_and_concurrency">10.9.3. Blocking and concurrency</h4>
<div class="paragraph"><p>Except when otherwise documented, all hooks block in the background. That is, while your hook command is running, Phusion Passenger can still handle web requests, but the background thread which is running your hook will be blocked and won’t be able to perform any further operations. For example, if you wrote a hook script for the <span class="monospaced">attached_process</span> event, then Phusion Passenger won’t be able to attach further processes until your hook script finishes. You should therefore be careful when writing hook scripts.</p></div>
<div class="paragraph"><p>If you have a bug in your script and it blocks, then you will be able to see that using the command <span class="monospaced">passenger-status --show=backtraces</span> which prints the backtraces of all threads in the Phusion Passenger HelperAgent. Look for the <span class="monospaced">runSingleHookScript</span> function in the backtrace. The following example shows at line 2 that Phusion Passenger is waiting for the hook script <span class="monospaced">/home/phusion/badscript.sh</span>.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Thread 'Group process spawner: /home/phusion/webapp.test#default' (0x1062d4000):
     in 'bool Passenger::runSingleHookScript(Passenger::HookScriptOptions &amp;, const string &amp;, const vector&lt;pair&lt;string, string&gt; &gt; &amp;)' (Hooks.h:116) -- /home/phusion/badscript.sh
     in 'bool Passenger::runHookScripts(Passenger::HookScriptOptions &amp;)' (Hooks.h:159)
     in 'void Passenger::ApplicationPool2::Group::spawnThreadRealMain(const SpawnerPtr &amp;, const Passenger::ApplicationPool2::Options &amp;, unsigned int)' (Implementation.cpp:878)</pre>
</div>
</div>
<div class="paragraph"><p>Hooks may be called concurrently, because Phusion Passenger sometimes uses multiple background threads. For example, while the <span class="monospaced">attached_process</span> hook is being called, a <span class="monospaced">detached_process</span> hook may be called, perhaps even for the same application. It is your responsibility to ensure that your hook scripts are concurrency-safe, e.g. by employing locks and other concurrency control techniques.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_error_handling"></span><h4 data-comment-topic="error-handling-m78oxs" data-anchor="_error_handling">10.9.4. Error handling</h4>
<div class="paragraph"><p>If a hook script fails — that is, if it exits with anything other than exit code 0 — then the error handling depends on the hook. Some hooks will abort, other hooks will ignore the error. In all cases, the result of the hook script is printed to the log.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_compatibility"></span><h4 data-comment-topic="compatibility-132b3ns" data-anchor="_compatibility">10.9.5. Compatibility</h4>
<div class="paragraph"><p>Because hooks are inherently tied to the implementation of Phusion Passenger, there is no guarantee that hooks that currently work will continue to be available in the future versions of Phusion Passenger. The availability of hooks is very much tied to the specific version of Phusion Passenger.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_available_hooks"></span><h4 data-comment-topic="available-hooks-11w1prq" data-anchor="_available_hooks">10.9.6. Available hooks</h4>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">before_watchdog_initialization</span>
</dt>
<dd>
<p>
        Called at the very beginning of Phusion Passenger’s life cycle, during the start of the Watchdog process. The first hook is called before initialization is performed (before the HelperAgent is started). Errors in the hook script cause Phusion Passenger to abort.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">after_watchdog_initialization</span>
</dt>
<dd>
<p>
        Like <span class="monospaced">before_watchdog_initialization</span>, but called after initialization of all Phusion Passenger agent processes. Errors in the hook script cause Phusion Passenger to abort.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">before_watchdog_shutdown</span>
</dt>
<dd>
<p>
        Called after an exit signal has been noticed (e.g. webserver exit), before the Watchdog starts terminating agents
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">after_watchdog_shutdown</span>
</dt>
<dd>
<p>
        Called after the Watchdog is done and about to exit
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">attached_process</span>
</dt>
<dd>
<p>
        Called when Phusion Passenger has successfully spawned an application processes and added it to the process pool. Extra environment variables: <span class="monospaced">PASSENGER_PROCESS_PID</span>, <span class="monospaced">PASSENGER_APP_ROOT</span>. Errors in the hook script are ignored.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">detached_process</span>
</dt>
<dd>
<p>
        Called when Phusion Passenger has removed an application process from the process pool. This could happen when:
</p>
<div class="ulist"><ul>
<li>
<p>
The process has crashed, and Phusion Passenger noticed it.
</p>
</li>
<li>
<p>
Phusion Passenger has shut down a process because it’s been idle for too long.
</p>
</li>
<li>
<p>
The administrator configured different resource limits, and Phusion Passenger is starting or shutting down processes in response.
</p>
</li>
<li>
<p>
Phusion Passenger itself is shutting down.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Extra environment variables: <span class="monospaced">PASSENGER_PROCESS_PID</span>, <span class="monospaced">PASSENGER_APP_ROOT</span>. Errors in the hook script are ignored.</p></div>
</dd>
<dt class="hdlist1">
<span class="monospaced">spawn_failed</span> (since 4.0.49)
</dt>
<dd>
<p>
        Called when an application process could not be spawned. This could happen when:
</p>
<div class="ulist"><ul>
<li>
<p>
The application failing to start. For example: bugs in the application, database problems causing the application to crash, incorrectly installed dependencies.
</p>
</li>
<li>
<p>
Operating system-level problems, such as running out of memory.
</p>
</li>
<li>
<p>
The application taking too long to start, and hitting Phusion Passenger’s timeout.
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<span class="monospaced">queue_full_error</span> (since 5.0.0 RC 1)
</dt>
<dd>
<p>
        The server rejects new requests (default: HTTP 503) while the request queue is full (<a href="https://www.phusionpassenger.com/documentation/Users%20guide%20Nginx.html#passenger_max_request_queue_size">https://www.phusionpassenger.com/documentation/Users%20guide%20Nginx.html#passenger_max_request_queue_size</a>).
        This hook gets called for each rejection.
</p>
<div class="paragraph"><p>Extra environment variables:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">PASSENGER_APP_ROOT</span>: the path to the application that failed to spawn.
</p>
</li>
<li>
<p>
<span class="monospaced">PASSENGER_APP_GROUP_NAME</span>: the configured app group name.
</p>
</li>
<li>
<p>
<span class="monospaced">PASSENGER_ERROR_MESSAGE</span>: an error message that describes the problem.
</p>
</li>
<li>
<p>
<span class="monospaced">PASSENGER_ERROR_ID</span>: a unique ID for this error event. If you search for this ID in the web server error log files, you should be able to find details about the error.
</p>
</li>
<li>
<p>
<span class="monospaced">PASSENGER_APP_ERROR_MESSAGE</span>: output captured from the application at the time the error occurred.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This hook does not block because it’s always run in an extra background thread. Errors in the hook script are ignored.</p></div>
</dd>
<dt class="hdlist1">
<span class="monospaced">after_initialize_supergroup</span>
</dt>
<dd>
<p>
        Called right after Phusion Passenger has allocated data structures for an application, and is about to spawn a process for the first time for this application. Errors in the hook script are ignored. Extra environment variables: <span class="monospaced">PASSENGER_APP_ROOT</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">before_destroy_supergroup</span>
</dt>
<dd>
<p>
        Called right before Phusion Passenger decallocates data structures for an application. Errors in the hook script are ignored.
</p>
<div class="paragraph"><p>Note that the <span class="monospaced">after_initialize_supergroup</span> hook may be called while this hook is still being executed, so make sure that operations don’t conflict with each other.</p></div>
<div class="paragraph"><p>Extra environment variables: <span class="monospaced">PASSENGER_APP_ROOT</span>.</p></div>
</dd>
<dt class="hdlist1">
<span class="monospaced">max_request_time_reached</span> (since 5.0.2, Enterprise-only)
</dt>
<dd>
<p>
        Called when a <a href="#PassengerMaxRequestTime">max request time limit</a> has been reached. Please note that as soon as this hook has finished executing, the application process will be killed with SIGKILL. So if you want to perform any diagnostics on the process in question (e.g. with strace, gdb, etc), please do not exit your hook script until you’ve obtained all the diagnostics you want.
</p>
<div class="paragraph"><p>Extra environment variables:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">PASSENGER_APP_ID</span>: the PID of the process whose request took too long.
</p>
</li>
<li>
<p>
<span class="monospaced">PASSENGER_REQUEST_PATH</span>: the path of the request that took took long, e.g. "/photos/edit?id=123".
</p>
</li>
<li>
<p>
<span class="monospaced">PASSENGER_REQUEST_HOST</span>: the host name of the request that took too long, e.g. "www.example.com". This environment variable is not set if the request doesn’t contain a Host header.
</p>
</li>
</ul></div>
</dd>
</dl></div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="flying_passenger"></span><h3 data-comment-topic="flying-passenger-137qg5e" data-anchor="flying_passenger">10.10. Flying Passenger</h3>
<div class="paragraph"><p><strong>This feature is only available in <a href="https://www.phusionpassenger.com/enterprise">Phusion Passenger Enterprise</a>. It was introduced in version 4.0.6. <a href="https://www.phusionpassenger.com/download">Buy Phusion Passenger Enterprise here.</a></strong></p></div>
<div class="paragraph"><p>Flying Passenger allows one to decouple Phusion Passenger’s life time from the web server’s life time, so that the web server can be independently restarted from Phusion Passenger, and from any of the application processes served by Phusion Passenger.</p></div>
<div class="paragraph"><p>Normally, Phusion Passenger starts together with the web server, and shuts down together with the web server. The advantages of this default behavior is that it makes Phusion Passenger easy to administer: one only has to deal with the web server process and can expect all relevant processes to be cleaned up after a web server shut down. However this also brings about a disadvantage: every time one restarts the web server (e.g. to make a minor configuration change), Phusion Passenger and all its application processes also get restarted.</p></div>
<div class="paragraph"><p>This problem is solved by <em>Flying Passenger</em>, which is an advanced mode of operation in Phusion Passenger that allows the web server to be indepedently restarted from Phusion Passenger. When this mode is enabled:</p></div>
<div class="ulist"><ul>
<li>
<p>
One must start Phusion Passenger separately from the web server, namely by starting the Flying Passenger daemon. This daemon must - to an extent - be separately configured and managed from the web server.
</p>
</li>
<li>
<p>
The web server must be configured to forward requests to the Flying Passenger daemon.
</p>
</li>
<li>
<p>
You should beware of the <a href="#flying_passenger_caveats">caveats and limitations</a>.
</p>
</li>
</ul></div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_requirements_2"></span><h4 data-comment-topic="requirements-194ysj6" data-anchor="_requirements_2">10.10.1. Requirements</h4>
<div class="paragraph"><p>Before you can use the Flying Passenger feature, you must have Phusion Passenger for
Nginx
properly installed.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_basic_usage"></span><h4 data-comment-topic="basic-usage-1qtgvwx" data-anchor="_basic_usage">10.10.2. Basic usage</h4>
<div class="paragraph"><p>Start the Flying Passenger daemon by invoking the <span class="monospaced">flying-passenger</span> command. The only required option is <span class="monospaced">--socket-file</span>. Depending on whether you wish to enable <a href="#user_switching">User Switching</a>, you have to start <span class="monospaced">flying-passenger</span> with root privileges or not.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ sudo flying-passenger --socket-file=/var/run/flying-passenger.sock
I, [2013-06-14T09:10:13.095339 #77179]  INFO -- : Welcome to Flying Passenger 4.1.0
I, [2013-06-14T09:10:13.095339 #77179]  INFO -- : Starting PassengerWatchdog...
I, [2013-06-14T09:10:13.097036 #77179]  INFO -- : PassengerWatchdog started on PID 77181
...
I, [2013-06-14T09:10:13.129017 #77179]  INFO -- : PassengerWatchdog initialized properly
I, [2013-06-14T09:10:13.129127 #77179]  INFO -- : Flying Passenger up and listening on /var/run/flying-passenger.sock!</pre>
</div>
</div>
<div class="paragraph"><p>Now configure the web server to make use of the Flying Passenger daemon,
by setting the <span class="monospaced">passenger_fly_with</span> option to the socket filename:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>http {
    ...
    passenger_fly_with /var/run/flying-passenger.sock;
    ...
}</pre>
</div>
</div>
<div class="paragraph"><p>After (re)starting
Nginx, Nginx + Flying Passenger is fully operational:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ sudo /path-to/nginx</pre>
</div>
</div>
<div class="paragraph"><p>Flying Passenger is fully operational:</p></div>
<div class="paragraph"><p>You can test it by adding a virtual host for a web app:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>http {
    ...

    server {
        listen 80;
        server_name www.foo.local;
        root /webapps/foo/public;
        passenger_enabled on;
    }
}</pre>
</div>
</div>
<div class="paragraph"><p>Verify that it works by making an HTTP request to it:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ curl http://www.foo.local/</pre>
</div>
</div>
<div class="paragraph"><p>Now let’s verify that restarting the web server does not restart the just-spawned application process. Run <span class="monospaced">passenger-status</span> to obtain the PID of the application process:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ sudo passenger-status
Version: 4.1.0
Date   : 2013-06-14 09:21:51 -0400
.---------- General information -----------
Max pool size : 6
Processes     : 1
Requests in top-level queue : 0

.---------- Application groups -----------
/webapps/foo#default:
  App root: /webapps/foo
  Requests in queue: 0
  * PID: 77283   Sessions: 0       Processed: 1       Uptime: 2s
    CPU: 1%      Memory  : 8M      Last used: 2s ago</pre>
</div>
</div>
<div class="paragraph"><p>As you can see, the PID of the application process is <strong>77283</strong>. Now let’s see what happens if we restart the web server:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ sudo /path-to/nginx -s stop
$ sudo /path-to/nginx
$ sudo passenger-status</pre>
</div>
</div>
<div class="paragraph"><p>The application process should remain there, unchanged:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ sudo passenger-status
Version: 4.1.0
Date   : 2013-06-14 09:21:51 -0400
.---------- General information -----------
Max pool size : 6
Processes     : 1
Requests in top-level queue : 0

.---------- Application groups -----------
/webapps/foo#default:
  App root: /webapps/foo
  Requests in queue: 0
  * PID: 77283   Sessions: 0       Processed: 1       Uptime: 18s
    CPU: 1%      Memory  : 8M      Last used: 18s ago</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="configuring_flying_passenger"></span><h4 data-comment-topic="configuring-flying-passenger-n558np" data-anchor="configuring_flying_passenger">10.10.3. Configuring Flying Passenger</h4>
<div class="paragraph"><p>Flying Passenger gets <strong>some</strong> configuration from the web server, but not all. In particular, most web server directives that are only valid in the
<span class="monospaced">http</span> context, e.g. <a href="#PassengerLogLevel">passenger_log_level</a>,
have no effect when using Flying Passenger. Instead, you are supposed to pass these configuration directives through command line options to the Flying Passenger daemon. Configuration directives that have no effect on Flying Passenger are documented as such. You can assume that configuration directives that are not documented as such, work fine on Flying Passenger.</p></div>
<div class="paragraph"><p>For example, to achieve the same effect as setting
<span class="monospaced">passenger_log_level</span>
to 2, run the Flying Passenger daemon as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ sudo flying-passenger --socket-file=/var/run/flying-passenger.sock --log-level=2</pre>
</div>
</div>
<div class="paragraph"><p>Currently, not all configuration directives have a Flying Passenger equivalent. Run the following command to see an overview of available options:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ flying-passenger --help</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_managing_the_flying_passenger_daemon"></span><h4 data-comment-topic="managing-the-flying-passenger-daemon-vjmzdh" data-anchor="_managing_the_flying_passenger_daemon">10.10.4. Managing the Flying Passenger daemon</h4>
<div class="paragraph"><p>The Flying Passenger daemon runs in the foreground by default. This is undesirable on server environments. You can make it go into the background by passing <span class="monospaced">--daemonize</span>, <span class="monospaced">--log-file</span> and <span class="monospaced">--pid-file</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ sudo flying-passenger --socket-file=/var/run/flying-passenger.sock \
    --daemonize --log-file=/var/log/flying-passenger.log \
    --pid-file=/var/run/flying-passenger.pid</pre>
</div>
</div>
<div class="paragraph"><p>You can shut down a Flying Passenger daemon by sending SIGINT or SIGTERM to it:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ kill `cat /var/run/flying-passenger.pid`</pre>
</div>
</div>
<div class="paragraph"><p>We recommend using <a href="http://cr.yp.to/daemontools.html">daemontools</a> or <a href="http://smarden.org/runit/">runit</a> for managing the Flying Passenger daemon. These tools will allow automatically starting the Flying Passenger daemon at boot, and will automatically restart the daemon if it crashes. You can create and enable a daemontools/runit service as folows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ sudo mkdir /etc/service/flying-passenger
$ sudo nano /etc/service/flying-passenger/run
#!/bin/sh
exec /path-to/flying-passenger \
    --socket-file=/var/run/flying-passenger.sock \
    --log-file=/var/log/flying-passenger.log \
    --pid-file=/var/run/flying-passenger.pid</pre>
</div>
</div>
<div class="paragraph"><p>Immediately after creating the <span class="monospaced">run</span> file, daemontools/runit automatically runs it to start the daemon. Note that the location (<span class="monospaced">/etc/service</span>) depends on the OS or Linux distros. Sometimes it’s <span class="monospaced">/service</span>. Also note that we start the Flying Passenger daemon without <span class="monospaced">--daemonize</span>.</p></div>
<div class="paragraph"><p>To shut down a daemontools/runit-managed daemon, you need to use <span class="monospaced">svc -d /etc/service/flying-passenger</span> (daemontools) or <span class="monospaced">sv stop /etc/service/flying-passenger</span> (runit) instead of sending a signal to the process.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="using_flying_passenger_with_mri_18_or_jruby"></span><h4 data-comment-topic="using-flying-passenger-with-mri-1-8-or-jruby-pxho35" data-anchor="using_flying_passenger_with_mri_18_or_jruby">10.10.5. Using Flying Passenger with MRI 1.8 or JRuby</h4>
<div class="paragraph"><p>Using Flying Passenger in combination with MRI Ruby 1.8 or with JRuby requires special attention. This is because the Flying Passenger daemon is written in Ruby, and requires proper <span class="monospaced">Process.spawn</span> support, which neither MRI 1.8 nor JRuby support.</p></div>
<div class="paragraph"><p>It is however possible to use Flying Passenger with MRI Ruby 1.8 and JRuby. You can’t run the Flying Passenger daemon in MRI 1.8 or JRuby, but you can still run the web applications - hosted under Flying Passenger - in MRI 1.8 or JRuby.</p></div>
<div class="paragraph"><p>First, edit your web server configuration file and specify a Ruby interpreter for your web applications. For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre># Connect to the Flying Passenger daemon on the following socket
passenger_fly_with /var/run/flying-passenger.sock;
...

server {
    listen 80;
    server_name www.foo.com;
    root /webapps/foo/public;
    passenger_enabled on;
    # Use JRuby for this web application
    passenger_ruby /opt/jruby/bin/jruby;
}</pre>
</div>
</div>
<div class="paragraph"><p>Then you need to install a Ruby 1.9-compatible Ruby interpreter with POSIX spawn support, alongside JRuby/MRI 1.8. Ruby interpreters which can be used for running the Flying Passenger daemon include:</p></div>
<div class="ulist"><ul>
<li>
<p>
MRI Ruby &gt;= 1.9.
</p>
</li>
<li>
<p>
Rubinius.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The following example demonstrates how you can install MRI Ruby 1.9 in parallel with your MRI Ruby 1.8 or JRuby installation.</p></div>
<div class="paragraph"><p>Example for Debian/Ubuntu users:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Install Ruby 1.9</span></span>
sudo apt-get install ruby1<span style="color: #990000">.</span><span style="color: #993399">9.3</span>
<span style="font-style: italic"><span style="color: #9A1900"># Run the Flying Passenger daemon in Ruby 1.9</span></span>
ruby1<span style="color: #990000">.</span><span style="color: #993399">9</span> -S flying-passenger --socket-file<span style="color: #990000">=</span>/var/run/flying-passenger<span style="color: #990000">.</span>sock</tt></pre>
</div>
</div>
<div class="paragraph"><p>Example for RVM users:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Install Ruby 1.9</span></span>
rvm install <span style="color: #993399">1.9</span><span style="color: #990000">.</span><span style="color: #993399">3</span>
<span style="font-style: italic"><span style="color: #9A1900"># Run the Flying Passenger daemon in Ruby 1.9</span></span>
$ rvm-exec <span style="color: #993399">1.9</span><span style="color: #990000">.</span><span style="color: #993399">3</span> ruby -S flying-passenger --socket-file<span style="color: #990000">=</span>/var/run/flying-passenger<span style="color: #990000">.</span>sock</tt></pre>
</div>
</div>
<div class="paragraph"><p>The Flying Passenger daemon will now be run on Ruby 1.9, while the web application <em>www.foo.com</em> will be run on JRuby.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="flying_passenger_caveats"></span><h4 data-comment-topic="caveats-and-limitations-15wakf" data-anchor="flying_passenger_caveats">10.10.6. Caveats and limitations</h4>
<div class="paragraph"><p>Beware of the following caveats and limitations when using Flying Passenger:</p></div>
<div class="ulist"><ul>
<li>
<p>
The Nginx executable <strong>must</strong> be compiled with the same version of Phusion Passenger as the Flying Passenger daemon. Failing to meet this requirement may result in cryptic errors, or may result in certain features not working, until you’ve fixed the situation. When upgrading Phusion Passenger, you must restart both Nginx and the Flying Passenger daemon.
</p>
</li>
<li>
<p>
The <a href="#PassengerRoot">passenger_root</a> directive has no effect. When using Flying Passenger, you are not supposed to set <span class="monospaced">passenger_root</span>.
</p>
</li>
<li>
<p>
The Flying Passenger daemon is written in Ruby. It requires a Ruby interpreter with proper <span class="monospaced">Process#spawn</span> support. At the time of writing, all Ruby interpreters in existance satisfy this requirement, except for MRI Ruby 1.8 and JRuby. See <a href="#using_flying_passenger_with_mri_18_or_jruby">Using Flying Passenger with MRI 1.8 or JRuby</a> for more information.
</p>
</li>
<li>
<p>
When you add a new application to the web server configuration, Flying Passenger will automatically pick up the application’s settings and spawn this new application upon the first request to it. However it is not capable of automatically starting the new app before a request has been sent to it (i.e.
<a href="#PassengerPreStart">passenger_pre_start</a>-like
behavior is not available in this case). As a workaround, you can send an HTTP request to your application after starting the daemon, which forces it to spawn application processes.
</p>
</li>
<li>
<p>
When you remove an application from the web server configuration, Flying Passenger will not detect the removal and will not shut down the associated application processes. Killing the application processes will also not help, because Flying Passenger will restart them per the (now-removed, but still in the Flying Passenger daemon’s memory)
<a href="#PassengerMinInstances">passenger_min_instances</a>
settings. At the moment, there are two ways to get rid of those processes:
</p>
<div class="ulist"><ul>
<li>
<p>
Before removing the application from the web server configuration, explicitly set its <span class="monospaced">passenger_min_instances</span> to 0. Next, send a request to it, which will cause the Flying Passenger daemon to take over the new <span class="monospaced">passenger_min_instances 0</span> option. You can then proceed with removing the application from the web server configuration, and restarting the web server. Finally, kill the PIDs associated to those application processes and remove the application configuration.
</p>
</li>
<li>
<p>
Restart the Flying Passenger daemon.
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_under_the_hood"></span><h2 data-comment-topic="under-the-hood-8uney" data-anchor="_under_the_hood">11. Under the hood</h2>
<div class="sectionbody">
<div class="paragraph"><p>Phusion Passenger hides a lot of complexity for the end user (i.e. the web server
system administrator), but sometimes it is desirable to know what is going on.
This section describes a few things that Phusion Passenger does under the hood.</p></div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_page_caching_support"></span><h3 data-comment-topic="page-caching-support-nafhf6" data-anchor="_page_caching_support">11.1. Page caching support</h3>
<div class="paragraph"><p>For each HTTP request, Phusion Passenger will automatically look for a corresponding
page cache file, and serve that if it exists. It does this by appending ".html" to
the filename that the URI normally maps to, and checking whether that file exists.
This check occurs after checking whether the original mapped filename exists (as part
of static asset serving). All this is done without the need for special mod_rewrite
rules.</p></div>
<div class="paragraph"><p>For example, suppose that the browser requests <em>/foo/bar</em>.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Phusion Passenger will first check whether this URI maps to a static file, i.e.
   whether the file <em>foo/bar</em> exists in the web application’s <em>public</em> directory.
   If it does then Phusion Passenger will serve this file through the web server immediately.
</p>
</li>
<li>
<p>
If that doesn’t exist, then Phusion Passenger will check whether the file
   <em>foo/bar.html</em> exists. If it does then Phusion Passenger will serve this file
   through the web server immediately.
</p>
</li>
<li>
<p>
If <em>foo/bar.html</em> doesn’t exist either, then Phusion Passenger will forward the
   request to the underlying web application.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Note that Phusion Passenger’s page caching support doesn’t work if your web
application uses a non-standard page cache directory, i.e. if it doesn’t cache to
the <em>public</em> directory. In that case you’ll need to use mod_rewrite to serve such
page cache files.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="relationship_with_ruby"></span><h3 data-comment-topic="phusion-passenger-and-its-relationship-with-ruby-1hub1pa" data-anchor="relationship_with_ruby">11.2. Phusion Passenger and its relationship with Ruby</h3>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_how_ruby_is_used"></span><h4 data-comment-topic="how-ruby-is-used-j7g2a4" data-anchor="_how_ruby_is_used">11.2.1. How Ruby is used</h4>
<div class="paragraph"><p>Phusion Passenger’s core is written in C++ for performance and memory efficiency. It supports web applications written in any language. Phusion Passenger requires Ruby, its usage of Ruby is minimal in order to maximize performance and to minimize memory usage.</p></div>
<div class="ulist"><ul>
<li>
<p>
Phusion Passenger’s installer, build system and administration tools are written in Ruby.
</p>
</li>
<li>
<p>
Certain internally used tools, such as the crash handler (which generates a backtrace in case Phusion Passenger crash) and the prespawn script (used to implement
<a href="#PassengerPreStart">passenger_pre_start</a>)
</p>
</li>
</ul></div>
<div class="paragraph"><p>are written in Ruby as well.
 * Ruby web application support is implemented in Ruby.
 * If you use <a href="#flying_passenger">Flying Passenger</a>, then the Flying Passenger daemon is written in Ruby. The daemon is a small (less than 500 lines of code) and offloads most tasks to the C<span class="monospaced"> core.
 * If you use <a href="Users%20guide%20Standalone.html">Phusion Passenger Standalone</a>, then the frontend (the <span class="monospaced">passenger</span> command) is written in Ruby. The frontend is small (less than 1500 lines of code) and offloads most tasks to the C</span> core.</p></div>
<div class="paragraph"><p>Other than the aforementioned aspects, Phusion Passenger does not use Ruby during normal operation. For example, if you run Python WSGI web applications on Phusion Passenger, then there will be (almost) no Ruby code running on the system.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_when_the_system_has_multiple_ruby_interpreters"></span><h4 data-comment-topic="when-the-system-has-multiple-ruby-interpreters-fwn3t" data-anchor="_when_the_system_has_multiple_ruby_interpreters">11.2.2. When the system has multiple Ruby interpreters</h4>
<div class="paragraph"><p>Phusion Passenger may be installed with any Ruby interpreter. Once installed, you can run Phusion Passenger’s Ruby parts under any Ruby interpreter you want, even if that Ruby interpreter was not the one you originally installed Phusion Passenger with.</p></div>
<div class="paragraph"><p>The reason for this is that Phusion Passenger does not dynamically link to Ruby: Phusion Passenger uses Ruby entirely out-of-process. Thus you can switch to any Ruby interpreter you want during runtime, without recompiling Phusion Passenger, and without worrying about what Ruby you used to install Phusion Passenger.</p></div>
<div class="paragraph"><p>Phusion Passenger is also capable of running Ruby web applications under any Ruby interpreter you want. So it is not important which Ruby you use to install Phusion Passenger: it will work regardless. Please refer to the documentation for the
<a href="#PassengerRuby">passenger_ruby</a>
directive to learn how run different web applications under different Ruby interpreters.</p></div>
<div class="paragraph">
<div class="title">Caveat: RVM and RVM gemsets</div>
<p>There is however one caveat if you happen to be using RVM or RVM gemsets. When you <span class="monospaced">gem install</span> Phusion Passenger using RVM, then RVM will install Phusion Passenger into the <strong>currently active RVM Ruby and gemset</strong>. This means that Phusion Passenger commands - such as <span class="monospaced">passenger</span>, <span class="monospaced">passenger-install-xxx-module</span> and <span class="monospaced">passenger-status</span> - are available in that same RVM Ruby and gemset only. When you switch Ruby interpreter, or when you switch gemset, the Phusion Passenger commands will no longer be available, and you will get a <span class="monospaced">command not found</span> error. Here’s an example which demonstrates the problem.</p>
</div>
<div class="listingblock">
<div class="title">"Command not found" problem demonstration</div>
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">## Install Phusion Passenger (open source edition) using Ruby 1.9.3</span></span>
<span style="font-style: italic"><span style="color: #9A1900">## and the 'business' gemset</span></span>
$ rvm use <span style="color: #993399">1.9</span><span style="color: #990000">.</span><span style="color: #993399">3</span>
Using /home/phusion<span style="color: #990000">/.</span>rvm/gems/ruby-<span style="color: #993399">1.9</span><span style="color: #990000">.</span><span style="color: #993399">3</span>-p<span style="color: #993399">429</span>
$ rvm gemset create business
$ rvm gemset use business
Using ruby-<span style="color: #993399">1.9</span><span style="color: #990000">.</span><span style="color: #993399">3</span>-p<span style="color: #993399">429</span> with gemset business
$ curl -O https<span style="color: #990000">:</span>//s<span style="color: #993399">3</span><span style="color: #990000">.</span>amazonaws<span style="color: #990000">.</span>com/phusion-passenger/releases/gem_bootstrap<span style="color: #990000">.</span>sh
$ <span style="font-weight: bold"><span style="color: #0000FF">eval</span></span> <span style="color: #FF0000">"`sh gem_bootstrap.sh`"</span>
$ gem install passenger

<span style="font-style: italic"><span style="color: #9A1900">## Verify that passenger works</span></span>
$ passenger --version
Phusion Passenger version <span style="color: #993399">4.0</span><span style="color: #990000">.</span><span style="color: #993399">14</span>

<span style="font-style: italic"><span style="color: #9A1900">## Switch to a different RVM gemset. You will get a `command not found`</span></span>
$ rvm gemset use default
Using ruby-<span style="color: #993399">1.9</span><span style="color: #990000">.</span><span style="color: #993399">3</span>-p<span style="color: #993399">429</span> with gemset default
$ passenger --version
bash<span style="color: #990000">:</span> passenger<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">command</span></span> not found

<span style="font-style: italic"><span style="color: #9A1900">## Switch to a different Ruby interpreter. You will also get</span></span>
<span style="font-style: italic"><span style="color: #9A1900">## a `command not found`</span></span>
$ rvm use <span style="color: #993399">2.0</span><span style="color: #990000">.</span><span style="color: #993399">0</span>
Using /home/phusion<span style="color: #990000">/.</span>rvm/gems/ruby-<span style="color: #993399">2.0</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-p<span style="color: #993399">195</span>
$ passenger --version
bash<span style="color: #990000">:</span> passenger<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">command</span></span> not found

<span style="font-style: italic"><span style="color: #9A1900">## Switch back to the Ruby and gemset that you installed Phusion</span></span>
<span style="font-style: italic"><span style="color: #9A1900">## Passenger with, and verify that it works again</span></span>
$ rvm use <span style="color: #993399">1.9</span><span style="color: #990000">.</span><span style="color: #993399">3</span>
Using /home/phusion<span style="color: #990000">/.</span>rvm/gems/ruby-<span style="color: #993399">2.0</span><span style="color: #990000">.</span><span style="color: #993399">0</span>-p<span style="color: #993399">195</span>
$ rvm gemset use business
Using ruby-<span style="color: #993399">1.9</span><span style="color: #990000">.</span><span style="color: #993399">3</span>-p<span style="color: #993399">429</span> with gemset business
$ passenger --version
Phusion Passenger version <span style="color: #993399">4.0</span><span style="color: #990000">.</span><span style="color: #993399">14</span></tt></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Solutions</div>
<p>There are several ways to solve this problem:</p>
</div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Permanently add Phusion Passenger’s command directory to your PATH, so that your shell can always find them even when you switch RVM Ruby or gemset. If you don’t know what PATH means, please read <a href="#about_environment_variable">About environment variables</a> first.
</p>
<div class="paragraph"><p>The drawback is that you have to redo this every time you upgrade Phusion Passenger, because the Phusion Passenger directory filename is dependent on the version number.</p></div>
<div class="paragraph"><p>First, identify the location of the Phusion Passenger command directory, like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ echo `passenger-config --root`/bin
/home/phusion/.rvm/gems/ruby-1.9.3-p429/gems/passenger-4.0.15/bin</pre>
</div>
</div>
<div class="paragraph"><p>Next, add the directory that you’ve found to your current shell’s PATH:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ export PATH=/home/phusion/.rvm/gems/ruby-1.9.3-p429/gems/passenger-4.0.15/bin:$PATH</pre>
</div>
</div>
<div class="paragraph"><p>Finally, make the change permanent by appending the above command to your bash startup file:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ echo 'export PATH=/home/phusion/.rvm/gems/ruby-1.9.3-p429/gems/passenger-4.0.15/bin:$PATH' &gt;&gt; ~/.bashrc</pre>
</div>
</div>
</li>
<li>
<p>
Switch back to the RVM Ruby and gemset that you installed Phusion Passenger with, before running any Phusion Passenger command.
</p>
</li>
<li>
<p>
Prepend any Phusion Passenger command with <span class="monospaced">rvm-exec RUBY_NAME@GEMSET_NAME ruby -S</span>. If the relevant Phusion Passenger command also needs root privileges, then prepend <span class="monospaced">rvmsudo</span> before that. For example:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>rvm-exec 1.9.3@business ruby -S passenger --version
rvmsudo rvm-exec 1.9.3@business ruby -S passenger-install-apache2-module</pre>
</div>
</div>
</li>
</ol></div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="application_detection"></span><h3 data-comment-topic="how-phusion-passenger-detects-whether-a-virtual-host-is-a-web-application-13qbmhn" data-anchor="application_detection">11.3. How Phusion Passenger detects whether a virtual host is a web application</h3>
<div class="paragraph"><p>After you’ve read the deployment instructions you might wonder how Phusion Passenger
knows that the server root points to a web application that Phusion Passenger is
able to serve, and how it knows what kind of web application it is (e.g. Rails or Rack).</p></div>
<div class="paragraph"><p>Phusion Passenger checks whether the virtual host is a Rails application by checking
whether the following file exists:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>dirname(DocumentRoot) + "/config/environment.rb"</pre>
</div>
</div>
<div class="paragraph"><p>If you’re not a programmer and don’t understand the above pseudo-code snippet, it means
that Phusion Passenger will:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Extract the parent directory filename from the value of the “root” directive.
</p>
</li>
<li>
<p>
Append the text "/config/environment.rb" to the result, and check whether the resulting
   filename exists.
</p>
</li>
</ol></div>
<div class="paragraph"><p>So suppose that your server root is <em>/webapps/foo/public</em>. Phusion Passenger will check
whether the file <em>/webapps/foo/config/environment.rb</em> exists.</p></div>
<div class="paragraph"><p>Note that Phusion Passenger for Nginx does <strong>not</strong> resolve any symlinks in the root path.
So for example, suppose that your root points to <em>/home/www/example.com</em>, which in
turn is a symlink to <em>/webapps/example.com/public</em>. Phusion Passenger for Nginx will check for
<em>/home/www/config/environment.rb</em>, <strong>not</strong> <em>/webapps/example.com/config/environment.rb</em>.
This file of course doesn’t exist, and as a result Phusion Passenger will not activate
itself for this virtual host, and you’ll most likely see some output generated by the
Nginx default directory handler such as a Forbidden error message.</p></div>
<div class="paragraph"><p>Detection of Rack applications happens through the same mechanism, exception that
Phusion Passenger will look for <em>config.ru</em> instead of <em>config/environment.rb</em>.</p></div>
</div>
</div>
</div>
<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_appendix_a_about_this_document"></span><h2 data-comment-topic="appendix-a-about-this-document-zfvixm" data-anchor="_appendix_a_about_this_document">12. Appendix A: About this document</h2>
<div class="sectionbody">
<div class="paragraph"><p>The text of this document is licensed under the
<a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons
Attribution-Share Alike 3.0 Unported License</a>.</p></div>
<div class="paragraph"><p><span class="image">
<a class="image" href="http://creativecommons.org/licenses/by-sa/3.0/">
<img src="images/by_sa.png" alt="images/by_sa.png">
</a>
</span></p></div>
<div class="paragraph"><p>Phusion Passenger is brought to you by <a href="http://www.phusion.nl/">Phusion</a>.</p></div>
<div class="paragraph"><p><span class="image">
<a class="image" href="http://www.phusion.nl/">
<img src="images/phusion_banner.png" alt="images/phusion_banner.png">
</a>
</span></p></div>
<div class="paragraph"><p>Phusion Passenger is a trademark of Hongli Lai &amp; Ninh Bui.</p></div>
</div>
</div>
<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_appendix_b_terminology"></span><h2 data-comment-topic="appendix-b-terminology-wzv5ro" data-anchor="_appendix_b_terminology">13. Appendix B: Terminology</h2>
<div class="sectionbody">
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="application_root"></span><h3 data-comment-topic="application-root-1fd6bqv" data-anchor="application_root">13.1. Application root</h3>
<div class="paragraph"><p>The root directory of an application that’s served by Phusion Passenger.</p></div>
<div class="paragraph"><p>In case of Ruby on Rails applications, this is the directory that contains
<em>Rakefile</em>, <em>app/</em>, <em>config/</em>, <em>public/</em>, etc. In other words, the directory
pointed to by <span class="monospaced">RAILS_ROOT</span>. For example, take the following directory structure:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>/apps/foo/       &lt;------ This is the Rails application's application root!
   |
   +- app/
   |   |
   |   +- controllers/
   |   |
   |   +- models/
   |   |
   |   +- views/
   |
   +- config/
   |   |
   |   +- environment.rb
   |   |
   |   +- ...
   |
   +- public/
   |   |
   |   +- ...
   |
   +- ...</pre>
</div>
</div>
<div class="paragraph"><p>In case of Rack applications, this is the directory that contains <em>config.ru</em>.
For example, take the following directory structure:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>/apps/bar/      &lt;----- This is the Rack application's application root!
   |
   +- public/
   |    |
   |    +- ...
   |
   +- config.ru
   |
   +- ...</pre>
</div>
</div>
<div class="paragraph"><p>In case of Python (WSGI) applications, this is the directory that contains
<em>passenger_wsgi.py</em>. For example, take the following directory structure:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>/apps/baz/      &lt;----- This is the WSGI application's application root!
   |
   +- public/
   |    |
   |    +- ...
   |
   +- passenger_wsgi.py
   |
   +- ...</pre>
</div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="idle_process"></span><h3 data-comment-topic="idle-process-13byfw9" data-anchor="idle_process">13.2. Idle process</h3>
<div class="paragraph"><p>An "idle process" refers to a process that hasn’t processed any requests for a while.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="inactive_process"></span><h3 data-comment-topic="inactive-process-1d2h0po" data-anchor="inactive_process">13.3. Inactive process</h3>
<div class="paragraph"><p>An "inactive process" refers to a process that’s current not processing any requests. An idle process is always inactive, but an inactive process is not always considered idle.</p></div>
</div>
</div>
</div>
<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="spawning_methods_explained"></span><h2 data-comment-topic="appendix-c-spawning-methods-explained-tcp8e6" data-anchor="spawning_methods_explained">14. Appendix C: Spawning methods explained</h2>
<div class="sectionbody">
<div class="paragraph"><p>At its core, Phusion Passenger is an HTTP proxy and process manager. It spawns
application processes and forwards incoming HTTP request to one of them.</p></div>
<div class="paragraph"><p>While this may sound simple, there’s not just one way to spawn application processes.
Let’s go over the different spawning methods. For simplicity’s sake, let’s
assume that we’re only talking about Ruby on Rails applications.</p></div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_the_most_straightforward_and_traditional_way_direct_spawning"></span><h3 data-comment-topic="the-most-straightforward-and-traditional-way-conservative-spawning-civ29z" data-anchor="_the_most_straightforward_and_traditional_way_direct_spawning">14.1. The most straightforward and traditional way: direct spawning</h3>
<div class="paragraph"><p>Phusion Passenger could create a new Ruby process, which will then load the
Rails application along with the entire Rails framework. This process will then
enter an request handling main loop.</p></div>
<div class="paragraph"><p>This is the most straightforward way to spawn processes, and each process contains
a full copy of the Rails application and the Rails framework in memory.</p></div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_the_smart_spawning_method"></span><h3 data-comment-topic="the-smart-spawning-method-7nhgtj" data-anchor="_the_smart_spawning_method">14.2. The smart spawning method</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">Smart spawning is only supported for Ruby applications. It’s not supported for other languages.</td>
</tr></table>
</div>
<div class="paragraph"><p>While direct spawning works well, it’s not as efficient as it could be
because each process has its own private copy of the Rails application
as well as the Rails framework. This wastes memory as well as startup time.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/direct_spawning.png" alt="Application processes and direct spawning">
</span><br>
<em>Figure: Application processes and direct spawning. Each process has its
own private copy of the application code and Rails framework code.</em></p></div>
<div class="paragraph"><p>It is possible to make the different processes share the memory occupied
by application and Rails framework code, by utilizing so-called
copy-on-write semantics of the virtual memory system on modern operating
systems. As a side effect, the startup time is also reduced. This is technique
is exploited by Phusion Passenger’s <em>smart</em> spawn method.</p></div>
<div class="paragraph"><p>The <em>smart</em> spawn method is similar to Unicorn’s <span class="monospaced">preload_app true</span> feature.</p></div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_how_it_works"></span><h4 data-comment-topic="how-it-works-f9umga" data-anchor="_how_it_works">14.2.1. How it works</h4>
<div class="paragraph"><p>When the <em>smart</em> spawn method is being used, Phusion Passenger will first
create a so-called <em>preloader</em> process. This process loads the
entire Rails application along with the Rails framework, by evaluating
<span class="monospaced">config.ru</span>. Then, whenever Phusion Passenger needs a new application process,
it will instruct the preloader to create one. The preloader then then spawns
a child process, which is an exact virtual copy of itself. This child process
therefore already has the application code and the Rails framework code in memory.</p></div>
<div class="paragraph"><p>Creating a process like this is very fast, about 10 times faster than loading the
Rails application/framework from scratch. On top of that, the OS also applies an
optimization called <em>copy-on-write</em>. This means that all memory that the child
process hasn’t modified, is shared with the parent process.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/smart_spawning.png" alt="images/smart_spawning.png">
</span><br>
<em>Figure: Application processes and the smart spawn method. All processes,
as well as the preloader, share the same application code and Rails
framework code.</em></p></div>
<div class="paragraph"><p>However, Ruby can only leverage this copy-on-write optimization if its garbage
collector is friendly. This is only the case starting from Ruby 2.0.0. Earlier
versions cannot leverage copy-on-write optimizations.</p></div>
<div class="paragraph"><p>Note that preloader processes have an idle timeout just like application processes.
If a preloader hasn’t been instructed to do anything for a while, it will be shutdown
in order to conserve memory. This idle timeout is configurable.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_summary_of_benefits"></span><h4 data-comment-topic="summary-of-benefits-qovyvk" data-anchor="_summary_of_benefits">14.2.2. Summary of benefits</h4>
<div class="paragraph"><p>Suppose that Phusion Passenger needs a process for an application
that uses Rails 4.1.0.</p></div>
<div class="paragraph"><p>If the <em>smart</em> spawning method is used, and a preloader for this application is
already running, then process creation time is about 10 times faster than direct
spawning. This process will also share application and Rails framework code memory
with the preloader, as well as with other processes that have been spawned by the
same preloader.</p></div>
<div class="paragraph"><p>In practice, the smart spawning method could mean a memory saving of about 33%,
assuming that your Ruby interpreter is copy-on-write friendly.</p></div>
<div class="paragraph"><p>Of course, smart spawning is not without caveats. But if you understand the
caveats you can easily reap the benefits of smart spawning.</p></div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_smart_spawning_caveat_1_unintentional_file_descriptor_sharing"></span><h3 data-comment-topic="smart-spawning-gotcha-1-unintentional-file-descriptor-sharing-cebw6q" data-anchor="_smart_spawning_caveat_1_unintentional_file_descriptor_sharing">14.3. Smart spawning caveat #1: unintentional file descriptor sharing</h3>
<div class="paragraph"><p>Because application processes are created by forking from a preloader process,
it will share all file descriptors that are opened by the
preloader process. (This is part of the semantics of the Unix
<em>fork()</em> system call. You might want to Google it if you’re not familiar with
it.) A file descriptor is a handle which can be an opened file, an opened socket
connection, a pipe, etc. If different application processes write to such a file
descriptor at the same time, then their write calls will be interleaved, which
may potentially cause problems.</p></div>
<div class="paragraph"><p>The problem commonly involves socket connections that are unintentionally being
shared. You can fix it by closing and reestablishing the connection when Phusion
Passenger is creating a new application process. Phusion Passenger provides the API
call <span class="monospaced">PhusionPassenger.on_event(:starting_worker_process)</span> to do so. So you
could insert the following code in your <em>config.ru</em>:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">defined</span></span><span style="color: #990000">?(</span>PhusionPassenger<span style="color: #990000">)</span>
    PhusionPassenger<span style="color: #990000">.</span>on_event<span style="color: #990000">(:</span>starting_worker_process<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>forked<span style="color: #990000">|</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> forked
            <span style="font-style: italic"><span style="color: #9A1900"># We're in smart spawning mode.</span></span>
            <span style="color: #990000">...</span> code to reestablish socket connections here <span style="color: #990000">...</span>
        <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
            <span style="font-style: italic"><span style="color: #9A1900"># We're in direct spawning mode. We don't need to do anything.</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre>
</div>
</div>
<div class="paragraph"><p>Note that Phusion Passenger automatically reestablishes the connection to the
database upon creating a new application process, which is why you normally do not
encounter any database issues when using smart spawning mode.</p></div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_example_1_memcached_connection_sharing_harmful"></span><h4 data-comment-topic="example-1-memcached-connection-sharing-harmful--1wfs3ad" data-anchor="_example_1_memcached_connection_sharing_harmful">14.3.1. Example 1: Memcached connection sharing (harmful)</h4>
<div class="paragraph"><p>Suppose we have a Rails application that connects to a Memcached server in
<em>environment.rb</em>. This causes the preloader to have a socket connection
(file descriptor) to the Memcached server, as shown in the following figure:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>+--------------------+
| Preloader          |-----------[Memcached server]
+--------------------+</pre>
</div>
</div>
<div class="paragraph"><p>Phusion Passenger then proceeds with creating a new Rails application process, which
is to process incoming HTTP requests. The result will look like this:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>+--------------------+
| Preloader          |------+----[Memcached server]
+--------------------+      |
                            |
+--------------------+      |
| App process 1      |-----/
+--------------------+</pre>
</div>
</div>
<div class="paragraph"><p>Since a <em>fork()</em> makes a (virtual) complete copy of a process, all its file
descriptors will be copied as well. What we see here is that Preloader
and App process 1 both share the same connection to Memcached.</p></div>
<div class="paragraph"><p>Now supposed that your site gets a sudden large surge of traffic, and Phusion Passenger needs to
spawn another process. It does so by forking Preloader. The result is now as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>+--------------------+
| Preloader          |------+----[Memcached server]
+--------------------+      |
                            |
+--------------------+      |
| App process 1      |-----/|
+--------------------+      |
                            |
+--------------------+      |
| App process 2      |-----/
+--------------------+</pre>
</div>
</div>
<div class="paragraph"><p>As you can see, App process 1 and App process 2 have the same Memcached
connection.</p></div>
<div class="paragraph"><p>Suppose that users Joe and Jane visit your website at the same time. Joe’s
request is handled by App process 1, and Jane’s request is handled by App
process 2. Both application processes want to fetch something from Memcached. Suppose
that in order to do that, both handlers need to send a "FETCH" command to Memcached.</p></div>
<div class="paragraph"><p>But suppose that, after App process 1 having only sent "FE", a context switch
occurs, and App process 2 starts sending a "FETCH" command to Memcached as
well. If App process 2 succeeds in sending only one bye, <em>F</em>, then Memcached
will receive a command which begins with "FEF", a command that it does not
recognize. In other words: the data from both handlers get interleaved. And thus
Memcached is forced to handle this as an error.</p></div>
<div class="paragraph"><p>This problem can be solved by reestablishing the connection to Memcached after forking:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>+--------------------+
| Preloader          |------+----[Memcached server]
+--------------------+      |                   |
                            |                   |
+--------------------+      |                   |
| App process 1      |-----/|                   |
+--------------------+      |                   |  &lt;--- created this
                            X                   |       new
                                                |       connection
                            X &lt;-- closed this   |
+--------------------+      |     old           |
| App process 2      |-----/      connection    |
+--------------------+                          |
          |                                     |
          +-------------------------------------+</pre>
</div>
</div>
<div class="paragraph"><p>App process 2 now has its own, separate communication channel with Memcached.
The code in <em>environment.rb</em> looks like this:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">defined</span></span><span style="color: #990000">?(</span>PhusionPassenger<span style="color: #990000">)</span>
    PhusionPassenger<span style="color: #990000">.</span>on_event<span style="color: #990000">(:</span>starting_worker_process<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>forked<span style="color: #990000">|</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> forked
            <span style="font-style: italic"><span style="color: #9A1900"># We're in smart spawning mode.</span></span>
            reestablish_connection_to_memcached
        <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
            <span style="font-style: italic"><span style="color: #9A1900"># We're in direct spawning mode. We don't need to do anything.</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_example_2_log_file_sharing_not_harmful"></span><h4 data-comment-topic="example-2-log-file-sharing-not-harmful--ox4yfy" data-anchor="_example_2_log_file_sharing_not_harmful">14.3.2. Example 2: Log file sharing (not harmful)</h4>
<div class="paragraph"><p>There are also cases in which unintentional file descriptor sharing is not harmful.
One such case is log file file descriptor sharing. Even if two processes write
to the log file at the same time, the worst thing that can happen is that the
data in the log file is interleaved.</p></div>
<div class="paragraph"><p>To guarantee that the data written to the log file is never interleaved, you
must synchronize write access via an inter-process synchronization mechanism,
such as file locks. Reopening the log file, like you would have done in the
Memcached example, doesn’t help.</p></div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_smart_spawning_caveat_2_the_need_to_revive_threads"></span><h3 data-comment-topic="smart-spawning-gotcha-2-the-need-to-revive-threads-1ey176o" data-anchor="_smart_spawning_caveat_2_the_need_to_revive_threads">14.4. Smart spawning caveat #2: the need to revive threads</h3>
<div class="paragraph"><p>Another part of the <em>fork()</em> system call’s semantics is the fact that threads
disappear after a fork call. So if you’ve created any threads in environment.rb,
then those threads will no longer be running in newly created application process.
You need to revive them when a new process is created. Use the
<span class="monospaced">:starting_worker_process</span> event that Phusion Passenger provides, like this:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">defined</span></span><span style="color: #990000">?(</span>PhusionPassenger<span style="color: #990000">)</span>
    PhusionPassenger<span style="color: #990000">.</span>on_event<span style="color: #990000">(:</span>starting_worker_process<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>forked<span style="color: #990000">|</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> forked
            <span style="font-style: italic"><span style="color: #9A1900"># We're in smart spawning mode.</span></span>
            <span style="color: #990000">...</span> code to revive threads here <span style="color: #990000">...</span>
        <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
            <span style="font-style: italic"><span style="color: #9A1900"># We're in direct spawning mode. We don't need to do anything.</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="about_environment_variables"></span><h2 data-comment-topic="appendix-d-about-environment-variables-1t2cuff" data-anchor="about_environment_variables">15. Appendix D: About environment variables</h2>
<div class="sectionbody">
<div class="paragraph"><p>Environment variables are named values that affect how the system works. For example they tell the system where to look for commands (the <span class="monospaced">PATH</span> variable) or where to look for libraries (<span class="monospaced">LD_LIBRARY_PATH</span>). Their names are often in all-uppercase. Sometimes people refer to an environment variable with a dollar sign <span class="monospaced">$</span> in front, but that’s the same thing: when people say "the $PATH environment variable" they mean "the PATH environment variable". This is because the dollar sign <span class="monospaced">$</span> is a shell syntax for refering to an environment variable, as you will learn later.</p></div>
<div class="paragraph"><p>Environment variables are set on a <strong>per-process</strong> basis, but they are <strong>inherited</strong> by child processes. This means that if you set environment variables in process A, another already running process B will not see these new environment variables. But if A spawns a child process C, then C will have all environment variables that A had. If you once again change the environment variables in A, then C will not see the changes.</p></div>
<div class="paragraph"><p>The per-process nature of environment variables some implications. When you set environment variables in your <span class="monospaced">bashrc</span> or other bash startup files…</p></div>
<div class="ulist"><ul>
<li>
<p>
…only newly spawned bash shells see them.
</p>
</li>
<li>
<p>
…the web server usually does not see them, because the web server tends to be started from init scripts, not from bash.
</p>
</li>
<li>
<p>
…cron jobs do not see them, because cron jobs' environment variables are entirely dictated by their crontabs.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">Because this chapter is meant for beginners, it assumes that the reader uses the bash shell. This chapter does not describe instructions for zsh, csh or other shells. We assume that users of other shells are familiar with the Bourne shell syntax, and know how to apply the instructions in this chapter in their shells' native syntaxes.</td>
</tr></table>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_working_with_environment_variables"></span><h3 data-comment-topic="working-with-environment-variables-1kmvq8w" data-anchor="_working_with_environment_variables">15.1. Working with environment variables</h3>
<div class="paragraph"><p>You can see all environment variables in your shell by running the following command:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>env</tt></pre>
</div>
</div>
<div class="paragraph"><p>You can set an evironment variable with the syntax <span class="monospaced">export &lt;NAME&gt;=&lt;VALUE&gt;</span>. For example, to set the <span class="monospaced">APXS2</span> variable to the value <span class="monospaced">/usr/sbin/apxs2</span>:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">APXS2</span><span style="color: #990000">=</span>/usr/sbin/apxs<span style="color: #993399">2</span></tt></pre>
</div>
</div>
<div class="paragraph"><p>Any process that you run from your shell from that point on will have said environment variable:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">APXS2</span><span style="color: #990000">=</span>/usr/sbin/apxs<span style="color: #993399">2</span>
ruby -e <span style="color: #FF0000">'p ENV["APXS2"]'</span>
<span style="font-style: italic"><span style="color: #9A1900"># =&gt; "/usr/sbin/apxs2"</span></span></tt></pre>
</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">
<div class="title">The "export" keyword is important</div>
<div class="paragraph"><p>You <strong>must</strong> set the <span class="monospaced">export</span> keyword. If you omit the <span class="monospaced">export</span> keyword then the environment variable will not be visible to other processes:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">APXS2</span><span style="color: #990000">=</span>/usr/sbin/apxs<span style="color: #993399">2</span>
ruby -e <span style="color: #FF0000">'p ENV["APXS2"]'</span>
<span style="font-style: italic"><span style="color: #9A1900"># =&gt; nil</span></span></tt></pre>
</div>
</div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>You can reference an environment variable in your shell by typing the <span class="monospaced">$</span> sign followed by the environment variable’s name. For example, to see the value of the <span class="monospaced">PATH</span> variable:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>echo <span style="color: #009900">$PATH</span></tt></pre>
</div>
</div>
<div class="paragraph"><p>You can also use this trick to extend the value of an environment variable:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">PATH</span><span style="color: #990000">=</span>/usr/bin

<span style="font-style: italic"><span style="color: #9A1900"># Prepends '/opt/local/bin', so that it becomes /opt/local/bin:/usr/bin</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">PATH</span><span style="color: #990000">=</span>/opt/local/bin<span style="color: #990000">:</span><span style="color: #009900">$PATH</span>
<span style="font-style: italic"><span style="color: #9A1900"># Appends '/usr/local/bin', so that it becomes /opt/local/bin:/usr/bin:/usr/local/bin</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">PATH</span><span style="color: #990000">=</span><span style="color: #009900">$PATH</span><span style="color: #990000">:</span>/usr/local/bin</tt></pre>
</div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="the_path_env_var"></span><h3 data-comment-topic="the-path-environment-variable-vlp05e" data-anchor="the_path_env_var">15.2. The PATH environment variable</h3>
<div class="paragraph"><p>The <span class="monospaced">PATH</span> environment variable dictates where the system looks for command. It is a colon-separated list of directories. If you get a "command not found" error while you know that the command is installed, then setting <span class="monospaced">PATH</span> will help. For example suppose that the command <span class="monospaced">frobnicator</span> is in <span class="monospaced">/opt/local/bin</span>:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user@localhost bash$ frobnicator
bash<span style="color: #990000">:</span> frobnicator<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">command</span></span> not found</tt></pre>
</div>
</div>
<div class="paragraph"><p>We verify that <span class="monospaced">/opt/local/bin</span> is not in <span class="monospaced">PATH</span>:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user@localhost bash$ echo <span style="color: #009900">$PATH</span>
/bin<span style="color: #990000">:</span>/usr/bin<span style="color: #990000">:</span>/usr/local/bin</tt></pre>
</div>
</div>
<div class="paragraph"><p>We can run <span class="monospaced">frobnicator</span> through it’s full path…</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user@localhost bash$ /opt/local/bin/frobnicator
<span style="font-style: italic"><span style="color: #9A1900"># =&gt; success!</span></span></tt></pre>
</div>
</div>
<div class="paragraph"><p>…or we can add <span class="monospaced">/opt/local/bin</span> to <span class="monospaced">PATH</span>.</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user@localhost bash$ <span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">PATH</span><span style="color: #990000">=</span><span style="color: #009900">$PATH</span><span style="color: #990000">:</span>/opt/local/bin
user@localhost bash$ frobnicator
<span style="font-style: italic"><span style="color: #9A1900"># =&gt; success!</span></span></tt></pre>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_adding_phusion_passenger_8217_s_administration_tools_to_path"></span><h4 data-comment-topic="adding-phusion-passenger-s-administration-tools-to-path-1flz2tu" data-anchor="_adding_phusion_passenger_8217_s_administration_tools_to_path">15.2.1. Adding Phusion Passenger’s administration tools to PATH</h4>
<div class="paragraph"><p>If you get a "command not found" error when invoking one of the Phusion Passenger administration tools (e.g. <span class="monospaced">passenger-status</span> or <span class="monospaced">passenger-memory-stats</span> then that means the tools are not in <span class="monospaced">PATH</span>, so you need to add them.</p></div>
<div class="ulist"><ul>
<li>
<p>
If you <a href="#rubygems_generic_install">installed Phusion Passenger with RubyGems</a>, then the tools are in your RubyGems executable path. You can view the gem path using the command <span class="monospaced">gem env</span>:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>$ gem env
RubyGems Environment:
  - RUBYGEMS VERSION: 1.8.15
  - RUBY VERSION: 1.8.7 (2011-12-28 patchlevel 357) [i686-darwin10.8.0]
  - INSTALLATION DIRECTORY: /opt/ruby-enterprise-1.8.7-2010.01/lib/ruby/gems/1.8
  - RUBY EXECUTABLE: /opt/ruby-enterprise-1.8.7-2010.01/bin/ruby
  - EXECUTABLE DIRECTORY: /opt/ruby-enterprise-1.8.7-2010.01/bin    &lt;--------- !!
  - RUBYGEMS PLATFORMS:
    - ruby
    - x86-darwin-10
  - GEM PATHS:
     - /opt/ruby-enterprise-1.8.7-2010.01/lib/ruby/gems/1.8
     - /Users/hongli/.gem/ruby/1.8
  - GEM CONFIGURATION:
     - :update_sources =&gt; true
     - :verbose =&gt; true
     - :benchmark =&gt; false
     - :backtrace =&gt; false
     - :bulk_threshold =&gt; 1000
     - "gem" =&gt; "--no-ri --no-rdoc"
  - REMOTE SOURCES:
     - http://rubygems.org/</pre>
</div>
</div>
<div class="paragraph"><p>As you can see, the RubyGems executable path in the example happens to be <span class="monospaced">/opt/ruby-enterprise-1.8.7-2010.01/bin</span>. So that directory must be added to <span class="monospaced">PATH</span>.</p></div>
</li>
<li>
<p>
If you <a href="#tarball_generic_install">installed Phusion Passenger using the tarball</a>, then the tools are in the <span class="monospaced">bin</span> subdirectory of the Phusion Passenger tarball directory that you extracted. For example, if you extracted <span class="monospaced">passenger-4.9.0.tar.gz</span> inside <span class="monospaced">/opt</span>, then the tools are located in <span class="monospaced">/opt/passenger-4.0.9/bin</span>. In that case, you need to add <span class="monospaced">/opt/passenger-4.0.9/bin</span> to your <span class="monospaced">PATH</span>.
</p>
</li>
<li>
<p>
If you installed Phusion Passenger using native OS packages, then some Phusion Passenger administration tools are in <span class="monospaced">/usr/bin</span>, while others are in <span class="monospaced">/usr/sbin</span>. If you are not logged in as root, then <span class="monospaced">/usr/sbin</span> may not be in <span class="monospaced">PATH</span>, which would explain why you get a "command not found" when trying to invoke some of the tools. You should <span class="monospaced">/usr/sbin</span> to <span class="monospaced">PATH</span>.
</p>
</li>
<li>
<p>
If you are unsure where your Phusion Passenger directory is then you can use the <span class="monospaced">find</span> command to look them up. Go to the root directory and invoke <span class="monospaced">find</span> with <span class="monospaced">sudo</span>:
</p>
<div class="listingblock">
<div class="content monospaced">
<pre>$ cd /
$ sudo find . -name passenger-status
/usr/local/passenger/bin/passenger-status</pre>
</div>
</div>
<div class="paragraph"><p>In this example, the administration tools happen to be in <span class="monospaced">/usr/local/passenger/bin</span>, so you must add that to <span class="monospaced">PATH</span>.</p></div>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">You may still get a "command not found" when invoking the tools through sudo, even after you’ve added the relevant directory to <span class="monospaced">PATH</span>. Please read <a href="#env_vars_and_sudo">Environment variables and sudo</a> to learn more.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_making_environment_variables_permanent"></span><h3 data-comment-topic="making-environment-variables-permanent-1wjyhzt" data-anchor="_making_environment_variables_permanent">15.3. Making environment variables permanent</h3>
<div class="paragraph"><p>When you exit your shell, the evironment variable changes are lost. There is no standard method to set environment variables system-wide, so you have to set them in different configuration files for different services.</p></div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_bash"></span><h4 data-comment-topic="bash-19xsxec" data-anchor="_bash">15.3.1. bash</h4>
<div class="paragraph"><p>To make environment variables permanent for future bash sessions <strong>for the current user</strong>, add them to your <span class="monospaced">~/.bashrc</span>:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>echo <span style="color: #FF0000">'export FOO=bar'</span> <span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">~/.</span>bashrc
echo <span style="color: #FF0000">'export PATH=/usr/local/bin:$PATH'</span> <span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">~/.</span>bashrc</tt></pre>
</div>
</div>
<div class="paragraph"><p>To make them permanent for future bash sessions <strong>for all users</strong>, add them to <span class="monospaced">/etc/bashrc</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">Depending on the system, the bashrc file may have a different filename. On Debian and Ubuntu, it’s <span class="monospaced">/etc/bash.bashrc</span>.
NOTE: Make sure your <span class="monospaced">~/.bashrc</span> is actually included by your <span class="monospaced">~/.profile</span>, which might not be the case if you created the user with <span class="monospaced">useradd</span> instead of <span class="monospaced">adduser</span> for example</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_apache"></span><h4 data-comment-topic="apache-9hqtyj" data-anchor="_apache">15.3.2. Apache</h4>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">This subsection describes how to set environment variables on Apache itself, not on apps served through Phusion Passenger for Apache. The environment variables you set here will be passed to all apps, but you cannot customize them on a per-app basis. See also <a href="#env_vars_passenger_apps">Setting environment variables on Phusion Passenger-served apps</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>On Debian and Ubuntu, with an Apache installed through apt, Apache environment variables are defined in the file <span class="monospaced">/etc/apache2/envvars</span>. This is a shell script so environment variables must be specified with the shell syntax.</p></div>
<div class="paragraph"><p>On Red Hat, Fedora, CentOS and ScientificLinux, with an Apache installed through YUM, Apache environment variables are defined in <span class="monospaced">/etc/sysconfig/httpd</span>.</p></div>
<div class="paragraph"><p>On OS X they are defined in <span class="monospaced">/System/Library/LaunchDaemons/org.apache.httpd.plist</span>, as explained <a href="/System/Library/LaunchDaemons/org.apache.httpd.plist">here on Stack Overflow</a>.</p></div>
<div class="paragraph"><p>On other systems, or if you did not install Apache through the system’s package manager, the configuration file for environment variables is specific to the vendor that supplied Apache. There may not even be such a configuration file. You should contact the vendor for support.</p></div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_nginx"></span><h4 data-comment-topic="nginx-157dpwy" data-anchor="_nginx">15.3.3. Nginx</h4>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">This subsection describes how to set environment variables on Nginx itself, not on apps served through Phusion Passenger for Nginx. The environment variables you set here will be passed to all apps, but you cannot customize them on a per-app basis. See also <a href="#env_vars_passenger_apps">Setting environment variables on Phusion Passenger-served apps</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>If you installed Nginx through <a href="#install_on_debian_ubuntu">the Debian or Ubuntu packages</a>, then you can define environment variables in <span class="monospaced">/etc/default/nginx</span>. This is a shell script so you must use the <span class="monospaced">export FOO=bar</span> syntax.</p></div>
<div class="paragraph"><p>Otherwise, environment variables are best set through the script which starts Nginx. For example, if you installed Nginx from source and you used
<a href="#nginx_init_script">the Nginx init script described earlier in this manual</a>,
then you should edit that script to define the environment variables. Those init scripts are regular shell scripts, so use the <span class="monospaced">export FOO=bar</span> syntax. Just make sure your set your environment variables before the script starts Nginx.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">Setting environment variables on Nginx has no effect on the <a href="#flying_passenger">Flying Passenger daemon</a> because the daemon is started seperately. You should set the environment variables in the shell right before starting the daemon.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="_cron"></span><h4 data-comment-topic="cron-1nuc9cz" data-anchor="_cron">15.3.4. cron</h4>
<div class="paragraph"><p>To make environment variables permanent for cron jobs, add those variables to the relevant crontab. But note that inside crontabs you cannot refer to existing environment variables with the <span class="monospaced">$</span> syntax because crontabs are not shell scripts. You have to specify the entire value.</p></div>
<div class="listingblock">
<div class="title">What to put in "crontab -e"</div>
<div class="content monospaced">
<pre># Environment variable definitions
FOO=bar
APXS2=/usr/sbin/apxs2

# **WRONG!** You cannot refer to existing variables with the `$` syntax!
PATH=/usr/bin:$PATH
# **WRONG!** You cannot use the 'export' keyword!
export PATH=/usr/bin:/usr/local/bin
# Correct:
PATH=/usr/bin:/usr/local/bin

# Jobs:
# m h  dom mon dow   command
  * *  *   *   *     frobnicator</pre>
</div>
</div>
</div>
<div class="sect3">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="env_vars_passenger_apps"></span><h4 data-comment-topic="phusion-passenger-served-apps-uiewl5" data-anchor="env_vars_passenger_apps">15.3.5. Phusion Passenger-served apps</h4>
<div class="paragraph"><p>You can pass environment variables to Phusion Passenger-served apps through various methods:</p></div>
<div class="ulist"><ul>
<li>
<p>
When running Apache, use the <span class="monospaced">PassEnv</span> and <span class="monospaced">SetEnv</span> directives of <a href="http://httpd.apache.org/docs/2.4/mod/mod_env.html">mod_env</a>. This is supported starting from Phusion Passenger 4.0.
</p>
</li>
<li>
<p>
When running Nginx, use the <a href="#PassengerEnvVar">passenger_env_var</a> directive.
</p>
</li>
<li>
<p>
Through your <span class="monospaced">bashrc</span>. Starting from version 4.0, Phusion Passenger 4.0 spawns applications through bash and inherit all bash environment variables. Phusion Passenger Standalone tends to be started from the shell and thus inherits all environment variables set by the shell.
</p>
</li>
<li>
<p>
Through Apache and Nginx, as described earlier in this chapter. Any environment variables that you set on Apache and Nginx itself are inherited by Phusion Passenger, and thus by Phusion Passenger-served apps as well.
</p>
</li>
<li>
<p>
Through the application itself. Most programming languages provide APIs for setting environment variables. For example in Ruby you can write:
</p>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ENV<span style="color: #990000">[</span><span style="color: #FF0000">'FOO'</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">'bar'</span></tt></pre>
</div>
</div>
<div class="paragraph"><p>In Python you can write:</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> os
os<span style="color: #990000">.</span>environ<span style="color: #990000">[</span><span style="color: #FF0000">'FOO'</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">'bar'</span></tt></pre>
</div>
</div>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<a href="javascript:void(0)" class="comments empty" title="Add a comment"><span class="count"></span></a><span class="anchor_helper" id="env_vars_and_sudo"></span><h3 data-comment-topic="environment-variables-and-sudo-10lphxn" data-anchor="env_vars_and_sudo">15.4. Environment variables and sudo</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">RVM users should always use the <span class="monospaced">rvmsudo</span> command instead of <span class="monospaced">sudo</span>. However all information in this section apply to <span class="monospaced">rvmsudo</span> as well.</td>
</tr></table>
</div>
<div class="paragraph"><p>The <span class="monospaced">sudo</span> command resets all environment variables before running the specified command, for security reasons. So if you set environment variables before running <span class="monospaced">sudo passenger-install-xxx-module</span>, <span class="monospaced">sudo passenger-status</span> or any other commands, then the environment variables are not correctly passed to the command. You can solve this by running sudo with <span class="monospaced">-E</span> (preserve environment variables):</p></div>
<div class="listingblock">
<div class="content">
<!-- Generator: GNU source-highlight 2.11.1
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>user@localhost bash$ <span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">APXS2</span><span style="color: #990000">=</span>/usr/sbin/apxs<span style="color: #993399">2</span>
user@localhost bash$ sudo -E passenger-install-apache<span style="color: #993399">2</span>-module</tt></pre>
</div>
</div>
<div class="paragraph"><p>Alternatively, you can obtain a root prompt with sudo first, and <strong>then</strong> set the environment variables, before running any further commands:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>user@localhost bash$ sudo -s
Password: ...
root@localhost bash# export APXS2=/usr/sbin/apxs2
root@localhost bash# passenger-install-apache2-module</pre>
</div>
</div>
<div class="paragraph"><p>Note that for security reasons, <span class="monospaced">sudo</span> <strong>always resets the <span class="monospaced">PATH</span> environment variable</strong>, even if you pass <span class="monospaced">-E</span>! You can get around this problem by obtaining a root prompt first, and then set the environment variables:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>user@localhost bash$ sudo -s
Password: ...
root@localhost bash# export PATH=$PATH:/opt/myruby/bin
root@localhost bash# passenger-install-apache2-module</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">

</div>
<script>/*! jQuery v1.7.1 jquery.com | jquery.org/license */
(function(a,b){function cy(a){return f.isWindow(a)?a:a.nodeType===9?a.defaultView||a.parentWindow:!1}function cv(a){if(!ck[a]){var b=c.body,d=f("<"+a+">").appendTo(b),e=d.css("display");d.remove();if(e==="none"||e===""){cl||(cl=c.createElement("iframe"),cl.frameBorder=cl.width=cl.height=0),b.appendChild(cl);if(!cm||!cl.createElement)cm=(cl.contentWindow||cl.contentDocument).document,cm.write((c.compatMode==="CSS1Compat"?"<!doctype html>":"")+"<html><body>"),cm.close();d=cm.createElement(a),cm.body.appendChild(d),e=f.css(d,"display"),b.removeChild(cl)}ck[a]=e}return ck[a]}function cu(a,b){var c={};f.each(cq.concat.apply([],cq.slice(0,b)),function(){c[this]=a});return c}function ct(){cr=b}function cs(){setTimeout(ct,0);return cr=f.now()}function cj(){try{return new a.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}function ci(){try{return new a.XMLHttpRequest}catch(b){}}function cc(a,c){a.dataFilter&&(c=a.dataFilter(c,a.dataType));var d=a.dataTypes,e={},g,h,i=d.length,j,k=d[0],l,m,n,o,p;for(g=1;g<i;g++){if(g===1)for(h in a.converters)typeof h=="string"&&(e[h.toLowerCase()]=a.converters[h]);l=k,k=d[g];if(k==="*")k=l;else if(l!=="*"&&l!==k){m=l+" "+k,n=e[m]||e["* "+k];if(!n){p=b;for(o in e){j=o.split(" ");if(j[0]===l||j[0]==="*"){p=e[j[1]+" "+k];if(p){o=e[o],o===!0?n=p:p===!0&&(n=o);break}}}}!n&&!p&&f.error("No conversion from "+m.replace(" "," to ")),n!==!0&&(c=n?n(c):p(o(c)))}}return c}function cb(a,c,d){var e=a.contents,f=a.dataTypes,g=a.responseFields,h,i,j,k;for(i in g)i in d&&(c[g[i]]=d[i]);while(f[0]==="*")f.shift(),h===b&&(h=a.mimeType||c.getResponseHeader("content-type"));if(h)for(i in e)if(e[i]&&e[i].test(h)){f.unshift(i);break}if(f[0]in d)j=f[0];else{for(i in d){if(!f[0]||a.converters[i+" "+f[0]]){j=i;break}k||(k=i)}j=j||k}if(j){j!==f[0]&&f.unshift(j);return d[j]}}function ca(a,b,c,d){if(f.isArray(b))f.each(b,function(b,e){c||bE.test(a)?d(a,e):ca(a+"["+(typeof e=="object"||f.isArray(e)?b:"")+"]",e,c,d)});else if(!c&&b!=null&&typeof b=="object")for(var e in b)ca(a+"["+e+"]",b[e],c,d);else d(a,b)}function b_(a,c){var d,e,g=f.ajaxSettings.flatOptions||{};for(d in c)c[d]!==b&&((g[d]?a:e||(e={}))[d]=c[d]);e&&f.extend(!0,a,e)}function b$(a,c,d,e,f,g){f=f||c.dataTypes[0],g=g||{},g[f]=!0;var h=a[f],i=0,j=h?h.length:0,k=a===bT,l;for(;i<j&&(k||!l);i++)l=h[i](c,d,e),typeof l=="string"&&(!k||g[l]?l=b:(c.dataTypes.unshift(l),l=b$(a,c,d,e,l,g)));(k||!l)&&!g["*"]&&(l=b$(a,c,d,e,"*",g));return l}function bZ(a){return function(b,c){typeof b!="string"&&(c=b,b="*");if(f.isFunction(c)){var d=b.toLowerCase().split(bP),e=0,g=d.length,h,i,j;for(;e<g;e++)h=d[e],j=/^\+/.test(h),j&&(h=h.substr(1)||"*"),i=a[h]=a[h]||[],i[j?"unshift":"push"](c)}}}function bC(a,b,c){var d=b==="width"?a.offsetWidth:a.offsetHeight,e=b==="width"?bx:by,g=0,h=e.length;if(d>0){if(c!=="border")for(;g<h;g++)c||(d-=parseFloat(f.css(a,"padding"+e[g]))||0),c==="margin"?d+=parseFloat(f.css(a,c+e[g]))||0:d-=parseFloat(f.css(a,"border"+e[g]+"Width"))||0;return d+"px"}d=bz(a,b,b);if(d<0||d==null)d=a.style[b]||0;d=parseFloat(d)||0;if(c)for(;g<h;g++)d+=parseFloat(f.css(a,"padding"+e[g]))||0,c!=="padding"&&(d+=parseFloat(f.css(a,"border"+e[g]+"Width"))||0),c==="margin"&&(d+=parseFloat(f.css(a,c+e[g]))||0);return d+"px"}function bp(a,b){b.src?f.ajax({url:b.src,async:!1,dataType:"script"}):f.globalEval((b.text||b.textContent||b.innerHTML||"").replace(bf,"/*$0*/")),b.parentNode&&b.parentNode.removeChild(b)}function bo(a){var b=c.createElement("div");bh.appendChild(b),b.innerHTML=a.outerHTML;return b.firstChild}function bn(a){var b=(a.nodeName||"").toLowerCase();b==="input"?bm(a):b!=="script"&&typeof a.getElementsByTagName!="undefined"&&f.grep(a.getElementsByTagName("input"),bm)}function bm(a){if(a.type==="checkbox"||a.type==="radio")a.defaultChecked=a.checked}function bl(a){return typeof a.getElementsByTagName!="undefined"?a.getElementsByTagName("*"):typeof a.querySelectorAll!="undefined"?a.querySelectorAll("*"):[]}function bk(a,b){var c;if(b.nodeType===1){b.clearAttributes&&b.clearAttributes(),b.mergeAttributes&&b.mergeAttributes(a),c=b.nodeName.toLowerCase();if(c==="object")b.outerHTML=a.outerHTML;else if(c!=="input"||a.type!=="checkbox"&&a.type!=="radio"){if(c==="option")b.selected=a.defaultSelected;else if(c==="input"||c==="textarea")b.defaultValue=a.defaultValue}else a.checked&&(b.defaultChecked=b.checked=a.checked),b.value!==a.value&&(b.value=a.value);b.removeAttribute(f.expando)}}function bj(a,b){if(b.nodeType===1&&!!f.hasData(a)){var c,d,e,g=f._data(a),h=f._data(b,g),i=g.events;if(i){delete h.handle,h.events={};for(c in i)for(d=0,e=i[c].length;d<e;d++)f.event.add(b,c+(i[c][d].namespace?".":"")+i[c][d].namespace,i[c][d],i[c][d].data)}h.data&&(h.data=f.extend({},h.data))}}function bi(a,b){return f.nodeName(a,"table")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function U(a){var b=V.split("|"),c=a.createDocumentFragment();if(c.createElement)while(b.length)c.createElement(b.pop());return c}function T(a,b,c){b=b||0;if(f.isFunction(b))return f.grep(a,function(a,d){var e=!!b.call(a,d,a);return e===c});if(b.nodeType)return f.grep(a,function(a,d){return a===b===c});if(typeof b=="string"){var d=f.grep(a,function(a){return a.nodeType===1});if(O.test(b))return f.filter(b,d,!c);b=f.filter(b,d)}return f.grep(a,function(a,d){return f.inArray(a,b)>=0===c})}function S(a){return!a||!a.parentNode||a.parentNode.nodeType===11}function K(){return!0}function J(){return!1}function n(a,b,c){var d=b+"defer",e=b+"queue",g=b+"mark",h=f._data(a,d);h&&(c==="queue"||!f._data(a,e))&&(c==="mark"||!f._data(a,g))&&setTimeout(function(){!f._data(a,e)&&!f._data(a,g)&&(f.removeData(a,d,!0),h.fire())},0)}function m(a){for(var b in a){if(b==="data"&&f.isEmptyObject(a[b]))continue;if(b!=="toJSON")return!1}return!0}function l(a,c,d){if(d===b&&a.nodeType===1){var e="data-"+c.replace(k,"-$1").toLowerCase();d=a.getAttribute(e);if(typeof d=="string"){try{d=d==="true"?!0:d==="false"?!1:d==="null"?null:f.isNumeric(d)?parseFloat(d):j.test(d)?f.parseJSON(d):d}catch(g){}f.data(a,c,d)}else d=b}return d}function h(a){var b=g[a]={},c,d;a=a.split(/\s+/);for(c=0,d=a.length;c<d;c++)b[a[c]]=!0;return b}var c=a.document,d=a.navigator,e=a.location,f=function(){function J(){if(!e.isReady){try{c.documentElement.doScroll("left")}catch(a){setTimeout(J,1);return}e.ready()}}var e=function(a,b){return new e.fn.init(a,b,h)},f=a.jQuery,g=a.$,h,i=/^(?:[^#<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,j=/\S/,k=/^\s+/,l=/\s+$/,m=/^<(\w+)\s*\/?>(?:<\/\1>)?$/,n=/^[\],:{}\s]*$/,o=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,p=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,q=/(?:^|:|,)(?:\s*\[)+/g,r=/(webkit)[ \/]([\w.]+)/,s=/(opera)(?:.*version)?[ \/]([\w.]+)/,t=/(msie) ([\w.]+)/,u=/(mozilla)(?:.*? rv:([\w.]+))?/,v=/-([a-z]|[0-9])/ig,w=/^-ms-/,x=function(a,b){return(b+"").toUpperCase()},y=d.userAgent,z,A,B,C=Object.prototype.toString,D=Object.prototype.hasOwnProperty,E=Array.prototype.push,F=Array.prototype.slice,G=String.prototype.trim,H=Array.prototype.indexOf,I={};e.fn=e.prototype={constructor:e,init:function(a,d,f){var g,h,j,k;if(!a)return this;if(a.nodeType){this.context=this[0]=a,this.length=1;return this}if(a==="body"&&!d&&c.body){this.context=c,this[0]=c.body,this.selector=a,this.length=1;return this}if(typeof a=="string"){a.charAt(0)!=="<"||a.charAt(a.length-1)!==">"||a.length<3?g=i.exec(a):g=[null,a,null];if(g&&(g[1]||!d)){if(g[1]){d=d instanceof e?d[0]:d,k=d?d.ownerDocument||d:c,j=m.exec(a),j?e.isPlainObject(d)?(a=[c.createElement(j[1])],e.fn.attr.call(a,d,!0)):a=[k.createElement(j[1])]:(j=e.buildFragment([g[1]],[k]),a=(j.cacheable?e.clone(j.fragment):j.fragment).childNodes);return e.merge(this,a)}h=c.getElementById(g[2]);if(h&&h.parentNode){if(h.id!==g[2])return f.find(a);this.length=1,this[0]=h}this.context=c,this.selector=a;return this}return!d||d.jquery?(d||f).find(a):this.constructor(d).find(a)}if(e.isFunction(a))return f.ready(a);a.selector!==b&&(this.selector=a.selector,this.context=a.context);return e.makeArray(a,this)},selector:"",jquery:"1.7.1",length:0,size:function(){return this.length},toArray:function(){return F.call(this,0)},get:function(a){return a==null?this.toArray():a<0?this[this.length+a]:this[a]},pushStack:function(a,b,c){var d=this.constructor();e.isArray(a)?E.apply(d,a):e.merge(d,a),d.prevObject=this,d.context=this.context,b==="find"?d.selector=this.selector+(this.selector?" ":"")+c:b&&(d.selector=this.selector+"."+b+"("+c+")");return d},each:function(a,b){return e.each(this,a,b)},ready:function(a){e.bindReady(),A.add(a);return this},eq:function(a){a=+a;return a===-1?this.slice(a):this.slice(a,a+1)},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},slice:function(){return this.pushStack(F.apply(this,arguments),"slice",F.call(arguments).join(","))},map:function(a){return this.pushStack(e.map(this,function(b,c){return a.call(b,c,b)}))},end:function(){return this.prevObject||this.constructor(null)},push:E,sort:[].sort,splice:[].splice},e.fn.init.prototype=e.fn,e.extend=e.fn.extend=function(){var a,c,d,f,g,h,i=arguments[0]||{},j=1,k=arguments.length,l=!1;typeof i=="boolean"&&(l=i,i=arguments[1]||{},j=2),typeof i!="object"&&!e.isFunction(i)&&(i={}),k===j&&(i=this,--j);for(;j<k;j++)if((a=arguments[j])!=null)for(c in a){d=i[c],f=a[c];if(i===f)continue;l&&f&&(e.isPlainObject(f)||(g=e.isArray(f)))?(g?(g=!1,h=d&&e.isArray(d)?d:[]):h=d&&e.isPlainObject(d)?d:{},i[c]=e.extend(l,h,f)):f!==b&&(i[c]=f)}return i},e.extend({noConflict:function(b){a.$===e&&(a.$=g),b&&a.jQuery===e&&(a.jQuery=f);return e},isReady:!1,readyWait:1,holdReady:function(a){a?e.readyWait++:e.ready(!0)},ready:function(a){if(a===!0&&!--e.readyWait||a!==!0&&!e.isReady){if(!c.body)return setTimeout(e.ready,1);e.isReady=!0;if(a!==!0&&--e.readyWait>0)return;A.fireWith(c,[e]),e.fn.trigger&&e(c).trigger("ready").off("ready")}},bindReady:function(){if(!A){A=e.Callbacks("once memory");if(c.readyState==="complete")return setTimeout(e.ready,1);if(c.addEventListener)c.addEventListener("DOMContentLoaded",B,!1),a.addEventListener("load",e.ready,!1);else if(c.attachEvent){c.attachEvent("onreadystatechange",B),a.attachEvent("onload",e.ready);var b=!1;try{b=a.frameElement==null}catch(d){}c.documentElement.doScroll&&b&&J()}}},isFunction:function(a){return e.type(a)==="function"},isArray:Array.isArray||function(a){return e.type(a)==="array"},isWindow:function(a){return a&&typeof a=="object"&&"setInterval"in a},isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},type:function(a){return a==null?String(a):I[C.call(a)]||"object"},isPlainObject:function(a){if(!a||e.type(a)!=="object"||a.nodeType||e.isWindow(a))return!1;try{if(a.constructor&&!D.call(a,"constructor")&&!D.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}var d;for(d in a);return d===b||D.call(a,d)},isEmptyObject:function(a){for(var b in a)return!1;return!0},error:function(a){throw new Error(a)},parseJSON:function(b){if(typeof b!="string"||!b)return null;b=e.trim(b);if(a.JSON&&a.JSON.parse)return a.JSON.parse(b);if(n.test(b.replace(o,"@").replace(p,"]").replace(q,"")))return(new Function("return "+b))();e.error("Invalid JSON: "+b)},parseXML:function(c){var d,f;try{a.DOMParser?(f=new DOMParser,d=f.parseFromString(c,"text/xml")):(d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(c))}catch(g){d=b}(!d||!d.documentElement||d.getElementsByTagName("parsererror").length)&&e.error("Invalid XML: "+c);return d},noop:function(){},globalEval:function(b){b&&j.test(b)&&(a.execScript||function(b){a.eval.call(a,b)})(b)},camelCase:function(a){return a.replace(w,"ms-").replace(v,x)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toUpperCase()===b.toUpperCase()},each:function(a,c,d){var f,g=0,h=a.length,i=h===b||e.isFunction(a);if(d){if(i){for(f in a)if(c.apply(a[f],d)===!1)break}else for(;g<h;)if(c.apply(a[g++],d)===!1)break}else if(i){for(f in a)if(c.call(a[f],f,a[f])===!1)break}else for(;g<h;)if(c.call(a[g],g,a[g++])===!1)break;return a},trim:G?function(a){return a==null?"":G.call(a)}:function(a){return a==null?"":(a+"").replace(k,"").replace(l,"")},makeArray:function(a,b){var c=b||[];if(a!=null){var d=e.type(a);a.length==null||d==="string"||d==="function"||d==="regexp"||e.isWindow(a)?E.call(c,a):e.merge(c,a)}return c},inArray:function(a,b,c){var d;if(b){if(H)return H.call(b,a,c);d=b.length,c=c?c<0?Math.max(0,d+c):c:0;for(;c<d;c++)if(c in b&&b[c]===a)return c}return-1},merge:function(a,c){var d=a.length,e=0;if(typeof c.length=="number")for(var f=c.length;e<f;e++)a[d++]=c[e];else while(c[e]!==b)a[d++]=c[e++];a.length=d;return a},grep:function(a,b,c){var d=[],e;c=!!c;for(var f=0,g=a.length;f<g;f++)e=!!b(a[f],f),c!==e&&d.push(a[f]);return d},map:function(a,c,d){var f,g,h=[],i=0,j=a.length,k=a instanceof e||j!==b&&typeof j=="number"&&(j>0&&a[0]&&a[j-1]||j===0||e.isArray(a));if(k)for(;i<j;i++)f=c(a[i],i,d),f!=null&&(h[h.length]=f);else for(g in a)f=c(a[g],g,d),f!=null&&(h[h.length]=f);return h.concat.apply([],h)},guid:1,proxy:function(a,c){if(typeof c=="string"){var d=a[c];c=a,a=d}if(!e.isFunction(a))return b;var f=F.call(arguments,2),g=function(){return a.apply(c,f.concat(F.call(arguments)))};g.guid=a.guid=a.guid||g.guid||e.guid++;return g},access:function(a,c,d,f,g,h){var i=a.length;if(typeof c=="object"){for(var j in c)e.access(a,j,c[j],f,g,d);return a}if(d!==b){f=!h&&f&&e.isFunction(d);for(var k=0;k<i;k++)g(a[k],c,f?d.call(a[k],k,g(a[k],c)):d,h);return a}return i?g(a[0],c):b},now:function(){return(new Date).getTime()},uaMatch:function(a){a=a.toLowerCase();var b=r.exec(a)||s.exec(a)||t.exec(a)||a.indexOf("compatible")<0&&u.exec(a)||[];return{browser:b[1]||"",version:b[2]||"0"}},sub:function(){function a(b,c){return new a.fn.init(b,c)}e.extend(!0,a,this),a.superclass=this,a.fn=a.prototype=this(),a.fn.constructor=a,a.sub=this.sub,a.fn.init=function(d,f){f&&f instanceof e&&!(f instanceof a)&&(f=a(f));return e.fn.init.call(this,d,f,b)},a.fn.init.prototype=a.fn;var b=a(c);return a},browser:{}}),e.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(a,b){I["[object "+b+"]"]=b.toLowerCase()}),z=e.uaMatch(y),z.browser&&(e.browser[z.browser]=!0,e.browser.version=z.version),e.browser.webkit&&(e.browser.safari=!0),j.test(" ")&&(k=/^[\s\xA0]+/,l=/[\s\xA0]+$/),h=e(c),c.addEventListener?B=function(){c.removeEventListener("DOMContentLoaded",B,!1),e.ready()}:c.attachEvent&&(B=function(){c.readyState==="complete"&&(c.detachEvent("onreadystatechange",B),e.ready())});return e}(),g={};f.Callbacks=function(a){a=a?g[a]||h(a):{};var c=[],d=[],e,i,j,k,l,m=function(b){var d,e,g,h,i;for(d=0,e=b.length;d<e;d++)g=b[d],h=f.type(g),h==="array"?m(g):h==="function"&&(!a.unique||!o.has(g))&&c.push(g)},n=function(b,f){f=f||[],e=!a.memory||[b,f],i=!0,l=j||0,j=0,k=c.length;for(;c&&l<k;l++)if(c[l].apply(b,f)===!1&&a.stopOnFalse){e=!0;break}i=!1,c&&(a.once?e===!0?o.disable():c=[]:d&&d.length&&(e=d.shift(),o.fireWith(e[0],e[1])))},o={add:function(){if(c){var a=c.length;m(arguments),i?k=c.length:e&&e!==!0&&(j=a,n(e[0],e[1]))}return this},remove:function(){if(c){var b=arguments,d=0,e=b.length;for(;d<e;d++)for(var f=0;f<c.length;f++)if(b[d]===c[f]){i&&f<=k&&(k--,f<=l&&l--),c.splice(f--,1);if(a.unique)break}}return this},has:function(a){if(c){var b=0,d=c.length;for(;b<d;b++)if(a===c[b])return!0}return!1},empty:function(){c=[];return this},disable:function(){c=d=e=b;return this},disabled:function(){return!c},lock:function(){d=b,(!e||e===!0)&&o.disable();return this},locked:function(){return!d},fireWith:function(b,c){d&&(i?a.once||d.push([b,c]):(!a.once||!e)&&n(b,c));return this},fire:function(){o.fireWith(this,arguments);return this},fired:function(){return!!e}};return o};var i=[].slice;f.extend({Deferred:function(a){var b=f.Callbacks("once memory"),c=f.Callbacks("once memory"),d=f.Callbacks("memory"),e="pending",g={resolve:b,reject:c,notify:d},h={done:b.add,fail:c.add,progress:d.add,state:function(){return e},isResolved:b.fired,isRejected:c.fired,then:function(a,b,c){i.done(a).fail(b).progress(c);return this},always:function(){i.done.apply(i,arguments).fail.apply(i,arguments);return this},pipe:function(a,b,c){return f.Deferred(function(d){f.each({done:[a,"resolve"],fail:[b,"reject"],progress:[c,"notify"]},function(a,b){var c=b[0],e=b[1],g;f.isFunction(c)?i[a](function(){g=c.apply(this,arguments),g&&f.isFunction(g.promise)?g.promise().then(d.resolve,d.reject,d.notify):d[e+"With"](this===i?d:this,[g])}):i[a](d[e])})}).promise()},promise:function(a){if(a==null)a=h;else for(var b in h)a[b]=h[b];return a}},i=h.promise({}),j;for(j in g)i[j]=g[j].fire,i[j+"With"]=g[j].fireWith;i.done(function(){e="resolved"},c.disable,d.lock).fail(function(){e="rejected"},b.disable,d.lock),a&&a.call(i,i);return i},when:function(a){function m(a){return function(b){e[a]=arguments.length>1?i.call(arguments,0):b,j.notifyWith(k,e)}}function l(a){return function(c){b[a]=arguments.length>1?i.call(arguments,0):c,--g||j.resolveWith(j,b)}}var b=i.call(arguments,0),c=0,d=b.length,e=Array(d),g=d,h=d,j=d<=1&&a&&f.isFunction(a.promise)?a:f.Deferred(),k=j.promise();if(d>1){for(;c<d;c++)b[c]&&b[c].promise&&f.isFunction(b[c].promise)?b[c].promise().then(l(c),j.reject,m(c)):--g;g||j.resolveWith(j,b)}else j!==a&&j.resolveWith(j,d?[a]:[]);return k}}),f.support=function(){var b,d,e,g,h,i,j,k,l,m,n,o,p,q=c.createElement("div"),r=c.documentElement;q.setAttribute("className","t"),q.innerHTML="   <link/><table></table><a href='/a' style='top:1px;float:left;opacity:.55;'>a</a><input type='checkbox'/>",d=q.getElementsByTagName("*"),e=q.getElementsByTagName("a")[0];if(!d||!d.length||!e)return{};g=c.createElement("select"),h=g.appendChild(c.createElement("option")),i=q.getElementsByTagName("input")[0],b={leadingWhitespace:q.firstChild.nodeType===3,tbody:!q.getElementsByTagName("tbody").length,htmlSerialize:!!q.getElementsByTagName("link").length,style:/top/.test(e.getAttribute("style")),hrefNormalized:e.getAttribute("href")==="/a",opacity:/^0.55/.test(e.style.opacity),cssFloat:!!e.style.cssFloat,checkOn:i.value==="on",optSelected:h.selected,getSetAttribute:q.className!=="t",enctype:!!c.createElement("form").enctype,html5Clone:c.createElement("nav").cloneNode(!0).outerHTML!=="<:nav></:nav>",submitBubbles:!0,changeBubbles:!0,focusinBubbles:!1,deleteExpando:!0,noCloneEvent:!0,inlineBlockNeedsLayout:!1,shrinkWrapBlocks:!1,reliableMarginRight:!0},i.checked=!0,b.noCloneChecked=i.cloneNode(!0).checked,g.disabled=!0,b.optDisabled=!h.disabled;try{delete q.test}catch(s){b.deleteExpando=!1}!q.addEventListener&&q.attachEvent&&q.fireEvent&&(q.attachEvent("onclick",function(){b.noCloneEvent=!1}),q.cloneNode(!0).fireEvent("onclick")),i=c.createElement("input"),i.value="t",i.setAttribute("type","radio"),b.radioValue=i.value==="t",i.setAttribute("checked","checked"),q.appendChild(i),k=c.createDocumentFragment(),k.appendChild(q.lastChild),b.checkClone=k.cloneNode(!0).cloneNode(!0).lastChild.checked,b.appendChecked=i.checked,k.removeChild(i),k.appendChild(q),q.innerHTML="",a.getComputedStyle&&(j=c.createElement("div"),j.style.width="0",j.style.marginRight="0",q.style.width="2px",q.appendChild(j),b.reliableMarginRight=(parseInt((a.getComputedStyle(j,null)||{marginRight:0}).marginRight,10)||0)===0);if(q.attachEvent)for(o in{submit:1,change:1,focusin:1})n="on"+o,p=n in q,p||(q.setAttribute(n,"return;"),p=typeof q[n]=="function"),b[o+"Bubbles"]=p;k.removeChild(q),k=g=h=j=q=i=null,f(function(){var a,d,e,g,h,i,j,k,m,n,o,r=c.getElementsByTagName("body")[0];!r||(j=1,k="position:absolute;top:0;left:0;width:1px;height:1px;margin:0;",m="visibility:hidden;border:0;",n="style='"+k+"border:5px solid #000;padding:0;'",o="<div "+n+"><div></div></div>"+"<table "+n+" cellpadding='0' cellspacing='0'>"+"<tr><td></td></tr></table>",a=c.createElement("div"),a.style.cssText=m+"width:0;height:0;position:static;top:0;margin-top:"+j+"px",r.insertBefore(a,r.firstChild),q=c.createElement("div"),a.appendChild(q),q.innerHTML="<table><tr><td style='padding:0;border:0;display:none'></td><td>t</td></tr></table>",l=q.getElementsByTagName("td"),p=l[0].offsetHeight===0,l[0].style.display="",l[1].style.display="none",b.reliableHiddenOffsets=p&&l[0].offsetHeight===0,q.innerHTML="",q.style.width=q.style.paddingLeft="1px",f.boxModel=b.boxModel=q.offsetWidth===2,typeof q.style.zoom!="undefined"&&(q.style.display="inline",q.style.zoom=1,b.inlineBlockNeedsLayout=q.offsetWidth===2,q.style.display="",q.innerHTML="<div style='width:4px;'></div>",b.shrinkWrapBlocks=q.offsetWidth!==2),q.style.cssText=k+m,q.innerHTML=o,d=q.firstChild,e=d.firstChild,h=d.nextSibling.firstChild.firstChild,i={doesNotAddBorder:e.offsetTop!==5,doesAddBorderForTableAndCells:h.offsetTop===5},e.style.position="fixed",e.style.top="20px",i.fixedPosition=e.offsetTop===20||e.offsetTop===15,e.style.position=e.style.top="",d.style.overflow="hidden",d.style.position="relative",i.subtractsBorderForOverflowNotVisible=e.offsetTop===-5,i.doesNotIncludeMarginInBodyOffset=r.offsetTop!==j,r.removeChild(a),q=a=null,f.extend(b,i))});return b}();var j=/^(?:\{.*\}|\[.*\])$/,k=/([A-Z])/g;f.extend({cache:{},uuid:0,expando:"jQuery"+(f.fn.jquery+Math.random()).replace(/\D/g,""),noData:{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0},hasData:function(a){a=a.nodeType?f.cache[a[f.expando]]:a[f.expando];return!!a&&!m(a)},data:function(a,c,d,e){if(!!f.acceptData(a)){var g,h,i,j=f.expando,k=typeof c=="string",l=a.nodeType,m=l?f.cache:a,n=l?a[j]:a[j]&&j,o=c==="events";if((!n||!m[n]||!o&&!e&&!m[n].data)&&k&&d===b)return;n||(l?a[j]=n=++f.uuid:n=j),m[n]||(m[n]={},l||(m[n].toJSON=f.noop));if(typeof c=="object"||typeof c=="function")e?m[n]=f.extend(m[n],c):m[n].data=f.extend(m[n].data,c);g=h=m[n],e||(h.data||(h.data={}),h=h.data),d!==b&&(h[f.camelCase(c)]=d);if(o&&!h[c])return g.events;k?(i=h[c],i==null&&(i=h[f.camelCase(c)])):i=h;return i}},removeData:function(a,b,c){if(!!f.acceptData(a)){var d,e,g,h=f.expando,i=a.nodeType,j=i?f.cache:a,k=i?a[h]:h;if(!j[k])return;if(b){d=c?j[k]:j[k].data;if(d){f.isArray(b)||(b in d?b=[b]:(b=f.camelCase(b),b in d?b=[b]:b=b.split(" ")));for(e=0,g=b.length;e<g;e++)delete d[b[e]];if(!(c?m:f.isEmptyObject)(d))return}}if(!c){delete j[k].data;if(!m(j[k]))return}f.support.deleteExpando||!j.setInterval?delete j[k]:j[k]=null,i&&(f.support.deleteExpando?delete a[h]:a.removeAttribute?a.removeAttribute(h):a[h]=null)}},_data:function(a,b,c){return f.data(a,b,c,!0)},acceptData:function(a){if(a.nodeName){var b=f.noData[a.nodeName.toLowerCase()];if(b)return b!==!0&&a.getAttribute("classid")===b}return!0}}),f.fn.extend({data:function(a,c){var d,e,g,h=null;if(typeof a=="undefined"){if(this.length){h=f.data(this[0]);if(this[0].nodeType===1&&!f._data(this[0],"parsedAttrs")){e=this[0].attributes;for(var i=0,j=e.length;i<j;i++)g=e[i].name,g.indexOf("data-")===0&&(g=f.camelCase(g.substring(5)),l(this[0],g,h[g]));f._data(this[0],"parsedAttrs",!0)}}return h}if(typeof a=="object")return this.each(function(){f.data(this,a)});d=a.split("."),d[1]=d[1]?"."+d[1]:"";if(c===b){h=this.triggerHandler("getData"+d[1]+"!",[d[0]]),h===b&&this.length&&(h=f.data(this[0],a),h=l(this[0],a,h));return h===b&&d[1]?this.data(d[0]):h}return this.each(function(){var b=f(this),e=[d[0],c];b.triggerHandler("setData"+d[1]+"!",e),f.data(this,a,c),b.triggerHandler("changeData"+d[1]+"!",e)})},removeData:function(a){return this.each(function(){f.removeData(this,a)})}}),f.extend({_mark:function(a,b){a&&(b=(b||"fx")+"mark",f._data(a,b,(f._data(a,b)||0)+1))},_unmark:function(a,b,c){a!==!0&&(c=b,b=a,a=!1);if(b){c=c||"fx";var d=c+"mark",e=a?0:(f._data(b,d)||1)-1;e?f._data(b,d,e):(f.removeData(b,d,!0),n(b,c,"mark"))}},queue:function(a,b,c){var d;if(a){b=(b||"fx")+"queue",d=f._data(a,b),c&&(!d||f.isArray(c)?d=f._data(a,b,f.makeArray(c)):d.push(c));return d||[]}},dequeue:function(a,b){b=b||"fx";var c=f.queue(a,b),d=c.shift(),e={};d==="inprogress"&&(d=c.shift()),d&&(b==="fx"&&c.unshift("inprogress"),f._data(a,b+".run",e),d.call(a,function(){f.dequeue(a,b)},e)),c.length||(f.removeData(a,b+"queue "+b+".run",!0),n(a,b,"queue"))}}),f.fn.extend({queue:function(a,c){typeof a!="string"&&(c=a,a="fx");if(c===b)return f.queue(this[0],a);return this.each(function(){var b=f.queue(this,a,c);a==="fx"&&b[0]!=="inprogress"&&f.dequeue(this,a)})},dequeue:function(a){return this.each(function(){f.dequeue(this,a)})},delay:function(a,b){a=f.fx?f.fx.speeds[a]||a:a,b=b||"fx";return this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,c){function m(){--h||d.resolveWith(e,[e])}typeof a!="string"&&(c=a,a=b),a=a||"fx";var d=f.Deferred(),e=this,g=e.length,h=1,i=a+"defer",j=a+"queue",k=a+"mark",l;while(g--)if(l=f.data(e[g],i,b,!0)||(f.data(e[g],j,b,!0)||f.data(e[g],k,b,!0))&&f.data(e[g],i,f.Callbacks("once memory"),!0))h++,l.add(m);m();return d.promise()}});var o=/[\n\t\r]/g,p=/\s+/,q=/\r/g,r=/^(?:button|input)$/i,s=/^(?:button|input|object|select|textarea)$/i,t=/^a(?:rea)?$/i,u=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,v=f.support.getSetAttribute,w,x,y;f.fn.extend({attr:function(a,b){return f.access(this,a,b,!0,f.attr)},removeAttr:function(a){return this.each(function(){f.removeAttr(this,a)})},prop:function(a,b){return f.access(this,a,b,!0,f.prop)},removeProp:function(a){a=f.propFix[a]||a;return this.each(function(){try{this[a]=b,delete this[a]}catch(c){}})},addClass:function(a){var b,c,d,e,g,h,i;if(f.isFunction(a))return this.each(function(b){f(this).addClass(a.call(this,b,this.className))});if(a&&typeof a=="string"){b=a.split(p);for(c=0,d=this.length;c<d;c++){e=this[c];if(e.nodeType===1)if(!e.className&&b.length===1)e.className=a;else{g=" "+e.className+" ";for(h=0,i=b.length;h<i;h++)~g.indexOf(" "+b[h]+" ")||(g+=b[h]+" ");e.className=f.trim(g)}}}return this},removeClass:function(a){var c,d,e,g,h,i,j;if(f.isFunction(a))return this.each(function(b){f(this).removeClass(a.call(this,b,this.className))});if(a&&typeof a=="string"||a===b){c=(a||"").split(p);for(d=0,e=this.length;d<e;d++){g=this[d];if(g.nodeType===1&&g.className)if(a){h=(" "+g.className+" ").replace(o," ");for(i=0,j=c.length;i<j;i++)h=h.replace(" "+c[i]+" "," ");g.className=f.trim(h)}else g.className=""}}return this},toggleClass:function(a,b){var c=typeof a,d=typeof b=="boolean";if(f.isFunction(a))return this.each(function(c){f(this).toggleClass(a.call(this,c,this.className,b),b)});return this.each(function(){if(c==="string"){var e,g=0,h=f(this),i=b,j=a.split(p);while(e=j[g++])i=d?i:!h.hasClass(e),h[i?"addClass":"removeClass"](e)}else if(c==="undefined"||c==="boolean")this.className&&f._data(this,"__className__",this.className),this.className=this.className||a===!1?"":f._data(this,"__className__")||""})},hasClass:function(a){var b=" "+a+" ",c=0,d=this.length;for(;c<d;c++)if(this[c].nodeType===1&&(" "+this[c].className+" ").replace(o," ").indexOf(b)>-1)return!0;return!1},val:function(a){var c,d,e,g=this[0];{if(!!arguments.length){e=f.isFunction(a);return this.each(function(d){var g=f(this),h;if(this.nodeType===1){e?h=a.call(this,d,g.val()):h=a,h==null?h="":typeof h=="number"?h+="":f.isArray(h)&&(h=f.map(h,function(a){return a==null?"":a+""})),c=f.valHooks[this.nodeName.toLowerCase()]||f.valHooks[this.type];if(!c||!("set"in c)||c.set(this,h,"value")===b)this.value=h}})}if(g){c=f.valHooks[g.nodeName.toLowerCase()]||f.valHooks[g.type];if(c&&"get"in c&&(d=c.get(g,"value"))!==b)return d;d=g.value;return typeof d=="string"?d.replace(q,""):d==null?"":d}}}}),f.extend({valHooks:{option:{get:function(a){var b=a.attributes.value;return!b||b.specified?a.value:a.text}},select:{get:function(a){var b,c,d,e,g=a.selectedIndex,h=[],i=a.options,j=a.type==="select-one";if(g<0)return null;c=j?g:0,d=j?g+1:i.length;for(;c<d;c++){e=i[c];if(e.selected&&(f.support.optDisabled?!e.disabled:e.getAttribute("disabled")===null)&&(!e.parentNode.disabled||!f.nodeName(e.parentNode,"optgroup"))){b=f(e).val();if(j)return b;h.push(b)}}if(j&&!h.length&&i.length)return f(i[g]).val();return h},set:function(a,b){var c=f.makeArray(b);f(a).find("option").each(function(){this.selected=f.inArray(f(this).val(),c)>=0}),c.length||(a.selectedIndex=-1);return c}}},attrFn:{val:!0,css:!0,html:!0,text:!0,data:!0,width:!0,height:!0,offset:!0},attr:function(a,c,d,e){var g,h,i,j=a.nodeType;if(!!a&&j!==3&&j!==8&&j!==2){if(e&&c in f.attrFn)return f(a)[c](d);if(typeof a.getAttribute=="undefined")return f.prop(a,c,d);i=j!==1||!f.isXMLDoc(a),i&&(c=c.toLowerCase(),h=f.attrHooks[c]||(u.test(c)?x:w));if(d!==b){if(d===null){f.removeAttr(a,c);return}if(h&&"set"in h&&i&&(g=h.set(a,d,c))!==b)return g;a.setAttribute(c,""+d);return d}if(h&&"get"in h&&i&&(g=h.get(a,c))!==null)return g;g=a.getAttribute(c);return g===null?b:g}},removeAttr:function(a,b){var c,d,e,g,h=0;if(b&&a.nodeType===1){d=b.toLowerCase().split(p),g=d.length;for(;h<g;h++)e=d[h],e&&(c=f.propFix[e]||e,f.attr(a,e,""),a.removeAttribute(v?e:c),u.test(e)&&c in a&&(a[c]=!1))}},attrHooks:{type:{set:function(a,b){if(r.test(a.nodeName)&&a.parentNode)f.error("type property can't be changed");else if(!f.support.radioValue&&b==="radio"&&f.nodeName(a,"input")){var c=a.value;a.setAttribute("type",b),c&&(a.value=c);return b}}},value:{get:function(a,b){if(w&&f.nodeName(a,"button"))return w.get(a,b);return b in a?a.value:null},set:function(a,b,c){if(w&&f.nodeName(a,"button"))return w.set(a,b,c);a.value=b}}},propFix:{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},prop:function(a,c,d){var e,g,h,i=a.nodeType;if(!!a&&i!==3&&i!==8&&i!==2){h=i!==1||!f.isXMLDoc(a),h&&(c=f.propFix[c]||c,g=f.propHooks[c]);return d!==b?g&&"set"in g&&(e=g.set(a,d,c))!==b?e:a[c]=d:g&&"get"in g&&(e=g.get(a,c))!==null?e:a[c]}},propHooks:{tabIndex:{get:function(a){var c=a.getAttributeNode("tabindex");return c&&c.specified?parseInt(c.value,10):s.test(a.nodeName)||t.test(a.nodeName)&&a.href?0:b}}}}),f.attrHooks.tabindex=f.propHooks.tabIndex,x={get:function(a,c){var d,e=f.prop(a,c);return e===!0||typeof e!="boolean"&&(d=a.getAttributeNode(c))&&d.nodeValue!==!1?c.toLowerCase():b},set:function(a,b,c){var d;b===!1?f.removeAttr(a,c):(d=f.propFix[c]||c,d in a&&(a[d]=!0),a.setAttribute(c,c.toLowerCase()));return c}},v||(y={name:!0,id:!0},w=f.valHooks.button={get:function(a,c){var d;d=a.getAttributeNode(c);return d&&(y[c]?d.nodeValue!=="":d.specified)?d.nodeValue:b},set:function(a,b,d){var e=a.getAttributeNode(d);e||(e=c.createAttribute(d),a.setAttributeNode(e));return e.nodeValue=b+""}},f.attrHooks.tabindex.set=w.set,f.each(["width","height"],function(a,b){f.attrHooks[b]=f.extend(f.attrHooks[b],{set:function(a,c){if(c===""){a.setAttribute(b,"auto");return c}}})}),f.attrHooks.contenteditable={get:w.get,set:function(a,b,c){b===""&&(b="false"),w.set(a,b,c)}}),f.support.hrefNormalized||f.each(["href","src","width","height"],function(a,c){f.attrHooks[c]=f.extend(f.attrHooks[c],{get:function(a){var d=a.getAttribute(c,2);return d===null?b:d}})}),f.support.style||(f.attrHooks.style={get:function(a){return a.style.cssText.toLowerCase()||b},set:function(a,b){return a.style.cssText=""+b}}),f.support.optSelected||(f.propHooks.selected=f.extend(f.propHooks.selected,{get:function(a){var b=a.parentNode;b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex);return null}})),f.support.enctype||(f.propFix.enctype="encoding"),f.support.checkOn||f.each(["radio","checkbox"],function(){f.valHooks[this]={get:function(a){return a.getAttribute("value")===null?"on":a.value}}}),f.each(["radio","checkbox"],function(){f.valHooks[this]=f.extend(f.valHooks[this],{set:function(a,b){if(f.isArray(b))return a.checked=f.inArray(f(a).val(),b)>=0}})});var z=/^(?:textarea|input|select)$/i,A=/^([^\.]*)?(?:\.(.+))?$/,B=/\bhover(\.\S+)?\b/,C=/^key/,D=/^(?:mouse|contextmenu)|click/,E=/^(?:focusinfocus|focusoutblur)$/,F=/^(\w*)(?:#([\w\-]+))?(?:\.([\w\-]+))?$/,G=function(a){var b=F.exec(a);b&&(b[1]=(b[1]||"").toLowerCase(),b[3]=b[3]&&new RegExp("(?:^|\\s)"+b[3]+"(?:\\s|$)"));return b},H=function(a,b){var c=a.attributes||{};return(!b[1]||a.nodeName.toLowerCase()===b[1])&&(!b[2]||(c.id||{}).value===b[2])&&(!b[3]||b[3].test((c["class"]||{}).value))},I=function(a){return f.event.special.hover?a:a.replace(B,"mouseenter$1 mouseleave$1")};
f.event={add:function(a,c,d,e,g){var h,i,j,k,l,m,n,o,p,q,r,s;if(!(a.nodeType===3||a.nodeType===8||!c||!d||!(h=f._data(a)))){d.handler&&(p=d,d=p.handler),d.guid||(d.guid=f.guid++),j=h.events,j||(h.events=j={}),i=h.handle,i||(h.handle=i=function(a){return typeof f!="undefined"&&(!a||f.event.triggered!==a.type)?f.event.dispatch.apply(i.elem,arguments):b},i.elem=a),c=f.trim(I(c)).split(" ");for(k=0;k<c.length;k++){l=A.exec(c[k])||[],m=l[1],n=(l[2]||"").split(".").sort(),s=f.event.special[m]||{},m=(g?s.delegateType:s.bindType)||m,s=f.event.special[m]||{},o=f.extend({type:m,origType:l[1],data:e,handler:d,guid:d.guid,selector:g,quick:G(g),namespace:n.join(".")},p),r=j[m];if(!r){r=j[m]=[],r.delegateCount=0;if(!s.setup||s.setup.call(a,e,n,i)===!1)a.addEventListener?a.addEventListener(m,i,!1):a.attachEvent&&a.attachEvent("on"+m,i)}s.add&&(s.add.call(a,o),o.handler.guid||(o.handler.guid=d.guid)),g?r.splice(r.delegateCount++,0,o):r.push(o),f.event.global[m]=!0}a=null}},global:{},remove:function(a,b,c,d,e){var g=f.hasData(a)&&f._data(a),h,i,j,k,l,m,n,o,p,q,r,s;if(!!g&&!!(o=g.events)){b=f.trim(I(b||"")).split(" ");for(h=0;h<b.length;h++){i=A.exec(b[h])||[],j=k=i[1],l=i[2];if(!j){for(j in o)f.event.remove(a,j+b[h],c,d,!0);continue}p=f.event.special[j]||{},j=(d?p.delegateType:p.bindType)||j,r=o[j]||[],m=r.length,l=l?new RegExp("(^|\\.)"+l.split(".").sort().join("\\.(?:.*\\.)?")+"(\\.|$)"):null;for(n=0;n<r.length;n++)s=r[n],(e||k===s.origType)&&(!c||c.guid===s.guid)&&(!l||l.test(s.namespace))&&(!d||d===s.selector||d==="**"&&s.selector)&&(r.splice(n--,1),s.selector&&r.delegateCount--,p.remove&&p.remove.call(a,s));r.length===0&&m!==r.length&&((!p.teardown||p.teardown.call(a,l)===!1)&&f.removeEvent(a,j,g.handle),delete o[j])}f.isEmptyObject(o)&&(q=g.handle,q&&(q.elem=null),f.removeData(a,["events","handle"],!0))}},customEvent:{getData:!0,setData:!0,changeData:!0},trigger:function(c,d,e,g){if(!e||e.nodeType!==3&&e.nodeType!==8){var h=c.type||c,i=[],j,k,l,m,n,o,p,q,r,s;if(E.test(h+f.event.triggered))return;h.indexOf("!")>=0&&(h=h.slice(0,-1),k=!0),h.indexOf(".")>=0&&(i=h.split("."),h=i.shift(),i.sort());if((!e||f.event.customEvent[h])&&!f.event.global[h])return;c=typeof c=="object"?c[f.expando]?c:new f.Event(h,c):new f.Event(h),c.type=h,c.isTrigger=!0,c.exclusive=k,c.namespace=i.join("."),c.namespace_re=c.namespace?new RegExp("(^|\\.)"+i.join("\\.(?:.*\\.)?")+"(\\.|$)"):null,o=h.indexOf(":")<0?"on"+h:"";if(!e){j=f.cache;for(l in j)j[l].events&&j[l].events[h]&&f.event.trigger(c,d,j[l].handle.elem,!0);return}c.result=b,c.target||(c.target=e),d=d!=null?f.makeArray(d):[],d.unshift(c),p=f.event.special[h]||{};if(p.trigger&&p.trigger.apply(e,d)===!1)return;r=[[e,p.bindType||h]];if(!g&&!p.noBubble&&!f.isWindow(e)){s=p.delegateType||h,m=E.test(s+h)?e:e.parentNode,n=null;for(;m;m=m.parentNode)r.push([m,s]),n=m;n&&n===e.ownerDocument&&r.push([n.defaultView||n.parentWindow||a,s])}for(l=0;l<r.length&&!c.isPropagationStopped();l++)m=r[l][0],c.type=r[l][1],q=(f._data(m,"events")||{})[c.type]&&f._data(m,"handle"),q&&q.apply(m,d),q=o&&m[o],q&&f.acceptData(m)&&q.apply(m,d)===!1&&c.preventDefault();c.type=h,!g&&!c.isDefaultPrevented()&&(!p._default||p._default.apply(e.ownerDocument,d)===!1)&&(h!=="click"||!f.nodeName(e,"a"))&&f.acceptData(e)&&o&&e[h]&&(h!=="focus"&&h!=="blur"||c.target.offsetWidth!==0)&&!f.isWindow(e)&&(n=e[o],n&&(e[o]=null),f.event.triggered=h,e[h](),f.event.triggered=b,n&&(e[o]=n));return c.result}},dispatch:function(c){c=f.event.fix(c||a.event);var d=(f._data(this,"events")||{})[c.type]||[],e=d.delegateCount,g=[].slice.call(arguments,0),h=!c.exclusive&&!c.namespace,i=[],j,k,l,m,n,o,p,q,r,s,t;g[0]=c,c.delegateTarget=this;if(e&&!c.target.disabled&&(!c.button||c.type!=="click")){m=f(this),m.context=this.ownerDocument||this;for(l=c.target;l!=this;l=l.parentNode||this){o={},q=[],m[0]=l;for(j=0;j<e;j++)r=d[j],s=r.selector,o[s]===b&&(o[s]=r.quick?H(l,r.quick):m.is(s)),o[s]&&q.push(r);q.length&&i.push({elem:l,matches:q})}}d.length>e&&i.push({elem:this,matches:d.slice(e)});for(j=0;j<i.length&&!c.isPropagationStopped();j++){p=i[j],c.currentTarget=p.elem;for(k=0;k<p.matches.length&&!c.isImmediatePropagationStopped();k++){r=p.matches[k];if(h||!c.namespace&&!r.namespace||c.namespace_re&&c.namespace_re.test(r.namespace))c.data=r.data,c.handleObj=r,n=((f.event.special[r.origType]||{}).handle||r.handler).apply(p.elem,g),n!==b&&(c.result=n,n===!1&&(c.preventDefault(),c.stopPropagation()))}}return c.result},props:"attrChange attrName relatedNode srcElement altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){a.which==null&&(a.which=b.charCode!=null?b.charCode:b.keyCode);return a}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,d){var e,f,g,h=d.button,i=d.fromElement;a.pageX==null&&d.clientX!=null&&(e=a.target.ownerDocument||c,f=e.documentElement,g=e.body,a.pageX=d.clientX+(f&&f.scrollLeft||g&&g.scrollLeft||0)-(f&&f.clientLeft||g&&g.clientLeft||0),a.pageY=d.clientY+(f&&f.scrollTop||g&&g.scrollTop||0)-(f&&f.clientTop||g&&g.clientTop||0)),!a.relatedTarget&&i&&(a.relatedTarget=i===a.target?d.toElement:i),!a.which&&h!==b&&(a.which=h&1?1:h&2?3:h&4?2:0);return a}},fix:function(a){if(a[f.expando])return a;var d,e,g=a,h=f.event.fixHooks[a.type]||{},i=h.props?this.props.concat(h.props):this.props;a=f.Event(g);for(d=i.length;d;)e=i[--d],a[e]=g[e];a.target||(a.target=g.srcElement||c),a.target.nodeType===3&&(a.target=a.target.parentNode),a.metaKey===b&&(a.metaKey=a.ctrlKey);return h.filter?h.filter(a,g):a},special:{ready:{setup:f.bindReady},load:{noBubble:!0},focus:{delegateType:"focusin"},blur:{delegateType:"focusout"},beforeunload:{setup:function(a,b,c){f.isWindow(this)&&(this.onbeforeunload=c)},teardown:function(a,b){this.onbeforeunload===b&&(this.onbeforeunload=null)}}},simulate:function(a,b,c,d){var e=f.extend(new f.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?f.event.trigger(e,null,b):f.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},f.event.handle=f.event.dispatch,f.removeEvent=c.removeEventListener?function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)}:function(a,b,c){a.detachEvent&&a.detachEvent("on"+b,c)},f.Event=function(a,b){if(!(this instanceof f.Event))return new f.Event(a,b);a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||a.returnValue===!1||a.getPreventDefault&&a.getPreventDefault()?K:J):this.type=a,b&&f.extend(this,b),this.timeStamp=a&&a.timeStamp||f.now(),this[f.expando]=!0},f.Event.prototype={preventDefault:function(){this.isDefaultPrevented=K;var a=this.originalEvent;!a||(a.preventDefault?a.preventDefault():a.returnValue=!1)},stopPropagation:function(){this.isPropagationStopped=K;var a=this.originalEvent;!a||(a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0)},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=K,this.stopPropagation()},isDefaultPrevented:J,isPropagationStopped:J,isImmediatePropagationStopped:J},f.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){f.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c=this,d=a.relatedTarget,e=a.handleObj,g=e.selector,h;if(!d||d!==c&&!f.contains(c,d))a.type=e.origType,h=e.handler.apply(this,arguments),a.type=b;return h}}}),f.support.submitBubbles||(f.event.special.submit={setup:function(){if(f.nodeName(this,"form"))return!1;f.event.add(this,"click._submit keypress._submit",function(a){var c=a.target,d=f.nodeName(c,"input")||f.nodeName(c,"button")?c.form:b;d&&!d._submit_attached&&(f.event.add(d,"submit._submit",function(a){this.parentNode&&!a.isTrigger&&f.event.simulate("submit",this.parentNode,a,!0)}),d._submit_attached=!0)})},teardown:function(){if(f.nodeName(this,"form"))return!1;f.event.remove(this,"._submit")}}),f.support.changeBubbles||(f.event.special.change={setup:function(){if(z.test(this.nodeName)){if(this.type==="checkbox"||this.type==="radio")f.event.add(this,"propertychange._change",function(a){a.originalEvent.propertyName==="checked"&&(this._just_changed=!0)}),f.event.add(this,"click._change",function(a){this._just_changed&&!a.isTrigger&&(this._just_changed=!1,f.event.simulate("change",this,a,!0))});return!1}f.event.add(this,"beforeactivate._change",function(a){var b=a.target;z.test(b.nodeName)&&!b._change_attached&&(f.event.add(b,"change._change",function(a){this.parentNode&&!a.isSimulated&&!a.isTrigger&&f.event.simulate("change",this.parentNode,a,!0)}),b._change_attached=!0)})},handle:function(a){var b=a.target;if(this!==b||a.isSimulated||a.isTrigger||b.type!=="radio"&&b.type!=="checkbox")return a.handleObj.handler.apply(this,arguments)},teardown:function(){f.event.remove(this,"._change");return z.test(this.nodeName)}}),f.support.focusinBubbles||f.each({focus:"focusin",blur:"focusout"},function(a,b){var d=0,e=function(a){f.event.simulate(b,a.target,f.event.fix(a),!0)};f.event.special[b]={setup:function(){d++===0&&c.addEventListener(a,e,!0)},teardown:function(){--d===0&&c.removeEventListener(a,e,!0)}}}),f.fn.extend({on:function(a,c,d,e,g){var h,i;if(typeof a=="object"){typeof c!="string"&&(d=c,c=b);for(i in a)this.on(i,c,d,a[i],g);return this}d==null&&e==null?(e=c,d=c=b):e==null&&(typeof c=="string"?(e=d,d=b):(e=d,d=c,c=b));if(e===!1)e=J;else if(!e)return this;g===1&&(h=e,e=function(a){f().off(a);return h.apply(this,arguments)},e.guid=h.guid||(h.guid=f.guid++));return this.each(function(){f.event.add(this,a,e,d,c)})},one:function(a,b,c,d){return this.on.call(this,a,b,c,d,1)},off:function(a,c,d){if(a&&a.preventDefault&&a.handleObj){var e=a.handleObj;f(a.delegateTarget).off(e.namespace?e.type+"."+e.namespace:e.type,e.selector,e.handler);return this}if(typeof a=="object"){for(var g in a)this.off(g,c,a[g]);return this}if(c===!1||typeof c=="function")d=c,c=b;d===!1&&(d=J);return this.each(function(){f.event.remove(this,a,d,c)})},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},live:function(a,b,c){f(this.context).on(a,this.selector,b,c);return this},die:function(a,b){f(this.context).off(a,this.selector||"**",b);return this},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return arguments.length==1?this.off(a,"**"):this.off(b,a,c)},trigger:function(a,b){return this.each(function(){f.event.trigger(a,b,this)})},triggerHandler:function(a,b){if(this[0])return f.event.trigger(a,b,this[0],!0)},toggle:function(a){var b=arguments,c=a.guid||f.guid++,d=0,e=function(c){var e=(f._data(this,"lastToggle"+a.guid)||0)%d;f._data(this,"lastToggle"+a.guid,e+1),c.preventDefault();return b[e].apply(this,arguments)||!1};e.guid=c;while(d<b.length)b[d++].guid=c;return this.click(e)},hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}}),f.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){f.fn[b]=function(a,c){c==null&&(c=a,a=null);return arguments.length>0?this.on(b,null,a,c):this.trigger(b)},f.attrFn&&(f.attrFn[b]=!0),C.test(b)&&(f.event.fixHooks[b]=f.event.keyHooks),D.test(b)&&(f.event.fixHooks[b]=f.event.mouseHooks)}),function(){function x(a,b,c,e,f,g){for(var h=0,i=e.length;h<i;h++){var j=e[h];if(j){var k=!1;j=j[a];while(j){if(j[d]===c){k=e[j.sizset];break}if(j.nodeType===1){g||(j[d]=c,j.sizset=h);if(typeof b!="string"){if(j===b){k=!0;break}}else if(m.filter(b,[j]).length>0){k=j;break}}j=j[a]}e[h]=k}}}function w(a,b,c,e,f,g){for(var h=0,i=e.length;h<i;h++){var j=e[h];if(j){var k=!1;j=j[a];while(j){if(j[d]===c){k=e[j.sizset];break}j.nodeType===1&&!g&&(j[d]=c,j.sizset=h);if(j.nodeName.toLowerCase()===b){k=j;break}j=j[a]}e[h]=k}}}var a=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,d="sizcache"+(Math.random()+"").replace(".",""),e=0,g=Object.prototype.toString,h=!1,i=!0,j=/\\/g,k=/\r\n/g,l=/\W/;[0,0].sort(function(){i=!1;return 0});var m=function(b,d,e,f){e=e||[],d=d||c;var h=d;if(d.nodeType!==1&&d.nodeType!==9)return[];if(!b||typeof b!="string")return e;var i,j,k,l,n,q,r,t,u=!0,v=m.isXML(d),w=[],x=b;do{a.exec(""),i=a.exec(x);if(i){x=i[3],w.push(i[1]);if(i[2]){l=i[3];break}}}while(i);if(w.length>1&&p.exec(b))if(w.length===2&&o.relative[w[0]])j=y(w[0]+w[1],d,f);else{j=o.relative[w[0]]?[d]:m(w.shift(),d);while(w.length)b=w.shift(),o.relative[b]&&(b+=w.shift()),j=y(b,j,f)}else{!f&&w.length>1&&d.nodeType===9&&!v&&o.match.ID.test(w[0])&&!o.match.ID.test(w[w.length-1])&&(n=m.find(w.shift(),d,v),d=n.expr?m.filter(n.expr,n.set)[0]:n.set[0]);if(d){n=f?{expr:w.pop(),set:s(f)}:m.find(w.pop(),w.length===1&&(w[0]==="~"||w[0]==="+")&&d.parentNode?d.parentNode:d,v),j=n.expr?m.filter(n.expr,n.set):n.set,w.length>0?k=s(j):u=!1;while(w.length)q=w.pop(),r=q,o.relative[q]?r=w.pop():q="",r==null&&(r=d),o.relative[q](k,r,v)}else k=w=[]}k||(k=j),k||m.error(q||b);if(g.call(k)==="[object Array]")if(!u)e.push.apply(e,k);else if(d&&d.nodeType===1)for(t=0;k[t]!=null;t++)k[t]&&(k[t]===!0||k[t].nodeType===1&&m.contains(d,k[t]))&&e.push(j[t]);else for(t=0;k[t]!=null;t++)k[t]&&k[t].nodeType===1&&e.push(j[t]);else s(k,e);l&&(m(l,h,e,f),m.uniqueSort(e));return e};m.uniqueSort=function(a){if(u){h=i,a.sort(u);if(h)for(var b=1;b<a.length;b++)a[b]===a[b-1]&&a.splice(b--,1)}return a},m.matches=function(a,b){return m(a,null,null,b)},m.matchesSelector=function(a,b){return m(b,null,null,[a]).length>0},m.find=function(a,b,c){var d,e,f,g,h,i;if(!a)return[];for(e=0,f=o.order.length;e<f;e++){h=o.order[e];if(g=o.leftMatch[h].exec(a)){i=g[1],g.splice(1,1);if(i.substr(i.length-1)!=="\\"){g[1]=(g[1]||"").replace(j,""),d=o.find[h](g,b,c);if(d!=null){a=a.replace(o.match[h],"");break}}}}d||(d=typeof b.getElementsByTagName!="undefined"?b.getElementsByTagName("*"):[]);return{set:d,expr:a}},m.filter=function(a,c,d,e){var f,g,h,i,j,k,l,n,p,q=a,r=[],s=c,t=c&&c[0]&&m.isXML(c[0]);while(a&&c.length){for(h in o.filter)if((f=o.leftMatch[h].exec(a))!=null&&f[2]){k=o.filter[h],l=f[1],g=!1,f.splice(1,1);if(l.substr(l.length-1)==="\\")continue;s===r&&(r=[]);if(o.preFilter[h]){f=o.preFilter[h](f,s,d,r,e,t);if(!f)g=i=!0;else if(f===!0)continue}if(f)for(n=0;(j=s[n])!=null;n++)j&&(i=k(j,f,n,s),p=e^i,d&&i!=null?p?g=!0:s[n]=!1:p&&(r.push(j),g=!0));if(i!==b){d||(s=r),a=a.replace(o.match[h],"");if(!g)return[];break}}if(a===q)if(g==null)m.error(a);else break;q=a}return s},m.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)};var n=m.getText=function(a){var b,c,d=a.nodeType,e="";if(d){if(d===1||d===9){if(typeof a.textContent=="string")return a.textContent;if(typeof a.innerText=="string")return a.innerText.replace(k,"");for(a=a.firstChild;a;a=a.nextSibling)e+=n(a)}else if(d===3||d===4)return a.nodeValue}else for(b=0;c=a[b];b++)c.nodeType!==8&&(e+=n(c));return e},o=m.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(a){return a.getAttribute("href")},type:function(a){return a.getAttribute("type")}},relative:{"+":function(a,b){var c=typeof b=="string",d=c&&!l.test(b),e=c&&!d;d&&(b=b.toLowerCase());for(var f=0,g=a.length,h;f<g;f++)if(h=a[f]){while((h=h.previousSibling)&&h.nodeType!==1);a[f]=e||h&&h.nodeName.toLowerCase()===b?h||!1:h===b}e&&m.filter(b,a,!0)},">":function(a,b){var c,d=typeof b=="string",e=0,f=a.length;if(d&&!l.test(b)){b=b.toLowerCase();for(;e<f;e++){c=a[e];if(c){var g=c.parentNode;a[e]=g.nodeName.toLowerCase()===b?g:!1}}}else{for(;e<f;e++)c=a[e],c&&(a[e]=d?c.parentNode:c.parentNode===b);d&&m.filter(b,a,!0)}},"":function(a,b,c){var d,f=e++,g=x;typeof b=="string"&&!l.test(b)&&(b=b.toLowerCase(),d=b,g=w),g("parentNode",b,f,a,d,c)},"~":function(a,b,c){var d,f=e++,g=x;typeof b=="string"&&!l.test(b)&&(b=b.toLowerCase(),d=b,g=w),g("previousSibling",b,f,a,d,c)}},find:{ID:function(a,b,c){if(typeof b.getElementById!="undefined"&&!c){var d=b.getElementById(a[1]);return d&&d.parentNode?[d]:[]}},NAME:function(a,b){if(typeof b.getElementsByName!="undefined"){var c=[],d=b.getElementsByName(a[1]);for(var e=0,f=d.length;e<f;e++)d[e].getAttribute("name")===a[1]&&c.push(d[e]);return c.length===0?null:c}},TAG:function(a,b){if(typeof b.getElementsByTagName!="undefined")return b.getElementsByTagName(a[1])}},preFilter:{CLASS:function(a,b,c,d,e,f){a=" "+a[1].replace(j,"")+" ";if(f)return a;for(var g=0,h;(h=b[g])!=null;g++)h&&(e^(h.className&&(" "+h.className+" ").replace(/[\t\n\r]/g," ").indexOf(a)>=0)?c||d.push(h):c&&(b[g]=!1));return!1},ID:function(a){return a[1].replace(j,"")},TAG:function(a,b){return a[1].replace(j,"").toLowerCase()},CHILD:function(a){if(a[1]==="nth"){a[2]||m.error(a[0]),a[2]=a[2].replace(/^\+|\s*/g,"");var b=/(-?)(\d*)(?:n([+\-]?\d*))?/.exec(a[2]==="even"&&"2n"||a[2]==="odd"&&"2n+1"||!/\D/.test(a[2])&&"0n+"+a[2]||a[2]);a[2]=b[1]+(b[2]||1)-0,a[3]=b[3]-0}else a[2]&&m.error(a[0]);a[0]=e++;return a},ATTR:function(a,b,c,d,e,f){var g=a[1]=a[1].replace(j,"");!f&&o.attrMap[g]&&(a[1]=o.attrMap[g]),a[4]=(a[4]||a[5]||"").replace(j,""),a[2]==="~="&&(a[4]=" "+a[4]+" ");return a},PSEUDO:function(b,c,d,e,f){if(b[1]==="not")if((a.exec(b[3])||"").length>1||/^\w/.test(b[3]))b[3]=m(b[3],null,null,c);else{var g=m.filter(b[3],c,d,!0^f);d||e.push.apply(e,g);return!1}else if(o.match.POS.test(b[0])||o.match.CHILD.test(b[0]))return!0;return b},POS:function(a){a.unshift(!0);return a}},filters:{enabled:function(a){return a.disabled===!1&&a.type!=="hidden"},disabled:function(a){return a.disabled===!0},checked:function(a){return a.checked===!0},selected:function(a){a.parentNode&&a.parentNode.selectedIndex;return a.selected===!0},parent:function(a){return!!a.firstChild},empty:function(a){return!a.firstChild},has:function(a,b,c){return!!m(c[3],a).length},header:function(a){return/h\d/i.test(a.nodeName)},text:function(a){var b=a.getAttribute("type"),c=a.type;return a.nodeName.toLowerCase()==="input"&&"text"===c&&(b===c||b===null)},radio:function(a){return a.nodeName.toLowerCase()==="input"&&"radio"===a.type},checkbox:function(a){return a.nodeName.toLowerCase()==="input"&&"checkbox"===a.type},file:function(a){return a.nodeName.toLowerCase()==="input"&&"file"===a.type},password:function(a){return a.nodeName.toLowerCase()==="input"&&"password"===a.type},submit:function(a){var b=a.nodeName.toLowerCase();return(b==="input"||b==="button")&&"submit"===a.type},image:function(a){return a.nodeName.toLowerCase()==="input"&&"image"===a.type},reset:function(a){var b=a.nodeName.toLowerCase();return(b==="input"||b==="button")&&"reset"===a.type},button:function(a){var b=a.nodeName.toLowerCase();return b==="input"&&"button"===a.type||b==="button"},input:function(a){return/input|select|textarea|button/i.test(a.nodeName)},focus:function(a){return a===a.ownerDocument.activeElement}},setFilters:{first:function(a,b){return b===0},last:function(a,b,c,d){return b===d.length-1},even:function(a,b){return b%2===0},odd:function(a,b){return b%2===1},lt:function(a,b,c){return b<c[3]-0},gt:function(a,b,c){return b>c[3]-0},nth:function(a,b,c){return c[3]-0===b},eq:function(a,b,c){return c[3]-0===b}},filter:{PSEUDO:function(a,b,c,d){var e=b[1],f=o.filters[e];if(f)return f(a,c,b,d);if(e==="contains")return(a.textContent||a.innerText||n([a])||"").indexOf(b[3])>=0;if(e==="not"){var g=b[3];for(var h=0,i=g.length;h<i;h++)if(g[h]===a)return!1;return!0}m.error(e)},CHILD:function(a,b){var c,e,f,g,h,i,j,k=b[1],l=a;switch(k){case"only":case"first":while(l=l.previousSibling)if(l.nodeType===1)return!1;if(k==="first")return!0;l=a;case"last":while(l=l.nextSibling)if(l.nodeType===1)return!1;return!0;case"nth":c=b[2],e=b[3];if(c===1&&e===0)return!0;f=b[0],g=a.parentNode;if(g&&(g[d]!==f||!a.nodeIndex)){i=0;for(l=g.firstChild;l;l=l.nextSibling)l.nodeType===1&&(l.nodeIndex=++i);g[d]=f}j=a.nodeIndex-e;return c===0?j===0:j%c===0&&j/c>=0}},ID:function(a,b){return a.nodeType===1&&a.getAttribute("id")===b},TAG:function(a,b){return b==="*"&&a.nodeType===1||!!a.nodeName&&a.nodeName.toLowerCase()===b},CLASS:function(a,b){return(" "+(a.className||a.getAttribute("class"))+" ").indexOf(b)>-1},ATTR:function(a,b){var c=b[1],d=m.attr?m.attr(a,c):o.attrHandle[c]?o.attrHandle[c](a):a[c]!=null?a[c]:a.getAttribute(c),e=d+"",f=b[2],g=b[4];return d==null?f==="!=":!f&&m.attr?d!=null:f==="="?e===g:f==="*="?e.indexOf(g)>=0:f==="~="?(" "+e+" ").indexOf(g)>=0:g?f==="!="?e!==g:f==="^="?e.indexOf(g)===0:f==="$="?e.substr(e.length-g.length)===g:f==="|="?e===g||e.substr(0,g.length+1)===g+"-":!1:e&&d!==!1},POS:function(a,b,c,d){var e=b[2],f=o.setFilters[e];if(f)return f(a,c,b,d)}}},p=o.match.POS,q=function(a,b){return"\\"+(b-0+1)};for(var r in o.match)o.match[r]=new RegExp(o.match[r].source+/(?![^\[]*\])(?![^\(]*\))/.source),o.leftMatch[r]=new RegExp(/(^(?:.|\r|\n)*?)/.source+o.match[r].source.replace(/\\(\d+)/g,q));var s=function(a,b){a=Array.prototype.slice.call(a,0);if(b){b.push.apply(b,a);return b}return a};try{Array.prototype.slice.call(c.documentElement.childNodes,0)[0].nodeType}catch(t){s=function(a,b){var c=0,d=b||[];if(g.call(a)==="[object Array]")Array.prototype.push.apply(d,a);else if(typeof a.length=="number")for(var e=a.length;c<e;c++)d.push(a[c]);else for(;a[c];c++)d.push(a[c]);return d}}var u,v;c.documentElement.compareDocumentPosition?u=function(a,b){if(a===b){h=!0;return 0}if(!a.compareDocumentPosition||!b.compareDocumentPosition)return a.compareDocumentPosition?-1:1;return a.compareDocumentPosition(b)&4?-1:1}:(u=function(a,b){if(a===b){h=!0;return 0}if(a.sourceIndex&&b.sourceIndex)return a.sourceIndex-b.sourceIndex;var c,d,e=[],f=[],g=a.parentNode,i=b.parentNode,j=g;if(g===i)return v(a,b);if(!g)return-1;if(!i)return 1;while(j)e.unshift(j),j=j.parentNode;j=i;while(j)f.unshift(j),j=j.parentNode;c=e.length,d=f.length;for(var k=0;k<c&&k<d;k++)if(e[k]!==f[k])return v(e[k],f[k]);return k===c?v(a,f[k],-1):v(e[k],b,1)},v=function(a,b,c){if(a===b)return c;var d=a.nextSibling;while(d){if(d===b)return-1;d=d.nextSibling}return 1}),function(){var a=c.createElement("div"),d="script"+(new Date).getTime(),e=c.documentElement;a.innerHTML="<a name='"+d+"'/>",e.insertBefore(a,e.firstChild),c.getElementById(d)&&(o.find.ID=function(a,c,d){if(typeof c.getElementById!="undefined"&&!d){var e=c.getElementById(a[1]);return e?e.id===a[1]||typeof e.getAttributeNode!="undefined"&&e.getAttributeNode("id").nodeValue===a[1]?[e]:b:[]}},o.filter.ID=function(a,b){var c=typeof a.getAttributeNode!="undefined"&&a.getAttributeNode("id");return a.nodeType===1&&c&&c.nodeValue===b}),e.removeChild(a),e=a=null}(),function(){var a=c.createElement("div");a.appendChild(c.createComment("")),a.getElementsByTagName("*").length>0&&(o.find.TAG=function(a,b){var c=b.getElementsByTagName(a[1]);if(a[1]==="*"){var d=[];for(var e=0;c[e];e++)c[e].nodeType===1&&d.push(c[e]);c=d}return c}),a.innerHTML="<a href='#'></a>",a.firstChild&&typeof a.firstChild.getAttribute!="undefined"&&a.firstChild.getAttribute("href")!=="#"&&(o.attrHandle.href=function(a){return a.getAttribute("href",2)}),a=null}(),c.querySelectorAll&&function(){var a=m,b=c.createElement("div"),d="__sizzle__";b.innerHTML="<p class='TEST'></p>";if(!b.querySelectorAll||b.querySelectorAll(".TEST").length!==0){m=function(b,e,f,g){e=e||c;if(!g&&!m.isXML(e)){var h=/^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec(b);if(h&&(e.nodeType===1||e.nodeType===9)){if(h[1])return s(e.getElementsByTagName(b),f);if(h[2]&&o.find.CLASS&&e.getElementsByClassName)return s(e.getElementsByClassName(h[2]),f)}if(e.nodeType===9){if(b==="body"&&e.body)return s([e.body],f);if(h&&h[3]){var i=e.getElementById(h[3]);if(!i||!i.parentNode)return s([],f);if(i.id===h[3])return s([i],f)}try{return s(e.querySelectorAll(b),f)}catch(j){}}else if(e.nodeType===1&&e.nodeName.toLowerCase()!=="object"){var k=e,l=e.getAttribute("id"),n=l||d,p=e.parentNode,q=/^\s*[+~]/.test(b);l?n=n.replace(/'/g,"\\$&"):e.setAttribute("id",n),q&&p&&(e=e.parentNode);try{if(!q||p)return s(e.querySelectorAll("[id='"+n+"'] "+b),f)}catch(r){}finally{l||k.removeAttribute("id")}}}return a(b,e,f,g)};for(var e in a)m[e]=a[e];b=null}}(),function(){var a=c.documentElement,b=a.matchesSelector||a.mozMatchesSelector||a.webkitMatchesSelector||a.msMatchesSelector;if(b){var d=!b.call(c.createElement("div"),"div"),e=!1;try{b.call(c.documentElement,"[test!='']:sizzle")}catch(f){e=!0}m.matchesSelector=function(a,c){c=c.replace(/\=\s*([^'"\]]*)\s*\]/g,"='$1']");if(!m.isXML(a))try{if(e||!o.match.PSEUDO.test(c)&&!/!=/.test(c)){var f=b.call(a,c);if(f||!d||a.document&&a.document.nodeType!==11)return f}}catch(g){}return m(c,null,null,[a]).length>0}}}(),function(){var a=c.createElement("div");a.innerHTML="<div class='test e'></div><div class='test'></div>";if(!!a.getElementsByClassName&&a.getElementsByClassName("e").length!==0){a.lastChild.className="e";if(a.getElementsByClassName("e").length===1)return;o.order.splice(1,0,"CLASS"),o.find.CLASS=function(a,b,c){if(typeof b.getElementsByClassName!="undefined"&&!c)return b.getElementsByClassName(a[1])},a=null}}(),c.documentElement.contains?m.contains=function(a,b){return a!==b&&(a.contains?a.contains(b):!0)}:c.documentElement.compareDocumentPosition?m.contains=function(a,b){return!!(a.compareDocumentPosition(b)&16)}:m.contains=function(){return!1},m.isXML=function(a){var b=(a?a.ownerDocument||a:0).documentElement;return b?b.nodeName!=="HTML":!1};var y=function(a,b,c){var d,e=[],f="",g=b.nodeType?[b]:b;while(d=o.match.PSEUDO.exec(a))f+=d[0],a=a.replace(o.match.PSEUDO,"");a=o.relative[a]?a+"*":a;for(var h=0,i=g.length;h<i;h++)m(a,g[h],e,c);return m.filter(f,e)};m.attr=f.attr,m.selectors.attrMap={},f.find=m,f.expr=m.selectors,f.expr[":"]=f.expr.filters,f.unique=m.uniqueSort,f.text=m.getText,f.isXMLDoc=m.isXML,f.contains=m.contains}();var L=/Until$/,M=/^(?:parents|prevUntil|prevAll)/,N=/,/,O=/^.[^:#\[\.,]*$/,P=Array.prototype.slice,Q=f.expr.match.POS,R={children:!0,contents:!0,next:!0,prev:!0};f.fn.extend({find:function(a){var b=this,c,d;if(typeof a!="string")return f(a).filter(function(){for(c=0,d=b.length;c<d;c++)if(f.contains(b[c],this))return!0});var e=this.pushStack("","find",a),g,h,i;for(c=0,d=this.length;c<d;c++){g=e.length,f.find(a,this[c],e);if(c>0)for(h=g;h<e.length;h++)for(i=0;i<g;i++)if(e[i]===e[h]){e.splice(h--,1);break}}return e},has:function(a){var b=f(a);return this.filter(function(){for(var a=0,c=b.length;a<c;a++)if(f.contains(this,b[a]))return!0})},not:function(a){return this.pushStack(T(this,a,!1),"not",a)},filter:function(a){return this.pushStack(T(this,a,!0),"filter",a)},is:function(a){return!!a&&(typeof a=="string"?Q.test(a)?f(a,this.context).index(this[0])>=0:f.filter(a,this).length>0:this.filter(a).length>0)},closest:function(a,b){var c=[],d,e,g=this[0];if(f.isArray(a)){var h=1;while(g&&g.ownerDocument&&g!==b){for(d=0;d<a.length;d++)f(g).is(a[d])&&c.push({selector:a[d],elem:g,level:h});g=g.parentNode,h++}return c}var i=Q.test(a)||typeof a!="string"?f(a,b||this.context):0;for(d=0,e=this.length;d<e;d++){g=this[d];while(g){if(i?i.index(g)>-1:f.find.matchesSelector(g,a)){c.push(g);break}g=g.parentNode;if(!g||!g.ownerDocument||g===b||g.nodeType===11)break}}c=c.length>1?f.unique(c):c;return this.pushStack(c,"closest",a)},index:function(a){if(!a)return this[0]&&this[0].parentNode?this.prevAll().length:-1;if(typeof a=="string")return f.inArray(this[0],f(a));return f.inArray(a.jquery?a[0]:a,this)},add:function(a,b){var c=typeof a=="string"?f(a,b):f.makeArray(a&&a.nodeType?[a]:a),d=f.merge(this.get(),c);return this.pushStack(S(c[0])||S(d[0])?d:f.unique(d))},andSelf:function(){return this.add(this.prevObject)}}),f.each({parent:function(a){var b=a.parentNode;return b&&b.nodeType!==11?b:null},parents:function(a){return f.dir(a,"parentNode")},parentsUntil:function(a,b,c){return f.dir(a,"parentNode",c)},next:function(a){return f.nth(a,2,"nextSibling")},prev:function(a){return f.nth(a,2,"previousSibling")},nextAll:function(a){return f.dir(a,"nextSibling")},prevAll:function(a){return f.dir(a,"previousSibling")},nextUntil:function(a,b,c){return f.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return f.dir(a,"previousSibling",c)},siblings:function(a){return f.sibling(a.parentNode.firstChild,a)},children:function(a){return f.sibling(a.firstChild)},contents:function(a){return f.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:f.makeArray(a.childNodes)}},function(a,b){f.fn[a]=function(c,d){var e=f.map(this,b,c);L.test(a)||(d=c),d&&typeof d=="string"&&(e=f.filter(d,e)),e=this.length>1&&!R[a]?f.unique(e):e,(this.length>1||N.test(d))&&M.test(a)&&(e=e.reverse());return this.pushStack(e,a,P.call(arguments).join(","))}}),f.extend({filter:function(a,b,c){c&&(a=":not("+a+")");return b.length===1?f.find.matchesSelector(b[0],a)?[b[0]]:[]:f.find.matches(a,b)},dir:function(a,c,d){var e=[],g=a[c];while(g&&g.nodeType!==9&&(d===b||g.nodeType!==1||!f(g).is(d)))g.nodeType===1&&e.push(g),g=g[c];return e},nth:function(a,b,c,d){b=b||1;var e=0;for(;a;a=a[c])if(a.nodeType===1&&++e===b)break;return a},sibling:function(a,b){var c=[];for(;a;a=a.nextSibling)a.nodeType===1&&a!==b&&c.push(a);return c}});var V="abbr|article|aside|audio|canvas|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",W=/ jQuery\d+="(?:\d+|null)"/g,X=/^\s+/,Y=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/ig,Z=/<([\w:]+)/,$=/<tbody/i,_=/<|&#?\w+;/,ba=/<(?:script|style)/i,bb=/<(?:script|object|embed|option|style)/i,bc=new RegExp("<(?:"+V+")","i"),bd=/checked\s*(?:[^=]|=\s*.checked.)/i,be=/\/(java|ecma)script/i,bf=/^\s*<!(?:\[CDATA\[|\-\-)/,bg={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],area:[1,"<map>","</map>"],_default:[0,"",""]},bh=U(c);bg.optgroup=bg.option,bg.tbody=bg.tfoot=bg.colgroup=bg.caption=bg.thead,bg.th=bg.td,f.support.htmlSerialize||(bg._default=[1,"div<div>","</div>"]),f.fn.extend({text:function(a){if(f.isFunction(a))return this.each(function(b){var c=f(this);c.text(a.call(this,b,c.text()))});if(typeof a!="object"&&a!==b)return this.empty().append((this[0]&&this[0].ownerDocument||c).createTextNode(a));return f.text(this)},wrapAll:function(a){if(f.isFunction(a))return this.each(function(b){f(this).wrapAll(a.call(this,b))});if(this[0]){var b=f(a,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstChild&&a.firstChild.nodeType===1)a=a.firstChild;return a}).append(this)}return this},wrapInner:function(a){if(f.isFunction(a))return this.each(function(b){f(this).wrapInner(a.call(this,b))});return this.each(function(){var b=f(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=f.isFunction(a);return this.each(function(c){f(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){f.nodeName(this,"body")||f(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,!0,function(a){this.nodeType===1&&this.appendChild(a)})},prepend:function(){return this.domManip(arguments,!0,function(a){this.nodeType===1&&this.insertBefore(a,this.firstChild)})},before:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this)});if(arguments.length){var a=f.clean(arguments);a.push.apply(a,this.toArray());return this.pushStack(a,"before",arguments)}},after:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this.nextSibling)});if(arguments.length){var a=this.pushStack(this,"after",arguments);a.push.apply(a,f.clean(arguments));return a}},remove:function(a,b){for(var c=0,d;(d=this[c])!=null;c++)if(!a||f.filter(a,[d]).length)!b&&d.nodeType===1&&(f.cleanData(d.getElementsByTagName("*")),f.cleanData([d])),d.parentNode&&d.parentNode.removeChild(d);return this},empty:function()
{for(var a=0,b;(b=this[a])!=null;a++){b.nodeType===1&&f.cleanData(b.getElementsByTagName("*"));while(b.firstChild)b.removeChild(b.firstChild)}return this},clone:function(a,b){a=a==null?!1:a,b=b==null?a:b;return this.map(function(){return f.clone(this,a,b)})},html:function(a){if(a===b)return this[0]&&this[0].nodeType===1?this[0].innerHTML.replace(W,""):null;if(typeof a=="string"&&!ba.test(a)&&(f.support.leadingWhitespace||!X.test(a))&&!bg[(Z.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(Y,"<$1></$2>");try{for(var c=0,d=this.length;c<d;c++)this[c].nodeType===1&&(f.cleanData(this[c].getElementsByTagName("*")),this[c].innerHTML=a)}catch(e){this.empty().append(a)}}else f.isFunction(a)?this.each(function(b){var c=f(this);c.html(a.call(this,b,c.html()))}):this.empty().append(a);return this},replaceWith:function(a){if(this[0]&&this[0].parentNode){if(f.isFunction(a))return this.each(function(b){var c=f(this),d=c.html();c.replaceWith(a.call(this,b,d))});typeof a!="string"&&(a=f(a).detach());return this.each(function(){var b=this.nextSibling,c=this.parentNode;f(this).remove(),b?f(b).before(a):f(c).append(a)})}return this.length?this.pushStack(f(f.isFunction(a)?a():a),"replaceWith",a):this},detach:function(a){return this.remove(a,!0)},domManip:function(a,c,d){var e,g,h,i,j=a[0],k=[];if(!f.support.checkClone&&arguments.length===3&&typeof j=="string"&&bd.test(j))return this.each(function(){f(this).domManip(a,c,d,!0)});if(f.isFunction(j))return this.each(function(e){var g=f(this);a[0]=j.call(this,e,c?g.html():b),g.domManip(a,c,d)});if(this[0]){i=j&&j.parentNode,f.support.parentNode&&i&&i.nodeType===11&&i.childNodes.length===this.length?e={fragment:i}:e=f.buildFragment(a,this,k),h=e.fragment,h.childNodes.length===1?g=h=h.firstChild:g=h.firstChild;if(g){c=c&&f.nodeName(g,"tr");for(var l=0,m=this.length,n=m-1;l<m;l++)d.call(c?bi(this[l],g):this[l],e.cacheable||m>1&&l<n?f.clone(h,!0,!0):h)}k.length&&f.each(k,bp)}return this}}),f.buildFragment=function(a,b,d){var e,g,h,i,j=a[0];b&&b[0]&&(i=b[0].ownerDocument||b[0]),i.createDocumentFragment||(i=c),a.length===1&&typeof j=="string"&&j.length<512&&i===c&&j.charAt(0)==="<"&&!bb.test(j)&&(f.support.checkClone||!bd.test(j))&&(f.support.html5Clone||!bc.test(j))&&(g=!0,h=f.fragments[j],h&&h!==1&&(e=h)),e||(e=i.createDocumentFragment(),f.clean(a,i,e,d)),g&&(f.fragments[j]=h?e:1);return{fragment:e,cacheable:g}},f.fragments={},f.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){f.fn[a]=function(c){var d=[],e=f(c),g=this.length===1&&this[0].parentNode;if(g&&g.nodeType===11&&g.childNodes.length===1&&e.length===1){e[b](this[0]);return this}for(var h=0,i=e.length;h<i;h++){var j=(h>0?this.clone(!0):this).get();f(e[h])[b](j),d=d.concat(j)}return this.pushStack(d,a,e.selector)}}),f.extend({clone:function(a,b,c){var d,e,g,h=f.support.html5Clone||!bc.test("<"+a.nodeName)?a.cloneNode(!0):bo(a);if((!f.support.noCloneEvent||!f.support.noCloneChecked)&&(a.nodeType===1||a.nodeType===11)&&!f.isXMLDoc(a)){bk(a,h),d=bl(a),e=bl(h);for(g=0;d[g];++g)e[g]&&bk(d[g],e[g])}if(b){bj(a,h);if(c){d=bl(a),e=bl(h);for(g=0;d[g];++g)bj(d[g],e[g])}}d=e=null;return h},clean:function(a,b,d,e){var g;b=b||c,typeof b.createElement=="undefined"&&(b=b.ownerDocument||b[0]&&b[0].ownerDocument||c);var h=[],i;for(var j=0,k;(k=a[j])!=null;j++){typeof k=="number"&&(k+="");if(!k)continue;if(typeof k=="string")if(!_.test(k))k=b.createTextNode(k);else{k=k.replace(Y,"<$1></$2>");var l=(Z.exec(k)||["",""])[1].toLowerCase(),m=bg[l]||bg._default,n=m[0],o=b.createElement("div");b===c?bh.appendChild(o):U(b).appendChild(o),o.innerHTML=m[1]+k+m[2];while(n--)o=o.lastChild;if(!f.support.tbody){var p=$.test(k),q=l==="table"&&!p?o.firstChild&&o.firstChild.childNodes:m[1]==="<table>"&&!p?o.childNodes:[];for(i=q.length-1;i>=0;--i)f.nodeName(q[i],"tbody")&&!q[i].childNodes.length&&q[i].parentNode.removeChild(q[i])}!f.support.leadingWhitespace&&X.test(k)&&o.insertBefore(b.createTextNode(X.exec(k)[0]),o.firstChild),k=o.childNodes}var r;if(!f.support.appendChecked)if(k[0]&&typeof (r=k.length)=="number")for(i=0;i<r;i++)bn(k[i]);else bn(k);k.nodeType?h.push(k):h=f.merge(h,k)}if(d){g=function(a){return!a.type||be.test(a.type)};for(j=0;h[j];j++)if(e&&f.nodeName(h[j],"script")&&(!h[j].type||h[j].type.toLowerCase()==="text/javascript"))e.push(h[j].parentNode?h[j].parentNode.removeChild(h[j]):h[j]);else{if(h[j].nodeType===1){var s=f.grep(h[j].getElementsByTagName("script"),g);h.splice.apply(h,[j+1,0].concat(s))}d.appendChild(h[j])}}return h},cleanData:function(a){var b,c,d=f.cache,e=f.event.special,g=f.support.deleteExpando;for(var h=0,i;(i=a[h])!=null;h++){if(i.nodeName&&f.noData[i.nodeName.toLowerCase()])continue;c=i[f.expando];if(c){b=d[c];if(b&&b.events){for(var j in b.events)e[j]?f.event.remove(i,j):f.removeEvent(i,j,b.handle);b.handle&&(b.handle.elem=null)}g?delete i[f.expando]:i.removeAttribute&&i.removeAttribute(f.expando),delete d[c]}}}});var bq=/alpha\([^)]*\)/i,br=/opacity=([^)]*)/,bs=/([A-Z]|^ms)/g,bt=/^-?\d+(?:px)?$/i,bu=/^-?\d/,bv=/^([\-+])=([\-+.\de]+)/,bw={position:"absolute",visibility:"hidden",display:"block"},bx=["Left","Right"],by=["Top","Bottom"],bz,bA,bB;f.fn.css=function(a,c){if(arguments.length===2&&c===b)return this;return f.access(this,a,c,!0,function(a,c,d){return d!==b?f.style(a,c,d):f.css(a,c)})},f.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=bz(a,"opacity","opacity");return c===""?"1":c}return a.style.opacity}}},cssNumber:{fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":f.support.cssFloat?"cssFloat":"styleFloat"},style:function(a,c,d,e){if(!!a&&a.nodeType!==3&&a.nodeType!==8&&!!a.style){var g,h,i=f.camelCase(c),j=a.style,k=f.cssHooks[i];c=f.cssProps[i]||i;if(d===b){if(k&&"get"in k&&(g=k.get(a,!1,e))!==b)return g;return j[c]}h=typeof d,h==="string"&&(g=bv.exec(d))&&(d=+(g[1]+1)*+g[2]+parseFloat(f.css(a,c)),h="number");if(d==null||h==="number"&&isNaN(d))return;h==="number"&&!f.cssNumber[i]&&(d+="px");if(!k||!("set"in k)||(d=k.set(a,d))!==b)try{j[c]=d}catch(l){}}},css:function(a,c,d){var e,g;c=f.camelCase(c),g=f.cssHooks[c],c=f.cssProps[c]||c,c==="cssFloat"&&(c="float");if(g&&"get"in g&&(e=g.get(a,!0,d))!==b)return e;if(bz)return bz(a,c)},swap:function(a,b,c){var d={};for(var e in b)d[e]=a.style[e],a.style[e]=b[e];c.call(a);for(e in b)a.style[e]=d[e]}}),f.curCSS=f.css,f.each(["height","width"],function(a,b){f.cssHooks[b]={get:function(a,c,d){var e;if(c){if(a.offsetWidth!==0)return bC(a,b,d);f.swap(a,bw,function(){e=bC(a,b,d)});return e}},set:function(a,b){if(!bt.test(b))return b;b=parseFloat(b);if(b>=0)return b+"px"}}}),f.support.opacity||(f.cssHooks.opacity={get:function(a,b){return br.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?parseFloat(RegExp.$1)/100+"":b?"1":""},set:function(a,b){var c=a.style,d=a.currentStyle,e=f.isNumeric(b)?"alpha(opacity="+b*100+")":"",g=d&&d.filter||c.filter||"";c.zoom=1;if(b>=1&&f.trim(g.replace(bq,""))===""){c.removeAttribute("filter");if(d&&!d.filter)return}c.filter=bq.test(g)?g.replace(bq,e):g+" "+e}}),f(function(){f.support.reliableMarginRight||(f.cssHooks.marginRight={get:function(a,b){var c;f.swap(a,{display:"inline-block"},function(){b?c=bz(a,"margin-right","marginRight"):c=a.style.marginRight});return c}})}),c.defaultView&&c.defaultView.getComputedStyle&&(bA=function(a,b){var c,d,e;b=b.replace(bs,"-$1").toLowerCase(),(d=a.ownerDocument.defaultView)&&(e=d.getComputedStyle(a,null))&&(c=e.getPropertyValue(b),c===""&&!f.contains(a.ownerDocument.documentElement,a)&&(c=f.style(a,b)));return c}),c.documentElement.currentStyle&&(bB=function(a,b){var c,d,e,f=a.currentStyle&&a.currentStyle[b],g=a.style;f===null&&g&&(e=g[b])&&(f=e),!bt.test(f)&&bu.test(f)&&(c=g.left,d=a.runtimeStyle&&a.runtimeStyle.left,d&&(a.runtimeStyle.left=a.currentStyle.left),g.left=b==="fontSize"?"1em":f||0,f=g.pixelLeft+"px",g.left=c,d&&(a.runtimeStyle.left=d));return f===""?"auto":f}),bz=bA||bB,f.expr&&f.expr.filters&&(f.expr.filters.hidden=function(a){var b=a.offsetWidth,c=a.offsetHeight;return b===0&&c===0||!f.support.reliableHiddenOffsets&&(a.style&&a.style.display||f.css(a,"display"))==="none"},f.expr.filters.visible=function(a){return!f.expr.filters.hidden(a)});var bD=/%20/g,bE=/\[\]$/,bF=/\r?\n/g,bG=/#.*$/,bH=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,bI=/^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,bJ=/^(?:about|app|app\-storage|.+\-extension|file|res|widget):$/,bK=/^(?:GET|HEAD)$/,bL=/^\/\//,bM=/\?/,bN=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,bO=/^(?:select|textarea)/i,bP=/\s+/,bQ=/([?&])_=[^&]*/,bR=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/,bS=f.fn.load,bT={},bU={},bV,bW,bX=["*/"]+["*"];try{bV=e.href}catch(bY){bV=c.createElement("a"),bV.href="",bV=bV.href}bW=bR.exec(bV.toLowerCase())||[],f.fn.extend({load:function(a,c,d){if(typeof a!="string"&&bS)return bS.apply(this,arguments);if(!this.length)return this;var e=a.indexOf(" ");if(e>=0){var g=a.slice(e,a.length);a=a.slice(0,e)}var h="GET";c&&(f.isFunction(c)?(d=c,c=b):typeof c=="object"&&(c=f.param(c,f.ajaxSettings.traditional),h="POST"));var i=this;f.ajax({url:a,type:h,dataType:"html",data:c,complete:function(a,b,c){c=a.responseText,a.isResolved()&&(a.done(function(a){c=a}),i.html(g?f("<div>").append(c.replace(bN,"")).find(g):c)),d&&i.each(d,[c,b,a])}});return this},serialize:function(){return f.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?f.makeArray(this.elements):this}).filter(function(){return this.name&&!this.disabled&&(this.checked||bO.test(this.nodeName)||bI.test(this.type))}).map(function(a,b){var c=f(this).val();return c==null?null:f.isArray(c)?f.map(c,function(a,c){return{name:b.name,value:a.replace(bF,"\r\n")}}):{name:b.name,value:c.replace(bF,"\r\n")}}).get()}}),f.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(a,b){f.fn[b]=function(a){return this.on(b,a)}}),f.each(["get","post"],function(a,c){f[c]=function(a,d,e,g){f.isFunction(d)&&(g=g||e,e=d,d=b);return f.ajax({type:c,url:a,data:d,success:e,dataType:g})}}),f.extend({getScript:function(a,c){return f.get(a,b,c,"script")},getJSON:function(a,b,c){return f.get(a,b,c,"json")},ajaxSetup:function(a,b){b?b_(a,f.ajaxSettings):(b=a,a=f.ajaxSettings),b_(a,b);return a},ajaxSettings:{url:bV,isLocal:bJ.test(bW[1]),global:!0,type:"GET",contentType:"application/x-www-form-urlencoded",processData:!0,async:!0,accepts:{xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript","*":bX},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText"},converters:{"* text":a.String,"text html":!0,"text json":f.parseJSON,"text xml":f.parseXML},flatOptions:{context:!0,url:!0}},ajaxPrefilter:bZ(bT),ajaxTransport:bZ(bU),ajax:function(a,c){function w(a,c,l,m){if(s!==2){s=2,q&&clearTimeout(q),p=b,n=m||"",v.readyState=a>0?4:0;var o,r,u,w=c,x=l?cb(d,v,l):b,y,z;if(a>=200&&a<300||a===304){if(d.ifModified){if(y=v.getResponseHeader("Last-Modified"))f.lastModified[k]=y;if(z=v.getResponseHeader("Etag"))f.etag[k]=z}if(a===304)w="notmodified",o=!0;else try{r=cc(d,x),w="success",o=!0}catch(A){w="parsererror",u=A}}else{u=w;if(!w||a)w="error",a<0&&(a=0)}v.status=a,v.statusText=""+(c||w),o?h.resolveWith(e,[r,w,v]):h.rejectWith(e,[v,w,u]),v.statusCode(j),j=b,t&&g.trigger("ajax"+(o?"Success":"Error"),[v,d,o?r:u]),i.fireWith(e,[v,w]),t&&(g.trigger("ajaxComplete",[v,d]),--f.active||f.event.trigger("ajaxStop"))}}typeof a=="object"&&(c=a,a=b),c=c||{};var d=f.ajaxSetup({},c),e=d.context||d,g=e!==d&&(e.nodeType||e instanceof f)?f(e):f.event,h=f.Deferred(),i=f.Callbacks("once memory"),j=d.statusCode||{},k,l={},m={},n,o,p,q,r,s=0,t,u,v={readyState:0,setRequestHeader:function(a,b){if(!s){var c=a.toLowerCase();a=m[c]=m[c]||a,l[a]=b}return this},getAllResponseHeaders:function(){return s===2?n:null},getResponseHeader:function(a){var c;if(s===2){if(!o){o={};while(c=bH.exec(n))o[c[1].toLowerCase()]=c[2]}c=o[a.toLowerCase()]}return c===b?null:c},overrideMimeType:function(a){s||(d.mimeType=a);return this},abort:function(a){a=a||"abort",p&&p.abort(a),w(0,a);return this}};h.promise(v),v.success=v.done,v.error=v.fail,v.complete=i.add,v.statusCode=function(a){if(a){var b;if(s<2)for(b in a)j[b]=[j[b],a[b]];else b=a[v.status],v.then(b,b)}return this},d.url=((a||d.url)+"").replace(bG,"").replace(bL,bW[1]+"//"),d.dataTypes=f.trim(d.dataType||"*").toLowerCase().split(bP),d.crossDomain==null&&(r=bR.exec(d.url.toLowerCase()),d.crossDomain=!(!r||r[1]==bW[1]&&r[2]==bW[2]&&(r[3]||(r[1]==="http:"?80:443))==(bW[3]||(bW[1]==="http:"?80:443)))),d.data&&d.processData&&typeof d.data!="string"&&(d.data=f.param(d.data,d.traditional)),b$(bT,d,c,v);if(s===2)return!1;t=d.global,d.type=d.type.toUpperCase(),d.hasContent=!bK.test(d.type),t&&f.active++===0&&f.event.trigger("ajaxStart");if(!d.hasContent){d.data&&(d.url+=(bM.test(d.url)?"&":"?")+d.data,delete d.data),k=d.url;if(d.cache===!1){var x=f.now(),y=d.url.replace(bQ,"$1_="+x);d.url=y+(y===d.url?(bM.test(d.url)?"&":"?")+"_="+x:"")}}(d.data&&d.hasContent&&d.contentType!==!1||c.contentType)&&v.setRequestHeader("Content-Type",d.contentType),d.ifModified&&(k=k||d.url,f.lastModified[k]&&v.setRequestHeader("If-Modified-Since",f.lastModified[k]),f.etag[k]&&v.setRequestHeader("If-None-Match",f.etag[k])),v.setRequestHeader("Accept",d.dataTypes[0]&&d.accepts[d.dataTypes[0]]?d.accepts[d.dataTypes[0]]+(d.dataTypes[0]!=="*"?", "+bX+"; q=0.01":""):d.accepts["*"]);for(u in d.headers)v.setRequestHeader(u,d.headers[u]);if(d.beforeSend&&(d.beforeSend.call(e,v,d)===!1||s===2)){v.abort();return!1}for(u in{success:1,error:1,complete:1})v[u](d[u]);p=b$(bU,d,c,v);if(!p)w(-1,"No Transport");else{v.readyState=1,t&&g.trigger("ajaxSend",[v,d]),d.async&&d.timeout>0&&(q=setTimeout(function(){v.abort("timeout")},d.timeout));try{s=1,p.send(l,w)}catch(z){if(s<2)w(-1,z);else throw z}}return v},param:function(a,c){var d=[],e=function(a,b){b=f.isFunction(b)?b():b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};c===b&&(c=f.ajaxSettings.traditional);if(f.isArray(a)||a.jquery&&!f.isPlainObject(a))f.each(a,function(){e(this.name,this.value)});else for(var g in a)ca(g,a[g],c,e);return d.join("&").replace(bD,"+")}}),f.extend({active:0,lastModified:{},etag:{}});var cd=f.now(),ce=/(\=)\?(&|$)|\?\?/i;f.ajaxSetup({jsonp:"callback",jsonpCallback:function(){return f.expando+"_"+cd++}}),f.ajaxPrefilter("json jsonp",function(b,c,d){var e=b.contentType==="application/x-www-form-urlencoded"&&typeof b.data=="string";if(b.dataTypes[0]==="jsonp"||b.jsonp!==!1&&(ce.test(b.url)||e&&ce.test(b.data))){var g,h=b.jsonpCallback=f.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,i=a[h],j=b.url,k=b.data,l="$1"+h+"$2";b.jsonp!==!1&&(j=j.replace(ce,l),b.url===j&&(e&&(k=k.replace(ce,l)),b.data===k&&(j+=(/\?/.test(j)?"&":"?")+b.jsonp+"="+h))),b.url=j,b.data=k,a[h]=function(a){g=[a]},d.always(function(){a[h]=i,g&&f.isFunction(i)&&a[h](g[0])}),b.converters["script json"]=function(){g||f.error(h+" was not called");return g[0]},b.dataTypes[0]="json";return"script"}}),f.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/javascript|ecmascript/},converters:{"text script":function(a){f.globalEval(a);return a}}}),f.ajaxPrefilter("script",function(a){a.cache===b&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)}),f.ajaxTransport("script",function(a){if(a.crossDomain){var d,e=c.head||c.getElementsByTagName("head")[0]||c.documentElement;return{send:function(f,g){d=c.createElement("script"),d.async="async",a.scriptCharset&&(d.charset=a.scriptCharset),d.src=a.url,d.onload=d.onreadystatechange=function(a,c){if(c||!d.readyState||/loaded|complete/.test(d.readyState))d.onload=d.onreadystatechange=null,e&&d.parentNode&&e.removeChild(d),d=b,c||g(200,"success")},e.insertBefore(d,e.firstChild)},abort:function(){d&&d.onload(0,1)}}}});var cf=a.ActiveXObject?function(){for(var a in ch)ch[a](0,1)}:!1,cg=0,ch;f.ajaxSettings.xhr=a.ActiveXObject?function(){return!this.isLocal&&ci()||cj()}:ci,function(a){f.extend(f.support,{ajax:!!a,cors:!!a&&"withCredentials"in a})}(f.ajaxSettings.xhr()),f.support.ajax&&f.ajaxTransport(function(c){if(!c.crossDomain||f.support.cors){var d;return{send:function(e,g){var h=c.xhr(),i,j;c.username?h.open(c.type,c.url,c.async,c.username,c.password):h.open(c.type,c.url,c.async);if(c.xhrFields)for(j in c.xhrFields)h[j]=c.xhrFields[j];c.mimeType&&h.overrideMimeType&&h.overrideMimeType(c.mimeType),!c.crossDomain&&!e["X-Requested-With"]&&(e["X-Requested-With"]="XMLHttpRequest");try{for(j in e)h.setRequestHeader(j,e[j])}catch(k){}h.send(c.hasContent&&c.data||null),d=function(a,e){var j,k,l,m,n;try{if(d&&(e||h.readyState===4)){d=b,i&&(h.onreadystatechange=f.noop,cf&&delete ch[i]);if(e)h.readyState!==4&&h.abort();else{j=h.status,l=h.getAllResponseHeaders(),m={},n=h.responseXML,n&&n.documentElement&&(m.xml=n),m.text=h.responseText;try{k=h.statusText}catch(o){k=""}!j&&c.isLocal&&!c.crossDomain?j=m.text?200:404:j===1223&&(j=204)}}}catch(p){e||g(-1,p)}m&&g(j,k,m,l)},!c.async||h.readyState===4?d():(i=++cg,cf&&(ch||(ch={},f(a).unload(cf)),ch[i]=d),h.onreadystatechange=d)},abort:function(){d&&d(0,1)}}}});var ck={},cl,cm,cn=/^(?:toggle|show|hide)$/,co=/^([+\-]=)?([\d+.\-]+)([a-z%]*)$/i,cp,cq=[["height","marginTop","marginBottom","paddingTop","paddingBottom"],["width","marginLeft","marginRight","paddingLeft","paddingRight"],["opacity"]],cr;f.fn.extend({show:function(a,b,c){var d,e;if(a||a===0)return this.animate(cu("show",3),a,b,c);for(var g=0,h=this.length;g<h;g++)d=this[g],d.style&&(e=d.style.display,!f._data(d,"olddisplay")&&e==="none"&&(e=d.style.display=""),e===""&&f.css(d,"display")==="none"&&f._data(d,"olddisplay",cv(d.nodeName)));for(g=0;g<h;g++){d=this[g];if(d.style){e=d.style.display;if(e===""||e==="none")d.style.display=f._data(d,"olddisplay")||""}}return this},hide:function(a,b,c){if(a||a===0)return this.animate(cu("hide",3),a,b,c);var d,e,g=0,h=this.length;for(;g<h;g++)d=this[g],d.style&&(e=f.css(d,"display"),e!=="none"&&!f._data(d,"olddisplay")&&f._data(d,"olddisplay",e));for(g=0;g<h;g++)this[g].style&&(this[g].style.display="none");return this},_toggle:f.fn.toggle,toggle:function(a,b,c){var d=typeof a=="boolean";f.isFunction(a)&&f.isFunction(b)?this._toggle.apply(this,arguments):a==null||d?this.each(function(){var b=d?a:f(this).is(":hidden");f(this)[b?"show":"hide"]()}):this.animate(cu("toggle",3),a,b,c);return this},fadeTo:function(a,b,c,d){return this.filter(":hidden").css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){function g(){e.queue===!1&&f._mark(this);var b=f.extend({},e),c=this.nodeType===1,d=c&&f(this).is(":hidden"),g,h,i,j,k,l,m,n,o;b.animatedProperties={};for(i in a){g=f.camelCase(i),i!==g&&(a[g]=a[i],delete a[i]),h=a[g],f.isArray(h)?(b.animatedProperties[g]=h[1],h=a[g]=h[0]):b.animatedProperties[g]=b.specialEasing&&b.specialEasing[g]||b.easing||"swing";if(h==="hide"&&d||h==="show"&&!d)return b.complete.call(this);c&&(g==="height"||g==="width")&&(b.overflow=[this.style.overflow,this.style.overflowX,this.style.overflowY],f.css(this,"display")==="inline"&&f.css(this,"float")==="none"&&(!f.support.inlineBlockNeedsLayout||cv(this.nodeName)==="inline"?this.style.display="inline-block":this.style.zoom=1))}b.overflow!=null&&(this.style.overflow="hidden");for(i in a)j=new f.fx(this,b,i),h=a[i],cn.test(h)?(o=f._data(this,"toggle"+i)||(h==="toggle"?d?"show":"hide":0),o?(f._data(this,"toggle"+i,o==="show"?"hide":"show"),j[o]()):j[h]()):(k=co.exec(h),l=j.cur(),k?(m=parseFloat(k[2]),n=k[3]||(f.cssNumber[i]?"":"px"),n!=="px"&&(f.style(this,i,(m||1)+n),l=(m||1)/j.cur()*l,f.style(this,i,l+n)),k[1]&&(m=(k[1]==="-="?-1:1)*m+l),j.custom(l,m,n)):j.custom(l,h,""));return!0}var e=f.speed(b,c,d);if(f.isEmptyObject(a))return this.each(e.complete,[!1]);a=f.extend({},a);return e.queue===!1?this.each(g):this.queue(e.queue,g)},stop:function(a,c,d){typeof a!="string"&&(d=c,c=a,a=b),c&&a!==!1&&this.queue(a||"fx",[]);return this.each(function(){function h(a,b,c){var e=b[c];f.removeData(a,c,!0),e.stop(d)}var b,c=!1,e=f.timers,g=f._data(this);d||f._unmark(!0,this);if(a==null)for(b in g)g[b]&&g[b].stop&&b.indexOf(".run")===b.length-4&&h(this,g,b);else g[b=a+".run"]&&g[b].stop&&h(this,g,b);for(b=e.length;b--;)e[b].elem===this&&(a==null||e[b].queue===a)&&(d?e[b](!0):e[b].saveState(),c=!0,e.splice(b,1));(!d||!c)&&f.dequeue(this,a)})}}),f.each({slideDown:cu("show",1),slideUp:cu("hide",1),slideToggle:cu("toggle",1),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){f.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),f.extend({speed:function(a,b,c){var d=a&&typeof a=="object"?f.extend({},a):{complete:c||!c&&b||f.isFunction(a)&&a,duration:a,easing:c&&b||b&&!f.isFunction(b)&&b};d.duration=f.fx.off?0:typeof d.duration=="number"?d.duration:d.duration in f.fx.speeds?f.fx.speeds[d.duration]:f.fx.speeds._default;if(d.queue==null||d.queue===!0)d.queue="fx";d.old=d.complete,d.complete=function(a){f.isFunction(d.old)&&d.old.call(this),d.queue?f.dequeue(this,d.queue):a!==!1&&f._unmark(this)};return d},easing:{linear:function(a,b,c,d){return c+d*a},swing:function(a,b,c,d){return(-Math.cos(a*Math.PI)/2+.5)*d+c}},timers:[],fx:function(a,b,c){this.options=b,this.elem=a,this.prop=c,b.orig=b.orig||{}}}),f.fx.prototype={update:function(){this.options.step&&this.options.step.call(this.elem,this.now,this),(f.fx.step[this.prop]||f.fx.step._default)(this)},cur:function(){if(this.elem[this.prop]!=null&&(!this.elem.style||this.elem.style[this.prop]==null))return this.elem[this.prop];var a,b=f.css(this.elem,this.prop);return isNaN(a=parseFloat(b))?!b||b==="auto"?0:b:a},custom:function(a,c,d){function h(a){return e.step(a)}var e=this,g=f.fx;this.startTime=cr||cs(),this.end=c,this.now=this.start=a,this.pos=this.state=0,this.unit=d||this.unit||(f.cssNumber[this.prop]?"":"px"),h.queue=this.options.queue,h.elem=this.elem,h.saveState=function(){e.options.hide&&f._data(e.elem,"fxshow"+e.prop)===b&&f._data(e.elem,"fxshow"+e.prop,e.start)},h()&&f.timers.push(h)&&!cp&&(cp=setInterval(g.tick,g.interval))},show:function(){var a=f._data(this.elem,"fxshow"+this.prop);this.options.orig[this.prop]=a||f.style(this.elem,this.prop),this.options.show=!0,a!==b?this.custom(this.cur(),a):this.custom(this.prop==="width"||this.prop==="height"?1:0,this.cur()),f(this.elem).show()},hide:function(){this.options.orig[this.prop]=f._data(this.elem,"fxshow"+this.prop)||f.style(this.elem,this.prop),this.options.hide=!0,this.custom(this.cur(),0)},step:function(a){var b,c,d,e=cr||cs(),g=!0,h=this.elem,i=this.options;if(a||e>=i.duration+this.startTime){this.now=this.end,this.pos=this.state=1,this.update(),i.animatedProperties[this.prop]=!0;for(b in i.animatedProperties)i.animatedProperties[b]!==!0&&(g=!1);if(g){i.overflow!=null&&!f.support.shrinkWrapBlocks&&f.each(["","X","Y"],function(a,b){h.style["overflow"+b]=i.overflow[a]}),i.hide&&f(h).hide();if(i.hide||i.show)for(b in i.animatedProperties)f.style(h,b,i.orig[b]),f.removeData(h,"fxshow"+b,!0),f.removeData(h,"toggle"+b,!0);d=i.complete,d&&(i.complete=!1,d.call(h))}return!1}i.duration==Infinity?this.now=e:(c=e-this.startTime,this.state=c/i.duration,this.pos=f.easing[i.animatedProperties[this.prop]](this.state,c,0,1,i.duration),this.now=this.start+(this.end-this.start)*this.pos),this.update();return!0}},f.extend(f.fx,{tick:function(){var a,b=f.timers,c=0;for(;c<b.length;c++)a=b[c],!a()&&b[c]===a&&b.splice(c--,1);b.length||f.fx.stop()},interval:13,stop:function(){clearInterval(cp),cp=null},speeds:{slow:600,fast:200,_default:400},step:{opacity:function(a){f.style(a.elem,"opacity",a.now)},_default:function(a){a.elem.style&&a.elem.style[a.prop]!=null?a.elem.style[a.prop]=a.now+a.unit:a.elem[a.prop]=a.now}}}),f.each(["width","height"],function(a,b){f.fx.step[b]=function(a){f.style(a.elem,b,Math.max(0,a.now)+a.unit)}}),f.expr&&f.expr.filters&&(f.expr.filters.animated=function(a){return f.grep(f.timers,function(b){return a===b.elem}).length});var cw=/^t(?:able|d|h)$/i,cx=/^(?:body|html)$/i;"getBoundingClientRect"in c.documentElement?f.fn.offset=function(a){var b=this[0],c;if(a)return this.each(function(b){f.offset.setOffset(this,a,b)});if(!b||!b.ownerDocument)return null;if(b===b.ownerDocument.body)return f.offset.bodyOffset(b);try{c=b.getBoundingClientRect()}catch(d){}var e=b.ownerDocument,g=e.documentElement;if(!c||!f.contains(g,b))return c?{top:c.top,left:c.left}:{top:0,left:0};var h=e.body,i=cy(e),j=g.clientTop||h.clientTop||0,k=g.clientLeft||h.clientLeft||0,l=i.pageYOffset||f.support.boxModel&&g.scrollTop||h.scrollTop,m=i.pageXOffset||f.support.boxModel&&g.scrollLeft||h.scrollLeft,n=c.top+l-j,o=c.left+m-k;return{top:n,left:o}}:f.fn.offset=function(a){var b=this[0];if(a)return this.each(function(b){f.offset.setOffset(this,a,b)});if(!b||!b.ownerDocument)return null;if(b===b.ownerDocument.body)return f.offset.bodyOffset(b);var c,d=b.offsetParent,e=b,g=b.ownerDocument,h=g.documentElement,i=g.body,j=g.defaultView,k=j?j.getComputedStyle(b,null):b.currentStyle,l=b.offsetTop,m=b.offsetLeft;while((b=b.parentNode)&&b!==i&&b!==h){if(f.support.fixedPosition&&k.position==="fixed")break;c=j?j.getComputedStyle(b,null):b.currentStyle,l-=b.scrollTop,m-=b.scrollLeft,b===d&&(l+=b.offsetTop,m+=b.offsetLeft,f.support.doesNotAddBorder&&(!f.support.doesAddBorderForTableAndCells||!cw.test(b.nodeName))&&(l+=parseFloat(c.borderTopWidth)||0,m+=parseFloat(c.borderLeftWidth)||0),e=d,d=b.offsetParent),f.support.subtractsBorderForOverflowNotVisible&&c.overflow!=="visible"&&(l+=parseFloat(c.borderTopWidth)||0,m+=parseFloat(c.borderLeftWidth)||0),k=c}if(k.position==="relative"||k.position==="static")l+=i.offsetTop,m+=i.offsetLeft;f.support.fixedPosition&&k.position==="fixed"&&(l+=Math.max(h.scrollTop,i.scrollTop),m+=Math.max(h.scrollLeft,i.scrollLeft));return{top:l,left:m}},f.offset={bodyOffset:function(a){var b=a.offsetTop,c=a.offsetLeft;f.support.doesNotIncludeMarginInBodyOffset&&(b+=parseFloat(f.css(a,"marginTop"))||0,c+=parseFloat(f.css(a,"marginLeft"))||0);return{top:b,left:c}},setOffset:function(a,b,c){var d=f.css(a,"position");d==="static"&&(a.style.position="relative");var e=f(a),g=e.offset(),h=f.css(a,"top"),i=f.css(a,"left"),j=(d==="absolute"||d==="fixed")&&f.inArray("auto",[h,i])>-1,k={},l={},m,n;j?(l=e.position(),m=l.top,n=l.left):(m=parseFloat(h)||0,n=parseFloat(i)||0),f.isFunction(b)&&(b=b.call(a,c,g)),b.top!=null&&(k.top=b.top-g.top+m),b.left!=null&&(k.left=b.left-g.left+n),"using"in b?b.using.call(a,k):e.css(k)}},f.fn.extend({position:function(){if(!this[0])return null;var a=this[0],b=this.offsetParent(),c=this.offset(),d=cx.test(b[0].nodeName)?{top:0,left:0}:b.offset();c.top-=parseFloat(f.css(a,"marginTop"))||0,c.left-=parseFloat(f.css(a,"marginLeft"))||0,d.top+=parseFloat(f.css(b[0],"borderTopWidth"))||0,d.left+=parseFloat(f.css(b[0],"borderLeftWidth"))||0;return{top:c.top-d.top,left:c.left-d.left}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||c.body;while(a&&!cx.test(a.nodeName)&&f.css(a,"position")==="static")a=a.offsetParent;return a})}}),f.each(["Left","Top"],function(a,c){var d="scroll"+c;f.fn[d]=function(c){var e,g;if(c===b){e=this[0];if(!e)return null;g=cy(e);return g?"pageXOffset"in g?g[a?"pageYOffset":"pageXOffset"]:f.support.boxModel&&g.document.documentElement[d]||g.document.body[d]:e[d]}return this.each(function(){g=cy(this),g?g.scrollTo(a?f(g).scrollLeft():c,a?c:f(g).scrollTop()):this[d]=c})}}),f.each(["Height","Width"],function(a,c){var d=c.toLowerCase();f.fn["inner"+c]=function(){var a=this[0];return a?a.style?parseFloat(f.css(a,d,"padding")):this[d]():null},f.fn["outer"+c]=function(a){var b=this[0];return b?b.style?parseFloat(f.css(b,d,a?"margin":"border")):this[d]():null},f.fn[d]=function(a){var e=this[0];if(!e)return a==null?null:this;if(f.isFunction(a))return this.each(function(b){var c=f(this);c[d](a.call(this,b,c[d]()))});if(f.isWindow(e)){var g=e.document.documentElement["client"+c],h=e.document.body;return e.document.compatMode==="CSS1Compat"&&g||h&&h["client"+c]||g}if(e.nodeType===9)return Math.max(e.documentElement["client"+c],e.body["scroll"+c],e.documentElement["scroll"+c],e.body["offset"+c],e.documentElement["offset"+c]);if(a===b){var i=f.css(e,d),j=parseFloat(i);return f.isNumeric(j)?j:i}return this.css(d,typeof a=="string"?a:a+"px")}}),a.jQuery=a.$=f,typeof define=="function"&&define.amd&&define.amd.jQuery&&define("jquery",[],function(){return f})})(window);
/**
 * jQuery hashchange 1.0.0
 * 
 * (based on jquery.history)
 *
 * Copyright (c) 2008 Chris Leishman (chrisleishman.com)
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 */
(function($) {

$.fn.extend({
    hashchange: function(callback) { this.bind('hashchange', callback) },
    openOnClick: function(href) {
		if (href === undefined || href.length == 0)
			href = '#';
		return this.click(function(ev) {
			if (href && href.charAt(0) == '#') {
				// execute load in separate call stack
				window.setTimeout(function() { $.locationHash(href) }, 0);
			} else {
				window.location(href);
			}
			ev.stopPropagation();
			return false;
		});
    }
});

// IE 8 introduces the hashchange event natively - so nothing more to do
if ($.browser.msie && document.documentMode && document.documentMode >= 8) {
	$.extend({
		locationHash: function(hash) {
	        if (!hash) hash = '#';
	        else if (hash.charAt(0) != '#') hash = '#' + hash;
	        location.hash = hash;
	    }
	});
	return;
}

var curHash;
// hidden iframe for IE (earlier than 8)
var iframe;

$.extend({
	locationHash: function(hash) {
		if (curHash === undefined) return;

		if (!hash) hash = '#';
		else if (hash.charAt(0) != '#') hash = '#' + hash;
		
		location.hash = hash;
		
		if (curHash == hash) return;
		curHash = hash;
		
		if ($.browser.msie) updateIEFrame(hash);
		$.event.trigger('hashchange');
	}
});

$(document).ready(function() {
    curHash = location.hash;
    if ($.browser.msie) {
        // stop the callback firing twice during init if no hash present
        if (curHash == '') curHash = '#';
        // add hidden iframe for IE
        iframe = $('<iframe />').hide().get(0);
        $('body').prepend(iframe);
        updateIEFrame(location.hash);
        setInterval(checkHashIE, 100);
    } else {
        setInterval(checkHash, 100);
    }
});
$(window).unload(function() { iframe = null });

function checkHash() {
    var hash = location.hash;
    if (hash != curHash) {
        curHash = hash;
        $.event.trigger('hashchange');
    }
}

if ($.browser.msie) {
    // Attach a live handler for any anchor links
    $('a[href^=#]').live('click', function() {
        var hash = $(this).attr('href');
        // Don't intercept the click if there is an existing anchor on the page
        // that matches this hash
        if ($(hash).length == 0 && $('a[name='+hash.slice(1)+']').length == 0) {
            $.locationHash(hash);
            return false;
        }
    });
}

function checkHashIE() {
    // On IE, check for location.hash of iframe
    var idoc = iframe.contentDocument || iframe.contentWindow.document;
    var hash = idoc.location.hash;
    if (hash == '') hash = '#';

    if (hash != curHash) {
        if (location.hash != hash) location.hash = hash;
        curHash = hash;
        $.event.trigger('hashchange');
    }
}

function updateIEFrame(hash) {
    if (hash == '#') hash = '';
    var idoc = iframe.contentWindow.document;
    idoc.open();
    idoc.close();
    if (idoc.location.hash != hash) idoc.location.hash = hash;
}

})(jQuery);
// IE...
if (!Date.now) {
	Date.now = function() {
		return new Date().getTime();
	}
}

var Mizuho = {
	/** Cached DOM elements so that we don't have to re-find them over and over. */
	$document: undefined,
	$window: undefined,
	$mainSections: undefined,
	$sectionHeaders: undefined,

	/** Constants */
	MAX_TOC_LEVEL: 3,

	sectionHeadersSelector: undefined,
	scrollMemory: {},
	changingHash: false,
	activeHash: undefined,
	/** Whether in single-page or multi-page mode. Either 'single' or 'multi'. */
	mode: 'single',
	/** Whether smooth scrolling is enabled. It is always enabled except right
	 * after page load: when the page is scrolled to the section as pointed to
	 * by location.hash.
	 */
	smoothScrolling: true,
	
	initialize: function() {
		this.sectionHeadersSelector = '';
		for (var i = 0; i < this.MAX_TOC_LEVEL; i++) {
			if (i != 0) {
				this.sectionHeadersSelector += ', ';
			}
			this.sectionHeadersSelector += 'h' + (i + 2);
		}
		
		this.$document = $(document);
		this.$window = $(window);
		this.$mainSections = $('.sect1');
		this.$sectionHeaders = $(this.sectionHeadersSelector, '#content');
		this.$sectionHeaders.sort(function(a, b) {
			var off_a = $(a).offset();
			var off_b = $(b).offset();
			return off_a.top - off_b.top;
		});
		
		if (this.isMobileDevice()) {
			$(document.body).addClass('mobile');
		}
	},
	

	/********* Generic utility functions *********/

	isMobileDevice: function() {
		return navigator.userAgent.match(
			/(IEMobile|Windows CE|NetFront|PlayStation|PLAYSTATION|like Mac OS X|MIDP|UP\.Browser|Symbian|Nintendo|Android)/
		);
	},
	
	virtualAnimate: function(options) {
		var options = $.extend({
			duration: 1000
		}, options || {});
		var animation_start = Date.now();
		var animation_end = Date.now() + options.duration;
		var interval = animation_end - animation_start;
		this._virtualAnimate_step(animation_start, animation_end, interval, options);
	},

	_virtualAnimate_step: function(animation_start, animation_end, interval, options) {
		var self = this;
		var now = new Date();
		var progress = (now - animation_start) / interval;
		if (progress > 1) {
			progress = 1;
		}
		progress = (1 + Math.sin(-Math.PI / 2 + progress * Math.PI)) / 2;
		options.step(progress);
		if (now < animation_end) {
			setTimeout(function() {
				self._virtualAnimate_step(animation_start,
					animation_end, interval, options);
			}, 15);
		} else {
			options.step(1);
			if (options.finish) {
				options.finish();
			}
		}
	},
	
	smoothlyScrollTo: function(top) {
		if (!this.smoothScrolling) {
			return this.setScrollTop(top);
		}
		
		var self = this;
		var $document = this.$document;
		var current = $document.scrollTop();
		this.virtualAnimate({
			duration: 300,
			step: function(x) {
				$document.scrollTop(Math.floor(
					top + (1 - x) * (current - top)
				));
			},
			finish: function() {
				self.setScrollTop(top);
			}
		});
	},
	
	smoothlyScrollToToc: function() {
		this.smoothlyScrollTo($('#toc').position().top);
	},

	scrollToHeader: function(header) {
		this.smoothlyScrollTo($(header).offset().top - 50);
	},
	
	setScrollTop: function(top, element) {
		// Browsers don't always scroll properly so work around
		// this with a few timers.
		var self = this;
		element = element || this.$document;
		element = $(element);
		element.scrollTop(top);
		setTimeout(function() {
			element.scrollTop(top);
		}, 1);
		setTimeout(function() {
			element.scrollTop(top);
			self.$document.trigger('mizuho:updateTopBar');
		}, 20);
	},
	

	/********* Mizuho-specific functions *********/

	/** Returns the currently displayed section's header DOM element. */
	currentSubsection: function() {
		var $sectionHeaders = this.$sectionHeaders;
		var scrollTop = this.$document.scrollTop();
		var windowHeight = this.$window.height();
		var offset;
		
		var low = 0;
		var high = this.$sectionHeaders.length - 1;
		var mid = 0;
		
		while (low <= high) {
			mid = Math.floor((low + high) / 2);
			offset = $($sectionHeaders[mid]).offset();
			
			if (offset.top >= scrollTop) {
				high = mid - 1;
			} else {
				low = mid + 1;
			}
		}
		
		var $found = $($sectionHeaders[low]);
		if ($found.offset().top > scrollTop + windowHeight) {
			if (low > 0) {
				return $sectionHeaders[low - 1];
			} else {
				return undefined;
			}
		} else {
			return $sectionHeaders[low];
		}
	},
	
	/** Looks up a section's header DOM element corresponding to a hash name. */
	lookupHeader: function(hash) {
		var id = hash.replace(/^#!\//, '#');
		if (id == '') {
			return undefined;
		} else {
			var header = $(id);
			if (header.length == 0) {
				return undefined;
			} else {
				return header;
			}
		}
	}
};

for (var key in Mizuho) {
	if (typeof(Mizuho[key]) == 'function') {
		Mizuho[key] = $.proxy(Mizuho[key], Mizuho);
	}
}
$(document).ready(Mizuho.initialize);
//$(document).ready(Mizuho.installHashbangLinks);

Mizuho.initializeTopBar = $.proxy(function() {
	var $window = this.$window;
	var $document = this.$document;
	var self = this;
	var $topbar = $('#topbar');
	var $title = $('#header h1');
	var $currentSection = $('#current_section');
	var isMobileDevice = this.isMobileDevice();
	var timerId;
	
	// Create the floating table of contents used in the top bar.
	var $floattoc = $('<div id="floattoc"></div>').html($('#toc').html());
	$floattoc.find('#toctitle').remove();
	$floattoc.find('.comments').remove();
	$floattoc.css('visibility', 'hidden');
	$floattoc.insertAfter($topbar);
	var $floattoclinks = $floattoc.find('a');
	$floattoclinks.each(function() {
		// Firefox changes '#!' to '#%21' so change that back.
		var $this = $(this);
		var href = $this.attr('href');
		if (href.match(/^#%21/)) {
			$this.attr('href', href.replace(/^#%21/, '#!'));
		}
	});
	$floattoclinks.click(function(event) {
		self.internalLinkClicked(this, event);
	});
	
	// Callback for when the user clicks on the Table of Contents
	// button on the top bar.
	function showFloatingToc() {
		var scrollUpdateTimerId;
		
		function reposition() {
			if (isMobileDevice) {
				$floattoc.css({
					top: $currentSection.offset().top +
						$currentSection.innerHeight() +
						'px',
					height: $window.height() * 0.7 + 'px'
				});
			}
		}
		
		function highlightCurrentTocEntry() {
			var currentSubsection = self.currentSubsection();
			$floattoclinks.removeClass('current');
			if (currentSubsection) {
				var currentSubsectionTitle = $(currentSubsection).text();
				var $link;
				
				$floattoclinks.each(function() {
					if ($(this).text() == currentSubsectionTitle) {
						$link = $(this);
						return false;
					}
				});
				if ($link) {
					$link.addClass('current');
					self.setScrollTop(
						$floattoc.scrollTop() +
							$link.position().top -
							$floattoc.height() * 0.45,
						$floattoc);
					return false;
				}
			}
		}
		
		function hideFloatingToc() {
			$currentSection.removeClass('pressed');
			$floattoc.css('visibility', 'hidden');
			$floattoclinks.unbind('click', hideFloatingToc);
			$document.unbind('mousedown', onMouseDown);
			$document.unbind('touchdown', onMouseDown);
			$document.unbind('mizuho:hideTopBar', hideFloatingToc);
			$window.unbind('scroll', onScroll);
			if (scrollUpdateTimerId !== undefined) {
				clearTimeout(scrollUpdateTimerId);
				scrollUpdateTimerId = undefined;
			}
		}
		
		function onMouseDown(event) {
			if (event.target != $floattoc[0]
			 && $(event.target).closest('#floattoc').length == 0) {
				hideFloatingToc();
			}
		}
		
		function onScroll(event) {
			if (scrollUpdateTimerId === undefined) {
				scrollUpdateTimerId = setTimeout(function() {
					scrollUpdateTimerId = undefined;
					reposition();
					highlightCurrentTocEntry();
				}, 100);
			}
		}
		
		// Layout and display floating TOC.
		highlightCurrentTocEntry();
		var origScrollTop = $document.scrollTop();
		var windowWidth = $window.width();
		var maxRight = windowWidth - Math.floor(windowWidth * 0.1);
		
		if ($currentSection.offset().left + $floattoc.outerWidth() > maxRight) {
			$floattoc.css('left', maxRight - $floattoc.outerWidth());
		} else {
			$floattoc.css('left', $currentSection.offset().left + 'px');
		}
		reposition();
		$floattoc.css('visibility', 'visible');
		$currentSection.addClass('pressed');
		
		$floattoclinks.bind('click', hideFloatingToc);
		$document.bind('mousedown', onMouseDown)
		$document.bind('touchdown', onMouseDown);
		$document.bind('mizuho:hideTopBar', hideFloatingToc);
		$window.bind('scroll', onScroll);
	}
	
	// Called whenever the user scrolls. Updates the title of the
	// Table of Contents button in the top bar to the section that
	// the user is currently reading.
	function update() {
		if ($title.offset().top + $title.height() < $document.scrollTop()) {
			if (!$topbar.is(':visible')) {
				$topbar.slideDown(250);
				$document.trigger('mizuho:showTopBar');
			}
		} else {
			if ($topbar.is(':visible')) {
				$topbar.slideUp();
				$document.trigger('mizuho:hideTopBar');
			}
		}
		
		if (isMobileDevice) {
			$topbar.css({
				top: $document.scrollTop() + 'px',
				width: $window.width() -
					parseInt($topbar.css('padding-left')) -
					parseInt($topbar.css('padding-right')) +
					'px'
			});
		}
		
		var header = self.currentSubsection();
		var name;
		if (header) {
			name = $(header).text();
		} else {
			name = 'Preamble';
		}
		$currentSection.text(name);
	}
	
	function scheduleUpdate() {
		if (timerId !== undefined) {
			return;
		}
		timerId = setTimeout(function() {
			timerId = undefined;
			update();
		}, 100);
	}
	
	
	if (isMobileDevice) {
		// Mobile devices don't support position fixed.
		$topbar.css('position', 'absolute');
		$floattoc.css('position', 'absolute');
	}
	
	$currentSection.click(showFloatingToc);
	$window.scroll(scheduleUpdate);
	$document.bind('mizuho:updateTopBar', update);
}, Mizuho);

$(document).ready(Mizuho.initializeTopBar);


				var JUVIA_URL = 'http://juvia.phusion.nl';
				var JUVIA_SITE_KEY = 'q0ptarhn8o9xanwomq8zkgewbtwffyz';
			var disqus_identifier;
var disqus_title;
var disqus_url;
var disqus_developer = 1;

Mizuho.initializeCommenting = $.proxy(function() {
	var self = this;
	this.commentBalloons = $('.comments');
	this.commentBalloons.click(function() {
		self.showCommentsPopup(this);
	});
	this.reloadCommentCount();
}, Mizuho);

Mizuho.showLightbox = $.proxy(function(creationCallback, closeCallback) {
	var lightbox = $(
		'<div id="comments_lightbox">' +
		'  <div id="comments_lightbox_shadow"></div>' +
		'  <div id="comments_lightbox_contents"><div class="shell"></div></div>' +
		'</div>');
	var shadow = $('#comments_lightbox_shadow', lightbox);
	var contents = $('#comments_lightbox_contents > .shell', lightbox);
	
	function close() {
		if (lightbox) {
			lightbox.remove();
			lightbox = undefined;
			if (closeCallback) {
				closeCallback();
			}
		}
	}

	shadow.click(close);
	lightbox.bind('lightbox:close', close);
	lightbox.appendTo(document.body);
	creationCallback(contents);
}, Mizuho);

Mizuho.getCommentThreadInfo = $.proxy(function(balloon) {
	var info = {};
	if ($(balloon).closest('#toc').length > 0) {
		info.id = 'toctitle';
		info.topic = 'toctitle';
		info.title = $('#header h1').text() + " - " + $('#toctitle').text();
	} else {
		var header = $(balloon).next('h2, h3, h4');
		if (header.length > 0) {
			info.id = header.attr('id');
			info.topic = header.data('comment-topic');
			info.title = $('#header h1').text() + " - " + header.text();
		} else {
			info = undefined;
		}
	}
	return info;
}, Mizuho);

Mizuho.callJuviaApi = function(action, options) {
	function makeQueryString(options) {
		var key, params = [];
		for (key in options) {
			params.push(
				encodeURIComponent(key) +
				'=' +
				encodeURIComponent(options[key]));
		}
		return params.join('&');
	}

	// Makes sure that each call generates a unique URL, otherwise
	// the browser may not actually perform the request.
	if (!('_juviaRequestCounter' in window)) {
		window._juviaRequestCounter = 0;
	}

	var url =
		JUVIA_URL + '/api/' + action +
		'?_c=' + window._juviaRequestCounter +
		'&' + makeQueryString(options);
	window._juviaRequestCounter++;
	
	var s       = document.createElement('script');
	s.async     = true;
	s.type      = 'text/javascript';
	s.className = 'juvia';
	s.src       = url;
	(document.getElementsByTagName('head')[0] ||
	 document.getElementsByTagName('body')[0]).appendChild(s);
}

Mizuho.showCommentsPopup = $.proxy(function(balloon) {
	var info = this.getCommentThreadInfo(balloon);
	if (!info) {
		return;
	}
	
	var self = this;
	this.showLightbox(function(element) {
		// We install a 'Close' button in the Juvia comment form after it has loaded.
		function installCloseButton() {
			if ($('#comments .juvia-form-actions').size() > 0) {
				// The Juvia form is now loaded. Install the button.
				var div = $('<div class="juvia-action" style="margin-left: 0.5em"></div>');
				var button = $('<input type="button" value="Cancel"></div>').appendTo(div);
				div.insertBefore('#comments .juvia-form-actions .juvia-error');
				button.click(function() {
					$(element).trigger('lightbox:close');
				});
			} else {
				// Continue polling.
				setTimeout(installCloseButton, 50);
			}
		}
		setTimeout(installCloseButton, 50);

		// Now load the Juvia comments form.
		element.html('<div id="comments">Loading comments...</div>');
		self.changingHash = true;
		location.hash = '#!/' + info.id;
		self.callJuviaApi('show_topic.js', {
			container   : '#comments',
			site_key    : JUVIA_SITE_KEY,
			topic_key   : info.topic,
			topic_url   : location.href,
			topic_title : info.topic,
			include_base: !window.Juvia,
			include_css : !window.Juvia
		});
	}, function() {
		self.reloadCommentCount();
	});
}, Mizuho);

Mizuho.reloadCommentCount = $.proxy(function() {
	this.callJuviaApi('list_topics.jsonp', {
		site_key: JUVIA_SITE_KEY,
		jsonp   : 'Mizuho.topicListReceived'
	});
}, Mizuho);

Mizuho.topicListReceived = $.proxy(function(result) {
	var self = this;
	var i, topic, map = {};
	for (i = 0; i < result.topics.length; i++) {
		topic = result.topics[i];
		map[topic.key] = topic;
	}

	this.commentBalloons.each(function() {
		var info = self.getCommentThreadInfo(this);
		if (info) {
			topic = map[info.topic];
			if (topic) {
				var balloon = $(this);
				$('.count', balloon).text(topic.comment_count);
				balloon.removeClass('empty');
				balloon.addClass('nonempty');
				balloon.attr('title', null);
			}
		}
	});
}, Mizuho);

$(document).ready(Mizuho.initializeCommenting);

</script>
</body>
</html>
